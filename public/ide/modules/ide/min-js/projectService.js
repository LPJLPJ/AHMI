var projectRecord=[],ideServices=angular.module("IDEServices",["ngFileUpload"]);ideServices.service("ProjectService",["$rootScope","$timeout","CanvasService","GlobalService","Preference","TemplateProvider","ViewService","Type","ResourceService",function(e,t,i,r,n,a,o,l,s){function c(e){var t=_.cloneDeep(e);return t.id=Math.random().toString(36).substr(2),t&&t.info&&(t.info.left+=10,t.info.top+=10),_.forEach(t.subLayers,function(e){e.id=Math.random().toString(36).substr(2);var t=e.proJsonStr;_.forEach(t.objects,function(t){_.forEach(e.widgets,function(e){if(e.id==t.id){var i=Math.random().toString(36).substr(2);e.id=i,t.id=i}})}),e.proJsonStr=t}),t}function h(e){var t=_.cloneDeep(e);t.id=Math.random().toString(36).substr(2),t.mode=0;var i=t.proJsonStr;return _.forEach(i.objects,function(e){_.forEach(t.layers,function(t){if(t.id==e.id){var i=Math.random().toString(36).substr(2);t.id=i,e.id=i}})}),t.proJsonStr=i,_.forEach(t.layers,function(e){_.forEach(e.subLayers,function(e){e.id=Math.random().toString(36).substr(2);var t=e.proJsonStr;_.forEach(t.objects,function(t){_.forEach(e.widgets,function(e){if(e.id==t.id){var i=Math.random().toString(36).substr(2);e.id=i,t.id=i}})}),e.proJsonStr=t})}),t}function g(e){var t=_.cloneDeep(e),i=Math.random().toString(36).substr(2);return t.id=i,t&&t.info&&(t.info.left+=5,t.info.top+=5),t}function u(){_.forEach(L.pages,function(e){e.$$hashKey=void 0})}function d(e,t){if(!e||e.type!=l.MyGroup)return void console.warn("传参不对");var r=null;r=t?i.getSubLayerNode():i.getPageNode();var n=[];if(r.forEachObject(function(t){_.forEach(e.getObjects(),function(e){e.id==t.id&&n.push(t)})}),n.length==e.getObjects().length){var a=new fabric.Group(n,{canvas:r});return a}return e}function f(e,t){var i=!1;return"group"!=t.type?i:(_.forEach(t.getObjects(),function(t){t.id==e.id&&(i=!0)}),i)}function b(e,t,i){for(var r=null;e>360;)e-=360;for(;e<0;)e+=360;return e>=0&&e<=90?r=Math.atan(Math.tan(e*Math.PI/180)*(i/t)):e>90&&e<=180?(r=Math.atan(Math.tan((e-90)*Math.PI/180)*(t/i)),r+=Math.PI/2):e>180&&e<=270?(r=Math.atan(Math.tan((e-180)*Math.PI/180)*(i/t)),r+=Math.PI):e>270&&e<=360&&(r=Math.atan(Math.tan((e-270)*Math.PI/180)*(t/i)),r+=3*Math.PI/2),r}function m(e,t,i){var r=e.slice(5,e.length-1).split(","),n=t.slice(5,t.length-1).split(","),a=parseInt(r[0]),o=parseInt(r[1]),l=parseInt(r[2]),s=(parseInt(r[3]),parseInt(n[0])),c=parseInt(n[1]),h=parseInt(n[2]),g=(parseInt(n[3]),parseInt(a+(s-a)*i)),u=parseInt(o+(c-o)*i),d=parseInt(l+(h-l)*i),f=1;return"rgba("+g+","+u+","+d+","+f+")"}function y(e,t,i,r,n,a,o,l,s,c,h){var g=n/s.scaleX,u=a/s.scaleY,d=o/s.scaleX,f=l/s.scaleY,b=Math.floor((i-g)/d)+1,m=Math.floor((r-u)/f)+1;if(c.save(),c.translate(e,t),c.beginPath(),c.save(),c.translate(g,0),s&&s.grid&&"1"==s.grid||"3"==s.grid){c.textAlign="center",c.textBaseline="top",c.fillStyle="rgba(255,255,255,1)",c.font="10px";for(var y=s.gridInitValue+(b-1)*s.gridUnitX,p=Math.floor(c.measureText(y).width/(2*o/3))+1,v=0;v<b;v++){var S=v*d,I=s.gridInitValue+v*s.gridUnitX;c.moveTo(S,0),c.lineTo(S,r-u),v%p==0&&(c.scale(1/s.scaleX,1/s.scaleY),c.fillText(I,S*s.scaleX,(r-u+2)*s.scaleY),c.scale(s.scaleX,s.scaleY))}}if(c.restore(),c.save(),c.translate(g,r-u),s&&s.grid&&"1"==s.grid||"2"==s.grid)for(c.textAlign="right",c.textBaseline="middle",c.fillStyle="rgba(255,255,255,1)",c.font="10px",v=0;v<m;v++){var L=v*f,C=h+s.gridInitValue+v*s.gridUnitY;c.moveTo(0,-L),c.lineTo(i-g,-L),c.scale(1/s.scaleX,1/s.scaleY),c.fillText(C,-2*s.scaleX,-L*s.scaleY),c.scale(s.scaleX,s.scaleY)}c.restore(),c.lineWidth=s.lineWidth||1,c.strokeStyle=s&&s.color||"lightgrey",c.scale(1/s.scaleX,1/s.scaleY),c.stroke(),c.restore()}function p(e,t,i,r,n){var a=n||1,o=parseInt(e*a),l=parseInt(t*a),c=I.getCurrentPage(),h=c.backgroundColor||"rgba(54,71,92,0.3)",g=c.backgroundImage||"",u=L.currentSize&&L.currentSize.width||1280,d=L.currentSize&&L.currentSize.height||480,f=document.getElementById("backgroundCanvas");f.width=o,f.height=l;var b=f.getContext("2d");if(""!=g&&"/public/images/blank.png"!=g){pageBackgroundImg=s.getResourceFromCache(g);var m=parseInt(pageBackgroundImg.width/u*i),y=parseInt(pageBackgroundImg.height/d*r),p=parseInt(pageBackgroundImg.width/u*e),v=parseInt(pageBackgroundImg.height/d*t);b.drawImage(pageBackgroundImg,m,y,p,v,0,0,o,l)}else b.beginPath(),b.rect(0,0,o,l),b.fillStyle=h,b.fill(),b.closePath()}function v(e,t,i){var r="1"==e?Math.sqrt(t*t+i*i)/2:Math.max(t,i)/2;return r=Math.floor(r)}function S(e,t,i,r,n,a,o){t.fillStyle=o;var l=new Date,s=[],c=[],h=0;for(s.push(l.getHours()),s.push(l.getMinutes()),s.push(l.getSeconds()),h=0;h<s.length;h++)s[h]<10&&(s[h]="0"+s[h]);for(c.push(l.getFullYear()),c.push(l.getMonth()+1),c.push(l.getDate()),h=0;h<c.length;h++)c[h]<10&&(c[h]="0"+c[h]);"0"==e?(t.scale(1/i,1/r),t.font=n,t.textAlign=a,t.textBaseline="middle",t.fillText(s.join(":"),0,0),t.scale(i,r)):"1"==e?(t.scale(1/i,1/r),t.font=n,t.textAlign=a,t.textBaseline="middle",t.fillText(s.slice(0,2).join(":"),0,0),t.scale(i,r)):"2"==e?(t.scale(1/i,1/r),t.font=n,t.textAlign=a,t.textBaseline="middle",t.fillText(c.join("/"),0,0),t.scale(i,r)):"3"==e&&(t.scale(1/i,1/r),t.font=n,t.textAlign=a,t.textBaseline="middle",t.fillText(c.join("-"),0,0),t.scale(i,r))}var I=this;fabric.Object.prototype.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{id:this.id})}}(fabric.Object.prototype.toObject),fabric.Canvas.prototype.setActive=function(e){var t=this;if(!e)return void console.warn("找不到对象");if(e.type==l.MyLayer||l.isWidget(e.type)){var i=e;t.setActiveObject(i),i.setCoords()}else if(e.type==l.MyLayerGroup||e.type==l.MyWidgetGroup){var r=e;t.deactivateAllWithDispatch(),r.addWithUpdate(),t.setActiveGroup(r),r.saveCoords(),t.renderAll();var n=t.getActiveGroup();n&&(n.setObjectsCoords().setCoords(),n.isMoving=!1,t.setCursor(t.defaultCursor)),t._groupSelector=null,t._currentTransform=null}},fabric.Image.prototype.setSrc=function(e,t){var i=this,r=new Image;r.src=e+"?"+100*Math.random(),r.onload=function(){i.setElement(r),t(r.width,r.height)}},fabric.MyLayer=fabric.util.createClass(fabric.Object,{type:l.MyLayer,initialize:function(e,t){var i=this;this.initScale||(this.initScale={X:1,Y:1}),this.callSuper("initialize",t),this.loadAll(e),this.lockRotation=!0,this.hasRotatingPoint=!1,this.on("OnRelease",function(){var e=(I.getLevelById(i.id),null);e=A(i.id),i.initPosition.left=_.cloneDeep(i.getLeft()),i.initPosition.top=_.cloneDeep(i.getTop()),i.initScale.X=e.getScaleX().toFixed(2),i.initScale.Y=e.getScaleY().toFixed(2)}),this.on("OnScaleRelease",function(e){e==i.id&&this.renderUrlInPage(i)}),this.on("OnRenderUrl",function(e){this.renderUrlInPage(i,e)}),this.on("OnRefresh",function(){this.refresh()})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"))},_render:function(e){this.loadAll(this.id);try{e.fillStyle=this.backgroundColor,e.fillRect(-(this.width/2),-(this.height/2),this.width,this.height);var t=M();if(t&&P.scaling&&P.objId==this.id){this.widgetImgs=[];var i=A(t.id),r=i.getAngle()*Math.PI/180,n=Math.sin(r),a=Math.cos(r),o=this.initPosition.left-this.getLeft(),l=this.initPosition.top-this.getTop();this.backgroundImg.width=this.width/i.getScaleX()*this.initScale.X,this.backgroundImg.height=this.height/i.getScaleY()*this.initScale.Y,this.backgroundImg.top=(-n*o+a*l)/i.getScaleY()-this.height/2,this.backgroundImg.left=(a*o+n*l)/i.getScaleX()-this.width/2}this.backgroundImg.element&&e.drawImage(this.backgroundImg.element,this.backgroundImg.left,this.backgroundImg.top,this.backgroundImg.width,this.backgroundImg.height)}catch(e){console.log("错误描述",e),toastr.warning("渲染Layer出错")}}}),fabric.MyLayer.prototype.loadAll=function(e){var t=new Image,i=(A(e),k(e)),r=i.info.width/this.initScale.X,n=i.info.height/this.initScale.Y;this.initPosition={},""==i.showSubLayer.url?t=null:(t.onload=function(){this.width=r,this.height=n,this.loaded=!0,this.setCoords(),this.fire("image:loaded")}.bind(this),t.src=_.cloneDeep(i.showSubLayer.url)),this.backgroundImg={element:t,width:r,height:n,left:-r/2,top:-n/2},this.backgroundColor=i.showSubLayer.backgroundColor,this.initPosition.left=_.cloneDeep(this.getLeft()),this.initPosition.top=_.cloneDeep(this.getTop())},fabric.MyLayer.prototype.refresh=function(){this.id&&this.loadAll(this.id)},fabric.MyLayer.prototype.renderUrlInPage=function(e,t){var r=k(e.id),n=new Image;n.onload=function(){e.backgroundImg.element=n,e.backgroundImg.width=e.width,e.backgroundImg.height=e.height,e.backgroundImg.left=-e.width/2,e.backgroundImg.top=-e.height/2,e.initPosition.left=_.cloneDeep(e.getLeft()),e.initPosition.top=_.cloneDeep(e.getTop());var r=i.getPageNode();r.renderAll(),t&&t()}.bind(e),n.onerror=function(e){n=null,t&&t(e)}.bind(e),n.src=r.showSubLayer.url},fabric.MyLayer.prototype.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{loaded:this.loaded,backgroundImg:this.backgroundImg,widgetImgs:this.widgetImgs,initPosition:this.initPosition,initScale:this.initScale})}}(fabric.MyLayer.prototype.toObject),fabric.MyLayer.fromObject=function(e,t){t&&t(new fabric.MyLayer(e.id,e))},fabric.MyLayer.async=!0,fabric.MyProgress=fabric.util.createClass(fabric.Object,{type:l.MyProgress,initialize:function(e,t){var r=this;this.callSuper("initialize",t),this.lockRotation=!0,this.hasRotatingPoint=!1,this.progressValue=e.info.progressValue/(e.info.maxValue-e.info.minValue),this.progressModeId=e.info.progressModeId,this.cursor=e.info.cursor,"1"==this.progressModeId&&(this.initColor=e.texList[1].slices[0].color,this.endColor=e.texList[2].slices[0].color),"0"==this.progressModeId&&"1"==this.cursor&&(this.cursorColor=e.texList[2].slices[0].color,this.cursorImageElement=s.getResourceFromCache(e.texList[2].slices[0].imgSrc)),"1"==this.progressModeId&&"1"==this.cursor&&(this.cursorColor=e.texList[3].slices[0].color,this.cursorImageElement=s.getResourceFromCache(e.texList[3].slices[0].imgSrc)),this.backgroundColor=e.texList[0].slices[0].color,this.backgroundImageElement=s.getResourceFromCache(e.texList[0].slices[0].imgSrc),this.backgroundImageElement&&(this.loaded=!0,this.setCoords(),this.fire("image:loaded")),this.progressColor=e.texList[1].slices[0].color,this.progressImageElement=s.getResourceFromCache(e.texList[1].slices[0].imgSrc),this.arrange=e.info.arrange,this.on("changeProgressValue",function(e){r.progressValue=e.progress;var t=e.callback,n=i.getSubLayerNode();n.renderAll(),t&&t()}),this.on("changeTex",function(e){var t=e.level,n=e.callback;t.texList[0]&&"进度条底纹"==t.texList[0].name&&(r.backgroundColor=t.texList[0].slices[0].color,r.backgroundImageElement=s.getResourceFromCache(t.texList[0].slices[0].imgSrc)),t.texList[1]&&"进度条"==t.texList[1].name?(r.progressColor=t.texList[1].slices[0].color,r.progressImageElement=s.getResourceFromCache(t.texList[1].slices[0].imgSrc)):t.texList[1]&&"初始颜色"==t.texList[1].name&&(r.initColor=t.texList[1].slices[0].color),t.texList[2]&&t.texList[2]&&"光标纹理"==t.texList[2].name?(r.cursorColor=t.texList[2].slices[0].color,r.cursorImageElement=s.getResourceFromCache(t.texList[2].slices[0].imgSrc)):t.texList[2]&&"结束颜色"==t.texList[2].name&&(r.endColor=t.texList[2].slices[0].color),t.texList[3]&&t.texList[3]&&"光标纹理"==t.texList[3].name&&(r.cursorColor=t.texList[3].slices[0].color,r.cursorImageElement=s.getResourceFromCache(t.texList[3].slices[0].imgSrc));var a=i.getSubLayerNode();a.renderAll(),n&&n()}),this.on("changeArrange",function(e){r.arrange=e.arrange;var t=e.callback,n=i.getSubLayerNode();n.renderAll(),t&&t()}),this.on("changeAttributeCursor",function(t){r.backgroundColor=t.backgroundColor,r.progressColor=t.progressColor,r.progressModeId=t.progressModeId,t.hasOwnProperty("initColor")&&(r.initColor=t.initColor),t.hasOwnProperty("endColor")&&(r.endColor=t.endColor),e.texList[0]&&"进度条底纹"==e.texList[0].name?r.backgroundImageElement=s.getResourceFromCache(e.texList[0].slices[0].imgSrc):r.backgroundImageElement=null,e.texList[1]&&"进度条"==e.texList[1].name?r.progressImageElement=s.getResourceFromCache(e.texList[1].slices[0].imgSrc):r.progressImageElement=null,e.texList[3]&&e.texList[3]&&"光标纹理"==e.texList[3].name?r.cursorImageElement=s.getResourceFromCache(e.texList[3].slices[0].imgSrc):r.cursorImageElement=null;var n=i.getSubLayerNode();n.renderAll()})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"))},_render:function(e){try{if("0"==this.progressModeId)e.fillStyle=this.backgroundColor,e.fillRect(-this.width/2,-this.height/2,this.width,this.height),this.backgroundImageElement&&e.drawImage(this.backgroundImageElement,-this.width/2,-this.height/2,this.width,this.height),"horizontal"==this.arrange?(e.fillStyle=this.progressColor,e.fillRect(-this.width/2,-this.height/2,this.width*this.progressValue,this.height),this.progressImageElement&&e.drawImage(this.progressImageElement,-this.width/2,-this.height/2,this.width*this.progressValue,this.height),this.cursorImageElement&&e.drawImage(this.cursorImageElement,-this.width/2+this.width*this.progressValue,-this.cursorImageElement.height/2/this.scaleY,this.cursorImageElement.width/this.scaleX,this.cursorImageElement.height/this.scaleY)):(e.fillStyle=this.progressColor,e.fillRect(-this.width/2,this.height/2-this.height*this.progressValue,this.width,this.height*this.progressValue),this.progressImageElement&&e.drawImage(this.progressImageElement,-this.width/2,this.height/2-this.height*this.progressValue,this.width,this.height*this.progressValue),this.cursorImageElement&&e.drawImage(this.cursorImageElement,-this.cursorImageElement.width/2/this.scaleX,this.height/2-this.height*this.progressValue-this.cursorImageElement.height/this.scaleY,this.cursorImageElement.width/this.scaleX,this.cursorImageElement.height/this.scaleY));else if("1"==this.progressModeId){var t=m(this.initColor,this.endColor,this.progressValue);"horizontal"==this.arrange?(this.cursorImageElement&&e.drawImage(this.cursorImageElement,-this.width/2+this.width*this.progressValue,-this.cursorImageElement.height/2/this.scaleY,this.cursorImageElement.width/this.scaleX,this.cursorImageElement.height/this.scaleY),e.fillStyle=t,e.fillRect(-this.width/2,-this.height/2,this.width*this.progressValue,this.height)):(e.fillStyle=t,e.fillRect(-this.width/2,this.height/2-this.height*this.progressValue,this.width,this.height*this.progressValue),this.cursorImageElement&&e.drawImage(this.cursorImageElement,-this.cursorImageElement.width/2/this.scaleX,this.height/2-this.height*this.progressValue-this.cursorImageElement.height/this.scaleY,this.cursorImageElement.width/this.scaleX,this.cursorImageElement.height/this.scaleY)),this.backgroundImageElement&&e.drawImage(this.backgroundImageElement,-this.width/2,-this.height/2,this.width,this.height)}else"2"==this.progressModeId;this.clipTo=function(e){e.save(),e.beginPath(),e.rect(-this.width/2,-this.height/2,this.width,this.height),e.closePath(),e.restore()}}catch(e){console.log("错误描述",e),toastr.warning("渲染进度条出错")}}}),fabric.MyProgress.fromLevel=function(e,t,i){t&&t(new fabric.MyProgress(e,i))},fabric.MyProgress.prototype.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{backgroundImageElement:this.backgroundImageElement,progressImageElement:this.progressImageElement,backgroundColor:this.backgroundColor,progressColor:this.progressColor,progressValue:this.progressValue,arrange:this.arrange})}}(fabric.MyProgress.prototype.toObject),fabric.MyProgress.fromObject=function(e,t){var i=I.getLevelById(e.id);t&&t(new fabric.MyProgress(i,e))},fabric.MyProgress.async=!0,fabric.MyOscilloscope=fabric.util.createClass(fabric.Object,{type:l.MyOscilloscope,initialize:function(e,t){var r=this;this.callSuper("initialize",t),this.lockRotation=!0,this.hasRotatingPoint=!1,this.maxValue=e.info.maxValue,this.minValue=e.info.minValue,this.spacing=e.info.spacing,this.grid=e.info.grid,this.lineWidth=e.info.lineWidth,this.gridUnitX=e.info.gridUnitX,this.gridUnitY=e.info.gridUnitY,this.gridInitValue=e.info.gridInitValue,this.blankX=e.info.blankX,this.blankY=e.info.blankY,this.setScaleY((((this.maxValue-this.minValue)/this.gridUnitY+.5)*this.spacing+this.blankY)/this.height),this.backgroundColor=e.texList[0].slices[0].color,this.backgroundImageElement=s.getResourceFromCache(e.texList[0].slices[0].imgSrc),this.backgroundImageElement&&(this.loaded=!0,this.setCoords(),this.fire("image:loaded")),this.oscilloscopeColor=e.texList[1].slices[0].color,this.oscilloscopeImageElement=s.getResourceFromCache(e.texList[1].slices[0].imgSrc),this.on("changeTex",function(e){var t=e.level,n=e.callback;r.backgroundColor=t.texList[0].slices[0].color,this.backgroundImageElement=s.getResourceFromCache(t.texList[0].slices[0].imgSrc),r.oscilloscopeColor=t.texList[1].slices[0].color,this.oscilloscopeImageElement=s.getResourceFromCache(t.texList[1].slices[0].imgSrc);var a=i.getSubLayerNode();a.renderAll(),n&&n()}),this.on("ChangeAttributeOscilloscope",function(e){var t=I.getCurrentSelectObject(),n=e.callback;e.hasOwnProperty("lineColor"),e.hasOwnProperty("spacing")&&(r.spacing=e.spacing,r.setScaleY((((r.maxValue-r.minValue)/r.gridUnitY+.5)*r.spacing+r.blankY)/r.height),t.level.info.height=((r.maxValue-r.minValue)/r.gridUnitY+.5)*r.spacing+r.blankY),e.hasOwnProperty("grid")&&(r.grid=e.grid),e.hasOwnProperty("lineWidth")&&(r.lineWidth=e.lineWidth),e.hasOwnProperty("gridInitValue")&&(r.gridInitValue=e.gridInitValue),e.hasOwnProperty("gridUnitX")&&(r.gridUnitX=e.gridUnitX),e.hasOwnProperty("gridUnitY")&&(r.gridUnitY=e.gridUnitY,r.setScaleY((((r.maxValue-r.minValue)/r.gridUnitY+.5)*r.spacing+r.blankY)/r.height),t.level.info.height=((r.maxValue-r.minValue)/r.gridUnitY+.5)*r.spacing+r.blankY),e.hasOwnProperty("maxValue")&&(r.maxValue=e.maxValue,r.setScaleY((((r.maxValue-r.minValue)/r.gridUnitY+.5)*r.spacing+r.blankY)/r.height),t.level.info.height=((r.maxValue-r.minValue)/r.gridUnitY+.5)*r.spacing+r.blankY),e.hasOwnProperty("minValue")&&(r.minValue=e.minValue,r.setScaleY((((r.maxValue-r.minValue)/r.gridUnitY+.5)*r.spacing+r.blankY)/r.height),t.level.info.height=((r.maxValue-r.minValue)/r.gridUnitY+.5)*r.spacing+r.blankY);var a=i.getSubLayerNode();a.renderAll(),n&&n()})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"))},_render:function(e){try{if(e.fillStyle=this.backgroundColor,e.fillRect(-this.width/2,-this.height/2,this.width,this.height),this.backgroundImageElement&&e.drawImage(this.backgroundImageElement,-this.width/2,-this.height/2,this.width,this.height),this.oscilloscopeImageElement&&e.drawImage(this.oscilloscopeImageElement,-this.width/2,-this.height/2,this.width,this.height),"0"!=this.grid){var t={lineWidth:this.lineWidth,grid:this.grid,gridInitValue:this.gridInitValue,gridUnitX:this.gridUnitX,gridUnitY:this.gridUnitY,scaleX:this.scaleX,scaleY:this.scaleY};y(-this.width/2,-this.height/2,this.width,this.height,this.blankX,this.blankY,this.spacing,this.spacing,t,e,this.minValue)}this.clipTo=function(e){e.save(),e.beginPath(),e.rect(-this.width/2,-this.height/2,this.width,this.height),e.closePath(),e.restore()}}catch(e){console.log("错误描述",e),toastr.warning("渲染示波器出错")}}}),fabric.MyOscilloscope.fromLevel=function(e,t,i){t&&t(new fabric.MyOscilloscope(e,i))},fabric.MyOscilloscope.prototype.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{backgroundImageElement:this.backgroundImageElement,oscilloscopeImageElement:this.oscilloscopeImageElement,backgroundColor:this.backgroundColor,oscilloscopeColor:this.oscilloscopeColor})}}(fabric.MyOscilloscope.prototype.toObject),fabric.MyOscilloscope.fromObject=function(e,t){var i=I.getLevelById(e.id);t&&t(new fabric.MyOscilloscope(i,e))},fabric.MyOscilloscope.async=!0,fabric.MyDashboard=fabric.util.createClass(fabric.Object,{type:l.MyDashboard,initialize:function(e,t){var r=this;this.callSuper("initialize",t),this.lockRotation=!0,this.hasRotatingPoint=!1,this.value=e.info.value,this.offsetValue=e.info.offsetValue,this.minValue=e.info.minValue,this.maxValue=e.info.maxValue,this.minAngle=e.info.minAngle,this.maxAngle=e.info.maxAngle,this.pointerLength=e.info.pointerLength,this.clockwise=e.info.clockwise,this.dashboardModeId=e.dashboardModeId,e.info.hasOwnProperty("minCoverAngle")&&(this.minCoverAngle=e.info.minCoverAngle),e.info.hasOwnProperty("maxCoverAngle")&&(this.maxCoverAngle=e.info.maxCoverAngle),"0"==this.dashboardModeId||"1"==this.dashboardModeId?(this.backgroundColor=e.texList[0].slices[0].color,this.backgroundImageElement=s.getResourceFromCache(e.texList[0].slices[0].imgSrc),this.backgroundImageElement&&(this.loaded=!0,this.setCoords(),this.fire("image:loaded")),this.pointerColor=e.texList[1].slices[0].color,this.pointerImageElement=s.getResourceFromCache(e.texList[1].slices[0].imgSrc),e.texList[2]&&(this.lightBandImageElement=s.getResourceFromCache(e.texList[2].slices[0].imgSrc))):"2"==this.dashboardModeId&&(this.backgroundColor=e.texList[0].slices[0].color,this.backgroundImageElement=null,this.pointerColor=null,this.pointerImageElement=null,this.lightBandImageElement=s.getResourceFromCache(e.texList[0].slices[0].imgSrc),this.lightBandImageElement&&(this.loaded=!0,this.setCoords(),this.fire("image:loaded"))),this.on("changeDashboardOffsetValue",function(e){(e.offsetValue||0==e.offsetValue)&&(r.offsetValue=e.offsetValue);var t=e.callback,n=i.getSubLayerNode();n.renderAll(),t&&t()}),this.on("changeDashboardValue",function(e){e.hasOwnProperty("value")?r.value=e.value:e.hasOwnProperty("maxValue")?r.maxValue=e.maxValue:e.hasOwnProperty("minValue")?r.minValue=e.minValue:e.hasOwnProperty("minAngle")?r.minAngle=e.minAngle:e.hasOwnProperty("maxAngle")&&(r.maxAngle=e.maxAngle);var t=e.callback,n=i.getSubLayerNode();n.renderAll(),t&&t()}),this.on("changeDashboardPointerLength",function(e){r.pointerLength=e.pointerLength,r.scaleX=e.scaleX,r.scaleY=e.scaleY;var t=e.callback,n=i.getSubLayerNode();n.renderAll(),t&&t()}),this.on("changeDashboardMode",function(e){var t=e.level,n=e.callback;r.dashboardModeId=e.dashboardModeId,"0"==r.dashboardModeId||"1"==r.dashboardModeId?(r.backgroundImageElement=s.getResourceFromCache(t.texList[0].slices[0].imgSrc),r.backgroundColor=t.texList[0].slices[0].color,r.pointerImageElement=s.getResourceFromCache(t.texList[1].slices[0].imgSrc),r.pointerColor=t.texList[1].slices[0].color,t.texList[2]?r.lightBandImageElement=s.getResourceFromCache(t.texList[2].slices[0].imgSrc):r.lightBandImageElement=null):"2"==r.dashboardModeId&&(r.backgroundImageElement=null,r.backgroundColor=t.texList[0].slices[0].color,r.pointerImageElement=null,r.pointerColor=null,r.lightBandImageElement=s.getResourceFromCache(t.texList[0].slices[0].imgSrc));var a=i.getSubLayerNode();a.renderAll(),n&&n()}),this.on("changeDashboardClockwise",function(e){r.clockwise=e.clockwise;var t=e.callback,n=i.getSubLayerNode();n.renderAll(),t&&t()}),this.on("changeDashboardCoverAngle",function(e){var t=e.callback,n=i.getSubLayerNode();e.hasOwnProperty("minCoverAngle")?r.minCoverAngle=e.minCoverAngle:e.hasOwnProperty("maxCoverAngle")&&(r.maxCoverAngle=e.maxCoverAngle),n.renderAll(),t&&t()}),this.on("changeTex",function(e){var t=e.level,n=t.dashboardModeId,a=e.callback;"0"==n||"1"==n?(r.backgroundColor=t.texList[0].slices[0].color,r.pointerColor=t.texList[1].slices[0].color,r.backgroundImageElement=s.getResourceFromCache(t.texList[0].slices[0].imgSrc),r.pointerImageElement=s.getResourceFromCache(t.texList[1].slices[0].imgSrc),t.texList[2]&&(r.lightBandImageElement=s.getResourceFromCache(t.texList[2].slices[0].imgSrc))):"2"==n&&(r.backgroundImageElement=null,r.backgroundColor=t.texList[0].slices[0].color,r.pointerImageElement=null,r.pointerColor=null,r.lightBandImageElement=s.getResourceFromCache(t.texList[0].slices[0].imgSrc));var o=i.getSubLayerNode();o.renderAll(),a&&a()})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"))},_render:function(e){try{var t=(this.maxAngle-this.minAngle)/(this.maxValue-this.minValue)*(this.value-this.minValue),i=(this.maxAngle-this.minAngle)/(this.maxValue-this.minValue)*this.value;if(e.fillStyle=this.backgroundColor,e.fillRect(-this.width/2,-this.height/2,this.width,this.height),this.backgroundImageElement&&e.drawImage(this.backgroundImageElement,-this.width/2,-this.height/2,this.width,this.height),this.lightBandImageElement){var r=b(t+this.offsetValue+this.minAngle,this.scaleX,this.scaleY),n=b(this.offsetValue+this.minAngle,this.scaleX,this.scaleY),a=b(i,this.scaleX,this.scaleY),o=b(this.offsetValue,this.scaleX,this.scaleY);e.save(),e.beginPath(),e.moveTo(0,0);var l=v(this.dashboardModeId,this.width,this.height);if("0"==this.clockwise)n=-n+Math.PI/2,r=-r+Math.PI/2,e.arc(0,0,l,n,r,!0),"2"==this.dashboardModeId&&e.arc(0,0,3*l/4,r,n,!1);else if("1"==this.clockwise)n+=Math.PI/2,r+=Math.PI/2,e.arc(0,0,l,n,r,!1),"2"==this.dashboardModeId&&e.arc(0,0,3*l/4,r,n,!0);else if("2"==this.clockwise)if(i>=0)n=o+Math.PI/2,r=a+o+Math.PI/2,e.arc(0,0,l,n,r,!1),"2"==this.dashboardModeId&&e.arc(0,0,3*l/4,r,n,!0);else if(i<0){var s=-i,a=b(s,this.scaleX,this.scaleY);n=o+Math.PI/2,r=-a+o+Math.PI/2,e.arc(0,0,l,r,n,!1),"2"==this.dashboardModeId&&e.arc(0,0,3*l/4,n,r,!0)}e.closePath(),e.clip(),e.drawImage(this.lightBandImageElement,-this.width/2,-this.height/2,this.width,this.height),e.restore()}if(this.pointerImageElement){e.save();var c=Math.sqrt(2),h=this.pointerLength/c/this.scaleX,g=this.pointerLength/c/this.scaleY,u=t+this.offsetValue+this.minAngle;if("0"==this.clockwise&&(u=-u),u+=45,this.minCoverAngle!=this.maxCoverAngle){var d=b(this.minCoverAngle,this.scaleX,this.scaleY)+Math.PI/2,f=b(this.maxCoverAngle,this.scaleX,this.scaleY)+Math.PI/2;e.save(),e.beginPath(),e.moveTo(0,0),e.arc(0,0,this.width/2,d,f,!1),e.closePath(),e.fillStyle="rgba(244,244,244,0.3)",e.fill(),e.restore(),e.beginPath(),e.moveTo(0,0),e.arc(0,0,this.width/2,f,d,!1),e.closePath(),e.clip()}e.scale(1/this.scaleX,1/this.scaleY),e.rotate(u*Math.PI/180),e.scale(this.scaleX,this.scaleY),e.fillStyle=this.pointerColor,e.fillRect(0,0,h,g),e.drawImage(this.pointerImageElement,0,0,h,g),e.restore()}this.clipTo=function(e){e.save(),e.beginPath(),e.rect(-this.width/2,-this.height/2,this.width,this.height),e.closePath(),e.restore()}}catch(e){console.log("错误描述",e),toastr.warning("渲染仪表盘出错")}}}),fabric.MyDashboard.fromLevel=function(e,t,i){t&&t(new fabric.MyDashboard(e,i))},fabric.MyDashboard.prototype.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{backgroundImageElement:this.backgroundImageElement,pointerImageElement:this.pointerImageElement,backgroundColor:this.backgroundColor,pointerColor:this.pointerColor,value:this.value})}}(fabric.MyDashboard.prototype.toObject),fabric.MyDashboard.fromObject=function(e,t){var i=I.getLevelById(e.id);t&&t(new fabric.MyDashboard(i,e))},fabric.MyDashboard.async=!0,fabric.MyKnob=fabric.util.createClass(fabric.Object,{type:l.MyKnob,initialize:function(e,t){var r=this;this.callSuper("initialize",t),this.lockRotation=!0,this.hasRotatingPoint=!1,this.value=e.info.value,this.knobSize=e.info.knobSize,this.backgroundColor=e.texList[0].slices[0].color,this.backgroundImageElement=s.getResourceFromCache(e.texList[0].slices[0].imgSrc),this.backgroundImageElement&&(this.loaded=!0,this.setCoords(),this.fire("image:loaded")),this.knobColor=e.texList[1].slices[0].color,this.knobImageElement=s.getResourceFromCache(e.texList[1].slices[0].imgSrc),this.on("changeKnobValue",function(e){r.value=e.value;var t=e.callback,n=i.getSubLayerNode();n.renderAll(),t&&t()}),this.on("changeKnobSize",function(e){r.knobSize=e.knobSize,r.scaleX=e.scaleX,r.scaleY=e.scaleY;var t=e.callback,n=i.getSubLayerNode();n.renderAll(),t&&t()}),this.on("changeTex",function(e){var t=e.level,n=e.callback;r.backgroundColor=t.texList[0].slices[0].color,r.backgroundImageElement=s.getResourceFromCache(t.texList[0].slices[0].imgSrc),r.knobColor=t.texList[1].slices[0].color,r.knobImageElement=s.getResourceFromCache(t.texList[1].slices[0].imgSrc);var a=i.getSubLayerNode();a.renderAll(),n&&n(),n&&n()})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"))},_render:function(e){try{if(e.fillStyle=this.backgroundColor,e.fillRect(-this.width/2,-this.height/2,this.width,this.height),this.backgroundImageElement&&e.drawImage(this.backgroundImageElement,-this.width/2,-this.height/2,this.width,this.height),this.knobImageElement){var t=Math.sqrt(2),i=this.knobSize/t/this.scaleX,r=this.knobSize/t/this.scaleY;e.scale(1/this.scaleX,1/this.scaleY),e.rotate(this.value*Math.PI/180),e.scale(this.scaleX,this.scaleY),e.drawImage(this.knobImageElement,-i/2,-r/2,i,r)}}catch(e){console.log("错误描述",e),toastr.warning("渲染旋钮出错")}}}),fabric.MyKnob.fromLevel=function(e,t,i){t&&t(new fabric.MyKnob(e,i))},fabric.MyKnob.prototype.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{backgroundImageElement:this.backgroundImageElement,knobImageElement:this.knobImageElement,backgroundColor:this.backgroundColor,knobColor:this.knobColor,value:this.value})}}(fabric.MyKnob.prototype.toObject),fabric.MyKnob.fromObject=function(e,t){var i=I.getLevelById(e.id);t&&t(new fabric.MyKnob(i,e))},fabric.MyKnob.async=!0,fabric.MySwitch=fabric.util.createClass(fabric.Object,{type:l.MySwitch,initialize:function(e,t){var r=this;this.callSuper("initialize",t),this.lockRotation=!0,this.hasRotatingPoint=!1,this.backgroundColor=e.texList[0].slices[0].color,this.bindBit=e.info.bindBit,this.imageElement=s.getResourceFromCache(e.texList[0].slices[0].imgSrc),this.imageElement&&(this.loaded=!0,this.setCoords(),this.fire("image:loaded")),this.on("changeTex",function(e){var t=e.level,n=e.callback,a=t.texList[0];r.backgroundColor=a.slices[0].color,r.imageElement=s.getResourceFromCache(t.texList[0].slices[0].imgSrc);var o=i.getSubLayerNode();o.renderAll(),n&&n()}),this.on("changeWidgetSize",function(e){var t=e.callback,n=e.widgetWidth||25,a=e.WidgetHeight||25;r.set({scaleX:1,scaleY:1,width:n,height:a});var o=i.getSubLayerNode();o.renderAll(),t&&t()})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"))},_render:function(e){try{e.fillStyle=this.backgroundColor,e.fillRect(-(this.width/2),-(this.height/2),this.width,this.height),this.imageElement&&e.drawImage(this.imageElement,-this.width/2,-this.height/2,this.width,this.height)}catch(e){console.log("错误描述",e),toastr.warning("渲染开关出错")}}}),fabric.MySwitch.fromLevel=function(e,t,i){t&&t(new fabric.MySwitch(e,i))},fabric.MySwitch.prototype.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{imageElement:this.imageElement,backgroundColor:this.backgroundColor})}}(fabric.MySwitch.prototype.toObject),fabric.MySwitch.fromObject=function(e,t){var i=I.getLevelById(e.id);t&&t(new fabric.MySwitch(i,e))},fabric.MySwitch.async=!0,fabric.MyScriptTrigger=fabric.util.createClass(fabric.Object,{type:l.MyScriptTrigger,initialize:function(e,t){this.callSuper("initialize",t),this.lockRotation=!0,this.hasRotatingPoint=!1},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"))},_render:function(e){}}),fabric.MyScriptTrigger.fromLevel=function(e,t,i){t&&t(new fabric.MyScriptTrigger(e,i))},fabric.MyScriptTrigger.prototype.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{})}}(fabric.MyScriptTrigger.prototype.toObject),fabric.MyScriptTrigger.fromObject=function(e,t){var i=I.getLevelById(e.id);t&&t(new fabric.MyScriptTrigger(i,e))},fabric.MyScriptTrigger.async=!0,fabric.MyRotateImg=fabric.util.createClass(fabric.Object,{type:l.MyRotateImg,initialize:function(e,t){var r=this;this.callSuper("initialize",t),this.lockRotation=!0,this.hasRotatingPoint=!1,this.backgroundColor=e.texList[0].slices[0].color,this.minValue=e.info.minValue,this.maxValue=e.info.maxValue,this.initValue=e.info.initValue,this.imageElement=s.getResourceFromCache(e.texList[0].slices[0].imgSrc),this.imageElement&&(this.loaded=!0,this.setCoords(),this.fire("image:loaded")),this.on("changeTex",function(e){var t=e.level,n=e.callback,a=t.texList[0];r.backgroundColor=a.slices[0].color,r.imageElement=s.getResourceFromCache(t.texList[0].slices[0].imgSrc);
var o=i.getSubLayerNode();o.renderAll(),n&&n()}),this.on("changeInitValue",function(e){var t=e.callback;r.initValue=e.initValue,r.setAngle(r.initValue);var n=i.getSubLayerNode();n.renderAll(),t&&t()})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"))},_render:function(e){try{e.fillStyle=this.backgroundColor,e.fillRect(-(this.width/2),-(this.height/2),this.width,this.height),this.imageElement&&e.drawImage(this.imageElement,-this.width/2,-this.height/2,this.width,this.height)}catch(e){console.log("错误描述",e),toastr.warning("渲染旋转图出错")}}}),fabric.MyRotateImg.fromLevel=function(e,t,i){t&&t(new fabric.MyRotateImg(e,i))},fabric.MyRotateImg.prototype.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{imageElement:this.imageElement,backgroundColor:this.backgroundColor})}}(fabric.MyRotateImg.prototype.toObject),fabric.MyRotateImg.fromObject=function(e,t){var i=I.getLevelById(e.id);t&&t(new fabric.MyRotateImg(i,e))},fabric.MyRotateImg.async=!0,fabric.MySlideBlock=fabric.util.createClass(fabric.Object,{type:l.MySlideBlock,initialize:function(e,t){var r=this;this.callSuper("initialize",t),this.lockRotation=!0,this.hasRotatingPoint=!1,this.minValue=e.info.minValue,this.maxValue=e.info.maxValue,this.initValue=e.info.initValue,this.arrange=e.info.arrange,this.backgroundColor=e.texList[0].slices[0].color,this.backgroundImageElement=s.getResourceFromCache(e.texList[0].slices[0].imgSrc),this.backgroundImageElement&&(this.loaded=!0,this.setCoords(),this.fire("image:loaded")),this.slideColor=e.texList[1].slices[0].color,this.slideImageElement=s.getResourceFromCache(e.texList[1].slices[0].imgSrc),this.slideImageElement&&(this.loaded=!0,this.setCoords(),this.fire("image:loaded")),this.on("changeTex",function(e){var t=e.level,n=e.callback;t.texList&&t.texList[0]&&(r.backgroundColor=t.texList[0].slices[0].color,r.backgroundImageElement=s.getResourceFromCache(t.texList[0].slices[0].imgSrc)),t.texList&&t.texList[1]&&(r.slideColor=t.texList[1].slices[0].color,r.slideImageElement=s.getResourceFromCache(t.texList[1].slices[0].imgSrc));var a=i.getSubLayerNode();a.renderAll(),n&&n()}),this.on("changeInitValue",function(e){var t=e.callback;console.log("haha",e),e.hasOwnProperty("minValue")&&(r.minValue=e.minValue),e.hasOwnProperty("maxValue")&&(r.maxValue=e.maxValue),e.hasOwnProperty("initValue")&&(r.initValue=e.initValue);var n=i.getSubLayerNode();n.renderAll(),t&&t()}),this.on("changeArrange",function(e){r.arrange=e.arrange;var t=e.callback,n=i.getSubLayerNode();n.renderAll(),t&&t()})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"))},_render:function(e){try{var t=(this.initValue-this.minValue)/(this.maxValue-this.minValue);e.fillStyle=this.backgroundColor,e.fillRect(-(this.width/2),-(this.height/2),this.width,this.height),this.backgroundImageElement&&e.drawImage(this.backgroundImageElement,-this.width/2,-this.height/2,this.width,this.height),this.slideImageElement&&("horizontal"==this.arrange?e.drawImage(this.slideImageElement,-this.width/2+(this.width-this.slideImageElement.width/this.scaleX)*t,-this.slideImageElement.height/(2*this.scaleY),this.slideImageElement.width/this.scaleX,this.slideImageElement.height/this.scaleY):e.drawImage(this.slideImageElement,-this.slideImageElement.width/(2*this.scaleX),this.height/2-this.slideImageElement.height/this.scaleY*(1-t)-this.height*t,this.slideImageElement.width/this.scaleX,this.slideImageElement.height/this.scaleY)),this.clipTo=function(e){e.save(),e.beginPath(),e.rect(-this.width/2,-this.height/2,this.width,this.height),e.closePath(),e.restore()}}catch(e){console.log("错误描述",e),toastr.warning("渲染滑块出错")}}}),fabric.MySlideBlock.fromLevel=function(e,t,i){t&&t(new fabric.MySlideBlock(e,i))},fabric.MySlideBlock.prototype.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{})}}(fabric.MySlideBlock.prototype.toObject),fabric.MySlideBlock.fromObject=function(e,t){var i=I.getLevelById(e.id);t&&t(new fabric.MySlideBlock(i,e))},fabric.MySlideBlock.async=!0,fabric.MyDateTime=fabric.util.createClass(fabric.Object,{type:l.MyDateTime,initialize:function(e,t){var r=this;this.callSuper("initialize",t);var n={bl:!1,br:!1,mb:!1,ml:!1,mr:!1,mt:!1,tl:!1,tr:!1};this.setControlsVisibility(n),this.lockRotation=!0,this.hasRotatingPoint=!1,this.dateTimeModeId=e.info.dateTimeModeId,this.fontFamily=e.info.fontFamily,this.fontSize=e.info.fontSize,this.fontColor=e.info.fontColor,this.align=e.info.align,this.initValue=e.info.initValue,this.setHeight(1.5*this.fontSize),"0"==this.dateTimeModeId?this.setWidth(4*this.fontSize):"1"==this.dateTimeModeId?this.setWidth(3*this.fontSize):this.setWidth(6*this.fontSize),this.on("changeDateTimeModeId",function(e){var t=e.dateTimeModeId,n=e.callback;r.dateTimeModeId=t,r.setHeight(1.5*r.fontSize),"0"==r.dateTimeModeId?r.setWidth(4*r.fontSize):"1"==r.dateTimeModeId?r.setWidth(3*r.fontSize):r.setWidth(6*r.fontSize);var a=i.getSubLayerNode();a.renderAll(),n&&n()}),this.on("changeDateTimeText",function(e){var t=e.callback;e.hasOwnProperty("fontFamily")&&(r.fontFamily=e.fontFamily),e.hasOwnProperty("fontSize")&&(r.fontSize=e.fontSize,r.setHeight(1.5*r.fontSize),"0"==r.dateTimeModeId?r.setWidth(4*r.fontSize):"1"==r.dateTimeModeId?r.setWidth(3*r.fontSize):r.setWidth(6*r.fontSize)),e.hasOwnProperty("fontColor")&&(r.fontColor=e.fontColor);var n=i.getSubLayerNode();n.renderAll(),t&&t()})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"))},_render:function(e){try{var t=null;t=this.fontSize+"px "+this.fontFamily,S(this.dateTimeModeId,e,this.scaleX,this.scaleY,t,this.align,this.fontColor)}catch(e){console.log("错误描述",e),toastr.warning("渲染时间日期出错")}}}),fabric.MyDateTime.fromLevel=function(e,t,i){t&&t(new fabric.MyDateTime(e,i))},fabric.MyDateTime.prototype.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{imageElement:this.imageElement,backgroundColor:this.backgroundColor})}}(fabric.MyDateTime.prototype.toObject),fabric.MyDateTime.fromObject=function(e,t){var i=I.getLevelById(e.id);t&&t(new fabric.MyDateTime(i,e))},fabric.MyDateTime.async=!0,fabric.MyButton=fabric.util.createClass(fabric.Object,{type:l.MyButton,initialize:function(e,t){var r=this;this.callSuper("initialize",t),this.lockRotation=!0,this.hasRotatingPoint=!1,this.normalColor=e.texList[0].slices[0].color,this.text=e.info.text,this.fontFamily=e.info.fontFamily,this.fontSize=e.info.fontSize,this.fontColor=e.info.fontColor,this.fontBold=e.info.fontBold,this.fontItalic=e.info.fontItalic,this.normalImageElement=s.getResourceFromCache(e.texList[0].slices[0].imgSrc),this.normalImageElement&&(this.loaded=!0,this.setCoords(),this.fire("image:loaded")),this.on("changeTex",function(e){var t=e.level,n=e.callback,a=t.texList[0];r.normalColor=a.slices[0].color,r.normalImageElement=s.getResourceFromCache(a.slices[0].imgSrc);var o=i.getSubLayerNode();o.renderAll(),n&&n()}),this.on("changeButtonText",function(e){e.hasOwnProperty("text")&&(r.text=e.text),e.fontFamily&&(r.fontFamily=e.fontFamily),e.fontBold&&(r.fontBold=e.fontBold),e.hasOwnProperty("fontItalic")&&(r.fontItalic=e.fontItalic),e.fontSize&&(r.fontSize=e.fontSize),e.fontColor&&(r.fontColor=e.fontColor);var t=e.callback,n=i.getSubLayerNode();n.renderAll(),t&&t()})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"))},_render:function(e){try{if(e.fillStyle=this.fontColor,e.save(),e.fillStyle=this.normalColor,e.fillRect(-(this.width/2),-(this.height/2),this.width,this.height),this.normalImageElement&&e.drawImage(this.normalImageElement,-this.width/2,-this.height/2,this.width,this.height),e.restore(),this.text){e.save();var t=this.fontItalic+" "+this.fontBold+" "+this.fontSize+"px "+this.fontFamily;e.scale(1/this.scaleX,1/this.scaleY),e.font=t,e.textAlign="center",e.textBaseline="middle",e.fillText(this.text,0,0),e.restore()}this.clipTo=function(e){e.save(),e.beginPath(),e.rect(-this.width/2,-this.height/2,this.width,this.height),e.closePath(),e.restore()}}catch(e){console.log("错误描述",e),toastr.warning("渲染按钮出错")}}}),fabric.MyButton.fromLevel=function(e,t,i){t&&t(new fabric.MyButton(e,i))},fabric.MyButton.prototype.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{normalImageElement:this.normalImageElement,normalColor:this.normalColor})}}(fabric.MyButton.prototype.toObject),fabric.MyButton.fromObject=function(e,t){var i=I.getLevelById(e.id);t&&t(new fabric.MyButton(i,e))},fabric.MyButton.async=!0,fabric.MyTextArea=fabric.util.createClass(fabric.Object,{type:l.MyTextArea,initialize:function(e,t){var r=this,n={bl:!1,br:!1,mb:!0,ml:!0,mr:!0,mt:!0,tl:!1,tr:!1};this.callSuper("initialize",t),this.lockRotation=!0,this.setControlsVisibility(n),this.hasRotatingPoint=!1,this.backgroundColor=e.texList[0].slices[0].color,this.text=e.info.text,this.fontFamily=e.info.fontFamily,this.fontSize=e.info.fontSize,this.fontColor=e.info.fontColor,this.fontBold=e.info.fontBold,this.fontItalic=e.info.fontItalic,this.fontUnderline=e.info.fontUnderline,this.text&&this.fontSize&&(this.setWidth(this.fontSize*(this.text.length+1)),this.setHeight(2*this.fontSize)),this.backgroundImageElement=s.getResourceFromCache(e.texList[0].slices[0].imgSrc),this.backgroundImageElement&&(this.loaded=!0,this.setCoords(),this.fire("image:loaded")),this.on("changeTex",function(e){var t=e.level,n=e.callback,a=t.texList[0];r.backgroundColor=a.slices[0].color,r.backgroundImageElement=s.getResourceFromCache(t.texList[0].slices[0].imgSrc);var o=i.getSubLayerNode();o.renderAll(),n&&n()}),this.on("changeTextContent",function(e){e.text&&(r.text=e.text),e.fontFamily&&(r.fontFamily=e.fontFamily),e.fontSize&&(r.fontSize=e.fontSize),e.fontColor&&(r.fontColor=e.fontColor),e.fontBold&&(r.fontBold=e.fontBold),e.hasOwnProperty("fontItalic")&&(r.fontItalic=e.fontItalic),r.fontSize&&r.text&&(r.setWidth(r.fontSize*(r.text.length+1)),r.setHeight(2*r.fontSize));var t=e.callback,n=i.getSubLayerNode();n.renderAll(),t&&t()})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"))},_render:function(e){try{if(e.fillStyle=this.fontColor,e.save(),e.fillStyle=this.backgroundColor,e.fillRect(-(this.width/2),-(this.height/2),this.width,this.height),this.backgroundImageElement&&e.drawImage(this.backgroundImageElement,-this.width/2,-this.height/2,this.width,this.height),e.restore(),this.text){var t=this.fontItalic+" "+this.fontBold+" "+this.fontSize+"px "+this.fontFamily;e.scale(1/this.scaleX,1/this.scaleY),e.font=t,e.textAlign="center",e.textBaseline="middle",e.fillText(this.text,0,0)}this.clipTo=function(e){e.save(),e.beginPath(),e.rect(-this.width/2,-this.height/2,this.width,this.height),e.closePath(),e.restore()}}catch(e){console.log("错误描述",e),toastr.warning("渲染文本出错")}}}),fabric.MyTextArea.fromLevel=function(e,t,i){t&&t(new fabric.MyTextArea(e,i))},fabric.MyTextArea.prototype.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{backgroundImageElement:this.backgroundImageElement,backgroundColor:this.backgroundColor})}}(fabric.MyTextArea.prototype.toObject),fabric.MyTextArea.fromObject=function(e,t){var i=I.getLevelById(e.id);t&&t(new fabric.MyTextArea(i,e))},fabric.MyTextArea.async=!0,fabric.MyNum=fabric.util.createClass(fabric.Object,{type:l.MyNum,initialize:function(e,t){var r=this,n={bl:!1,br:!1,mb:!1,ml:!1,mr:!1,mt:!1,tl:!1,tr:!1};this.callSuper("initialize",t),this.lockRotation=!0,this.setControlsVisibility(n),this.hasRotatingPoint=!1,this.backgroundColor=e.info.fontColor,this.numValue=e.info.numValue,this.fontFamily=e.info.fontFamily,this.fontSize=e.info.fontSize,this.fontColor=e.info.fontColor,this.fontBold=e.info.fontBold,this.fontItalic=e.info.fontItalic,this.align=e.info.align,this.numOfDigits=e.info.numOfDigits,this.decimalCount=e.info.decimalCount,this.symbolMode=e.info.symbolMode,this.fontZeroMode=e.info.frontZeroMode,this.numOfDigits&&this.fontSize&&(this.setWidth(this.numOfDigits*("0"==r.symbolMode?r.fontSize-3:r.fontSize)),this.setHeight(1.2*this.fontSize)),this.backgroundImageElement=s.getResourceFromCache(e.texList[0].slices[0].imgSrc),this.backgroundImageElement&&(this.loaded=!0,this.setCoords(),this.fire("image:loaded")),this.on("changeTex",function(e){var t=e.level,n=e.callback,a=t.texList[0];r.backgroundColor=a.slices[0].color,r.backgroundImageElement=s.getResourceFromCache(t.texList[0].slices[0].imgSrc);var o=i.getSubLayerNode();o.renderAll(),n&&n()}),this.on("changeNumContent",function(e){e.hasOwnProperty("numValue")&&(r.numValue=e.numValue),e.fontFamily&&(r.fontFamily=e.fontFamily),e.fontSize&&(r.fontSize=e.fontSize),e.fontBold&&(r.fontBold=e.fontBold),e.hasOwnProperty("fontItalic")&&(r.fontItalic=e.fontItalic),e.numOfDigits&&(r.numOfDigits=e.numOfDigits),e.hasOwnProperty("decimalCount")&&(r.decimalCount=e.decimalCount),e.symbolMode&&(r.symbolMode=e.symbolMode),e.frontZeroMode&&(r.frontZeroMode=e.frontZeroMode),e.align&&(r.align=e.align),e.fontColor&&(r.fontColor=e.fontColor),r.numOfDigits&&r.fontSize&&(r.setWidth(r.numOfDigits*("0"==r.symbolMode?r.fontSize-3:r.fontSize)),r.setHeight(1.2*r.fontSize));var t=e.callback,n=i.getSubLayerNode();n.renderAll(),t&&t()})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"))},_render:function(e){try{if(e.fillStyle=this.fontColor,!isNaN(this.numValue)){e.font=this.fontItalic+" "+this.fontBold+" "+this.fontSize+"px "+this.fontFamily,e.textAlign=this.align,e.textBaseline="middle";var t=!1;this.numValue<0&&(t=!0);var i=Math.abs(this.numValue);i=i.toString();var r=0;if(this.decimalCount)if(i.indexOf(".")!=-1){var n=i.split(".")[1];for(r=0;r<this.decimalCount-n.length;r++)i+="0"}else for(i+=".",r=0;r<this.decimalCount;r++)i+="0";if("1"==this.frontZeroMode){var a=this.numOfDigits-i.length;if(this.decimalCount)for(r=0;r<a+1;r++)i="0"+i;else for(r=0;r<a;r++)i="0"+i}"1"!=this.symbolMode||t?t&&(i="-"+i):i="+"+i,"center"==this.align?e.fillText(i,0,0):"left"==this.align?e.fillText(i,-this.width/2,0):"right"==this.align&&e.fillText(i,this.width/2,0)}}catch(e){console.log("错误描述",e),toastr.warning("渲染数字出错")}}}),fabric.MyNum.fromLevel=function(e,t,i){t&&t(new fabric.MyNum(e,i))},fabric.MyNum.prototype.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{backgroundImageElement:this.backgroundImageElement,backgroundColor:this.backgroundColor})}}(fabric.MyNum.prototype.toObject),fabric.MyNum.fromObject=function(e,t){var i=I.getLevelById(e.id);t&&t(new fabric.MyNum(i,e))},fabric.MyNum.async=!0,fabric.MyButtonGroup=fabric.util.createClass(fabric.Object,{type:l.MyButtonGroup,initialize:function(e,t){var r=this;this.callSuper("initialize",t),this.lockRotation=!0,this.hasRotatingPoint=!1,r.interval=e.info.interval,r.arrange=e.info.arrange,r.normalColors=[],r.normalImageElements=[];for(var n=0;n<e.texList.length-1;n++)r.normalColors.push(e.texList[n].slices[0].color),r.normalImageElements.push(s.getResourceFromCache(e.texList[n].slices[0].imgSrc));this.on("changeArrange",function(e){r.arrange=e.arrange;var t=e.callback,n=i.getSubLayerNode();n.renderAll(),t&&t()}),this.on("changeInterval",function(e){r.interval=e.interval;var t=e.callback,n=i.getSubLayerNode();n.renderAll(),t&&t()}),this.on("changeTex",function(e){var t=e.level,n=e.callback;r.normalColors=[],r.normalImageElements=[];for(var a=0;a<t.texList.length-1;a++)r.normalColors.push(t.texList[a].slices[0].color),r.normalImageElements.push(s.getResourceFromCache(t.texList[a].slices[0].imgSrc));var o=i.getSubLayerNode();o.renderAll(),n&&n()})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"))},_render:function(e){try{var t=this.normalColors.length;if("horizontal"==this.arrange){var i=(this.width-this.interval*(t-1))/t,r=this.height,n=this.interval;if(i<0)return;for(var a=0;a<this.normalColors.length;a++)e.fillStyle=this.normalColors[a],e.fillRect(-(this.width/2)+(i+n)*a,-(this.height/2),i,r);for(var a=0;a<this.normalImageElements.length;a++){var o=this.normalImageElements[a];o&&e.drawImage(o,-this.width/2+(i+n)*a,-this.height/2,i,r)}}else{var r=(this.height-this.interval*(t-1))/t,i=this.width,n=this.interval;if(r<0)return;for(var a=0;a<this.normalColors.length;a++){e.fillStyle=this.normalColors[a],e.fillRect(-(this.width/2),-(this.height/2)+(r+n)*a,i,r);var o=this.normalImageElements[a];o&&e.drawImage(o,-this.width/2,-this.height/2+(r+n)*a,i,r)}}}catch(e){console.log("错误描述",e),toastr.warning("渲染按钮组出错")}}}),fabric.MyButtonGroup.fromLevel=function(e,t,i){t&&t(new fabric.MyButtonGroup(e,i))},fabric.MyButtonGroup.prototype.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{normalImageElements:this.normalImageElements,normalColors:this.normalColors,interval:this.interval,arrange:this.arrange})}}(fabric.MyButtonGroup.prototype.toObject),fabric.MyButtonGroup.fromObject=function(e,t){var i=I.getLevelById(e.id);t&&t(new fabric.MyButtonGroup(i,e))},fabric.MyButtonGroup.async=!0,fabric.MyNumber=fabric.util.createClass(fabric.Object,{type:l.MyNumber,initialize:function(e,t){var r=this;this.callSuper("initialize",t),this.lockRotation=!0,this.hasRotatingPoint=!1,this.myNumber=e.info.initValue+"",this.numberBackColors=[],this.numberImageElements=[];for(var a=0;a<13;a++)if(e.texList[a]){var o=e.texList[a];r.numberBackColors.push(o.slices[0].color);var l=new Image;o.slices[0].imgSrc?l.src=o.slices[0].imgSrc:l.src=n.NUMBER_IMAGES[a],l.onload=function(){}.bind(this),r.numberImageElements.push(l)}else{r.numberBackColors.push(n.WHITE_COLOR);var l=new Image;l.src=n.NUMBER_IMAGES[a],l.onload=function(){}.bind(this),r.numberImageElements.push(l)}this.on("changeNumber",function(e,t){r.myNumber=e.info.initValue+"",this.width=e.info.width,this.height=e.info.height;var n=i.getSubLayerNode();n.renderAll(),t&&t()}),this.on("changeTex",function(e){var t=e.level,a=e.callback;r.numberBackColors=[],r.numberImageElements=[];for(var o=0;o<13;o++)if(t.texList[o]){var l=t.texList[o];r.numberBackColors.push(l.slices[0].color);var s=new Image;l.slices[0].imgSrc?s.src=l.slices[0].imgSrc:s.src=n.NUMBER_IMAGES[o],s.onload=function(){}.bind(this),r.numberImageElements.push(s)}else{r.numberBackColors.push(n.WHITE_COLOR);var s=new Image;s.src=n.NUMBER_IMAGES[o],s.onload=function(){}.bind(this),r.numberImageElements.push(s)}var c=i.getSubLayerNode();c.renderAll(),a&&a()})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"))},_render:function(e){for(var t=this.myNumber.split(""),i=t.length,r=this.width/i,n=this.height,a=[],o=[],l=0;l<t.length;l++){var s=t[l];switch(s){case"0":a.push(this.numberBackColors[0]),o.push(this.numberImageElements[0]);break;case"1":a.push(this.numberBackColors[1]),o.push(this.numberImageElements[1]);break;case"2":a.push(this.numberBackColors[2]),o.push(this.numberImageElements[2]);break;case"3":a.push(this.numberBackColors[3]),o.push(this.numberImageElements[3]);break;case"4":a.push(this.numberBackColors[4]),o.push(this.numberImageElements[4]);break;case"5":a.push(this.numberBackColors[5]),o.push(this.numberImageElements[5]);break;case"6":a.push(this.numberBackColors[6]),o.push(this.numberImageElements[6]);break;case"7":a.push(this.numberBackColors[7]),o.push(this.numberImageElements[7]);break;case"8":a.push(this.numberBackColors[8]),o.push(this.numberImageElements[8]);break;case"9":a.push(this.numberBackColors[9]),o.push(this.numberImageElements[9]);break;case"+":a.push(this.numberBackColors[10]),o.push(this.numberImageElements[10]);break;case"-":a.push(this.numberBackColors[11]),o.push(this.numberImageElements[11]);break;case".":a.push(this.numberBackColors[12]),o.push(this.numberImageElements[12])}}for(var l=0;l<a.length;l++)e.fillStyle=a[l],e.fillRect(-(this.width/2)+r*l,-(this.height/2),r,n);for(var l=0;l<o.length;l++)e.fillStyle=o[l],e.drawImage(o[l],-(this.width/2)+r*l,-(this.height/2),r,n)}}),fabric.MyNumber.fromLevel=function(e,t,i){t&&t(new fabric.MyNumber(e,i))},fabric.MyNumber.prototype.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{numberImageElements:this.numberImageElements,numberBackColors:this.numberBackColors,myNumber:this.myNumber})}}(fabric.MyNumber.prototype.toObject),fabric.MyNumber.fromObject=function(e,t){var i=I.getLevelById(e.id);t&&t(new fabric.MyNumber(i,e))},fabric.MyNumber.async=!0,fabric.MyVideo=fabric.util.createClass(fabric.Object,{type:l.MyVideo,initialize:function(e,t){this.callSuper("initialize",t),this.lockRotation=!0,this.hasRotatingPoint=!1,this.backgroundColor=e.texList[0].slices[0].color},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"))},_render:function(e){try{e.fillStyle=this.backgroundColor,e.fillRect(-(this.width/2),-(this.height/2),this.width,this.height)}catch(e){console.log("错误描述",e),toastr.warning("渲染Slide出错")}}}),fabric.MyVideo.fromLevel=function(e,t,i){t&&t(new fabric.MyVideo(e,i))},fabric.MyVideo.prototype.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{backgroundColor:this.backgroundColor})}}(fabric.MyVideo.prototype.toObject),fabric.MyVideo.fromObject=function(e,t){var i=I.getLevelById(e.id);t&&t(new fabric.MyVideo(i,e))},fabric.MyVideo.async=!0,fabric.MySlide=fabric.util.createClass(fabric.Object,{type:l.MySlide,initialize:function(e,t){var r=this;this.callSuper("initialize",t),this.lockRotation=!0,this.hasRotatingPoint=!1;var n=e.texList[0];this.currentColor=n.slices[n.currentSliceIdx].color,this.currentImageElement=s.getResourceFromCache(n.slices[n.currentSliceIdx].imgSrc),this.currentImageElement&&(this.loaded=!0,this.setCoords(),this.fire("image:loaded")),this.on("changeTex",function(e){var t=e.level,n=e.callback,a=t.texList[0];r.currentColor=a.slices[a.currentSliceIdx].color,r.currentImageElement=s.getResourceFromCache(a.slices[a.currentSliceIdx].imgSrc);var o=i.getSubLayerNode();o.renderAll(),n&&n()})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"))},_render:function(e){try{e.fillStyle=this.currentColor,e.fillRect(-(this.width/2),-(this.height/2),this.width,this.height),this.currentImageElement&&e.drawImage(this.currentImageElement,-this.width/2,-this.height/2,this.width,this.height)}catch(e){console.log("错误描述",e),toastr.warning("渲染Slide出错")}}}),fabric.MySlide.fromLevel=function(e,t,i){t&&t(new fabric.MySlide(e,i))},fabric.MySlide.prototype.toObject=function(e){return function(){return fabric.util.object.extend(e.call(this),{currentColor:this.currentColor,currentImageElement:this.currentImageElement})}}(fabric.MySlide.prototype.toObject),fabric.MySlide.fromObject=function(e,t){var i=I.getLevelById(e.id);t&&t(new fabric.MySlide(i,e))},fabric.MySlide.async=!0;var L={},C={type:"",objects:[]};this.shearPlate={type:"",objects:[],mode:0,target:null};var w=this.shearPlate,O=!1;this.setRendering=function(e){O=e},this.isRendering=function(){return O},this.isEditingPage=function(){var e=I.getCurrentPage();return 0==e.mode};var x=this.getCurrentSelectObject=function(){var e="none",t=null,r=null,n=0,a=i.getPageNode(),o=i.getSubLayerNode();return _.forEach(L.pages,function(s){s.current&&(s.selected&&(e=l.MyPage,t=a,r=s,n=0),s.currentFabLayer&&s.currentFabLayer.type==l.MyLayerGroup&&(e=l.MyLayerGroup,t=a.getActiveGroup(),r={info:{left:t?Math.round(t.getLeft()):null,top:t?Math.round(t.getTop()):null}},n=0),_.forEach(s.layers,function(a){a.current&&(a.selected&&(e=l.MyLayer,t=s.currentFabLayer,r=a,n=0),_.forEach(a.subLayers,function(a){a.current&&(a.selected&&(e=l.MySubLayer,t=i.getSubLayerNode(),r=a,n=1),a.currentFabWidget&&a.currentFabWidget.type==l.MyWidgetGroup&&(e=l.MyWidgetGroup,t=o.getActiveGroup(),r={info:{left:t?Math.round(t.getLeft()):null,top:t?Math.round(t.getTop()):null}},n=1),_.forEach(a.widgets,function(i){i.current&&i.selected&&(e=A(i.id,!0).type,t=a.currentFabWidget,r=i,n=1)}))}))}))}),{type:e,target:t,level:r,mode:n}};this.saveProjectFromGlobal=function(e,t){function i(e,t){e==r?I.changeCurrentPageIndex(0,t):I.changeCurrentPageIndex(e,function(){i(e+1,t)},!0)}L=e,_.forEach(L.pages,function(e){_.forEach(e.layers,function(e){_.forEach(e.subLayers,function(t){t.id==e.showSubLayer.id&&(e.showSubLayer=t)})})});var r=L.pages.length;i(0,t)},this.getProjectTo=function(e,t){e.project=L,t&&t()},this.getProjectCopyTo=function(e,t){e.project=_.cloneDeep(L),t&&t()},this.getCurrentPage=function(){var e=null;return _.forEach(L.pages,function(t){t.current&&(e=t)}),e},this.getCurrentSubLayer=function(){var e=I.getCurrentPage(),t=null;return _.forEach(e.layers,function(e){e.current&&_.forEach(e.subLayers,function(e){e.current&&(t=e)})}),t};var M=this.getCurrentLayer=function(e){var t=e;t||(t=I.getCurrentPage());var i=null;return _.forEach(t.layers,function(e){e.current&&(i=e)}),i},k=this.getLevelById=function(e){var t=null;return _.forEach(L.pages,function(i){i.id==e&&(t=i),_.forEach(i.layers,function(i){i.id==e&&(t=i),_.forEach(i.subLayers,function(i){i.id==e&&(t=i),_.forEach(i.widgets,function(i){i.id==e&&(t=i)})})})}),t},E=(this.getResourceList=function(){return L.resourceList},this.getCurrentWidget=function(e){var t=W();if(t||(t=e),!t)return void console.warn("找不到SubLayer");var i=null;return _.forEach(t.widgets,function(e){e.current&&(i=e)}),i}),A=this.getFabricObject=function(e,t){var r;r=t?i.getSubLayerNode():i.getPageNode();var n=null;return _.forEach(r.getObjects(),function(t){t.id==e&&(n=t)}),n};this.getRequiredResourceNames=function(){var e=[];return _.forEach(L.pages,function(t){t.backgroundImage&&e.push(t.backgroundImage),_.forEach(t.layers,function(t){_.forEach(t.subLayers,function(t){t.backgroundImage&&e.push(t.backgroundImage),_.forEach(t.widgets,function(t){_.forEach(t.texList,function(t){_.forEach(t.slices,function(t){t.imgSrc&&e.push(t.imgSrc)})})})})})}),e},this.getRequiredTagNames=function(){var e=[];return _.forEach(L.pages,function(t){t.tag&&e.push(t.tag),_.forEach(t.layers,function(t){t.tag&&e.push(t.tag),_.forEach(t.subLayers,function(t){_.forEach(t.widgets,function(t){t.tag&&e.push(t.tag)})})})}),e};this.changeCurrentPageIndex=function(e,t,r){function n(){function n(e,t){if(e==l)t&&t();else{var i=o.layers[e];I.SyncSubLayerImage(i,i.showSubLayer,function(){n(e+1,t)})}}var a=i.getPageNode(),o=L.pages[e];if(!o)return void console.warn("找不到Page");z(e);var l=o.layers.length;a.setBackgroundImage(null,function(){a.loadFromJSON(o.proJsonStr,function(){r?n(0,function(){I.ScaleCanvas("page"),a.deactivateAll(),a.renderAll(),o.url=a.toDataURL({format:"jpeg",quality:"0.2"}),I.OnPageSelected(e,t,!0)}):(console.log("不更新layer"),I.ScaleCanvas("page"),a.renderAll(),o.url=a.toDataURL({format:"jpeg",quality:"0.2"}),I.OnPageSelected(e,t))})})}if(r)n();else if(e>=0){var a=I.getCurrentPage();if(a){var o=-1;_.forEach(L.pages,function(e,t){e.id==a.id&&(o=t)}),o!=e?(console.log("页面间切换"),1==a.mode?I.OnPageSelected(o,n,!0):I.OnPageSelected(e,function(){t&&t(!0)})):I.OnPageSelected(e,function(){t&&t(!0)},r)}else console.log("异常情况"),n()}},this.changeCurrentSubLayerIndex=function(e,t){if(e<0)return void console.warn("输入不合法");var r=(i.getSubLayerNode(),M()),n=(R(I.getCurrentPage().layers,r),r.subLayers[e]);return n?(r.showSubLayer=n,void I.SyncSubLayerImage(r,n,function(){var e=I.getCurrentSelectObject();e.target.fire("OnScaleRelease",e.target.id),e.target.fire("OnRelease",e.target.id),t&&t()})):void console.warn("找不到SubLayer")},this.shearPagePlateEnable=function(){return 0!=C.objects.length},this.shearPlateEnable=function(){if(0==w.objects.length)return!1;var e=x();I.getCurrentPage();return e.type==l.MyPage?w.type==l.MyLayer||w.type==l.MyGroup&&0==w.mode:e.type==l.MyLayer||e.type==l.MyGroup&&0==e.mode?w.type==l.MyLayer||w.type==l.MyGroup&&0==w.mode:e.type==l.MySubLayer?!!l.isWidget(w.type)||w.type==l.MyGroup&&1==w.mode:!!(l.isWidget(e.type)||e.type==l.MyGroup&&1==e.mode)&&(!!l.isWidget(w.type)||w.type==l.MyGroup&&1==w.mode)},this.AddNewPage=function(e,t){T(!0);var i=_.cloneDeep(e);console.log("newPage",i);var r=R(L.pages,I.getCurrentPage()),n=-1;r==L.pages.length-1?(L.pages.push(i),n=L.pages.length-1):(L.pages.splice(r+1,0,i),n=r+1),I.changeCurrentPageIndex(n,function(){u(),t&&t()},!0)},this.AddNewLayerInCurrentPage=function(e,t){var r=i.getPageNode();e.zIndex=r.getObjects().length;var n=I.getCurrentPage(),a={width:e.info.width,height:e.info.height,top:e.info.top,left:e.info.left,id:e.id,lockScalingFlip:!0,hasRotatingPoint:!1,shadow:{color:"rgba(0,0,0,0.4)",blur:2}};n.layers.push(e);var o=new fabric.MyLayer(e.id,a);r.add(o),r.renderAll.bind(r)(),e.info.width=o.getWidth(),e.info.height=o.getHeight(),n.currentFabLayer=o,r.renderAll.bind(r)(),I.currentFabLayerIdList=[],I.currentFabLayerIdList.push(e.id),I.OnLayerSelected(e,t)},this.AddNewSubLayerInCurrentLayer=function(e,t){var i=_.cloneDeep(e),r=M(),n=R(I.getCurrentPage().layers,r);r.subLayers.push(i);var a=r.subLayers.length-1;I.OnSubLayerSelected(n,a,t,!0)},this.AddNewWidgetInCurrentSubLayer=function(e,t){var r=i.getSubLayerNode(),a=W();e.zIndex=r.getObjects().length;var o={width:e.info.width,height:e.info.height,top:e.info.top,left:e.info.left,id:e.id,lockScalingFlip:!0,hasRotatingPoint:!1,shadow:{color:"rgba(0,0,0,0.4)",blur:2}};I.currentFabWidgetIdList=[],I.currentFabWidgetIdList.push(e.id);var s=function(i){a.proJsonStr=r.toJSON(),a.widgets.push(e),a.currentFabWidget=i,N(e,t)};e.type==l.MySlide?fabric.MySlide.fromLevel(e,function(t){I.currentFabWidgetIdList=[t.id],t.urls=e.subSlides,r.add(t),r.renderAll.bind(r)(),e.info.width=t.getWidth(),e.info.height=t.getHeight(),s(t)},o):e.type==l.MyProgress?(""==e.backgroundImg&&(e.backgroundImg=n.BLANK_LAYER_URL),""==e.progressImg&&(e.progressImg=n.BLANK_LAYER_URL),fabric.MyProgress.fromLevel(e,function(t){I.currentFabWidgetIdList=[t.id],t.backgroundUrl=e.backgroundImg,t.progressUrl=e.progressImg,r.add(t),r.renderAll(),r.renderAll.bind(r)(),e.info.width=t.getWidth(),e.info.height=t.getHeight(),s(t)},o)):e.type==l.MyDashboard?(""==e.backgroundImg&&(e.backgroundImg=n.BLANK_LAYER_URL),""==e.progressImg&&(e.progressImg=n.BLANK_LAYER_URL),fabric.MyDashboard.fromLevel(e,function(t){I.currentFabWidgetIdList=[t.id],t.backgroundUrl=e.backgroundImg,t.progressUrl=e.progressImg,r.add(t),r.renderAll(),r.renderAll.bind(r)(),e.info.width=t.getWidth(),e.info.height=t.getHeight(),s(t)},o)):e.type==l.MyButton?fabric.MyButton.fromLevel(e,function(t){I.currentFabWidgetIdList=[t.id],t.normalImg=e.backgroundImg,t.pressImg=e.progressImg,r.add(t),r.renderAll.bind(r)(),e.info.width=t.getWidth(),e.info.height=t.getHeight(),s(t)},o):e.type==l.MyButtonGroup?fabric.MyButtonGroup.fromLevel(e,function(t){I.currentFabWidgetIdList=[t.id],r.add(t),r.renderAll.bind(r)(),e.info.width=t.getWidth(),e.info.height=t.getHeight(),s(t)},o):e.type==l.MyNumber?fabric.MyNumber.fromLevel(e,function(t){I.currentFabWidgetIdList=[t.id],r.add(t),r.renderAll.bind(r)(),e.info.width=t.getWidth(),e.info.height=t.getHeight(),s(t)},o):e.type==l.MyTextArea?fabric.MyTextArea.fromLevel(e,function(t){I.currentFabWidgetIdList=[t.id],r.add(t),r.renderAll.bind(r)(),e.info.width=t.getWidth(),e.info.height=t.getHeight(),s(t)},o):e.type==l.MyNum?fabric.MyNum.fromLevel(e,function(t){I.currentFabWidgetIdList=[t.id],r.add(t),r.renderAll(),r.renderAll.bind(r)(),e.info.width=t.getWidth(),e.info.height=t.getHeight(),s(t)},o):e.type==l.MyKnob?(""==e.backgroundImg&&(e.backgroundImg=n.BLANK_LAYER_URL),""==e.knobImg&&(e.knobImg=n.BLANK_LAYER_URL),fabric.MyKnob.fromLevel(e,function(t){I.currentFabWidgetIdList=[t.id],t.backgroundUrl=e.backgroundImg,t.knobUrl=e.KnobImg,r.add(t),r.renderAll(),r.renderAll.bind(r)(),e.info.width=t.getWidth(),e.info.height=t.getHeight(),s(t)},o)):e.type==l.MyOscilloscope?(""==e.backgroundImg&&(e.backgroundImg=n.BLANK_LAYER_URL),""==e.oscillationImg&&(e.oscillationImg=n.BLANK_LAYER_URL),fabric.MyOscilloscope.fromLevel(e,function(t){I.currentFabWidgetIdList=[t.id],t.backgroundUrl=e.backgroundImg,t.oscillationImg=e.oscillationImg,r.add(t),r.renderAll(),r.renderAll.bind(r)(),e.info.width=t.getWidth(),e.info.height=t.getHeight(),s(t)},o)):e.type==l.MySwitch?fabric.MySwitch.fromLevel(e,function(t){
I.currentFabWidgetIdList=[t.id],t.urls=e.subSlides,r.add(t),r.renderAll.bind(r)(),e.info.width=t.getWidth(),e.info.height=t.getHeight(),s(t)},o):e.type==l.MyRotateImg?fabric.MyRotateImg.fromLevel(e,function(t){I.currentFabWidgetIdList=[t.id],t.urls=e.subSlides,r.add(t),r.renderAll.bind(r)(),e.info.width=t.getWidth(),e.info.height=t.getHeight(),s(t)},o):e.type==l.MyDateTime?fabric.MyDateTime.fromLevel(e,function(t){I.currentFabWidgetIdList=[t.id],t.urls=e.subSlides,r.add(t),r.renderAll.bind(r)(),e.info.width=t.getWidth(),e.info.height=t.getHeight(),s(t)},o):e.type==l.MyScriptTrigger?fabric.MyScriptTrigger.fromLevel(e,function(t){I.currentFabWidgetIdList=[t.id],t.urls=e.subSlides,r.add(t),r.renderAll.bind(r)(),e.info.width=t.getWidth(),e.info.height=t.getHeight(),s(t)},o):e.type==l.MySlideBlock?fabric.MySlideBlock.fromLevel(e,function(t){I.currentFabWidgetIdList=[t.id],t.urls=e.subSlides,r.add(t),r.renderAll.bind(r)(),e.info.width=t.getWidth(),e.info.height=t.getHeight(),s(t)},o):e.type==l.MyVideo&&fabric.MyVideo.fromLevel(e,function(t){I.currentFabLayerIdList=[t.id],t.urls=e.subSlides,r.add(t),r.renderAll.bind(r)(),e.info.width=t.getWidth(),e.info.height=t.getHeight(),s(t)},o)},this.BindPageTree=function(e,t){var i,r,n,a;return{dragStart:function(t){i=J(),r=t.source.index,e(t)},dropped:function(e){n=e.dest.index,n!=r&&(a=J()),t(e,a)}}},this.DeletePageByIndex=function(e,t){var i=-1;if(0==e&&1==L.pages.length){L.pages=[];var r=a.getRandomPage();L.pages.push(r),i=0}else 0==e?(L.pages.shift(),i=0):(L.pages.splice(e,1),i=e-1);u(),I.changeCurrentPageIndex(i,t)},this.DeleteActiveLayers=function(e){function t(e){for(var t=I.getCurrentPage().layers,i=0;i<t.length;i++){var r=t[i];r.id==e.id&&t.splice(i,1)}}var r=i.getPageNode(),n=I.getCurrentPage(),a=R(L.pages,n),o=r.getActiveGroup(),l=r.getActiveObject();o&&o.objects.length>0?(_.forEach(o.getObjects(),function(e){r.fxRemove(e,{onComplete:function(){t(e)}})}),r.fxRemove(o,{onComplete:function(){r.deactivateAll(),r.renderAll(),I.OnPageSelected(a,e)}})):l&&r.fxRemove(l,{onComplete:function(){t(l),I.OnPageSelected(a,e)}})},this.DeleteCurrentSubLayer=function(e){var t=I.getCurrentLayer(),i=I.getCurrentSubLayer(),r=(R(L.pages,I.getCurrentPage()),-1);if(_.forEach(t.subLayers,function(e,t){e.id==i.id&&(r=t)}),r<0)return void console.warn("找不到SubLayer");var n=t.showSubLayer.id==i.id;if(n)if(t.subLayers.length>1){var o=t.subLayers[0];t.showSubLayer=o,I.SyncSubLayerImage(t,o,function(){I.OnLayerSelected(t,function(){t.subLayers.splice(r,1),e&&e()})})}else{var l=a.getDefaultSubLayer();t.subLayers.push(l),t.showSubLayer=l,I.SyncSubLayerImage(t,l,function(){I.OnLayerSelected(t,function(){t.subLayers.splice(r,1),e&&e()})})}else I.OnLayerSelected(t,function(){t.subLayers.splice(r,1),e&&e()})},this.DeleteActiveWidgets=function(e){function t(e){for(var t=I.getCurrentSubLayer().widgets,i=0;i<t.length;i++){var r=t[i];r.id==e.id&&t.splice(i,1)}}var r=i.getSubLayerNode(),n=I.getCurrentSubLayer(),a=I.getCurrentPage(),o=I.getCurrentLayer(),l=R(a.layers,o),s=R(o.subLayers,n),c=r.getActiveGroup(),h=r.getActiveObject();c&&c.objects.length>0?(_.forEach(c.getObjects(),function(e){r.fxRemove(e,{onComplete:function(){t(e)}})}),r.fxRemove(c,{onComplete:function(){r.deactivateAll(),r.renderAll(),n.proJsonStr=JSON.stringify(r.toJSON()),I.OnSubLayerSelected(l,s,e)}})):h&&r.fxRemove(h,{onComplete:function(){t(h),I.OnSubLayerSelected(l,s,e)}})},this.MoveActiveObjects=function(e,t,r,n){var a,o=!0;if("layers"===e)a=i.getPageNode();else{if("widgets"!==e)return;a=i.getSubLayerNode(),o=!1}var l=a.getActiveGroup(),s=a.getActiveObject();r=r||0;var c=0,h=0;switch(t){case"up":h=0-r;break;case"down":h=r;break;case"left":c=0-r;break;case"right":c=r}var g,u;if(l&&l.objects.length>0?(g=l.get("left")+c,u=l.get("top")+h,l.set("left",g),l.set("top",u)):s&&(g=s.get("left")+c,u=s.get("top")+h,s.set("left",g),s.set("top",u)),a.renderAll(),o){var d=I.getCurrentLayer();if(d){var f=I.getFabricObject(d.id);f&&I.SyncLevelFromFab(d,f)}}else{var b=I.getCurrentWidget();if(b){var m=I.getFabricObject(b.id,!0);m&&I.SyncLevelFromFab(b,m)}}I.UpdateCurrentThumb(),n&&n()},this.CopyPageByIndex=function(e,t){I.OnPageSelected(e,function(){C={type:l.MyPage,objects:[L.pages[e]]},t&&t()},!0)},this.CopyLayer=function(e,t){var i=I.getFabricObject(e.id);w={type:l.MyLayer,objects:[e],mode:0,target:i},toastr.info("复制成功"),t&&t()},this.CopyWidget=function(e,t){var i=g(e),r=I.getFabricObject(e.id,!0);w={type:e.type,objects:[i],mode:0,target:r},toastr.info("复制成功"),t&&t()},this.CopyLayerGroup=function(e,t){var i=R(L.pages,I.getCurrentPage()),r=_.cloneDeep(e);I.OnPageSelected(i,function(){var i=I.getCurrentPage().layers;_.forEach(i,function(e){V(e,I.getFabricObject(e.id))}),I.OnLayerGroupSelected(d(r),function(){var i=[],r=e;_.forEach(e.getObjects(),function(e){var t=_.cloneDeep(I.getLevelById(e.id));return t?void i.push(t):void console.warn("layer不存在")}),w={type:l.MyLayerGroup,objects:i,mode:0,target:r},toastr.info("复制成功"),t&&t()})})},this.CopyWidgetGroup=function(e,t){var i=R(I.getCurrentPage().layers,I.getCurrentLayer()),r=R(I.getCurrentLayer().subLayers,I.getCurrentSubLayer()),n=_.cloneDeep(e);I.OnSubLayerSelected(i,r,function(){var i=I.getCurrentSubLayer().widgets;_.forEach(i,function(e){V(e,I.getFabricObject(e.id,!0))}),I.OnWidgetGroupSelected(d(n,!0),function(){var i=[],r=e;_.forEach(e.getObjects(),function(e){var t=_.cloneDeep(I.getLevelById(e.id));return e.id=t.id,t?void i.push(t):void console.warn("layer不存在")}),w={type:l.MyWidgetGroup,objects:i,mode:1,target:r},toastr.info("复制成功"),t&&t()})})},this.DoPaste=function(e){function t(e,i){var n=c(w.objects[e]);n.$$hashKey=void 0,I.AddNewLayerInCurrentPage(n,function(n){return r.push(n),e==w.objects.length-1?void(i&&i()):void t(e+1,i)})}function i(e,t){var r=g(w.objects[e]);r.$$hashKey=void 0,I.AddNewWidgetInCurrentSubLayer(r,function(r){return n.push(r),e==w.objects.length-1?void(t&&t()):void i(e+1,t)})}var r=[],n=[];if(w.type==l.MyLayer){var a=c(w.objects[0]);a.$$hashKey=void 0,I.AddNewLayerInCurrentPage(a,e)}else if(w.type==l.MyGroup&&0==w.mode)t(0,function(){I.OnLayerGroupSelected(new fabric.Group(r),e,!0)});else if(l.isWidget(w.type)){var o=g(w.objects[0]);o.$$hashKey=void 0,I.AddNewWidgetInCurrentSubLayer(o,e)}else w.type==l.MyGroup&&1==w.mode&&i(0,function(){I.OnWidgetGroupSelected(new fabric.Group(n),e)})},this.PastePageByIndex=function(e){if(C.type!=l.MyPage)return void console.warn("当前剪切板中不是页面");var t=h(C.objects[0]);console.log("pastePage",t),t.id=Math.random().toString(36).substr(2),t.$$hashKey=void 0,this.AddNewPage(t,function(){e&&e()})},this.HoldObject=function(e,t){e.holdOperate=J(),t&&t()};var P={scaling:!1,objId:""};this.ScaleLayer=function(e,t){P.scaling=!0,P.objId=x().level.id;M();e.holdOperate=J(),t&&t()},this.ReleaseObject=function(e,t){var r=x();if(P.scaling&&(P.scaling=!1,P.objId="",r.type==l.MyLayer&&I.SyncSubLayerImage(r.level,r.level.showSubLayer,function(){r.target.fire("OnScaleRelease",r.target.id)})),r.type==l.MyLayer?r.target.fire("OnRelease",r.target.id):r.type==l.MyGroup&&0==r.mode?_.forEach(r.target.getObjects(),function(e){var t=A(e.id);t.fire("OnRelease",t.id)}):l.isWidget(r.type)?r.target.fire("OnRelease",r.target.id):r.type==l.MyGroup&&1==r.mode&&_.forEach(r.target.getObjects(),function(e){var t=A(e.id,!0);t.fire("OnRelease",t.id)}),e.holdOperate){var n=I.getCurrentPage();if(!n)return void console.warn("找不到Page");n.proJsonStr=JSON.stringify(i.getPageNode().toJSON());var a=I.getCurrentSubLayer();a&&(a.proJsonStr=JSON.stringify(i.getSubLayerNode().toJSON())),t&&t()}},this.SaveCurrentOperate=function(){var e=(I.getCurrentPage(),i.getPageNode(),I.getCurrentSubLayer());if(e){i.getSubLayerNode()}return _.cloneDeep(L)},this.LoadCurrentOperate=function(e,t,r){L=e,u();i.getPageNode(),i.getSubLayerNode();_.forEach(L.pages,function(e,i){if(e.current){if(e.selected)return void I.OnPageSelected(i,t,!0,!1,r);if(e.currentFabLayer&&e.currentFabLayer.type!=l.MyLayer)return void I.OnLayerGroupSelected(d(e.currentFabLayer),t,!0);_.forEach(e.layers,function(e,i){if(e.current){if(e.selected)return void I.OnLayerSelected(e,t,!0);_.forEach(e.subLayers,function(e,r){if(e.current){if(e.selected)return void I.OnSubLayerSelected(i,r,t,!0);if(!l.isWidget(e.currentFabWidget.type))return void I.OnWidgetGroupSelected(d(e.currentFabWidget,!0),t,!0);_.forEach(e.widgets,function(e){e.current&&e.selected&&I.OnWidgetSelected(e,t,!0)})}})}})}})},this.OnPageClicked=function(e,t,i){return e<0?void console.warn("找不到Page"):(i||(I.currentFabLayerIdList=[]),I.currentFabWidgetIdList=[],_.forEach(L.pages,function(t,i){i!=e?(t.selected=!1,t.current=!1):(t.selected=!0,t.current=!0,t.currentFabLayer=null),_.forEach(t.layers,function(e){e.selected=!1,e.current=!1,_.forEach(e.subLayers,function(e){e.selected=!1,e.current=!1,e.currentFabWidget=null,_.forEach(e.widgets,function(t){t.selected=!1,e.current=!1})})})}),void(t&&t()))},this.OnPageSelected=function(e,t,r,n,a){var o=L.pages[e];if(o||(o=I.getCurrentPage()),!o)return void console.warn("找不到Page");var l=!1;I.getCurrentPage()?I.getCurrentPage()&&I.getCurrentPage().id==o.id&&(l=!0):l=!0;var s=i.getPageNode();0==o.mode&&l&&!r?(I.OnPageClicked(e,null,n),s.deactivateAll(),s.renderAll(),o.proJsonStr=s.toJSON(),o.url=s.toDataURL({format:"jpeg",quality:"0.2"}),t&&t()):1==o.mode?F(o,function(){I.OnPageClicked(e,null,n),s.deactivateAll(),s.renderAll(),o.proJsonStr=s.toJSON(),o.mode=0,o.url=s.toDataURL({format:"jpeg",quality:"0.2"}),t&&t()}):s.setBackgroundImage(null,function(){s.loadFromJSON(o.proJsonStr,function(){I.OnPageClicked(e,null,n),s.deactivateAll(),s.renderAll(),o.proJsonStr=s.toJSON(),o.mode=0,o.url=s.toDataURL({format:"jpeg",quality:"0.2"}),t&&t()})})},this.currentFabLayerIdList=[],this.currentFabWidgetIdList=[],this.OnLayerClicked=function(e,t){I.currentFabWidgetIdList=[];var i=I.getCurrentPage();return i?(i.selected=!1,_.forEach(i.layers,function(t){if(e.id==t.id)t.current=!0,t.selected=!0,i.currentFabLayer=e,e.hasControls=!0,V(t,e);else if(f(t,e)){e.lockScalingX=!0,e.lockScalingY=!0,t.current=!1,t.selected=!0,i.currentFabLayer=e;var r=n.GROUP_CONTROL_VISIBLE;e.setControlsVisibility(r)}else t.current=!1,t.selected=!1;_.forEach(t.subLayers,function(e){e.selected=!1,e.current=!1,e.currentFabWidget=null,_.forEach(e.widgets,function(t){t.selected=!1,e.current=!1})})}),void(t&&t())):void console.warn("找不到Page")},this.OnLayerMultiSelected=function(e){var t=I.currentFabLayerIdList,r=i.getPageNode(),n=R(L.pages,I.getCurrentPage());t.length>1?I.OnPageSelected(n,function(){var i=[];r.forEachObject(function(e){R(t,e.id)>=0&&i.push(e)}),i.length!=t.length&&console.warn("数据不一致");var n=new fabric.Group(i,{canvas:r});I.OnLayerGroupSelected(n,e,!1)},!1,!0):1==t.length?I.OnPageSelected(n,function(){I.OnLayerSelected(I.getLevelById(t[0]),e,!1)},!1,!0):console.warn("currentFabLayerIdList为空")},this.OnLayerDoubleClicked=function(e,t){var i=I.getCurrentPage(),r=R(L.pages,i),n=I.getLevelById(e),a=R(i.layers,n),o=-1;_.forEach(n.subLayers,function(e,t){e.id==n.showSubLayer.id&&(o=t)}),I.OnPageSelected(r,function(){I.OnSubLayerSelected(a,o,t,!0)})},this.OnWidgetMultiSelected=function(e){var t=I.currentFabWidgetIdList,r=i.getSubLayerNode(),n=R(I.getCurrentPage().layers,I.getCurrentLayer()),a=R(I.getCurrentLayer().subLayers,I.getCurrentSubLayer());t.length>1?I.OnSubLayerSelected(n,a,function(){var i=[];r.forEachObject(function(e){R(t,e.id)>=0&&i.push(e)}),i.length!=t.length&&console.warn("数据不一致");var n=new fabric.Group(i,{canvas:r});I.OnWidgetGroupSelected(n,e,!1)},!1,!0):1==t.length?I.OnSubLayerSelected(n,a,function(){I.OnWidgetSelected(I.getLevelById(t[0]),e,!1)},!1,!0):console.warn("currentFabWidgetList为空")},this.OnLayerGroupSelected=function(e,t,r,n){var a=I.getCurrentPage();if(!a)return void console.warn("找不到Page");var o=i.getPageNode();if(0!=a.mode||r)F(a,function(){a.currentFabLayer=e;var i=d(a.currentFabLayer);o.setActive(i),a.currentFabLayer=_.cloneDeep(i),o.renderAll(),a.proJsonStr=JSON.stringify(o.toJSON()),a.mode=0,a.url=o.toDataURL({format:"jpeg",quality:"0.2"}),t&&t()});else{a.currentFabLayer=e;var l=a.currentFabLayer;o.setActive(l),a.currentFabLayer=_.cloneDeep(l),o.renderAll(),a.proJsonStr=JSON.stringify(o.toJSON()),a.url=o.toDataURL({format:"jpeg",quality:"0.2"}),t&&t()}},this.OnLayerSelected=function(e,t,r,n){var a=I.getCurrentPage();if(!a)return void console.warn("找不到Page");var o=i.getPageNode();if(0!=a.mode||r)F(a,function(){a.currentFabLayer=A(e.id);var i=a.currentFabLayer;o.deactivateAll(),o.renderAll(),o.setActive(i),a.currentFabLayer=_.cloneDeep(i),o.renderAll(),a.proJsonStr=JSON.stringify(o.toJSON()),a.mode=0,a.url=o.toDataURL({format:"jpeg",quality:"0.2"}),I.SyncSubLayerImage(e,e.showSubLayer,function(){t&&t(i)})});else{o.deactivateAll(),o.renderAll(),a.currentFabLayer=n?n:A(e.id);var l=a.currentFabLayer;o.setActive(l),a.currentFabLayer=_.cloneDeep(l),o.renderAll(),a.proJsonStr=JSON.stringify(o.toJSON()),a.url=o.toDataURL({format:"jpeg",quality:"0.2"}),I.SyncSubLayerImage(e,e.showSubLayer,function(){t&&t(l)})}},this.OnSubLayerClicked=function(e,t,i){I.currentFabLayerIdList=[];var r=I.getCurrentPage(),n=r.layers[e],a=n.subLayers[t];r.selected=!1,_.forEach(r.layers,function(i,r){e>=0&&(r==e?(i.current=!0,i.selected=!1,n=i):(i.current=!1,i.selected=!1)),_.forEach(i.subLayers,function(i,n){t>=0&&(n==t&&r==e?(i.current=!0,i.selected=!0,a=i,a.currentFabWidget=null):(i.current=!1,i.selected=!1)),_.forEach(i.widgets,function(e){e.current=!1,e.selected=!1})})}),i&&i()},this.OnSubLayerSelected=function(e,t,r,n){var a=I.getCurrentPage();if(!a)return void console.warn("找不到Page");1==a.mode&&B(I.getCurrentSubLayer());try{var o=a.layers[e]}catch(e){console.log(e)}var l=o.subLayers[t];if(!l)return void console.warn("找不到SubLayer");p(o.info.width,o.info.height,o.info.left,o.info.top);var s=!1;W()&&W().id==l.id&&(s=!0),D(e,t);var c=i.getSubLayerNode();A(o.id);1==a.mode&&s&&!n?(I.ScaleCanvas("subCanvas",o),c.deactivateAll(),c.renderAll(),l.proJsonStr=JSON.stringify(c.toJSON()),r&&r()):(c.clear(),c.setBackgroundImage(null,function(){c.loadFromJSON(l.proJsonStr,function(){I.ScaleCanvas("subCanvas",o),c.deactivateAll(),c.renderAll(),l.proJsonStr=JSON.stringify(c.toJSON()),a.mode=1,j=!1,r&&r()})}))};var j=!1;this.SyncSubLayerImage=function(e,t,r){if(!j){j=!0;var n=i.getSubLayerNode(),a=t,o=e;o.showSubLayer.backgroundImage&&""!=o.showSubLayer.backgroundImage?(n.clear(),n.loadFromJSON(o.showSubLayer.proJsonStr,function(){I.ScaleCanvas("subCanvas",o),n.setBackgroundImage(o.showSubLayer.backgroundImage,function(){n.deactivateAll(),n.renderAll(),a.proJsonStr=n.toJSON(),a.url=n.toDataURL({format:"png"}),j=!1,r&&r()},{width:o.info.width,height:o.info.height})})):n.setBackgroundImage(null,function(){n.setBackgroundColor(o.showSubLayer.backgroundColor,function(){n.loadFromJSON(o.showSubLayer.proJsonStr,function(){I.ScaleCanvas("subCanvas",o),n.deactivateAll(),n.renderAll(),a.proJsonStr=n.toJSON(),a.url=n.toDataURL({format:"png"}),j=!1,r&&r()})})})}},this.OnWidgetClicked=function(e,t){I.currentFabLayerIdList=[];var i=I.getCurrentPage();return i.selected=!1,i?(i.selected=!1,_.forEach(i.layers,function(t){t.current=!1,t.selected=!1,_.forEach(t.subLayers,function(i){i.selected=!1,i.current=!1,_.forEach(i.widgets,function(r){if(r.id==e.id)r.selected=!0,r.current=!0,i.current=!0,i.currentFabWidget=_.cloneDeep(e),t.current=!0,e.hasControls=!0,V(r,e);else if(f(r,e)){r.selected=!0,r.current=!1,i.current=!0,t.current=!0,i.currentFabWidget=_.cloneDeep(e);var a=n.GROUP_CONTROL_VISIBLE;e.setControlsVisibility(a)}else r.selected=!1,r.current=!1})})}),void(t&&t())):void console.warn("找不到Page")};var N=this.OnWidgetSelected=function(e,t,r,n){var a=I.getCurrentPage();1==a.mode;var o=null,l=null;if(_.forEach(a.layers,function(t){_.forEach(t.subLayers,function(i){_.forEach(i.widgets,function(r){r.id==e.id&&(o=i,l=t)})})}),!a)return void console.warn("找不到Page");if(!o)return void console.warn("找不到SubLayer");var s=!1;W()&&W().id==o.id&&(s=!0);var c=i.getSubLayerNode();if(1==a.mode&&s&&!r){I.ScaleCanvas("subCanvas",l),c.deactivateAll(),c.renderAll(),o.currentFabWidget=n?n:A(e.id,!0);var h=o.currentFabWidget;c.setActive(h),o.currentFabWidget=_.cloneDeep(h),o.proJsonStr=JSON.stringify(c.toJSON()),c.renderAll(),t&&t(h)}else c.clear(),c.setBackgroundImage(null,function(){c.loadFromJSON(o.proJsonStr,function(){I.ScaleCanvas("subCanvas",l),c.deactivateAll(),c.renderAll(),o.currentFabWidget=A(e.id,!0);var i=o.currentFabWidget;c.setActive(i),o.currentFabWidget=_.cloneDeep(i),o.proJsonStr=JSON.stringify(c.toJSON()),c.renderAll(),a.mode=1,t&&t(i)})})};this.OnWidgetGroupSelected=function(e,t,r){var n=I.getCurrentPage(),a=I.getCurrentSubLayer(),o=i.getSubLayerNode();if(1!=n.mode||r)o.clear(),o.setBackgroundImage(null,function(){o.loadFromJSON(a.proJsonStr,function(){o.renderAll(),a.currentFabwidget=e;var i=d(a.currentFabwidget,!0);o.setActive(i),a.currentFabwidget=_.cloneDeep(i),o.renderAll(),n.mode=1,a.proJsonStr=JSON.stringify(o.toJSON()),a.url=o.toDataURL({format:"png"}),t&&t()})});else{a.currentFabwidget=e;var l=a.currentFabwidget;o.setActive(l),a.currentFabwidget=_.cloneDeep(l),o.renderAll(),a.proJsonStr=JSON.stringify(o.toJSON()),a.url=o.toDataURL({format:"png"}),t&&t()}},this.OnSelectAll=function(e){if(I.isEditingPage()){var t=i.getPageNode(),r=I.getCurrentPage(),n=t.getObjects();if(0==n.length)return;if(1==n.length)I.OnLayerSelected(r.layers[0],e);else{var a=new fabric.Group(n,{originX:"left",originY:"top"});I.OnLayerGroupSelected(a,e)}}else{var o=i.getSubLayerNode(),l=I.getCurrentSubLayer(),s=o.getObjects();if(0==s.length);else if(1==s.length)I.OnWidgetSelected(l.widgets[0],e);else{var a=new fabric.Group(s,{originX:"left",originY:"top"});I.OnWidgetGroupSelected(a,e)}}};var V=this.SyncLevelFromFab=function(e,t){var i=e.info.width,r=e.info.height;e.info.left,e.info.top;e.info.width=Math.abs(t.getWidth()-i)<=1?i:Math.round(t.getWidth()),e.info.height=Math.abs(t.getHeight()-r)<=1?r:Math.round(t.getHeight()),e.info.left=Math.round(t.getLeft()),e.info.top=Math.round(t.getTop()),e.type==l.MyButtonGroup&&("horizontal"==e.info.arrange?e.info.interval=e.info.intervalScale*t.getWidth():e.info.interval=e.info.intervalScale*t.getHeight())};this.UpdateCurrentThumb=function(e){var t=i.getPageNode(),r=I.getCurrentPage();r.url=t.toDataURL({format:"jpeg",quality:"0.2"}),e&&e()},this.updateCurrentThumbInPage=function(){var e=i.getSubLayerNode();return M()?void(M().url=e.toDataURL({format:"png"})):void console.warn("当前Layer为空")},this.ChangeAttributeName=function(e,t){var i=J(),r=x();r.level.name=e.name,t&&t(i)},this.ChangeAttributeBackgroundColor=function(e,t){var r=J(),n=x();switch(n.type){case l.MyPage:var a=I.getCurrentPage(),o=i.getPageNode();o.setBackgroundColor(e.color,function(){o.renderAll(),a.backgroundColor=e.color,a.proJsonStr=JSON.stringify(o.toJSON());var i=R(L.pages,a);I.OnPageSelected(i,function(){t&&t(r)})});break;case l.MySubLayer:var s=W(),c=i.getSubLayerNode();c.setBackgroundColor(e.color,function(){c.renderAll(),s.backgroundColor=e.color,s.proJsonStr=JSON.stringify(c.toJSON());var i=R(L.pages,I.getCurrentPage()),n=R(L.pages[i].layers,I.getCurrentLayer()),a=R(L.pages[i].layers[n].subLayers,I.getCurrentSubLayer());I.OnSubLayerSelected(i,a,function(){t&&t(r)})})}},this.ChangeAttributeBackgroundImage=function(e,t){var r=J(),n=x(),a=I.getCurrentPage();switch(n.type){case l.MyPage:var o=i.getPageNode();o.setBackgroundImage(e.image,function(){o.renderAll(),a.backgroundImage=e.image,a.proJsonStr=JSON.stringify(o.toJSON());var i=R(L.pages,a);I.OnPageSelected(i,function(){t&&t(r)})},{width:o.getWidth()/o.getZoom(),height:o.getHeight()/o.getZoom()});break;case l.MySubLayer:var s=M(),c=W(),h=i.getSubLayerNode();h.setBackgroundImage(e.image,function(){h.renderAll(),c.backgroundImage=e.image,c.proJsonStr=JSON.stringify(h.toJSON());var i=R(I.getCurrentPage().layers,s),n=R(s.subLayers,c);I.OnSubLayerSelected(i,n,function(){t&&t(r)})},{width:s.info.width,height:s.info.height})}},this.ChangeAttributePressImage=function(e,t){var i=I.getCurrentSelectObject();return e.image&&""!=e.image?void(i.level.pressImg=e.image):void console.warn("内容为空")},this.ChangeAttributeButtonText=function(e,t){var i=I.getCurrentSelectObject(),r=(A(i.level.id,!0),{level:i.level,callback:function(){var e=i.level;N(e,t)}});e.hasOwnProperty("text")&&(i.level.info.text=e.text,r.text=e.text),e.fontFamily&&(i.level.info.fontFamily=e.fontFamily,r.fontFamily=e.fontFamily),e.fontSize&&(i.level.info.fontSize=e.fontSize,r.fontSize=e.fontSize),e.fontColor&&(i.level.info.fontColor=e.fontColor,r.fontColor=e.fontColor),e.fontBold&&(i.level.info.fontBold=e.fontBold,r.fontBold=e.fontBold),e.hasOwnProperty("fontItalic")&&(i.level.info.fontItalic=e.fontItalic,r.fontItalic=e.fontItalic),e.fontName&&(i.level.info.fontName=e.fontName),i.target.fire("changeButtonText",r)},this.ChangeAttributeProgressValue=function(e,t){var i=I.getCurrentSelectObject(),r=(e.progressValue-i.level.info.minValue)/(i.level.info.maxValue-i.level.info.minValue);i.level.info.progressValue=e.progressValue;var n={progress:r,callback:t};i.target.fire("changeProgressValue",n)},this.ChangeAttributeArrange=function(e,t){var i=I.getCurrentSelectObject();i.level.info.arrange=e.arrange;var r={arrange:e.arrange,callback:t};i.target.fire("changeArrange",r)},this.ChangeAttributeCursor=function(e,t){var i=a.getTemplateId(),r={},n=I.getCurrentSelectObject();n.level.info.cursor=e.cursor,n.level.info.progressModeId=e.progressModeId,"0"==e.cursor&&(n.level.texList=[{currentSliceIdx:0,name:"进度条底纹",slices:[{color:i?"rgba(0,0,0,0)":"rgba(240,145,66,1)",imgSrc:i?"/public/templates/defaultTemplate/defaultResources/barBackground.png":"",name:"进度条底纹"}]},{currentSliceIdx:0,name:"进度条",slices:[{color:i?"rgba(0,0,0,0)":"rgba(125,27,27,1)",imgSrc:i?"/public/templates/defaultTemplate/defaultResources/barAll.png":"",name:"进度条"}]}],"1"==e.progressModeId&&(n.level.texList=[{currentSliceIdx:0,name:"进度条背景",slices:[{color:i?"rgba(0,0,0,0)":"rgba(240,145,66,1)",imgSrc:"",name:"进度条背景"}]},{currentSliceIdx:0,name:"初始颜色",slices:[{color:"rgba(170,80,80,1)",imgSrc:"",name:"初始颜色"}]},{currentSliceIdx:0,name:"结束颜色",slices:[{color:"rgba(243,204,82,1)",imgSrc:"",name:"结束颜色"}]}],r.initColor=n.level.texList[1].slices[0].color,r.endColor=n.level.texList[2].slices[0].color)),"1"==e.cursor&&(n.level.texList=[{currentSliceIdx:0,name:"进度条底纹",slices:[{color:i?"rgba(0,0,0,0)":"rgba(240,145,66,1)",imgSrc:i?"/public/templates/defaultTemplate/defaultResources/barBackground.png":"",name:"进度条底纹"}]},{currentSliceIdx:0,name:"进度条",slices:[{color:i?"rgba(0,0,0,0)":"rgba(125,27,27,1)",imgSrc:i?"/public/templates/defaultTemplate/defaultResources/barAll.png":"",name:"进度条"}]},{currentSliceIdx:0,name:"光标纹理",slices:[{color:"rgba(0,0,0,0)",imgSrc:"",name:"光标纹理"}]}],"1"==e.progressModeId&&(n.level.texList=[{currentSliceIdx:0,name:"进度条底纹",slices:[{color:i?"rgba(0,0,0,0)":"rgba(240,145,66,1)",imgSrc:"",name:"进度条底纹"}]},{currentSliceIdx:0,name:"初始颜色",slices:[{color:"rgba(170,80,80,1)",imgSrc:"",name:"初始颜色"}]},{currentSliceIdx:0,name:"结束颜色",slices:[{color:"rgba(243,204,82,1)",imgSrc:"",name:"结束颜色"}]},{currentSliceIdx:0,name:"光标纹理",slices:[{color:"rgba(0,0,0,0)",imgSrc:"",name:"光标纹理"}]}],r.initColor=n.level.texList[1].slices[0].color,r.endColor=n.level.texList[2].slices[0].color)),r.backgroundColor=n.level.texList[0].slices[0].color,r.progressColor=n.level.texList[1].slices[0].color,r.progressModeId=n.level.info.progressModeId,r.level=_.cloneDeep(n.level),t&&t(),n.target.fire("changeAttributeCursor",r)},this.ChangeAttributeDashboardOffsetValue=function(e,t){var i=I.getCurrentSelectObject(),r=e.offsetValue;i.level.info.offsetValue=r;var n={offsetValue:r,callback:t};i.target.fire("changeDashboardOffsetValue",n)},this.ChangeAttributeDashboardValue=function(e,t){var i=I.getCurrentSelectObject(),r=e.value;i.level.info.value=e.value;var n={value:r,callback:t};i.target.fire("changeDashboardValue",n)},this.ChangeAttributeDashboardPointerLength=function(e,t){var i=I.getCurrentSelectObject(),r=e.pointerLength,n=A(i.level.id,!0);i.level.info.pointerLength=r;var a={pointerLength:r,scaleX:n.getScaleX(),scaleY:n.getScaleY(),callback:t};i.target.fire("changeDashboardPointerLength",a)},this.ChangeAttributeKnobSize=function(e,t){var i=I.getCurrentSelectObject(),r=e.knobSize,n=A(i.level.id,!0);i.level.info.knobSize=r;var a={knobSize:r,scaleX:n.getScaleX(),scaleY:n.getScaleY(),callback:t};i.target.fire("changeKnobSize",a)},this.ChangeAttributeKnobValue=function(e,t){var i=I.getCurrentSelectObject(),r=e.value;i.level.info.value=e.value;var n={value:r,callback:t};i.target.fire("changeKnobValue",n)},this.ChangeAttributeTextContent=function(e,t){var i=I.getCurrentSelectObject(),r=(A(i.level.id,!0),{level:i.level,callback:function(){var e=i.level;N(e,t)}});if(e.text){var n=e.text;i.level.info.text=n,r.text=n}if(e.fontFamily){var a=e.fontFamily;i.level.info.fontFamily=a,r.fontFamily=a}if(e.fontSize){var o=e.fontSize;i.level.info.fontSize=o,r.fontSize=o}if(e.fontColor){var l=e.fontColor;i.level.info.fontColor=l,r.fontColor=l}if(e.fontBold){var s=e.fontBold;i.level.info.fontBold=s,r.fontBold=s}if(e.hasOwnProperty("fontItalic")){var c=e.fontItalic;i.level.info.fontItalic=c,r.fontItalic=c}e.fontName&&(i.level.info.fontName=e.fontName),i.target.fire("changeTextContent",r)},this.ChangeAttributeNumContent=function(e,t){var i=I.getCurrentSelectObject(),r=A(i.level.id,!0),n={scaleX:r.getScaleX(),scaleY:r.getScaleY(),callback:t};if(e.fontFamily){var a=e.fontFamily;i.level.info.fontFamily=a,n.fontFamily=a}if(e.fontSize){var o=e.fontSize;i.level.info.fontSize=o,n.fontSize=o}if(e.fontBold){var l=e.fontBold;i.level.info.fontBold=l,n.fontBold=l}if(e.hasOwnProperty("fontItalic")){var s=e.fontItalic;i.level.info.fontItalic=s,n.fontItalic=s}if(e.hasOwnProperty("fontColor")){var c=e.fontColor;i.level.info.fontColor=c,n.fontColor=c}if(e.numOfDigits){var h=e.numOfDigits;i.level.info.numOfDigits=h,n.numOfDigits=h}if(e.decimalCount||0==e.decimalCount){var g=e.decimalCount;i.level.info.decimalCount=g,n.decimalCount=g}if(e.symbolMode){var u=e.symbolMode;i.level.info.symbolMode=u,n.symbolMode=u}if(e.frontZeroMode){var d=e.frontZeroMode;i.level.info.frontZeroMode=d,n.frontZeroMode=d}if(e.hasOwnProperty("numValue")){var f=e.numValue;i.level.info.numValue=f,n.numValue=f}if(e.align){var b=e.align;i.level.info.align=b,n.align=b}i.target.fire("changeNumContent",n)},this.ChangeAttributeOfNum=function(e,t){var i=I.getCurrentSelectObject();e.numModeId&&(i.level.info.numModeId=e.numModeId),e.overFlowStyle&&(i.level.info.overFlowStyle=e.overFlowStyle),t&&t()},this.ChangeAttributeButtonModeId=function(e,t){var i=I.getCurrentSelectObject();i.level.buttonModeId=e.buttonModeId,t&&t()},this.ChangeAttributeOscilloscopeForRender=function(e,t){var i=I.getCurrentSelectObject(),r={callback:t};e.hasOwnProperty("spacing")&&(i.level.info.spacing=e.spacing,r.spacing=e.spacing),e.hasOwnProperty("grid")&&(i.level.info.grid=e.grid,r.grid=e.grid),e.hasOwnProperty("lineWidth")&&(i.level.info.lineWidth=e.lineWidth,r.lineWidth=e.lineWidth),e.hasOwnProperty("gridInitValue")&&(i.level.info.gridInitValue=e.gridInitValue,r.gridInitValue=e.gridInitValue),e.hasOwnProperty("gridUnitX")&&(i.level.info.gridUnitX=e.gridUnitX,r.gridUnitX=e.gridUnitX),e.hasOwnProperty("gridUnitY")&&(i.level.info.gridUnitY=e.gridUnitY,r.gridUnitY=e.gridUnitY),i.target.fire("ChangeAttributeOscilloscope",r)},this.ChangeAttributeOscilloscope=function(e,t){var i=I.getCurrentSelectObject();e.hasOwnProperty("lineColor")&&(i.level.info.lineColor=e.lineColor)},this.ChangeAttributeBindBit=function(e,t){var i=(e.bindBit,I.getCurrentSelectObject());i.level.info.bindBit=e.bindBit,t&&t()},this.ChangeAttributeInitValue=function(e,t){var i=e.initValue,r=I.getCurrentSelectObject();r.level.info.initValue=e.initValue,arg={initValue:i,callback:t},r.target.fire("changeInitValue",arg)},this.ChangeAttributeDateTimeModeId=function(e,t){var i=e.dateTimeModeId,r=e.RTCModeId,n=I.getCurrentSelectObject();n.level.info.dateTimeModeId=i,n.level.info.RTCModeId=r;var a={level:n.level,dateTimeModeId:i,callback:function(){var e=n.level;N(e,t)}};n.target.fire("changeDateTimeModeId",a)},this.ChangeAttributeDateTimeText=function(e,t){var i=I.getCurrentSelectObject(),r={level:i.level,callback:function(){var e=i.level;N(e,t)}};e.hasOwnProperty("fontFamily")&&(i.level.info.fontFamily=e.fontFamily,r.fontFamily=e.fontFamily),e.hasOwnProperty("fontSize")&&(i.level.info.fontSize=e.fontSize,r.fontSize=e.fontSize),e.hasOwnProperty("fontColor")&&(i.level.info.fontColor=e.fontColor,r.fontColor=e.fontColor),i.target.fire("changeDateTimeText",r)},this.ChangeAttributeGroupAlign=function(e,t){var r=J(),n=i.getPageNode(),a=i.getSubLayerNode(),o=I.getCurrentPage(),l=I.getCurrentSelectObject(),s=l.target,c=(l.level,s.getWidth()),h=s.getHeight();switch(e.align){case"left":s.forEachObject(function(e){e.setLeft(-c/2)});break;case"top":s.forEachObject(function(e){e.setTop(-h/2)});break;case"bottom":s.forEachObject(function(e){var t=e.getHeight(),i=h/2-t;e.setTop(i)});break;case"right":s.forEachObject(function(e){var t=e.getWidth(),i=c/2-t;e.setLeft(i)})}if(W()){var g=W();g.proJsonStr=JSON.stringify(a.toJSON())}else o.proJsonStr=JSON.stringify(n.toJSON());a.renderAll(),n.renderAll(),t&&t(r)},this.ChangeAttributeDashboardModeId=function(e,t){var i=a.getTemplateId(),r=I.getCurrentSelectObject();r.level.dashboardModeId=e.dashboardModeId,"0"==r.level.dashboardModeId?r.level.texList=[{currentSliceIdx:0,name:"仪表盘背景",slices:[{color:i?"rgba(0,0,0,0)":"rgba(100,100,100,1)",imgSrc:i?"/public/templates/defaultTemplate/defaultResources/dashboard.png":"",name:"仪表盘背景"}]},{currentSliceIdx:0,name:"仪表盘指针",slices:[{color:"rgba(0,0,0,0)",imgSrc:i?"/public/templates/defaultTemplate/defaultResources/pointer.png":"",name:"仪表盘指针"}]}]:"1"==r.level.dashboardModeId?r.level.texList=[{currentSliceIdx:0,name:"仪表盘背景",slices:[{color:i?"rgba(0,0,0,0)":"rgba(100,100,100,1)",imgSrc:i?"/public/templates/defaultTemplate/defaultResources/dashboard.png":"",name:"仪表盘背景"}]},{currentSliceIdx:0,name:"仪表盘指针",slices:[{color:"rgba(0,0,0,0)",imgSrc:i?"/public/templates/defaultTemplate/defaultResources/pointer.png":"",name:"仪表盘指针"}]},{currentSliceIdx:0,name:"光带效果",slices:[{color:"rgba(0,0,0,0)",imgSrc:i?"/public/templates/defaultTemplate/defaultResources/lightBand.png":"",name:"光带效果"}]}]:"2"==r.level.dashboardModeId&&(r.level.texList=[{currentSliceIdx:0,name:"光带效果",slices:[{color:"rgba(0,0,0,0)",imgSrc:i?"/public/templates/defaultTemplate/defaultResources/lightBand.png":"",name:"光带效果"}]}]);var n=_.cloneDeep(r.level);arg={level:n,backgroundColor:_.cloneDeep(r.level.texList[0].slices[0].color),dashboardModeId:e.dashboardModeId,callback:t},r.target.fire("changeDashboardMode",arg)},this.ChangeAttributeDashboardClockwise=function(e,t){var i=I.getCurrentSelectObject();i.level.info.clockwise=e.clockwise,arg={clockwise:e.clockwise,callback:t},i.target.fire("changeDashboardClockwise",arg)},this.ChangeAttributeDashboardCoverAngle=function(e,t){var i=I.getCurrentSelectObject();arg={callback:t},e.hasOwnProperty("minCoverAngle")?(arg.minCoverAngle=e.minCoverAngle,i.level.info.minCoverAngle=e.minCoverAngle):e.hasOwnProperty("maxCoverAngle")&&(arg.maxCoverAngle=e.maxCoverAngle,i.level.info.maxCoverAngle=e.maxCoverAngle),toastr.info("修改成功!"),i.target.fire("changeDashboardCoverAngle",arg)},this.ChangeAttributeInterval=function(e,t){var i=I.getCurrentSelectObject();i.level.info.interval=e.interval;var r=i.level.info.interval,n=A(i.level.id,!0);"horizontal"==i.level.info.arrange?(i.level.info.intervalScale=i.level.info.interval/n.getWidth(),r=i.level.info.interval/n.getScaleX()):(i.level.info.intervalScale=i.level.info.interval/n.getHeight(),r=i.level.info.interval/n.getScaleY());var a={interval:r,callback:t};i.target.fire("changeInterval",a)},this.ChangeAttributeButtonCount=function(e,t){function i(e,t,r){if(e.texList.length<t+1)e.texList.splice(e.texList.length-1,0,a.getDefaultButtonTex()),i(e,t,r);else{if(!(e.texList.length>t+1))return void(r&&r());e.texList.splice(e.texList.length-2,1),i(e,t,r);
}}var r=I.getCurrentSelectObject();r.level.info.count=e.count,i(r.level,r.level.info.count,function(){var e={level:r.level,callback:t};r.target.fire("changeTex",e)})},this.ChangeAttributePosition=function(e,t){var r=J(),n=I.getCurrentSelectObject(),a=i.getPageNode(),o=i.getSubLayerNode(),s=I.getCurrentPage();if(n.type==l.MyLayer){var c=null,h=M();_.forEach(a.getObjects(),function(e){e.id==n.target.id&&(c=e)}),_.isNumber(e.left)&&(c.setLeft(e.left),h.info.left=e.left),_.isNumber(e.top)&&(c.setTop(e.top),h.info.top=e.top),a.renderAll(),s.proJsonStr=JSON.stringify(a.toJSON()),I.OnLayerSelected(h,function(){t&&t(r)})}else if(l.isWidget(n.type)){var g=null,u=W(),d=E(u);if(_.forEach(o.getObjects(),function(e){e.id==n.target.id&&(g=e)}),g=A(n.target.id,!0),!g)return void console.warn("找不到fabSlide");_.isNumber(e.left)&&(g.setLeft(e.left),d.info.left=e.left),_.isNumber(e.top)&&(g.setTop(e.top),d.info.top=e.top),o.renderAll(),u.proJsonStr=JSON.stringify(o.toJSON()),I.OnWidgetSelected(d,function(){t&&t(r)})}else if(n.type==l.MyGroup){var f=n.target,b=n.level;if(!f)return void console.warn("找不到fabWidget");if(_.isNumber(e.left)&&(f.setLeft(e.left),b.info.left=e.left),_.isNumber(e.top)&&(f.setTop(e.top),b.info.top=e.top),W()){var u=W();u.proJsonStr=JSON.stringify(o.toJSON())}else s.proJsonStr=JSON.stringify(a.toJSON());o.renderAll(),a.renderAll(),t&&t(r)}},this.ChangeAttributeAnimation=function(e,t){var i=I.getCurrentSelectObject();i.level.animations=e,t&&t()},this.AddAttributeTransition=function(e,t){var i=I.getCurrentSelectObject();i.level.transition=e,t&&t()},this.ChangeAttributeTransition=function(e,t){var i=I.getCurrentSelectObject();e.hasOwnProperty("name")?(i.level.transition.name=e.name,i.level.transition.show=e.show):e.hasOwnProperty("duration")&&(i.level.transition.duration=e.duration),t&&t()},this.ChangeAttributeAction=function(e,t){var i=I.getCurrentSelectObject();i.level.actions=e,t&&t()},this.ChangeAttributeTexList=function(e,t){var i=I.getCurrentSelectObject();i.level.texList=e;var r={level:i.level,callback:t};i.target.fire("changeTex",r)},this.ChangeAttributeWidgetSize=function(e){var t=I.getCurrentSelectObject(),i={callback:e},r=s.getResourceFromCache(t.level.texList[0].slices[0].imgSrc);i.widgetWidth=r.width,i.WidgetHeight=r.height,r.width==t.level.info.width&&r.height==t.level.info.height&&1==t.target.scaleX&&1==t.target.scaleY||(t.level.info.width=r.width,t.level.info.height=r.height,t.target.fire("changeWidgetSize",i))},this.ChangeAttributeTag=function(e,t){var i=I.getCurrentSelectObject();i.level.tag=e,t&&t()},this.ChangeAttributeValue=function(e,t){var r=J(),n=i.getSubLayerNode(),a=null,o=null,s=x();e.hasOwnProperty("maxValue")&&(s.level.info.maxValue=e.maxValue,s.type==l.MyProgress&&(o=(s.level.info.progressValue-s.level.info.minValue)/(s.level.info.maxValue-s.level.info.minValue),a={progress:o,callback:t},s.target.fire("changeProgressValue",a)),s.type==l.MyDashboardDashboard&&(a={maxValue:e.maxValue,callback:t},s.target.fire("changeDashboardValue",a)),s.type==l.MyOscilloscope&&(a={maxValue:e.maxValue,callback:t},s.target.fire("ChangeAttributeOscilloscope",a)),s.type==l.MySlideBlock&&(a={maxValue:e.maxValue,callback:t},s.target.fire("changeInitValue",a))),e.hasOwnProperty("minValue")&&(s.level.info.minValue=e.minValue,s.type==l.MyProgress&&(o=(s.level.info.progressValue-s.level.info.minValue)/(s.level.info.maxValue-s.level.info.minValue),a={progress:o,callback:t},s.target.fire("changeProgressValue",a)),s.type==l.MyDashboard&&(a={minValue:e.minValue,callback:t},s.target.fire("changeDashboardValue",a)),s.type==l.MyOscilloscope&&(a={minValue:e.minValue,callback:t},s.target.fire("ChangeAttributeOscilloscope",a)),s.type==l.MySlideBlock&&(a={minValue:e.minValue,callback:t},s.target.fire("changeInitValue",a))),e.hasOwnProperty("minAngle")&&(s.level.info.minAngle=e.minAngle,s.type==l.MyDashboard&&(a={minAngle:e.minAngle,callback:t},s.target.fire("changeDashboardValue",a))),e.hasOwnProperty("maxAngle")&&(s.level.info.maxAngle=e.maxAngle,s.type==l.MyDashboard&&(a={maxAngle:e.maxAngle,callback:t},s.target.fire("changeDashboardValue",a))),e.hasOwnProperty("highAlarmValue")&&(s.level.info.highAlarmValue=e.highAlarmValue),e.hasOwnProperty("lowAlarmValue")&&(s.level.info.lowAlarmValue=e.lowAlarmValue),e.hasOwnProperty("initValue")&&(s.level.info.initValue=e.initValue,s.target.fire("changeNumber",s.level),n.renderAll()),toastr.info("修改成功!"),t&&t(r)},this.ChangeAttributeNoInit=function(e,t){var i=x();e.noInit&&(i.level.info.noInit=e.noInit),toastr.info("修改成功!")},this.ChangeAttributeZIndex=function(e,t){var r=J(),n=x();if(n.type==l.MyLayer){var a=i.getPageNode(),o=null,s=I.getCurrentPage();M();if(_.forEach(a.getObjects(),function(e){e.id==n.target.id&&(o=e)}),!o)return void console.warn("找不到Layer");0==e.index?o.bringForward():o.sendBackwards(),s.proJsonStr=JSON.stringify(a.toJSON());var c=a.getObjects();_.forEach(s.layers,function(e,t){for(var i=0;i<c.length;i++)if(c[i].id==e.id){e.zIndex=i;break}}),s.layers.sort(function(e,t){return e.zIndex-t.zIndex})}else if(l.isWidget(n.type)){var h=i.getSubLayerNode(),g=null,u=W();console.log(u.widgets);E();if(_.forEach(h.getObjects(),function(e){e.id==n.target.id&&(g=e)}),!g)return void console.warn("找不到Widget");0==e.index?g.bringForward():g.sendBackwards(),u.proJsonStr=JSON.stringify(h.toJSON());var d=h.getObjects();_.forEach(u.widgets,function(e,t){for(var i=0;i<d.length;i++)if(d[i].id==e.id){e.zIndex=i;break}}),u.widgets.sort(function(e,t){return e.zIndex-t.zIndex})}t&&t(r)},this.ChangeAttributeSize=function(e,t){var r=J(),n=x();if(n.type==l.MyLayer){var a=i.getPageNode(),o=null,s=M();if(_.forEach(a.getObjects(),function(e){e.id==n.target.id&&(o=e)}),!o)return void console.warn("找不到Layer");var c=I.getCurrentPage();e.width&&(o.set({width:e.width,scaleX:1}),s.info.width=e.width),e.height&&(o.set({height:e.height,scaleY:1}),s.info.height=e.height),n.target.fire("OnRelease",n.target.id),a.renderAll(),c.proJsonStr=JSON.stringify(a.toJSON());var h=M();I.OnLayerSelected(h,function(){t&&t(r)})}else if(l.isWidget(n.type)){var g=i.getSubLayerNode(),u=null,d=W(),f=E(d);if(_.forEach(g.getObjects(),function(e){e.id==n.target.id&&(u=e)}),!u)return void console.warn("找不到Widget");e.width&&(u.set({width:e.width,scaleX:1}),f.info.width=e.width),e.height&&(u.set({height:e.height,scaleY:1}),f.info.height=e.height),g.renderAll(),d.proJsonStr=JSON.stringify(g.toJSON()),N(f,function(){t&&t(r)})}},this.SearchObjectByName=function(e,t){var i=[];_.forEach(L.pages,function(t){t.name==e&&i.push({id:t.id,type:l.MyPage}),_.forEach(t.layers,function(t){t.name==e&&i.push({id:t.id,type:l.MyLayer}),_.forEach(t.subLayers,function(t){t.name==e&&i.push({id:t.id,type:l.MySubLayer}),_.forEach(t.widgets,function(t){t.name==e&&i.push({id:t.id,type:t.type})})})})}),t(i)},this.SelectInSearchResults=function(e,t){if(!e)return void console.warn("无效的参数");var i=R(L.pages,I.getCurrentPage());_.forEach(L.pages,function(r,n){return r.id==e.id&&e.type==l.MyPage?void I.changeCurrentPageIndex(n,t):void _.forEach(r.layers,function(r,a){return r.id==e.id&&e.type==l.MyLayer?void(i==n?I.OnLayerSelected(r,t,!0):I.changeCurrentPageIndex(n,function(){I.OnLayerSelected(r,t,!0)})):void _.forEach(r.subLayers,function(r,o){return r.id==e.id&&e.type==l.MySubLayer?void(i==n?I.OnSubLayerSelected(a,o,t,!0):I.changeCurrentPageIndex(n,function(){I.OnSubLayerSelected(a,o,t,!0)})):void _.forEach(r.widgets,function(r){r.id==e.id&&l.isWidget(e.type)&&(i==n?I.OnSubLayerSelected(a,o,function(){I.OnWidgetSelected(r,t,!0)},!0):I.changeCurrentPageIndex(n,function(){I.OnSubLayerSelected(a,o,function(){I.OnWidgetSelected(r,t,!0)},!0)}))})})})})},this.ScaleCanvas=function(e,t){var r=(I.getCurrentPage(),1);if("page"==e){var n=i.getPageNode();r=o.getScaleFloat("page"),n.setZoom(r),n.setWidth(L.currentSize.width*r),n.setHeight(L.currentSize.height*r)}else if("subCanvas"==e){var a=t?t:I.getCurrentLayer(),l=i.getSubLayerNode();r=o.getScaleFloat("subCanvas"),p(a.info.width,a.info.height,a.info.left,a.info.top,r),l.setZoom(r),l.setWidth(a.info.width*r),l.setHeight(a.info.height*r)}else console.warn("传参有问题")};var F=function(e,t){var r=W(),n=i.getPageNode();r&&(r.proJsonStr=JSON.stringify(i.getSubLayerNode().toJSON())),n.setBackgroundImage(null,function(){n.loadFromJSON(e.proJsonStr,function(){1==e.mode?B(r,t):t&&t()})})},R=function(e,t){var i=-1;return e?(_.forEach(e,function(e,r){e.id==t.id&&(i=r)}),i):i},B=function(e,t){if(!e)return void console.warn("找不到SubLayer");var r=i.getSubLayerNode(),n=i.getPageNode();r.deactivateAll(),r.renderAll(),e.url=r.toDataURL({format:"png"});var a=n.getObjects(),o=a.length;if(o>0){var l=function(){o-=1,o<=0&&t&&t()}.bind(this);_.forEach(a,function(e){e.fire("OnRenderUrl",l)}.bind(this))}else t&&t()},T=this.setRendering,W=this.getCurrentSubLayer,z=this.OnPageClicked,D=this.OnSubLayerClicked,J=this.SaveCurrentOperate}]);