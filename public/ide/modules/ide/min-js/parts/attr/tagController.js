ide.controller("TagCtrl",["$scope","TagService","ProjectService","Type","$uibModal",function(e,n,t,a,o){function s(){m(),$()}function r(){l(-1)}function l(a,s){var r;if("timer"!==(r=s&&"timer"==s?s:"custom"))if(-1!=a){var l=e.component.curTagClass.tagArray[a].name;e.selectedIdx=S(l,e.component.tagClasses[0]),a=e.selectedIdx}else e.selectedIdx=a;e.selectedIdx=a,e.selectedType=r;var i;i=-1==a?n.getNewTag():"timer"==r?_.cloneDeep(e.component.allTimerTags[a]):_.cloneDeep(e.component.allCustomTags[a]),o.open({animation:e.animationsEnabled,templateUrl:"tagModal.html",controller:"TagInstanceCtrl",size:"sm",resolve:{tag:function(){return i},type:function(){return r},index:function(){return e.selectedIdx}}}).result.then(function(o,s){if(-1==e.selectedIdx)n.setUniqueTags(o,u,function(){m(),c(o,e.component.curTagClass.name)}.bind(this));else if("custom"==e.selectedType)if("force"===s){var r=n.getTagByIndex(a);t.replaceAllRelatedTag(r,o)}else n.editTagByIndex(e.selectedIdx,o,function(){m()}.bind(this)),O(l,o,e.component.curTagClass);else"timer"==e.selectedType&&n.editTimerTagByIndex(e.selectedIdx,o,function(){m()}.bind(this))},function(e){})}function i(n){for(var t=0;t<e.component.allCustomTags.length;t++)e.component.allCustomTags[t].name===n&&(e.selectedIdx=t);var a=_.cloneDeep(e.component.tagClasses);a.splice(0,2);for(var s,r=0;r<a.length;r++){s=a[r].tagArray;for(var l=0;l<s.length;l++)if(n===s[l].name){a.splice(r,1),r--;break}}var i=a.map(function(e){return e.name});o.open({animation:e.animationsEnabled,templateUrl:"addToTagClassModal.html",controller:["$scope","$uibModalInstance",function(e,n){e.tagClassNames=i,e.save=function(t){void 0===e.curIndex?toastr.warning("未选中任何标签"):n.close(e.tagClassNames[e.curIndex])},e.cancel=function(){n.dismiss("cancel")},e.indexSelected=function(n){e.curIndex=n}}],size:"sm",resolve:{tagClassNames:function(){return i}}}).result.then(function(n){c(e.component.allCustomTags[e.selectedIdx],n)},function(e){})}function c(n,t){for(var a=0;a<e.component.tagClasses.length;a++)if(t===e.component.tagClasses[a].name){for(var o=0;o<e.component.tagClasses[a].tagArray.length;o++)if(e.component.tagClasses[a].tagArray[o].name===n.name)return;return void e.component.tagClasses[a].tagArray.push(n)}}function g(){var a=e.component.tagClasses.map(function(e){return{name:e.name,renamed:!1,renaming:!1,deleted:!1}}),s=a.splice(0,2);o.open({animation:e.animationsEnabled,templateUrl:"editTagClasses.html",controller:["$scope","$uibModalInstance",function(e,n){function o(n){if(null==n)return toastr.error("名称不能为空"),!1;for(var a=0;a<e.tagClassesManage.length;a++)if(n==e.tagClassesManage[a].name&&!1===e.tagClassesManage[a].deleted)return toastr.error("重复的名称"),!1;return!!t.inputValidate(n)}e.tagClassesManage=a,e.defaultTagClasses=s,e.$scopeCtl=e,e.$scopeCtl.curTagClassNewName=null,e.someTagClassRenaming=!1,e.addTagClass=!1,e.addTagClass=function(){e.addTagClassFlag=!0,e.someTagClassRenaming=!0,e.$scopeCtl.curTagClassNewName=null},e.inputName=function(n){if(void 0!==n&&null!==n){var t=e.tagClassesManage[n];t.renaming=!t.renaming,e.$scopeCtl.curTagClassNewName=t.name}else e.addTagClassFlag=!1;e.someTagClassRenaming=!e.someTagClassRenaming},e.enterName=function(n){if(1==o(e.$scopeCtl.curTagClassNewName)){if(n){var t=e.tagClassesManage[n];t.name=e.$scopeCtl.curTagClassNewName,t.renamed=!0,t.renaming=!1}else{var a={name:e.$scopeCtl.curTagClassNewName,renamed:!1,renaming:!1,deleted:!1};e.tagClassesManage.push(a),e.addTagClassFlag=!1}e.someTagClassRenaming=!1}},e.delete=function(e){},e.close=function(){n.close(e.tagClassesManage)}}],size:"md",resolve:{tagClassesManage:function(){return a},defaultTagClasses:function(){return s}}}).result.then(function(t){for(var a=0;a<e.component.tagClasses.length-2;a++)1!=t[a].deleted?1==t[a].renamed&&(e.component.tagClasses[a+2].name=t[a].name):(t.splice(a,1),e.component.tagClasses.splice(a+2,1),a--);if(e.component.tagClasses.length-2<t.length)for(;a<t.length;a++)if(0==t[a].deleted){var o=n.getNewTagClass();o.name=t[a].name,e.component.tagClasses.push(o)}n.syncTagClasses(e.component.tagClasses)},function(e){})}function m(){e.component.allCustomTags=n.getAllCustomTags(),e.component.allTimerTags=n.getAllTimerTags(),e.component.allTags=n.getAllTags(),e.component.timerNum=n.getTimerNum()}function u(e,n){if("custom"===e.type)for(var t=0;t<n.length;t++)if(e.name==n[t].name)return toastr.error("重复的tag名称"),!1;return!0}function d(n){n.preventDefault(),n.stopPropagation(),13==n.keyCode?f():e.component.tag.name+=String.fromCharCode(n.charCode)}function f(){if(e.selected=null,document.getElementById("tagName").disabled)document.getElementById("tagName").disabled=!1,e.component.tag={name:"",register:!1,indexOfRegister:null,writeOrRead:!1,value:null};else{if(""==e.component.tag.name)return void alert("Please enter tag's name");var t=_.cloneDeep(e.component.tag);0==t.register&&(t.indexOfRegister=null,t.writeOrRead="false",t.value=null),n.setUniqueTags(t,function(e,n){for(var a=0;a<n.length;a++)if(t.name==n[a].name)return console.log("equal"),!1;return!0}),e.component.tag={name:"",register:!1,indexOfRegister:null,writeOrRead:!1,value:null}}}function T(){e.component.visibleOfList=!e.component.visibleOfList}function p(n,a){for(var o=t.getRequiredTagNames(),s=0;s<o.length;s++)if(n==o[s])return void toastr.warning("该tag已经被使用");switch(a){case"system":return void toastr.warning("系统变量不可删除")}for(var r,l=0;l<e.component.tagClasses.length;l++)for(r=e.component.tagClasses[l].tagArray,s=0;s<r.length;s++)r[s].name===n&&r.splice(s,1)}function C(t){document.getElementById("tagName").disabled=!1,e.component.tag=_.cloneDeep(n.getTagByIndex(t.$index)),e.component.indexOfTagInList=t.$index,e.selected=t.$id}function v(t){document.getElementById("tagName").disabled=!0,e.component.tag=_.cloneDeep(n.getTimerTagByIndex(t.$index)),e.component.indexOfTagInList=t.$index,e.selected=t.$id}function y(){if(console.log("edit success"),!n.getAllCustomTags().length&&!n.getAllTimerTags().length||""==e.component.tag.name)return void alert("Not selected tag!");0==e.component.tag.register&&(e.component.tag.indexOfRegister=null,e.component.tag.writeOrRead=!1,e.component.tag.value=null),e.component.tag.name.match("SysTmr_")?n.editTimerTagByIndex(e.component.indexOfTagInList,e.component.tag):n.editTagByIndex(e.component.indexOfTagInList,e.component.tag)}function h(){m()}function N(){e.component.timerNum++;var n={};n.keyCode=13,I(n)}function x(){e.component.timerNum--;var n={};n.keyCode=13,I(n)}function I(t){if(13===t.keyCode){var a=n.getTimerNum();if(!_.isInteger(parseInt(e.component.timerNum)))return toastr.warning("输入不合法"),void(e.component.timerNum=a);if(e.component.timerNum>10||e.component.timerNum<0)return toastr.warning("超出范围"),void(e.component.timerNum=a);n.setTimerNum(e.component.timerNum),n.setTimerTags(e.component.timerNum)}}function b(){e.component.timerNum=n.getTimerNum()}function w(e){n.sortByName(function(){m()})}function M(){n.sortByRegister(function(){m()})}function $(){e.component.tagClasses=n.getAllTagClasses(),e.component.tagClasses[0].tagArray=e.component.allCustomTags,e.component.tagClasses[1].tagArray=e.component.allTimerTags,e.component.curTagClass=n.getAllTagClasses()[0],e.component.curTagClassName=n.getAllTagClasses()[0].name}function A(){g()}function R(e){i(e)}function B(){for(var n=e.component.tagClasses,t=e.component.curTagClassName,a=(e.component.tagClasses[0].tagArray,0);a<n.length;a++)if(t===n[a].name){e.component.curTagClass=n[a];break}"定时器"===e.component.curTagClass.name?e.component.timerTagShow=!0:e.component.timerTagShow=!1,k(e.component.curTagClass)}function S(e,n){for(var t=0;t<n.tagArray.length;t++)if(e===n.tagArray[t].name)return t;return-1}function O(e,n,t){var a=S(e,t);t.tagArray[a]=n}function k(n){for(var t=0;t<n.tagArray.length;t++)for(var a=0;a<e.component.allTags.length;a++)n.tagArray[t].name===e.component.allTags[a].name&&(n.tagArray[t]=e.component.allTags[a])}function P(t){if(e.component.curTagClassName!==e.component.tagClasses[0].name){var a=S(t.name,e.component.tagClasses[0]);n.editTagByIndex(a,t,function(){m()})}}function D(){o.open({animation:!0,templateUrl:"tagsImport.html",scope:e,size:"md",resolve:{curTagClass:function(){return e.component.curTagClass}},controller:["$scope","$uibModalInstance","$http","TagService","curTagClass",function(e,n,t,a,o){function s(e){var n=new RegExp(/tags_default\d*$/g),a="";if(n.test(e)&&(a="/public/ide/modules/tagConfig/template/"+e.replace("_",".")+".json",console.log("url",a)),!a)return void console.error("url is empty!");t({method:"get",url:a}).success(function(e){r(null,e)}).error(function(e){r(e,null)})}function r(t,s){if(t)return toastr.error("获取失败，请检查您的网络"),void l();a.syncTagFromRemote(s,o,e.overlay,function(){e.$emit("syncTagSuccess"),n.close()})}function l(){e.btnText="确定"===e.btnText?"导入中...":e.btnText,e.disableBtn="确定"!==e.btnText}e.selectedTagId=null,e.overlay=!1,e.btnText="确定",e.disableBtn=!1,e.ok=function(){if(!e.selectedTagId)return void toastr.warning("请选择一项预设变量");l(),s(e.selectedTagId)},e.cancel=function(){n.dismiss()}}]})}e.selectedIdx=-1,e.component={allCustomTags:null,allTimerTags:null,visibleOfList:!0,indexOfTagInList:null,timerNum:null,tagClasses:null,curTagClass:null,curTagClassName:null,timerTagShow:!1,addNewTag:r,openPanel:l,setTag:f,enterTag:d,toggle:T,deleteTag:p,editTag:y,displayTagByIndex:C,displayTimerTagByIndex:v,setTimerNum:I,addTimerNum:N,minusTimerNum:x,restoreTimerNum:b,readTags:h,sortByName:w,sortByRegister:M,editTagClass:A,changeCurTagClass:B,addToTagClass:R,regCheckboxClick:P,importTags:D},e.$on("GlobalProjectReceived",function(){s()}),e.$on("syncTagSuccess",function(e){m()})}]),ide.controller("TagInstanceCtrl",["$scope","$uibModalInstance","TagService","ProjectService","tag","type","index",function(e,n,t,a,o,s,r){e.tag=o,e.type=s,e.showForceEditBtn=!1,e.save=function(o){if(e.showForceEditBtn=!1,"timer"===o.type)return void n.close(e.tag);if(-1!==r){var s=t.getTagByIndex(r);if(s.name!==e.tag.name){for(var l=_.cloneDeep(t.getAllTags()),i=0;i<l.length;i++)if(e.tag.name===l[i].name&&r!=i)return void toastr.error("重复的tag名称");for(var c=a.getRequiredTagNames(),g=0;g<c.length;g++)if(s.name===c[g])return toastr.warning("该tag已经被使用,修改名称请先解除绑定"),void(e.showForceEditBtn=!0)}}if(a.inputValidate(e.tag.name)){if(e.tag.name.match(/^SysTmr_[0-9]+_t$/))return void toastr.error("SysTmr_数字_t 为定时器保留名称");n.close(e.tag)}},e.forceSave=function(o){var s=!1;if(-1!==r){var l=t.getTagByIndex(r);if(l.name!==e.tag.name&&a.inputValidate(e.tag.name)){for(var i=_.cloneDeep(t.getAllTags()),c=0;c<i.length;c++)if(e.tag.name===i[c].name&&r!=c)return void toastr.error("重复的tag名称");if(e.tag.name.match(/^SysTmr_[0-9]+_t$/))return void toastr.error("SysTmr_数字_t 为定时器保留名称");for(var g=a.getRequiredTagNames(),m=0;m<g.length;m++)if(l.name===g[m]){s=!0;break}s&&n.close(e.tag,"force")}}},e.cancel=function(){n.dismiss("cancel")},e.checkTagIndex=function(){(e.tag.indexOfRegister>65535||e.tag.indexOfRegister<0)&&(toastr.warning("序号超出范围"),e.tag.indexOfRegister=0),_.isInteger(e.tag.indexOfRegister)||(toastr.error("序号只能是整数"),e.tag.indexOfRegister=0)}}]),ide.controller("TagSelectCtl",["$scope","TagService","ProjectService","Type",function(e,n,t,a){function o(){r(),l()}function s(){e.component.allCustomTags=n.getAllCustomTags(),e.component.allTimerTags=n.getAllTimerTags()}function r(){var n=t.getCurrentSelectObject();if(!n.level)return void console.warn("空!");e.component.selectedTag=n.level.tag}function l(){var n=_.cloneDeep(t.getCurrentSelectObject().level);if(!n)return void console.warn("空!");switch(n.type){case a.MyNumber:case a.MySlide:case a.MyProgress:case a.MyDashboard:case a.MyButtonGroup:case a.MyLayer:case a.MyPage:case a.MyNum:case a.MyKnob:case a.MyOscilloscope:case a.MyImage:case a.MySwitch:case a.MyRotateImg:case a.MyScriptTrigger:case a.MySlideBlock:case a.MyVideo:case a.MyAnimation:case a.MyTexNum:e.component.showTagPanel=!0;break;default:e.component.showTagPanel=!1}}function i(){e.component.selectedTag=e.selectedTagObj.tagName,t.ChangeAttributeTag(e.component.selectedTag,function(n){e.$emit("ChangeCurrentPage",n)})}e.component={showTagPanel:!1,selectedTag:null,allCustomTags:null,allTimerTags:null,selectedTagFun:i},e.selectedTagObj={tagName:null},e.$on("GlobalProjectReceived",function(){o()}),e.$on("AttributeChanged",function(){s(),r(),l()}),e.$on("MaskView",function(n,t){e.myMask=t})}]);