ide.controller("TagCtrl",["$scope","TagService","ProjectService","Type","$uibModal",function(e,n,a,t,o){function s(){m(),$()}function l(){r(-1)}function r(a,t){var s;s=t&&"timer"==t?t:"custom";var l=e.component.curTagClass.tagArray[a].name;e.selectedIdx=S(l,e.component.tagClasses[0]),a=e.selectedIdx,e.selectedType=s;var r;r=-1==a?n.getNewTag():"timer"==s?_.cloneDeep(e.component.allTimerTags[a]):_.cloneDeep(e.component.allCustomTags[a]),o.open({animation:e.animationsEnabled,templateUrl:"tagModal.html",controller:"TagInstanceCtrl",size:"sm",resolve:{tag:function(){return r},type:function(){return s},index:function(){return e.selectedIdx}}}).result.then(function(a){-1==e.selectedIdx?n.setUniqueTags(a,u,function(){m(),c(a,e.component.curTagClass.name)}.bind(this)):"custom"==e.selectedType?n.editTagByIndex(e.selectedIdx,a,function(){m()}.bind(this)):"timer"==e.selectedType&&n.editTimerTagByIndex(e.selectedIdx,a,function(){m()}.bind(this))},function(e){})}function i(n){for(var a=0;a<e.component.allCustomTags.length;a++)e.component.allCustomTags[a].name===n&&(e.selectedIdx=a);var t=_.cloneDeep(e.component.tagClasses);t.splice(0,2);for(var s,l=0;l<t.length;l++){s=t[l].tagArray;for(var r=0;r<s.length;r++)if(n===s[r].name){t.splice(l,1),l--;break}}var i=t.map(function(e){return e.name});o.open({animation:e.animationsEnabled,templateUrl:"addToTagClassModal.html",controller:["$scope","$uibModalInstance",function(e,n){e.tagClassNames=i,e.save=function(a){void 0===e.curIndex?toastr.warning("未选中任何标签"):n.close(e.tagClassNames[e.curIndex])},e.cancel=function(){n.dismiss("cancel")},e.indexSelected=function(n){e.curIndex=n}}],size:"sm",resolve:{tagClassNames:function(){return i}}}).result.then(function(n){c(e.component.allCustomTags[e.selectedIdx],n)},function(e){})}function c(n,a){for(var t=0;t<e.component.tagClasses.length;t++)if(a===e.component.tagClasses[t].name){for(var o=0;o<e.component.tagClasses[t].tagArray.length;o++)if(e.component.tagClasses[t].tagArray[o].name===n.name)return;return void e.component.tagClasses[t].tagArray.push(n)}}function g(){var t=e.component.tagClasses.map(function(e){return{name:e.name,renamed:!1,renaming:!1,deleted:!1}}),s=t.splice(0,2);o.open({animation:e.animationsEnabled,templateUrl:"editTagClasses.html",controller:["$scope","$uibModalInstance",function(e,n){function o(n){if(null==n)return toastr.error("名称不能为空"),!1;for(var t=0;t<e.tagClassesManage.length;t++)if(n==e.tagClassesManage[t].name&&!1===e.tagClassesManage[t].deleted)return toastr.error("重复的名称"),!1;return!!a.inputValidate(n)}e.tagClassesManage=t,e.defaultTagClasses=s,e.$scopeCtl=e,e.$scopeCtl.curTagClassNewName=null,e.someTagClassRenaming=!1,e.addTagClass=!1,e.addTagClass=function(){e.addTagClassFlag=!0,e.someTagClassRenaming=!0,e.$scopeCtl.curTagClassNewName=null},e.inputName=function(n){if(void 0!==n&&null!==n){var a=e.tagClassesManage[n];a.renaming=!a.renaming,e.$scopeCtl.curTagClassNewName=a.name}else e.addTagClassFlag=!1;e.someTagClassRenaming=!e.someTagClassRenaming},e.enterName=function(n){if(1==o(e.$scopeCtl.curTagClassNewName)){if(n){var a=e.tagClassesManage[n];a.name=e.$scopeCtl.curTagClassNewName,a.renamed=!0,a.renaming=!1}else{var t={name:e.$scopeCtl.curTagClassNewName,renamed:!1,renaming:!1,deleted:!1};e.tagClassesManage.push(t),e.addTagClassFlag=!1}e.someTagClassRenaming=!1}},e.delete=function(e){},e.close=function(){n.close(e.tagClassesManage)}}],size:"md",resolve:{tagClassesManage:function(){return t},defaultTagClasses:function(){return s}}}).result.then(function(a){for(var t=0;t<e.component.tagClasses.length-2;t++)1!=a[t].deleted?1==a[t].renamed&&(e.component.tagClasses[t+2].name=a[t].name):(a.splice(t,1),e.component.tagClasses.splice(t+2,1),t--);if(e.component.tagClasses.length-2<a.length)for(;t<a.length;t++)if(0==a[t].deleted){var o=n.getNewTagClass();o.name=a[t].name,e.component.tagClasses.push(o)}n.syncTagClasses(e.component.tagClasses)},function(e){})}function m(){e.component.allCustomTags=n.getAllCustomTags(),e.component.allTimerTags=n.getAllTimerTags(),e.component.allTags=n.getAllTags(),e.component.timerNum=n.getTimerNum()}function u(e,n){for(var a=0;a<n.length;a++)if(e.name==n[a].name)return toastr.error("重复的tag名称"),!1;return!0}function d(n){n.preventDefault(),n.stopPropagation(),13==n.keyCode?f():e.component.tag.name+=String.fromCharCode(n.charCode)}function f(){if(e.selected=null,document.getElementById("tagName").disabled)document.getElementById("tagName").disabled=!1,e.component.tag={name:"",register:!1,indexOfRegister:null,writeOrRead:!1,value:null};else{if(""==e.component.tag.name)return void alert("Please enter tag's name");var a=_.cloneDeep(e.component.tag);0==a.register&&(a.indexOfRegister=null,a.writeOrRead="false",a.value=null),n.setUniqueTags(a,function(e,n){for(var t=0;t<n.length;t++)if(a.name==n[t].name)return console.log("equal"),!1;return!0}),e.component.tag={name:"",register:!1,indexOfRegister:null,writeOrRead:!1,value:null}}}function T(){e.component.visibleOfList=!e.component.visibleOfList}function p(n,t){for(var o=a.getRequiredTagNames(),s=0;s<o.length;s++)if(n==o[s])return void toastr.warning("该tag已经被使用");switch(t){case"system":return void toastr.warning("系统变量不可删除")}for(var l,r=0;r<e.component.tagClasses.length;r++)for(l=e.component.tagClasses[r].tagArray,s=0;s<l.length;s++)l[s].name===n&&l.splice(s,1)}function C(a){document.getElementById("tagName").disabled=!1,e.component.tag=_.cloneDeep(n.getTagByIndex(a.$index)),e.component.indexOfTagInList=a.$index,e.selected=a.$id}function v(a){document.getElementById("tagName").disabled=!0,e.component.tag=_.cloneDeep(n.getTimerTagByIndex(a.$index)),e.component.indexOfTagInList=a.$index,e.selected=a.$id}function y(){if(console.log("edit success"),!n.getAllCustomTags().length&&!n.getAllTimerTags().length||""==e.component.tag.name)return void alert("Not selected tag!");0==e.component.tag.register&&(e.component.tag.indexOfRegister=null,e.component.tag.writeOrRead=!1,e.component.tag.value=null),e.component.tag.name.match("SysTmr_")?n.editTimerTagByIndex(e.component.indexOfTagInList,e.component.tag):n.editTagByIndex(e.component.indexOfTagInList,e.component.tag)}function N(){m()}function h(){e.component.timerNum++;var n={};n.keyCode=13,I(n)}function x(){e.component.timerNum--;var n={};n.keyCode=13,I(n)}function I(a){if(13===a.keyCode){var t=n.getTimerNum();if(!_.isInteger(parseInt(e.component.timerNum)))return toastr.warning("输入不合法"),void(e.component.timerNum=t);if(e.component.timerNum>10||e.component.timerNum<0)return toastr.warning("超出范围"),void(e.component.timerNum=t);n.setTimerNum(e.component.timerNum),n.setTimerTags(e.component.timerNum)}}function M(){e.component.timerNum=n.getTimerNum()}function w(e){n.sortByName(function(){m()})}function b(){n.sortByRegister(function(){m()})}function $(){e.component.tagClasses=n.getAllTagClasses(),e.component.tagClasses[0].tagArray=e.component.allCustomTags,e.component.tagClasses[1].tagArray=e.component.allTimerTags,e.component.curTagClass=n.getAllTagClasses()[0],e.component.curTagClassName=n.getAllTagClasses()[0].name}function A(){g()}function O(e){i(e)}function R(){for(var n=e.component.tagClasses,a=e.component.curTagClassName,t=(e.component.tagClasses[0].tagArray,0);t<n.length;t++)if(a===n[t].name){e.component.curTagClass=n[t];break}"定时器"===e.component.curTagClass.name?e.component.timerTagShow=!0:e.component.timerTagShow=!1}function S(e,n){for(var a=0;a<n.tagArray.length;a++)if(e===n.tagArray[a].name)return a;return-1}e.selectedIdx=-1,e.component={allCustomTags:null,allTimerTags:null,visibleOfList:!0,indexOfTagInList:null,timerNum:null,tagClasses:null,curTagClass:null,curTagClassName:null,timerTagShow:!1,addNewTag:l,openPanel:r,setTag:f,enterTag:d,toggle:T,deleteTag:p,editTag:y,displayTagByIndex:C,displayTimerTagByIndex:v,setTimerNum:I,addTimerNum:h,minusTimerNum:x,restoreTimerNum:M,readTags:N,sortByName:w,sortByRegister:b,editTagClass:A,changeCurTagClass:R,addToTagClass:O},e.$on("GlobalProjectReceived",function(){s()}),e.$on("ChangeAllTags",function(e){console.log("receive ChangeAllTags",e)})}]),ide.controller("TagInstanceCtrl",["$scope","$uibModalInstance","TagService","ProjectService","tag","type","index",function(e,n,a,t,o,s,l){e.tag=o,e.type=s,e.save=function(o){if("timer"===o.type)return void n.close(e.tag);if(-1!==l){var s=a.getTagByIndex(l);if(s.name!==e.tag.name){for(var r=t.getRequiredTagNames(),i=0;i<r.length;i++)if(s.name===r[i])return void toastr.warning("该tag已经被使用,修改名称请先解除绑定");for(var c=_.cloneDeep(a.getAllTags()),g=0;g<c.length;g++)if(e.tag.name===c[g].name&&l!=g)return void toastr.error("重复的tag名称")}}if(t.inputValidate(e.tag.name)){if(e.tag.name.match(/^SysTmr_[0-9]+_t$/))return void toastr.error("SysTmr_数字_t 为定时器保留名称");n.close(e.tag)}},e.cancel=function(){n.dismiss("cancel")},e.checkTagIndex=function(){(e.tag.indexOfRegister>65535||e.tag.indexOfRegister<0)&&(toastr.warning("序号超出范围"),e.tag.indexOfRegister=0),_.isInteger(e.tag.indexOfRegister)||(toastr.error("序号只能是整数"),e.tag.indexOfRegister=0)}}]),ide.controller("TagSelectCtl",["$scope","TagService","ProjectService","Type",function(e,n,a,t){function o(){l(),r()}function s(){e.component.allCustomTags=n.getAllCustomTags(),e.component.allTimerTags=n.getAllTimerTags()}function l(){var n=a.getCurrentSelectObject();if(!n.level)return void console.warn("空!");e.component.selectedTag=n.level.tag}function r(){var n=_.cloneDeep(a.getCurrentSelectObject().level);if(!n)return void console.warn("空!");switch(n.type){case t.MyNumber:case t.MySlide:case t.MyProgress:case t.MyDashboard:case t.MyButtonGroup:case t.MyLayer:case t.MyPage:case t.MyNum:case t.MyKnob:case t.MyOscilloscope:case t.MyImage:case t.MySwitch:case t.MyRotateImg:case t.MyScriptTrigger:case t.MySlideBlock:case t.MyVideo:case t.MyAnimation:case t.MyTexNum:e.component.showTagPanel=!0;break;default:e.component.showTagPanel=!1}}function i(){e.component.selectedTag=e.selectedTagObj.tagName,a.ChangeAttributeTag(e.component.selectedTag,function(n){e.$emit("ChangeCurrentPage",n)})}e.component={showTagPanel:!1,selectedTag:null,allCustomTags:null,allTimerTags:null,selectedTagFun:i},e.selectedTagObj={tagName:null},e.$on("GlobalProjectReceived",function(){o()}),e.$on("AttributeChanged",function(){s(),l(),r()}),e.$on("MaskView",function(n,a){e.myMask=a})}]);