ideServices.service("ResourceService",[function(){var e,t=!1;try{e=require("path"),t=!0}catch(e){}var n=new Image;n.src="";var r=[{id:"blank",src:"blank",name:"blank",content:n,complete:!0}],o=[],i=[],c=0,a="",s="",u="",l=function(){var e=document.createElement("style");return e.appendChild(document.createTextNode("xxx")),document.head.appendChild(e),e}(),f=l.sheet;window.fontStyle=l,this.getGlobalResources=function(){return r},this.setGlobalResources=function(e){r=e},this.setTemplateFiles=function(e){i=e},this.getResourceFromCache=function(e,t){t=t||"src";for(var n=0;n<r.length;n++)if(r[n][t]==e)return r[n].complete?r[n].content:null;return null},this.setResourceNWUrl=function(e){s=e},this.getResourceNWUrl=function(){return s},this.setProjectUrl=function(e){u=e},this.getProjectUrl=function(){return u},this.getAllResource=function(){return o},this.setFiles=function(e){o=e||[]},this.getExt=function(e){var t=e.split("."),n=t[t.length-1];return n},this.syncFiles=function(e){console.log("_files",e),o=e||[]},this.getAllCustomResources=function(){var e=o.slice();return e},this.getAllImages=function(){var e=_.filter(o,function(e){return!(!e.type||"image"!=e.type.split("/")[0]||"blank.png"==e.id)});return e},this.getAllImagesAndTemplates=function(){var e=_.filter(o,function(e){return!(!e.type||"image"!=e.type.split("/")[0]||"blank.png"==e.id)});return e=e.concat(i)},this.getAllFontResources=function(){return _.filter(o,function(e){var t=this.getExt(e.id);return"ttf"===t||"woff"===t}.bind(this))},this.ResourcesLength=function(){return o.length},this.getCurrentTotalSize=function(){for(var e=0,t=0;t<o.length;t++)e+=o[t].size;return e},this.setMaxTotalSize=function(e){c=e},this.getMaxTotalSize=function(){return c},this.getResourceByIndex=function(e){return o[e]},this.appendFile=function(e,t){o.push(e),t&&t()},this.addWebFont=function(e,n){console.log("font: ",e,n,e);var r=e.name.split(".")[0],o=e.src;t&&process&&process.platform&&process.platform.indexOf("win")!=-1&&(o=o.replace(/\\/g,"/"));var i="@font-face {font-family: '"+r+"'; src:url('"+o+"') format('"+n+"') ;} ";f.insertRule(i,0)},this.cacheFile=function(e,t,n,o){var i={};if(i.id=e.id,i.type=e.type,i.name=e.name,i.src=e.src,e.type.match(/image/)){var c=new Image;i.content=c,c.onload=function(e){i.complete=!0,n&&n(e,i)},c.onerror=function(e){i.complete=!1,o&&o(e,i)},c.src=e.src,r.push(i)}else if("ttf"===this.getExt(e.id)||"woff"===this.getExt(e.id)){var a,s=this.getExt(e.id);console.log(s),"ttf"===s?a="truetype":"woff"===s&&(a="woff"),this.addWebFont(e,a),i.type="font/"+a,r.push(i),console.log("added",r),n&&n({type:"ok"},i)}else n&&n({type:"ok"},{})},this.cacheFileToGlobalResources=function(e,t,n){this.cacheFile(e,r,t,n)},this.appendFileUnique=function(e,t,n){t(e,o)&&(o.push(e),n&&n()),console.log(o)},this.deleteFileByIndex=function(e,t,n){var r=!1;return e>=0&&e<=o.length-1?(o.splice(e,1),r=!0):r=!1,r?(t&&t(),!0):(n&&n(),!1)},this.deleteFileById=function(e,t,n){for(var r=!1,i=0;i<o.length;i++){if(o[i].id==e){o.splice(i,1),r=!0;break}r=!1}return r?(t&&t(),!0):(n&&n(),!1)},this.setResourceUrl=function(e){a=e},this.getResourceUrl=function(){return a}}]).factory("uploadingService",["$http",function(e){var t=function(t,n,r){return e({method:"POST",data:t,url:n,params:r,headers:{"Content-Type":void 0}})};return{upload:function(e,n){return t(e,n)}}}]).factory("idService",[function(){var e=function(e,t){for(var n=0,r=0;r<e.length;r++)n+=parseInt(e.charCodeAt(0),10);return n=(n+Number(t)).toString(16)},t=function(e){for(var t=0,n=0;n<e.length;n++)t+=parseInt(e.charCodeAt(0),10);return t=(t+Number(date)).toString(16)};return{generateId:function(n,r){return r?e(n,r):t(n)}}}]),ideServices.directive("filereadform",["uploadingService","idService","ResourceService","Upload",function(e,t,n,r){return{restrict:"AE",template:"<input type='file' ngf-select='uploadFiles($files)'  ngf-multiple='true' />",replace:"true",link:function(e,o,i){function c(e){var t=e.name.split("."),n=t[t.length-1].toLowerCase();switch(n){case"png":case"jpg":case"bmp":case"jpeg":case"tiff":case"ttf":case"woff":return!0;default:return!1}}function a(t){for(var n=e.component.top.uploadingArray,r=0;r<n.length;r++)if(n[r].id==t.id){n.splice(r,1);break}}function s(e,t){window.local?u(e,t):l(e,t)}function u(t,r){function o(e,t,n,r,o){var i,c,a,s=p.createWriteStream(t);try{console.log(e),i=p.createReadStream(e),c=p.statSync(e),a=c.size}catch(e){return void console.log("err load file",e)}s.on("finish",function(){n&&n()}),s.on("error",function(e){r&&r(e)}),i.on("data",function(e){var t={loaded:s.bytesWritten,total:a};o&&o(t)}),i.pipe(s)}var i=n.getCurrentTotalSize(),c=n.getMaxTotalSize();if(i>c)return toastr.info("资源超过限制"),void a(r);var s=function(){n.appendFileUnique(r,function(e,t){for(var n=0;n<t.length;n++)if(t[n].id==e.id)return!1;return!0},function(){n.cacheFileToGlobalResources(r,function(){a(r),e.$emit("ResourceUpdate")}.bind(this))}.bind(this))},u=function(){r.progress="上传失败",a(r)},l=function(e){r.progress=Math.round(1*e.loaded/e.total*100)+"%",console.log(r.progress)},f=n.getResourceUrl(),h=d.join(f,r.id);o(t.path,h,s,u,l)}function l(t,o){var i=n.getCurrentTotalSize(),c=n.getMaxTotalSize();if(i>c)return toastr.info("资源超过限制"),void a(o);var s=function(t){console.log(t),200==t.status?n.appendFileUnique(o,function(e,t){for(var n=0;n<t.length;n++)if(t[n].id==e.id)return!1;return!0},function(){n.cacheFileToGlobalResources(o,function(){a(o),console.log("updating fonts"),e.$emit("ResourceUpdate")}.bind(this))}.bind(this)):(console.error(t),a(o),e.$emit("ResourceUpdate"))},u=function(e){switch(console.error(e),o.progress="上传失败",e.data.errMsg){case"not logged in":toastr.info("请重新登录");break;case"user not valid":toastr.info("请登录")}a(o)},l=function(e){o.progress=Math.round(1*e.loaded/e.total*100)+"%"};r.upload({url:"/project/"+n.getResourceUrl().split("/")[2]+"/upload",data:{file:t,name:o.id}}).then(s,u,l)}function f(e){var r,o={};if(r=h?n.getResourceNWUrl()+d.sep:n.getResourceUrl(),!e.name)return null;var i=e.name.split("."),c=t.generateId(e.name,Date.now())+"."+i[i.length-1],a=new FormData;return a.append("file",e),a.append("name",c),_.extend(o,e),o.id=c,o.name=i.slice(0,-1).join(""),o.src=r+o.id,o}var d,p,h=!1;try{d=require("path"),p=require("fs"),h=!0}catch(e){}n.getResourceUrl();e.uploadFiles=function(t){if(t&&t.length){t=t.filter(c);for(var n=0;n<t.length;n++){var r=f(t[n]);e.component.top.uploadingArray.push(r),s(t[n],r)}}}}}}]);