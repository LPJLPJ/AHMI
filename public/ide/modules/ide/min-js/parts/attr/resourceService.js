ideServices.service("ResourceService",[function(){var e=new Image;e.src="";var t=[{id:"blank",src:"blank",name:"blank",content:e,complete:!0}],n=[],r=[],o=0,i="",c="",a="",s=function(){var e=document.createElement("style");return e.appendChild(document.createTextNode("xxx")),document.head.appendChild(e),e}(),u=s.sheet;window.fontStyle=s,this.getGlobalResources=function(){return t},this.setGlobalResources=function(e){t=e},this.setTemplateFiles=function(e){r=e},this.getResourceFromCache=function(e,n){n=n||"src";for(var r=0;r<t.length;r++)if(t[r][n]==e)return t[r].complete?t[r].content:null;return null},this.setResourceNWUrl=function(e){c=e},this.getResourceNWUrl=function(){return c},this.setProjectUrl=function(e){a=e},this.getProjectUrl=function(){return a},this.getAllResource=function(){return n},this.setFiles=function(e){n=e||[]},this.getExt=function(e){var t=e.split("."),n=t[t.length-1];return n},this.syncFiles=function(e){console.log("_files",e),n=e||[]},this.getAllCustomResources=function(){var e=n.slice();return e},this.getAllImages=function(){var e=_.filter(n,function(e){return!(!e.type||"image"!=e.type.split("/")[0]||"blank.png"==e.id)});return e},this.getAllImagesAndTemplates=function(){var e=_.filter(n,function(e){return!(!e.type||"image"!=e.type.split("/")[0]||"blank.png"==e.id)});return e=e.concat(r)},this.getAllFontResources=function(){return _.filter(n,function(e){var t=this.getExt(e.id);return"ttf"===t||"woff"===t}.bind(this))},this.ResourcesLength=function(){return n.length},this.getCurrentTotalSize=function(){for(var e=0,t=0;t<n.length;t++)e+=n[t].size;return e},this.setMaxTotalSize=function(e){o=e},this.getMaxTotalSize=function(){return o},this.getResourceByIndex=function(e){return n[e]},this.appendFile=function(e,t){n.push(e),t&&t()},this.addWebFont=function(e,t){console.log("font: ",e,t);var n=e.name.split(".")[0],r="@font-face {font-family: '"+n+"'; src:url('"+e.src+"') format('"+t+"') ;} ";u.insertRule(r,0)},this.cacheFile=function(e,n,r,o){var i={};if(i.id=e.id,i.type=e.type,i.name=e.name,i.src=e.src,e.type.match(/image/)){var c=new Image;i.content=c,c.onload=function(e){i.complete=!0,r&&r(e,i)},c.onerror=function(e){i.complete=!1,o&&o(e,i)},c.src=e.src,t.push(i)}else if("ttf"===this.getExt(e.id)||"woff"===this.getExt(e.id)){var a,s=this.getExt(e.id);console.log(s),"ttf"===s?a="truetype":"woff"===s&&(a="woff"),this.addWebFont(e,a),i.type="font/"+a,t.push(i),console.log("added",t),r&&r({type:"ok"},i)}else r&&r({type:"ok"},{})},this.cacheFileToGlobalResources=function(e,n,r){this.cacheFile(e,t,n,r)},this.appendFileUnique=function(e,t,r){t(e,n)&&(n.push(e),r&&r()),console.log(n)},this.deleteFileByIndex=function(e,t,r){var o=!1;return e>=0&&e<=n.length-1?(n.splice(e,1),o=!0):o=!1,o?(t&&t(),!0):(r&&r(),!1)},this.deleteFileById=function(e,t,r){for(var o=!1,i=0;i<n.length;i++){if(n[i].id==e){n.splice(i,1),o=!0;break}o=!1}return o?(t&&t(),!0):(r&&r(),!1)},this.setResourceUrl=function(e){i=e},this.getResourceUrl=function(){return i}}]).factory("uploadingService",["$http",function(e){var t=function(t,n,r){return e({method:"POST",data:t,url:n,params:r,headers:{"Content-Type":void 0}})};return{upload:function(e,n){return t(e,n)}}}]).factory("idService",[function(){var e=function(e,t){for(var n=0,r=0;r<e.length;r++)n+=parseInt(e.charCodeAt(0),10);return n=(n+Number(t)).toString(16)},t=function(e){for(var t=0,n=0;n<e.length;n++)t+=parseInt(e.charCodeAt(0),10);return t=(t+Number(date)).toString(16)};return{generateId:function(n,r){return r?e(n,r):t(n)}}}]),ideServices.directive("filereadform",["uploadingService","idService","ResourceService","Upload",function(e,t,n,r){return{restrict:"AE",template:"<input type='file' ngf-select='uploadFiles($files)'  ngf-multiple='true' />",replace:"true",link:function(e,o,i){function c(e){var t=e.name.split("."),n=t[t.length-1].toLowerCase();switch(n){case"png":case"jpg":case"bmp":case"jpeg":case"tiff":case"ttf":case"woff":return!0;default:return!1}}function a(t){for(var n=e.component.top.uploadingArray,r=0;r<n.length;r++)if(n[r].id==t.id){n.splice(r,1);break}}function s(e,t){window.local?u(e,t):l(e,t)}function u(t,r){function o(e,t,n,r,o){var i,c,a,s=p.createWriteStream(t);try{console.log(e),i=p.createReadStream(e),c=p.statSync(e),a=c.size}catch(e){return void console.log("err load file",e)}s.on("finish",function(){n&&n()}),s.on("error",function(e){r&&r(e)}),i.on("data",function(e){var t={loaded:s.bytesWritten,total:a};o&&o(t)}),i.pipe(s)}var i=n.getCurrentTotalSize(),c=n.getMaxTotalSize();if(i>c)return toastr.info("资源超过限制"),void a(r);var s=function(){n.appendFileUnique(r,function(e,t){for(var n=0;n<t.length;n++)if(t[n].id==e.id)return!1;return!0},function(){n.cacheFileToGlobalResources(r,function(){a(r),e.$emit("ResourceUpdate")}.bind(this))}.bind(this))},u=function(){r.progress="上传失败",a(r)},l=function(e){r.progress=Math.round(1*e.loaded/e.total*100)+"%",console.log(r.progress)},f=n.getResourceUrl(),h=d.join(f,r.id);o(t.path,h,s,u,l)}function l(t,o){var i=n.getCurrentTotalSize(),c=n.getMaxTotalSize();if(i>c)return toastr.info("资源超过限制"),void a(o);var s=function(t){console.log(t),200==t.status?n.appendFileUnique(o,function(e,t){for(var n=0;n<t.length;n++)if(t[n].id==e.id)return!1;return!0},function(){n.cacheFileToGlobalResources(o,function(){a(o),console.log("updating fonts"),e.$emit("ResourceUpdate")}.bind(this))}.bind(this)):(console.error(t),a(o),e.$emit("ResourceUpdate"))},u=function(e){switch(console.error(e),o.progress="上传失败",e.data.errMsg){case"not logged in":toastr.info("请重新登录");break;case"user not valid":toastr.info("请登录")}a(o)},l=function(e){o.progress=Math.round(1*e.loaded/e.total*100)+"%"};r.upload({url:"/project/"+n.getResourceUrl().split("/")[2]+"/upload",data:{file:t,name:o.id}}).then(s,u,l)}function f(e){var r,o={};if(r=h?n.getResourceNWUrl()+d.sep:n.getResourceUrl(),!e.name)return null;var i=e.name.split("."),c=t.generateId(e.name,Date.now())+"."+i[i.length-1],a=new FormData;return a.append("file",e),a.append("name",c),_.extend(o,e),o.id=c,o.name=i.slice(0,-1).join(""),o.src=r+o.id,o}var d,p,h=!1;try{d=require("path"),p=require("fs"),h=!0}catch(e){}n.getResourceUrl();e.uploadFiles=function(t){if(t&&t.length){t=t.filter(c);for(var n=0;n<t.length;n++){var r=f(t[n]);e.component.top.uploadingArray.push(r),s(t[n],r)}}}}}}]);