ideServices.service("ResourceService",[function(){var e=!1;try{require("path"),e=!0}catch(e){}var t=new Image;t.src="";var n=[{id:"blank",src:"blank",name:"blank",content:t,complete:!0}],r=[],o=[],i=0,c="",s="",a="",l=function(){var e=document.createElement("style");return e.appendChild(document.createTextNode("xxx")),document.head.appendChild(e),e}(),u=l.sheet;window.fontStyle=l,this.getGlobalResources=function(){return n},this.setGlobalResources=function(e){n=e},this.setTemplateFiles=function(e){o=e},this.getResourceFromCache=function(e,t){t=t||"src";for(var r=0;r<n.length;r++)if(n[r][t]==e)return n[r].complete?n[r].content:null;return null},this.setResourceNWUrl=function(e){s=e},this.getResourceNWUrl=function(){return s},this.setProjectUrl=function(e){a=e},this.getProjectUrl=function(){return a},this.getAllResource=function(){return r},this.setFiles=function(e){r=e||[]},this.getExt=function(e){var t=e.split(".");return t[t.length-1].toLowerCase()},this.syncFiles=function(e){r=e||[]},this.getAllCustomResources=function(){return r.slice()},this.getAllImages=function(){return _.filter(r,function(e){return!(!e.type||"image"!=e.type.split("/")[0]||"blank.png"==e.id)})},this.getAllImagesAndTemplates=function(){var e=_.filter(r,function(e){return!(!e.type||"image"!=e.type.split("/")[0]||"blank.png"==e.id)});return e=e.concat(o)},this.getAllFontResources=function(){return _.filter(r,function(e){var t=this.getExt(e.id);return"ttf"===t||"woff"===t}.bind(this))},this.ResourcesLength=function(){return r.length},this.getCurrentTotalSize=function(){for(var e=0,t=0;t<r.length;t++)e+=r[t].size;return e},this.setMaxTotalSize=function(e){i=e},this.getMaxTotalSize=function(){return i},this.getResourceByIndex=function(e){return r[e]},this.appendFile=function(e,t){r.push(e),t&&t()},this.addWebFont=function(t,n){console.log("font: ",t,n,t);var r=t.name.split(".")[0],o=t.src;e&&process&&process.platform&&-1!=process.platform.indexOf("win")&&(o=o.replace(/\\/g,"/"));var i="@font-face {font-family: '"+r+"'; src:url('"+o+"') format('"+n+"') ;} ";u.insertRule(i,0)},this.cacheFile=function(e,t,r,o){var i={};if(i.id=e.id,i.type=e.type,i.name=e.name,i.src=e.src,e.type.match(/image/)){var c=new Image;i.content=c,c.onload=function(e){i.complete=!0,r&&r(e,i)},c.onerror=function(e){i.complete=!1,o&&o(e,i)},c.src=e.src,n.push(i)}else if("ttf"===this.getExt(e.id)||"woff"===this.getExt(e.id)){var s,a=this.getExt(e.id);console.log(a),"ttf"===a?s="truetype":"woff"===a&&(s="woff"),this.addWebFont(e,s),i.type="font/"+s,e.type=i.type,n.push(i),console.log("added",n),r&&r({type:"ok"},i)}else r&&r({type:"ok"},{})},this.cacheFileToGlobalResources=function(e,t,r){this.cacheFile(e,n,t,r)},this.deleteFileCache=function(e){for(var t=0;t<n.length;t++)if(e==n[t].id)return n.splice(t,1),!0;return!1},this.appendFileUnique=function(e,t,n){t(e,r)&&(r.push(e),n&&n()),console.log(r)},this.deleteFileByIndex=function(e,t,n){var o=!1;return e>=0&&e<=r.length-1?(this.deleteFileCache(r[e].id),r.splice(e,1),o=!0):o=!1,o?(t&&t(),!0):(n&&n(),!1)},this.deleteFileById=function(e,t,n){for(var o=!1,i=0;i<r.length;i++){if(r[i].id==e){this.deleteFileCache(r[i].id),r.splice(i,1),o=!0;break}o=!1}return o?(t&&t(),!0):(n&&n(),!1)},this.setResourceUrl=function(e){c=e},this.getResourceUrl=function(){return c}}]).factory("uploadingService",["$http",function(e){var t=function(t,n,r){return e({method:"POST",data:t,url:n,params:r,headers:{"Content-Type":void 0}})};return{upload:function(e,n){return t(e,n)}}}]).factory("idService",[function(){var e=function(e,t){for(var n=0,r=0;r<e.length;r++)n+=parseInt(e.charCodeAt(0),10);return n=(n+Number(t)).toString(16)},t=function(e){for(var t=0,n=0;n<e.length;n++)t+=parseInt(e.charCodeAt(0),10);return t=(t+Number(date)).toString(16)};return{generateId:function(n,r){return r?e(n,r):t(n)}}}]),ideServices.directive("filereadform",["uploadingService","idService","ResourceService","Upload",function(e,t,n,r){return{restrict:"AE",template:"<input type='file' ngf-select='uploadFiles($files)'  ngf-multiple='true' />",replace:"true",link:function(e,o,i){function c(e){var t=e.name.split(".");switch(t[t.length-1].toLowerCase()){case"png":case"jpg":case"bmp":case"jpeg":case"ttf":case"woff":return!0;default:return!1}}function s(t){++g,console.log("d"+g);for(var n=e.component.top.uploadingArray,r=0;r<n.length;r++)if(n[r].id==t.id){n.splice(r,1);break}}function a(e,t){window.local?l(e,t):u(e,t)}function l(t,r){if(n.getCurrentTotalSize()>n.getMaxTotalSize())return toastr.info("资源超过限制"),void s(r);var o=function(){n.appendFileUnique(r,function(e,t){for(var n=0;n<t.length;n++)if(t[n].id==e.id)return!1;return!0},function(){n.cacheFileToGlobalResources(r,function(){s(r),e.$emit("ResourceUpdate")}.bind(this))}.bind(this))},i=function(){r.progress="上传失败",s(r)},c=function(e){r.progress=Math.round(1*e.loaded/e.total*100)+"%",console.log(r.progress)},a=n.getResourceUrl(),l=d.join(a,r.id);!function(e,t,n,r,o){var i,c,s,a=p.createWriteStream(t);try{console.log(e),i=p.createReadStream(e),c=p.statSync(e),s=c.size}catch(e){return void console.log("err load file",e)}a.on("finish",function(){n&&n()}),a.on("error",function(e){r&&r(e)}),i.on("data",function(e){var t={loaded:a.bytesWritten,total:s};o&&o(t)}),i.pipe(a)}(t.path,l,o,i,c)}function u(t,o){if(n.getCurrentTotalSize()>n.getMaxTotalSize())return toastr.info("资源超过限制"),void s(o);var i=function(t){++m,console.log("s"+m),console.log(t),200==t.status?n.appendFileUnique(o,function(e,t){for(var n=0;n<t.length;n++)if(t[n].id==e.id)return!1;return!0},function(){n.cacheFileToGlobalResources(o,function(){s(o),console.log("updating fonts"),e.$emit("ResourceUpdate")}.bind(this))}.bind(this)):(console.error(t),s(o),e.$emit("ResourceUpdate"))},c=function(e){switch(++e,console.log("e"+e),console.error(e),o.progress="上传失败",e.data.errMsg){case"not logged in":toastr.info("请重新登录");break;case"user not valid":toastr.info("请登录")}s(o)},a=function(e){++v,console.log("p"+v),o.progress=Math.round(1*e.loaded/e.total*100)+"%"};r.upload({url:"/project/"+n.getResourceUrl().split("/")[2]+"/upload",data:{file:t,name:o.id}}).then(i,c,a)}function f(e){var r,o={};if(r=h?n.getResourceNWUrl()+d.sep:n.getResourceUrl(),!e.name)return null;var i=e.name.split("."),c=t.generateId(e.name,Date.now())+"."+i[i.length-1],s=new FormData;return s.append("file",e),s.append("name",c),_.extend(o,e),o.id=c,o.name=i.slice(0,-1).join(""),o.src=r+o.id,o}var d,p,h=!1;try{d=require("path"),p=require("fs"),h=!0}catch(e){}n.getResourceUrl();e.uploadFiles=function(t){if(t&&t.length){t=t.filter(c);for(var n=0;n<t.length;n++){var r=f(t[n]);e.component.top.uploadingArray.push(r),a(t[n],r)}}};var g=0,m=0,v=0}}}]);