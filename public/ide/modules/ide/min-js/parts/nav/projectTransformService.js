ideServices.service("ProjectTransformService",["Type","ResourceService",function(e,t){function o(e,t){return actionCompiler.transformer.trans(actionCompiler.parser.parse(e),t)}function r(e,t){if(t=t||!0,e&&e.actions&&e.actions.length)for(var r=0;r<e.actions.length;r++){var a=e.actions[r];a.commands=o(a.commands,t)}}function a(){var e=["onInitialize","onDestroy","onMouseUp","onMouseDown","onTagChange","onMouseMove","onKeyBoardLeft","onKeyBoardRight","onKeyBoardOK","onAnimationFrame"],t={},o=WidgetModel.models,r=_.cloneDeep(WidgetCommands);console.log("models",o);for(var a in o)if(o.hasOwnProperty(a)){var n=_.cloneDeep(o[a].prototype.commands);g(n,e),t[a]=n}console.log("registered commands",t);var i={};for(var a in r)if(i[a]={},r.hasOwnProperty(a)){modelObj=r[a];for(var s=0;s<e.length;s++){var l=e[s];l in modelObj&&(modelObj[l]=ASTTransformer.transAST(widgetCompiler.parse(modelObj[l])),d(modelObj,l),i[a][l]=cppWidgetCommandTranslator.transJSWidgetCommands(modelObj[l]))}}return console.log("testModels",r),console.log("cppModels",i),{commands:r,cppModels:i}}function n(e){var t={};t.version=e.version,t.name=e.name||"default project",t.author=e.author||"author",t.size=e.currentSize;var o=a();t.generalWidgetCommands=o.commands,t.cppWidgetCommands=o.cppModels,t.pageList=[];for(var r=0;r<e.pages.length;r++)t.pageList.push(i(e.pages[r],r));return t}function i(t,o){var a={};a.id=""+o,a.type=e.MyPage,m(t,a,["name","backgroundImage","backgroundColor","triggers","actions","tag","transition"]),r(a),a.canvasList=[];for(var n=0;n<t.layers.length;n++)a.canvasList.push(s(t.layers[n],n,a.id));return a}function s(t,o,a){var n={};n.id=a+"."+o,n.type=e.MyLayer,m(t,n,["name","triggers","actions","tag","zIndex","animations","transition"]),r(n),n.w=t.info.width,n.h=t.info.height,n.x=t.info.left,n.y=t.info.top,n.subCanvasList=[];for(var i=0;i<t.subLayers.length;i++){var s=t.subLayers[i];t.showSubLayer.id==s&&(n.curSubCanvasIdx=i),n.subCanvasList.push(l(s,i,n.id))}return n}function l(t,o,a){var n={};n.id=a+"."+o,n.type=e.MySubLayer,m(t,n,["name","tag","actions","zIndex","backgroundImage","backgroundColor"]),r(n),n.widgetList=[];for(var i=0;i<t.widgets.length;i++){var s=t.widgets[i];n.widgetList.push(c(s,i,n.id))}return n}function c(e,o,a){var n={},i={};if(n=_.cloneDeep(e),r(n),"general"==n.type){var s=n.info,l=s.left,c=s.top,g=s.width,d=s.height;i=new WidgetModel.models.Button(l,c,g,d,"button",null,n.texList[0].slices),i=i.toObject(),i.generalType="Button",i.id=a+"."+o,i.type="widget",i.tag=e.tag,i.subType="general"}else{var s=n.info,l=s.left,c=s.top,g=s.width,d=s.height,m=!1;switch(n.type){case"MyButton":m=!n.info.disableHighlight,i=new WidgetModel.models.Button(l,c,g,d,"button",null,n.texList[0].slices,m),i=i.toObject(),i.generalType="Button",i.mode=Number(e.buttonModeId),i.tag=_.cloneDeep(e.tag),i.subType="general",i.actions=n.actions;break;case"MyButtonGroup":var h=[];n.texList.map(function(e){h.push(e.slices[0]),h.push(e.slices[1])}),i=new WidgetModel.models.ButtonGroup(l,c,g,d,n.info.count||1,"horizontal"==n.info.arrange?0:1,n.info.interval||0,h),i=i.toObject(),i.tag=_.cloneDeep(e.tag),i.generalType="ButtonGroup",i.subType="general",i.actions=n.actions;break;case"MyDashboard":i=new WidgetModel.models.Dashboard(l,c,g,d,n.dashboardModeId,n.texList,n.info),i=i.toObject(),i.generalType="Dashboard",i.mode=Number(e.dashboardModeId),i.tag=_.cloneDeep(e.tag),i.subType="general";var p="minValue,maxValue,minAngle,maxAngle,lowAlarmValue,highAlarmValue";p.split(",").forEach(function(e){i[e]=s[e]||0}),console.log("enableAnimation",s.enableAnimation),s.enableAnimation&&(i.totalFrame=30),i.otherAttrs[0]=s.offsetValue||0,i.otherAttrs[1]=Number(s.clockwise),i.actions=n.actions;break;case"MyProgress":var h=[];n.texList.map(function(e){h.push(e.slices[0])}),i=new WidgetModel.models.Progress(l,c,g,d,n.info,h),i=i.toObject(),i.tag=_.cloneDeep(e.tag),i.mode=Number(e.info.progressModeId);var p="minValue,maxValue,lowAlarmValue,highAlarmValue";p.split(",").forEach(function(e){i[e]=s[e]||0}),console.log("progress",s.enableAnimation),s.enableAnimation&&(i.totalFrame=30),i.actions=n.actions,i.generalType="Progress",i.subType="general";var f;if(1==i.mode?(f=u(h[1].color),i.otherAttrs[0]=f.r,i.otherAttrs[1]=f.g,i.otherAttrs[2]=f.b,i.otherAttrs[3]=f.a,f=u(h[2].color),i.otherAttrs[4]=f.r,i.otherAttrs[5]=f.g,i.otherAttrs[6]=f.b,i.otherAttrs[7]=f.a):3==i.mode&&(i.otherAttrs[0]=n.info.thresholdModeId,i.otherAttrs[1]=n.info.threshold1,i.otherAttrs[2]=n.info.threshold2,f=u(h[1].color),i.otherAttrs[3]=f.r,i.otherAttrs[4]=f.g,i.otherAttrs[5]=f.b,i.otherAttrs[6]=f.a,f=u(h[2].color),i.otherAttrs[7]=f.a,i.otherAttrs[8]=f.g,i.otherAttrs[9]=f.b,i.otherAttrs[10]=f.a,2==n.info.thresholdModeId&&(f=u(h[3].color),i.otherAttrs[11]=f.a,i.otherAttrs[12]=f.g,i.otherAttrs[13]=f.b,i.otherAttrs[14]=f.a)),i.otherAttrs[19]=Number(e.info.cursor),"1"==e.info.cursor){var b=h[h.length-1].imgSrc;if(b){var y=t.getResourceFromCache(b);i.layers[2].width=y.width,i.layers[2].height=y.height,rawH=i.layers[0].height,yTemp=parseInt((rawH-y.height)/2),i.layers[2].y=yTemp}}break;case"MyRotateImg":i=new WidgetModel.models.RotateImg(l,c,g,d,n.texList[0].slices[0]),i=i.toObject(),i.generalType="RotateImg",i.tag=_.cloneDeep(e.tag),i.subType="general";var p="minValue,maxValue";p.split(",").forEach(function(e){i[e]=s[e]||0}),i.actions=n.actions;break;case"MyTextArea":var A="fontFamily,fontSize,fontColor,fontBold,fontItalic,fontUnderline",v={};A.split(",").forEach(function(e){v[e]=s[e]}),i=new WidgetModel.models.TextArea(l,c,g,d,s.text,v,n.texList[0].slices[0]),i=i.toObject(),i.generalType="TextArea",i.tag=_.cloneDeep(e.tag),i.subType="general";break;case"MySwitch":var h=[];n.texList.map(function(e){h.push(e.slices[0])}),i=new WidgetModel.models.Switch(l,c,g,d,n.info,h),i=i.toObject(),i.tag=_.cloneDeep(e.tag),i.generalType="Switch",i.subType="general",i.otherAttrs[0]=Number(n.info.bindBit);break;case"MyScriptTrigger":i=new WidgetModel.models.ScriptTrigger(l,c,g,d),i=i.toObject(),i.generalType="ScriptTrigger",i.tag=_.cloneDeep(e.tag),i.subType="general";var p="lowAlarmValue,highAlarmValue";p.split(",").forEach(function(e){i[e]=s[e]||0});break;case"MyVideo":i=new WidgetModel.models.Video(l,c,g,d,n.texList[0].slices[0]),i=i.toObject(),i.generalType="Video","HDMI"==s.scource?i.mode=0:i.mode=1,i.tag=_.cloneDeep(e.tag),i.subType="general";break;case"MySlide":i=new WidgetModel.models.Slide(l,c,g,d,n.info,_.cloneDeep(n.texList[0].slices)),i=i.toObject(),i.generalType="Slide",i.tag=_.cloneDeep(e.tag),i.subType="general",i.actions=n.actions;break;case"MySlideBlock":var b=n.texList[1].slices[0].imgSrc,M={w:0,h:0};if(b){var w=t.getResourceFromCache(b);w&&(M.w=w.width,M.h=w.height)}i=new WidgetModel.models.SlideBlock(l,c,g,d,s.arrange,M,[n.texList[0].slices[0],n.texList[1].slices[0]]),i=i.toObject(),i.generalType="SlideBlock",i.tag=_.cloneDeep(e.tag);var p="minValue,maxValue,lowAlarmValue,highAlarmValue";p.split(",").forEach(function(e){i[e]=s[e]||0}),i.arrange="horizontal"==s.arrange?0:1,console.log(i,n),i.otherAttrs[0]=0,i.otherAttrs[1]=0,i.otherAttrs[2]=M.w,i.otherAttrs[3]=M.h,i.otherAttrs[4]=0,i.otherAttrs[5]=0,i.otherAttrs[6]=0,i.subType="general",i.actions=n.actions;break;case"MyNum":var A="fontFamily,fontSize,fontColor,fontBold,fontItalic,fontUnderline",v={};A.split(",").forEach(function(e){v[e]=s[e]}),i=new WidgetModel.models.Num(l,c,g,d,s,v),i=i.toObject();var p="minValue,maxValue,lowAlarmValue,highAlarmValue";switch(p.split(",").forEach(function(e){i[e]=s[e]||0}),i.mode=Number(s.numModeId),i.otherAttrs[0]=Number("NO"!=s.noInit),i.otherAttrs[1]=Number(s.frontZeroMode),i.otherAttrs[2]=Number(s.symbolMode),i.otherAttrs[3]=s.decimalCount,i.otherAttrs[4]=s.numOfDigits,i.otherAttrs[5]=Number(s.overFlowStyle),i.otherAttrs[6]=Number(s.maxFontWidth),s.align){case"left":i.otherAttrs[7]=0;break;case"center":i.otherAttrs[7]=1;break;case"right":i.otherAttrs[7]=2;break;default:i.otherAttrs[7]=1}i.generalType="Num",i.tag=_.cloneDeep(e.tag),i.subType="general",i.actions=n.actions,console.log(i);break;case"MyDateTime":var A="fontFamily,fontSize,fontColor,fontBold,fontItalic,fontUnderline",v={};A.split(",").forEach(function(e){v[e]=s[e]}),i=new WidgetModel.models.DateTime(l,c,g,d,n.info,v),i=i.toObject(),i.generalType="DateTime",i.subType="general",i.actions=n.actions,i.mode=n.info.dateTimeModeId,"0"==i.mode||"1"==i.mode?i.tag=_.cloneDeep(e.tag)||"时钟变量时分秒":i.tag=_.cloneDeep(e.tag)||"时钟变量年月日";break;default:n.subType=e.type,i=n}i.id=a+"."+o,i.type="widget"}return i}function g(e,t){for(var o=0;o<t.length;o++){d(e,t[o])}}function d(e,t){t in e&&(e[t]=WidgetModel.WidgetCommandParser.complier.transformer.trans(WidgetModel.WidgetCommandParser.complier.parser.parse(e[t]),!0).map(function(e){return e.cmd}))}function m(e,t,o){for(var r=0;r<o.length;r++){var a=o[r];"object"==typeof e[a]?t[a]=_.cloneDeep(e[a]):t[a]=e[a]}}function u(e){var t=[],o={r:0,g:0,b:0,a:0};if(-1!==e.indexOf("rgba"))t=e.split(/[\(|\)]/)[1].split(",").map(function(e){return Number(e)}),o={r:t[0],g:t[1],b:t[2],a:255*t[3]};else{if(-1===e.indexOf("rgb"))throw new Error("parsing color error: "+e);t=e.split(/[\(|\)]/)[1].split(","),o={r:t[0],g:t[1],b:t[2],a:255}}return o}this.transDataFile=n}]);