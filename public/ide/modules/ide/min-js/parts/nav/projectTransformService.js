ideServices.service("ProjectTransformService",["Type","ResourceService",function(e,t){function r(e){var t={};t.version=e.version,t.name=e.name||"default project",t.author=e.author||"author",t.size=e.currentSize;var r=o();t.generalWidgetCommands=r.commands,t.cppWidgetCommands=r.cppModels,t.lastSaveTimeStamp=e.lastSaveTimeStamp,t.lastSaveUUID=e.lastSaveUUID,t.pageList=[];for(var a=0;a<e.pages.length;a++)t.pageList.push(s(e.pages[a],a));var n=new WidgetModel.models.ColorPicker(0,0,t.size.width,t.size.height,[{color:"rgba(255,0,0,255)",imgSrc:"/public/images/colorPicker/slide.png"},{color:"rgba(255,0,0,255)",imgSrc:"/public/images/colorPicker/bg.png"},{color:"rgba(255,0,0,255)",imgSrc:"/public/images/colorPicker/pickerIndicator.png"}]);return n=n.toObject(),n.generalType="ColorPicker",n.type="widget",n.subType="general",t.systemWidgets=[],t.systemWidgets.push(n),t}function o(){var e=["onInitialize","onDestroy","onMouseUp","onMouseDown","onTagChange","onMouseMove","onKeyBoardLeft","onKeyBoardRight","onKeyBoardOK","onAnimationFrame","onHighlightFrame"],t={},r=WidgetModel.models,o=_.cloneDeep(WidgetCommands);for(var s in r)if(r.hasOwnProperty(s)){var i=_.cloneDeep(r[s].prototype.commands);a(i,e),t[s]=i}var l={};for(var s in o)if(l[s]={},o.hasOwnProperty(s))for(var c=o[s],g=0;g<e.length;g++){var u=e[g];if(u in c){var m=widgetCompiler.parse(c[u]);c[u]=ASTTransformer.transAST(m),n(c,u),l[s][u]=cppWidgetCommandTranslator.transJSWidgetCommands(c[u])}}return console.log("testModels",o),console.log("cppModels",l),{commands:o,cppModels:l}}function a(e,t){for(var r=0;r<t.length;r++){n(e,t[r])}}function n(e,t){t in e&&(e[t]=WidgetModel.WidgetCommandParser.complier.transformer.trans(WidgetModel.WidgetCommandParser.complier.parser.parse(e[t]),!0).map(function(e){return e.cmd}))}function s(t,r){var o={};o.id=""+r,o.type=e.MyPage,m(t,o,["name","backgroundImage","backgroundColor","triggers","actions","tag","transition"]),g(o),o.canvasList=[];for(var a=0;a<t.layers.length;a++)o.canvasList.push(i(t.layers[a],a,o.id));return o}function i(t,r,o){var a={};a.id=o+"."+r,a.type=e.MyLayer,m(t,a,["name","triggers","actions","tag","zIndex","animations","transition"]),g(a),a.w=t.info.width,a.h=t.info.height,a.x=t.info.left,a.y=t.info.top,a.subCanvasList=[];for(var n=0;n<t.subLayers.length;n++){var s=t.subLayers[n];t.showSubLayer.id==s&&(a.curSubCanvasIdx=n),a.subCanvasList.push(l(s,n,a.id))}return a}function l(t,r,o){var a={};a.id=o+"."+r,a.type=e.MySubLayer,m(t,a,["name","tag","actions","zIndex","backgroundImage","backgroundColor"]),g(a),a.widgetList=[];for(var n=0;n<t.widgets.length;n++){var s=t.widgets[n];a.widgetList.push(c(s,n,a.id))}return a}function c(e,r,o){var a={},n={};if(a=_.cloneDeep(e),g(a),"general"==a.type){var s=a.info,i=s.left,l=s.top,c=s.width,u=s.height;n=new WidgetModel.models.Button(i,l,c,u,"button",null,a.texList[0].slices),n=n.toObject(),n.generalType="Button",n.id=o+"."+r,n.type="widget",n.tag=e.tag,n.subType="general"}else{var s=a.info,m=a.texList,i=s.left,l=s.top,c=s.width,u=s.height,d=!1;switch(a.type){case"MyButton":d=!a.info.disableHighlight;var f={};for(var p in s)switch(p){case"fontItalic":f["font-style"]=s[p];break;case"fontBold":f["font-weight"]=s[p];break;case"fontSize":f["font-size"]=s[p];break;case"fontFamily":f["font-family"]=s[p];break;case"fontColor":f["font-color"]=s[p]}n=new WidgetModel.models.Button(i,l,c,u,"button",f,a.texList[0].slices,d),n=n.toObject(),n.generalType="Button",n.mode=Number(e.buttonModeId),n.tag=_.cloneDeep(e.tag),n.subType="general",n.actions=a.actions;break;case"MyButtonGroup":d=!s.disableHighlight;var b=[];m.map(function(e){e.slices.map(function(e){b.push(e)})}),n=new WidgetModel.models.ButtonGroup(i,l,c,u,s.count||1,"horizontal"===s.arrange?0:1,s.interval||0,b,d),n=n.toObject(),n.tag=_.cloneDeep(e.tag),n.generalType="ButtonGroup",n.subType="general",n.actions=a.actions,n.totalHLFrame=d?6:void 0,n.otherAttrs[0]=s.interval,n.otherAttrs[1]=s.count,n.otherAttrs[2]=1,n.otherAttrs[3]=1,n.otherAttrs[4]="horizontal"===s.arrange?0:1;break;case"MyDashboard":n=new WidgetModel.models.Dashboard(i,l,c,u,a.dashboardModeId,a.texList,a.info),n=n.toObject(),n.generalType="Dashboard",n.mode=Number(e.dashboardModeId),n.tag=_.cloneDeep(e.tag),n.subType="general";var y="minValue,maxValue,minAngle,maxAngle,lowAlarmValue,highAlarmValue";y.split(",").forEach(function(e){n[e]=s[e]||0}),s.enableAnimation&&(n.totalFrame=30),n.otherAttrs[0]=s.offsetValue||0,n.otherAttrs[1]=Number(s.clockwise),n.actions=a.actions;break;case"MyProgress":var b=[];a.texList.map(function(e){b.push(e.slices[0])}),n=new WidgetModel.models.Progress(i,l,c,u,a.info,b),n=n.toObject(),n.tag=_.cloneDeep(e.tag),n.mode=Number(e.info.progressModeId);var y="minValue,maxValue,lowAlarmValue,highAlarmValue";y.split(",").forEach(function(e){n[e]=s[e]||0}),s.enableAnimation&&(n.totalFrame=30),n.actions=a.actions,n.generalType="Progress",n.subType="general";var M;if(1==n.mode?(M=h(b[1].color),n.otherAttrs[0]=M.r,n.otherAttrs[1]=M.g,n.otherAttrs[2]=M.b,n.otherAttrs[3]=M.a,M=h(b[2].color),n.otherAttrs[4]=M.r,n.otherAttrs[5]=M.g,n.otherAttrs[6]=M.b,n.otherAttrs[7]=M.a):3==n.mode&&(n.otherAttrs[0]=a.info.thresholdModeId,n.otherAttrs[1]=a.info.threshold1,n.otherAttrs[2]=a.info.threshold2,M=h(b[1].color),n.otherAttrs[3]=M.r,n.otherAttrs[4]=M.g,n.otherAttrs[5]=M.b,n.otherAttrs[6]=M.a,M=h(b[2].color),n.otherAttrs[7]=M.a,n.otherAttrs[8]=M.g,n.otherAttrs[9]=M.b,n.otherAttrs[10]=M.a,2==a.info.thresholdModeId&&(M=h(b[3].color),n.otherAttrs[11]=M.a,n.otherAttrs[12]=M.g,n.otherAttrs[13]=M.b,n.otherAttrs[14]=M.a)),n.otherAttrs[19]=Number(e.info.cursor),"1"==e.info.cursor){var x=b[b.length-1].imgSrc;if(x){var S=t.getResourceFromCache(x);n.layers[2].width=S.width,n.layers[2].height=S.height,rawH=n.layers[0].height,yTemp=parseInt((rawH-S.height)/2),n.layers[2].y=yTemp}}break;case"MyRotateImg":n=new WidgetModel.models.RotateImg(i,l,c,u,a.texList[0].slices[0]),n=n.toObject(),n.generalType="RotateImg",n.tag=_.cloneDeep(e.tag),n.subType="general";var y="minValue,maxValue";y.split(",").forEach(function(e){n[e]=s[e]||0}),n.actions=a.actions;break;case"MyTextArea":var f={};"fontFamily,fontSize,fontColor,fontBold,fontItalic,fontUnderline".split(",").forEach(function(e){f[e]=s[e]}),n=new WidgetModel.models.TextArea(i,l,c,u,s.text,f,a.texList[0].slices[0]),n=n.toObject(),n.generalType="TextArea",n.tag=_.cloneDeep(e.tag),n.subType="general";break;case"MySwitch":var b=[];a.texList.map(function(e){b.push(e.slices[0])}),n=new WidgetModel.models.Switch(i,l,c,u,a.info,b),n=n.toObject(),n.tag=_.cloneDeep(e.tag),n.generalType="Switch",n.subType="general",n.otherAttrs[0]=Number(a.info.bindBit);break;case"MyScriptTrigger":n=new WidgetModel.models.ScriptTrigger(i,l,c,u),n=n.toObject(),n.generalType="ScriptTrigger",n.tag=_.cloneDeep(e.tag),n.subType="general";var y="lowAlarmValue,highAlarmValue";y.split(",").forEach(function(e){n[e]=s[e]||0}),n.minValue=n.lowAlarmValue-1,n.maxValue=n.highAlarmValue+1,n.actions=a.actions;break;case"MyVideo":n=new WidgetModel.models.Video(i,l,c,u,a.texList[0].slices[0]),n=n.toObject(),n.generalType="Video","HDMI"==s.scource?n.mode=0:n.mode=1,n.tag=_.cloneDeep(e.tag),n.subType="general";break;case"MySlide":n=new WidgetModel.models.Slide(i,l,c,u,a.info,_.cloneDeep(a.texList[0].slices)),n=n.toObject(),n.generalType="Slide",n.tag=_.cloneDeep(e.tag),n.subType="general",n.actions=a.actions;break;case"MySlideBlock":var x=a.texList[1].slices[0].imgSrc,k={w:0,h:0};if(x){var I=t.getResourceFromCache(x);I&&(k.w=I.width,k.h=I.height)}n=new WidgetModel.models.SlideBlock(i,l,c,u,s.arrange,k,[a.texList[0].slices[0],a.texList[1].slices[0]]),n=n.toObject(),n.generalType="SlideBlock",n.tag=_.cloneDeep(e.tag);var y="minValue,maxValue,lowAlarmValue,highAlarmValue";y.split(",").forEach(function(e){n[e]=s[e]||0}),n.arrange="horizontal"==s.arrange?0:1,n.otherAttrs[0]=0,n.otherAttrs[1]=0,n.otherAttrs[2]=k.w,n.otherAttrs[3]=k.h,n.otherAttrs[4]=0,n.otherAttrs[5]=0,n.otherAttrs[6]=0,n.subType="general",n.actions=a.actions;break;case"MyNum":var f={};for(var p in s)switch(p){case"fontItalic":f["font-style"]=s[p];break;case"fontBold":f["font-weight"]=s[p];break;case"fontSize":f["font-size"]=s[p];break;case"fontFamily":f["font-family"]=s[p];break;case"fontColor":f["font-color"]=s[p]}n=new WidgetModel.models.Num(i,l,c,u,s,f),n=n.toObject();var y="minValue,maxValue,lowAlarmValue,highAlarmValue";switch(y.split(",").forEach(function(e){n[e]=s[e]||0}),n.mode=Number(s.numModeId),n.otherAttrs[0]=Number("NO"!=s.noInit),n.otherAttrs[1]=Number(s.frontZeroMode),n.otherAttrs[2]=Number(s.symbolMode),n.otherAttrs[3]=s.decimalCount,n.otherAttrs[4]=s.numOfDigits,n.otherAttrs[5]=Number(s.overFlowStyle),n.otherAttrs[6]=Number(s.maxFontWidth),s.align){case"left":n.otherAttrs[7]=0;break;case"center":n.otherAttrs[7]=1;break;case"right":n.otherAttrs[7]=2;break;default:n.otherAttrs[7]=1}n.otherAttrs[8]=Number(s.width),n.generalType="Num",n.tag=_.cloneDeep(e.tag),n.subType="general",n.actions=a.actions;break;case"MyTexNum":n=new WidgetModel.models.TexNum(i,l,c,u,s,a.texList[0].slices),n=n.toObject();var y="minValue,maxValue,lowAlarmValue,highAlarmValue";switch(y.split(",").forEach(function(e){n[e]=s[e]||0}),n.mode=Number(s.numModeId),n.otherAttrs[0]=Number(s.numValue),n.otherAttrs[1]=Number(s.frontZeroMode),n.otherAttrs[2]=Number(s.symbolMode),n.otherAttrs[3]=Number(s.decimalCount),n.otherAttrs[4]=Number(s.numOfDigits),n.otherAttrs[5]=Number(s.overFlowStyle),n.otherAttrs[6]=Number(s.characterW),n.otherAttrs[7]=Number(s.characterH),n.otherAttrs[8]=Number(s.width),s.align){case"left":n.otherAttrs[9]=0;break;case"center":n.otherAttrs[9]=1;break;case"right":n.otherAttrs[9]=2;break;default:n.otherAttrs[9]=1}n.generalType="TexNum",n.tag=_.cloneDeep(e.tag),n.subType="general",n.actions=a.actions;break;case"MyRotaryKnob":n=new WidgetModel.models.RotaryKnob(i,l,c,u,s,a.texList),n=n.toObject();var y="minValue,maxValue";y.split(",").forEach(function(e){n[e]=s[e]||0}),n.otherAttrs[1]=0,n.otherAttrs[2]=c/2,n.otherAttrs[3]=u/2,n.otherAttrs[4]=0,n.otherAttrs[5]=0,n.otherAttrs[6]=0,n.generalType="RotaryKnob",n.tag=_.cloneDeep(e.tag),n.subType="general",n.actions=a.actions;break;case"MySelector":for(var N=a.texList[1].slices,D=[],C=0,L=N.length;C<L;C++)D[C]={},D[C].color=N[C].color,D[C].text=N[C].text,D[C].img=t.getResourceFromCache(N[C].imgSrc);N=a.texList[2].slices;for(var V=[],C=0,L=N.length;C<L;C++)V[C]={},V[C].color=N[C].color,V[C].text=N[C].text,V[C].img=t.getResourceFromCache(N[C].imgSrc);var W=s.itemFont.fontItalic+" "+s.itemFont.fontBold+" "+s.itemFont.fontSize+'px "'+s.itemFont.fontFamily+'"',F=s.selectorFont.fontItalic+" "+s.selectorFont.fontBold+" "+s.selectorFont.fontSize+'px "'+s.selectorFont.fontFamily+'"',O=A(s.selectorWidth,s.selectorHeight*s.itemCount,s.selectorHeight,V,F,s.selectorFont.fontColor),j=A(s.itemWidth,s.itemHeight*s.itemCount,s.itemHeight,D,W,s.itemFont.fontColor),z="selector"+(++T).toString()+".png",B="selector"+(++T).toString()+".png",R={id:z,name:"selectedImg",type:"image/png",src:O.src},H={id:B,name:"unSelectedImg",type:"image/png",src:j.src},P=function(e,t){"error"===e.type?(toastr.warning("资源加载失败: "+t.name),t.complete=!1):t.complete=!0}.bind(this);v("selector001")||t.cacheFile(R,globalResources,null,P),v("selector002")||t.cacheFile(H,globalResources,null,P);var E="/"+z;w(z,E);var U="/"+B;w(B,U),n=new WidgetModel.models.Selector(i,l,c,u,s,a.texList[0].slices[0],U,E,a.texList[3].slices[0]),n=n.toObject(),n.otherAttrs[0]=Number("NO"!=s.noInit),n.otherAttrs[1]=Number(s.curValue),n.otherAttrs[2]=Number(s.itemCount),n.otherAttrs[3]=Number(s.itemShowCount),n.otherAttrs[4]=Number(s.width),n.otherAttrs[5]=Number(s.height),n.otherAttrs[6]=Number(s.itemWidth),n.otherAttrs[7]=Number(s.itemHeight),n.otherAttrs[8]=Number(s.selectorWidth),n.otherAttrs[9]=Number(s.selectorHeight),n.otherAttrs[10]=0,n.generalType="Selector",n.tag=_.cloneDeep(e.tag),n.subType="general",n.actions=a.actions;break;case"MyDateTime":var f={},K=0;for(var p in s)switch(p){case"fontItalic":f["font-style"]=s[p];break;case"fontBold":f["font-weight"]=s[p];break;case"fontSize":f["font-size"]=s[p];break;case"fontFamily":f["font-family"]=s[p];break;case"fontColor":f["font-color"]=s[p]}switch(n=new WidgetModel.models.DateTime(i,l,c,u,a.info,f,a.texList[0].slices[0]),n=n.toObject(),n.generalType="DateTime",n.subType="general",n.actions=a.actions,n.mode=a.info.dateTimeModeId,"0"==n.mode||"1"==n.mode?n.tag=_.cloneDeep(e.tag)||"时钟变量时分秒":n.tag=_.cloneDeep(e.tag)||"时钟变量年月日",Number(a.info.dateTimeModeId)){case 0:K=8;break;case 1:K=5;break;case 2:case 3:K=10;break;default:K=8}n.otherAttrs[0]=K,n.otherAttrs[1]=0;break;default:a.subType=e.type,n=a}n.id=o+"."+r,n.type="widget"}return n}function g(e,t){if(t=t||!0,e&&e.actions&&e.actions.length)for(var r=0;r<e.actions.length;r++){var o=e.actions[r];o.commands=u(o.commands,t)}}function u(e,t){return actionCompiler.transformer.trans(actionCompiler.parser.parse(e),t)}function m(e,t,r){for(var o=0;o<r.length;o++){var a=r[o];"object"==typeof e[a]?t[a]=_.cloneDeep(e[a]):t[a]=e[a]}}function h(e){var t=[],r={r:0,g:0,b:0,a:0};if(-1!==e.indexOf("rgba"))t=e.split(/[\(|\)]/)[1].split(",").map(function(e){return Number(e)}),r={r:t[0],g:t[1],b:t[2],a:255*t[3]};else{if(-1===e.indexOf("rgb"))throw new Error("parsing color error: "+e);t=e.split(/[\(|\)]/)[1].split(","),r={r:t[0],g:t[1],b:t[2],a:255}}return r}function d(e){var t={};t.DSFlag="base",t.projectId=e.projectId,t.version=e.version,t.name=e.name||"default project",t.author=e.author||"author",t.CANId=e.CANId,t.lastSaveTimeStamp=e.lastSaveTimeStamp,t.lastSaveUUID=e.lastSaveUUID,t.size=e.currentSize;var r=e.pages;t.pages=[];for(var o=0;o<r.length;o++)t.pages.push(f(r[o]));return t}function f(e){var t={};m(e,t,["id","name","url","type","mode","selected","expand","current","currentFablayer","backgroundImage","backgroundColor","triggers","actions","tag","transition"]),g(t);var r=e.layers;t.layers=[];for(var o=0;o<r.length;o++)t.layers.push(p(r[o]));return t}function p(e){var t={};m(e,t,["id","name","url","type","zIndex","info","selected","current","expand","actions","animations","transition"]),t.w=e.info.width,t.h=e.info.height,t.x=e.info.left,t.y=e.info.top;var r=e.subLayers;t.subLayers=[];for(var o=0;o<r.length;o++){var a=r[o];e.showSubLayer.id==a&&(t.curSubCanvasIdx=o),t.subLayers.push(b(a))}return t}function b(e){var t={};m(e,t,["id","name","url","type","selected","expand","current","tag","actions","zIndex","backgroundImage","backgroundColor"]);var r=e.widgets;t.widgets=[];for(var o=0;o<r.length;o++){var a=r[o];t.widgets.push(y(a))}return t}function y(e){return _.cloneDeep(e)}function A(e,t,r,o,a,n){var s=document.createElement("canvas");s.width=e,s.height=t;for(var i=s.getContext("2d"),l=0;l<o.length;l++)o[l].color&&(i.fillStyle=o[l].color,i.fillRect(0,r*l,e,r)),o[l].img&&i.drawImage(o[l].img,0,r*l,e,r),o[l].text&&(i.font=a,i.fillStyle=n,i.textAlign="center",i.textBaseline="middle",i.fillText(o[l].text,e/2,r*l+r/2));var c=new Image;return c.src=s.toDataURL("image/png"),c}function v(e){for(var t=0;t<globalResources.length;t++)if(e===globalResources[t].id)return!0;return!1}function w(e,t){for(var r=0;r<globalResources.length;r++)if(e===globalResources[r].id)return globalResources[r].src=t,!0;return!1}this.transDataFile=r;var T=0;this.transDateFileBase=d}]);