ideServices.service("ProjectTransformService",["Type","ResourceService",function(e,t){function r(e,t){return actionCompiler.transformer.trans(actionCompiler.parser.parse(e),t)}function o(e,t){if(t=t||!0,e&&e.actions&&e.actions.length)for(var o=0;o<e.actions.length;o++){var a=e.actions[o];a.commands=r(a.commands,t)}}function a(){var e=["onInitialize","onDestroy","onMouseUp","onMouseDown","onTagChange","onMouseMove","onKeyBoardLeft","onKeyBoardRight","onKeyBoardOK","onAnimationFrame"],t={},r=WidgetModel.models,o=_.cloneDeep(WidgetCommands);console.log("models",r);for(var a in r)if(r.hasOwnProperty(a)){var n=_.cloneDeep(r[a].prototype.commands);g(n,e),t[a]=n}console.log("registered commands",t);var s={};for(var a in o)if(s[a]={},o.hasOwnProperty(a)){modelObj=o[a];for(var i=0;i<e.length;i++){var l=e[i];if(l in modelObj){var c=widgetCompiler.parse(modelObj[l]);console.log(c),modelObj[l]=ASTTransformer.transAST(c),u(modelObj,l),s[a][l]=cppWidgetCommandTranslator.transJSWidgetCommands(modelObj[l])}}}return console.log("testModels",o),console.log("cppModels",s),{commands:o,cppModels:s}}function n(e){var t={};t.version=e.version,t.name=e.name||"default project",t.author=e.author||"author",t.size=e.currentSize;var r=a();t.generalWidgetCommands=r.commands,t.cppWidgetCommands=r.cppModels,t.lastSaveTimeStamp=e.lastSaveTimeStamp,t.lastSaveUUID=e.lastSaveUUID,t.pageList=[];for(var o=0;o<e.pages.length;o++)t.pageList.push(s(e.pages[o],o));return t}function s(t,r){var a={};a.id=""+r,a.type=e.MyPage,m(t,a,["name","backgroundImage","backgroundColor","triggers","actions","tag","transition"]),o(a),a.canvasList=[];for(var n=0;n<t.layers.length;n++)a.canvasList.push(i(t.layers[n],n,a.id));return a}function i(t,r,a){var n={};n.id=a+"."+r,n.type=e.MyLayer,m(t,n,["name","triggers","actions","tag","zIndex","animations","transition"]),o(n),n.w=t.info.width,n.h=t.info.height,n.x=t.info.left,n.y=t.info.top,n.subCanvasList=[];for(var s=0;s<t.subLayers.length;s++){var i=t.subLayers[s];t.showSubLayer.id==i&&(n.curSubCanvasIdx=s),n.subCanvasList.push(l(i,s,n.id))}return n}function l(t,r,a){var n={};n.id=a+"."+r,n.type=e.MySubLayer,m(t,n,["name","tag","actions","zIndex","backgroundImage","backgroundColor"]),o(n),n.widgetList=[];for(var s=0;s<t.widgets.length;s++){var i=t.widgets[s];n.widgetList.push(c(i,s,n.id))}return n}function c(e,r,a){var n={},s={};if(n=_.cloneDeep(e),o(n),"general"==n.type){var i=n.info,l=i.left,c=i.top,g=i.width,u=i.height;s=new WidgetModel.models.Button(l,c,g,u,"button",null,n.texList[0].slices),s=s.toObject(),s.generalType="Button",s.id=a+"."+r,s.type="widget",s.tag=e.tag,s.subType="general"}else{var i=n.info,l=i.left,c=i.top,g=i.width,u=i.height,m=!1;switch(n.type){case"MyButton":m=!n.info.disableHighlight;var h={};for(var f in i)switch(f){case"fontItalic":h["font-style"]=i[f];break;case"fontBold":h["font-weight"]=i[f];break;case"fontSize":h["font-size"]=i[f];break;case"fontFamily":h["font-family"]=i[f];break;case"fontColor":h["font-color"]=i[f]}s=new WidgetModel.models.Button(l,c,g,u,"button",h,n.texList[0].slices,m),s=s.toObject(),s.generalType="Button",s.mode=Number(e.buttonModeId),s.tag=_.cloneDeep(e.tag),s.subType="general",s.actions=n.actions;break;case"MyButtonGroup":m=!n.info.disableHighlight;var p,b=[];if(m)for(var y=n.texList[n.texList.length-1].slices[0],T=0;T<n.info.count;T++)p=n.texList[T],b.push(p.slices[0]),b.push(p.slices[1]),b.push(y);else for(var T=0;T<n.info.count;T++)p=n.texList[T],b.push(p.slices[0]),b.push(p.slices[1]);s=new WidgetModel.models.ButtonGroup(l,c,g,u,n.info.count||1,"horizontal"==n.info.arrange?0:1,n.info.interval||0,b,m),s=s.toObject(),s.tag=_.cloneDeep(e.tag),s.generalType="ButtonGroup",s.subType="general",s.actions=n.actions;break;case"MyDashboard":s=new WidgetModel.models.Dashboard(l,c,g,u,n.dashboardModeId,n.texList,n.info),s=s.toObject(),s.generalType="Dashboard",s.mode=Number(e.dashboardModeId),s.tag=_.cloneDeep(e.tag),s.subType="general";var M="minValue,maxValue,minAngle,maxAngle,lowAlarmValue,highAlarmValue";M.split(",").forEach(function(e){s[e]=i[e]||0}),console.log("enableAnimation",i.enableAnimation),i.enableAnimation&&(s.totalFrame=30),s.otherAttrs[0]=i.offsetValue||0,s.otherAttrs[1]=Number(i.clockwise),s.actions=n.actions;break;case"MyProgress":var b=[];n.texList.map(function(e){b.push(e.slices[0])}),s=new WidgetModel.models.Progress(l,c,g,u,n.info,b),s=s.toObject(),s.tag=_.cloneDeep(e.tag),s.mode=Number(e.info.progressModeId);var M="minValue,maxValue,lowAlarmValue,highAlarmValue";M.split(",").forEach(function(e){s[e]=i[e]||0}),console.log("progress",i.enableAnimation),i.enableAnimation&&(s.totalFrame=30),s.actions=n.actions,s.generalType="Progress",s.subType="general";var S;if(1==s.mode?(S=d(b[1].color),s.otherAttrs[0]=S.r,s.otherAttrs[1]=S.g,s.otherAttrs[2]=S.b,s.otherAttrs[3]=S.a,S=d(b[2].color),s.otherAttrs[4]=S.r,s.otherAttrs[5]=S.g,s.otherAttrs[6]=S.b,s.otherAttrs[7]=S.a):3==s.mode&&(s.otherAttrs[0]=n.info.thresholdModeId,s.otherAttrs[1]=n.info.threshold1,s.otherAttrs[2]=n.info.threshold2,S=d(b[1].color),s.otherAttrs[3]=S.r,s.otherAttrs[4]=S.g,s.otherAttrs[5]=S.b,s.otherAttrs[6]=S.a,S=d(b[2].color),s.otherAttrs[7]=S.a,s.otherAttrs[8]=S.g,s.otherAttrs[9]=S.b,s.otherAttrs[10]=S.a,2==n.info.thresholdModeId&&(S=d(b[3].color),s.otherAttrs[11]=S.a,s.otherAttrs[12]=S.g,s.otherAttrs[13]=S.b,s.otherAttrs[14]=S.a)),s.otherAttrs[19]=Number(e.info.cursor),"1"==e.info.cursor){var k=b[b.length-1].imgSrc;if(k){var I=t.getResourceFromCache(k);s.layers[2].width=I.width,s.layers[2].height=I.height,rawH=s.layers[0].height,yTemp=parseInt((rawH-I.height)/2),s.layers[2].y=yTemp}}break;case"MyRotateImg":s=new WidgetModel.models.RotateImg(l,c,g,u,n.texList[0].slices[0]),s=s.toObject(),s.generalType="RotateImg",s.tag=_.cloneDeep(e.tag),s.subType="general";var M="minValue,maxValue";M.split(",").forEach(function(e){s[e]=i[e]||0}),s.actions=n.actions;break;case"MyTextArea":var h={};"fontFamily,fontSize,fontColor,fontBold,fontItalic,fontUnderline".split(",").forEach(function(e){h[e]=i[e]}),s=new WidgetModel.models.TextArea(l,c,g,u,i.text,h,n.texList[0].slices[0]),s=s.toObject(),s.generalType="TextArea",s.tag=_.cloneDeep(e.tag),s.subType="general";break;case"MySwitch":var b=[];n.texList.map(function(e){b.push(e.slices[0])}),s=new WidgetModel.models.Switch(l,c,g,u,n.info,b),s=s.toObject(),s.tag=_.cloneDeep(e.tag),s.generalType="Switch",s.subType="general",s.otherAttrs[0]=Number(n.info.bindBit);break;case"MyScriptTrigger":s=new WidgetModel.models.ScriptTrigger(l,c,g,u),s=s.toObject(),s.generalType="ScriptTrigger",s.tag=_.cloneDeep(e.tag),s.subType="general";var M="lowAlarmValue,highAlarmValue";M.split(",").forEach(function(e){s[e]=i[e]||0}),s.minValue=s.lowAlarmValue-1,s.maxValue=s.highAlarmValue+1,s.actions=n.actions;break;case"MyVideo":s=new WidgetModel.models.Video(l,c,g,u,n.texList[0].slices[0]),s=s.toObject(),s.generalType="Video","HDMI"==i.scource?s.mode=0:s.mode=1,s.tag=_.cloneDeep(e.tag),s.subType="general";break;case"MySlide":s=new WidgetModel.models.Slide(l,c,g,u,n.info,_.cloneDeep(n.texList[0].slices)),s=s.toObject(),s.generalType="Slide",s.tag=_.cloneDeep(e.tag),s.subType="general",s.actions=n.actions;break;case"MySlideBlock":var k=n.texList[1].slices[0].imgSrc,N={w:0,h:0};if(k){var D=t.getResourceFromCache(k);D&&(N.w=D.width,N.h=D.height)}s=new WidgetModel.models.SlideBlock(l,c,g,u,i.arrange,N,[n.texList[0].slices[0],n.texList[1].slices[0]]),s=s.toObject(),s.generalType="SlideBlock",s.tag=_.cloneDeep(e.tag);var M="minValue,maxValue,lowAlarmValue,highAlarmValue";M.split(",").forEach(function(e){s[e]=i[e]||0}),s.arrange="horizontal"==i.arrange?0:1,s.otherAttrs[0]=0,s.otherAttrs[1]=0,s.otherAttrs[2]=N.w,s.otherAttrs[3]=N.h,s.otherAttrs[4]=0,s.otherAttrs[5]=0,s.otherAttrs[6]=0,s.subType="general",s.actions=n.actions;break;case"MyNum":var h={};for(var f in i)switch(f){case"fontItalic":h["font-style"]=i[f];break;case"fontBold":h["font-weight"]=i[f];break;case"fontSize":h["font-size"]=i[f];break;case"fontFamily":h["font-family"]=i[f];break;case"fontColor":h["font-color"]=i[f]}s=new WidgetModel.models.Num(l,c,g,u,i,h),s=s.toObject();var M="minValue,maxValue,lowAlarmValue,highAlarmValue";switch(M.split(",").forEach(function(e){s[e]=i[e]||0}),s.mode=Number(i.numModeId),s.otherAttrs[0]=Number("NO"!=i.noInit),s.otherAttrs[1]=Number(i.frontZeroMode),s.otherAttrs[2]=Number(i.symbolMode),s.otherAttrs[3]=i.decimalCount,s.otherAttrs[4]=i.numOfDigits,s.otherAttrs[5]=Number(i.overFlowStyle),s.otherAttrs[6]=Number(i.maxFontWidth),i.align){case"left":s.otherAttrs[7]=0;break;case"center":s.otherAttrs[7]=1;break;case"right":s.otherAttrs[7]=2;break;default:s.otherAttrs[7]=1}s.otherAttrs[8]=Number(i.width),s.generalType="Num",s.tag=_.cloneDeep(e.tag),s.subType="general",s.actions=n.actions;break;case"MyTexNum":s=new WidgetModel.models.TexNum(l,c,g,u,i,n.texList[0].slices),s=s.toObject();var M="minValue,maxValue,lowAlarmValue,highAlarmValue";switch(M.split(",").forEach(function(e){s[e]=i[e]||0}),s.mode=Number(i.numModeId),s.otherAttrs[0]=Number("NO"!=i.noInit),s.otherAttrs[1]=Number(i.frontZeroMode),s.otherAttrs[2]=Number(i.symbolMode),s.otherAttrs[3]=i.decimalCount,s.otherAttrs[4]=i.numOfDigits,s.otherAttrs[5]=Number(i.overFlowStyle),s.otherAttrs[6]=Number(i.characterW),s.otherAttrs[7]=Number(i.characterH),s.otherAttrs[8]=Number(i.width),i.align){case"left":s.otherAttrs[9]=0;break;case"center":s.otherAttrs[9]=1;break;case"right":s.otherAttrs[9]=2;break;default:s.otherAttrs[9]=1}s.generalType="TexNum",s.tag=_.cloneDeep(e.tag),s.subType="general",s.actions=n.actions;break;case"MyRotaryKnob":s=new WidgetModel.models.RotaryKnob(l,c,g,u,i,n.texList),s=s.toObject();var M="minValue,maxValue";M.split(",").forEach(function(e){s[e]=i[e]||0}),console.log("info",i),s.otherAttrs[1]=0,s.otherAttrs[2]=g/2,s.otherAttrs[3]=u/2,s.otherAttrs[4]=0,s.otherAttrs[5]=0,s.otherAttrs[6]=0,s.generalType="RotaryKnob",s.tag=_.cloneDeep(e.tag),s.subType="general",s.actions=n.actions,console.log("generalWidget",s);break;case"MySelector":for(var L=n.texList[1].slices,C=[],T=0,V=L.length;T<V;T++)C[T]={},C[T].color=L[T].color,C[T].text=L[T].text,C[T].img=t.getResourceFromCache(L[T].imgSrc);L=n.texList[2].slices;for(var W=[],T=0,V=L.length;T<V;T++)W[T]={},W[T].color=L[T].color,W[T].text=L[T].text,W[T].img=t.getResourceFromCache(L[T].imgSrc);var O=i.itemFont.fontItalic+" "+i.itemFont.fontBold+" "+i.itemFont.fontSize+'px "'+i.itemFont.fontFamily+'"',F=i.selectorFont.fontItalic+" "+i.selectorFont.fontBold+" "+i.selectorFont.fontSize+'px "'+i.selectorFont.fontFamily+'"',j=A(i.selectorWidth,i.selectorHeight*i.itemCount,i.selectorHeight,W,F,i.selectorFont.fontColor),B=A(i.itemWidth,i.itemHeight*i.itemCount,i.itemHeight,C,O,i.itemFont.fontColor),R="selector"+(++x).toString()+".png",z="selector"+(++x).toString()+".png",H={id:R,name:"selectedImg",type:"image/png",src:j.src},E={id:z,name:"unSelectedImg",type:"image/png",src:B.src},U=function(e,t){"error"===e.type?(toastr.warning("资源加载失败: "+t.name),t.complete=!1):t.complete=!0}.bind(this);v("selector001")||t.cacheFile(H,globalResources,null,U),v("selector002")||t.cacheFile(E,globalResources,null,U);var P="/"+R;w(R,P);var K="/"+z;w(z,K),s=new WidgetModel.models.Selector(l,c,g,u,i,n.texList[0].slices[0],K,P,n.texList[3].slices[0]),s=s.toObject(),s.otherAttrs[0]=Number("NO"!=i.noInit),s.otherAttrs[1]=Number(i.curValue),s.otherAttrs[2]=Number(i.itemCount),s.otherAttrs[3]=Number(i.itemShowCount),s.otherAttrs[4]=Number(i.width),s.otherAttrs[5]=Number(i.height),s.otherAttrs[6]=Number(i.itemWidth),s.otherAttrs[7]=Number(i.itemHeight),s.otherAttrs[8]=Number(i.selectorWidth),s.otherAttrs[9]=Number(i.selectorHeight),s.otherAttrs[10]=0,s.generalType="Selector",s.tag=_.cloneDeep(e.tag),s.subType="general",s.actions=n.actions;break;case"MyDateTime":var h={},G=0;for(var f in i)switch(f){case"fontItalic":h["font-style"]=i[f];break;case"fontBold":h["font-weight"]=i[f];break;case"fontSize":h["font-size"]=i[f];break;case"fontFamily":h["font-family"]=i[f];break;case"fontColor":h["font-color"]=i[f]}switch(s=new WidgetModel.models.DateTime(l,c,g,u,n.info,h,n.texList[0].slices[0]),s=s.toObject(),s.generalType="DateTime",s.subType="general",s.actions=n.actions,s.mode=n.info.dateTimeModeId,"0"==s.mode||"1"==s.mode?s.tag=_.cloneDeep(e.tag)||"时钟变量时分秒":s.tag=_.cloneDeep(e.tag)||"时钟变量年月日",Number(n.info.dateTimeModeId)){case 0:G=8;break;case 1:G=5;break;case 2:case 3:G=10;break;default:G=8}s.otherAttrs[0]=G,s.otherAttrs[1]=0;break;default:n.subType=e.type,s=n}s.id=a+"."+r,s.type="widget"}return s}function g(e,t){for(var r=0;r<t.length;r++){u(e,t[r])}}function u(e,t){t in e&&(e[t]=WidgetModel.WidgetCommandParser.complier.transformer.trans(WidgetModel.WidgetCommandParser.complier.parser.parse(e[t]),!0).map(function(e){return e.cmd}))}function m(e,t,r){for(var o=0;o<r.length;o++){var a=r[o];"object"==typeof e[a]?t[a]=_.cloneDeep(e[a]):t[a]=e[a]}}function d(e){var t=[],r={r:0,g:0,b:0,a:0};if(-1!==e.indexOf("rgba"))t=e.split(/[\(|\)]/)[1].split(",").map(function(e){return Number(e)}),r={r:t[0],g:t[1],b:t[2],a:255*t[3]};else{if(-1===e.indexOf("rgb"))throw new Error("parsing color error: "+e);t=e.split(/[\(|\)]/)[1].split(","),r={r:t[0],g:t[1],b:t[2],a:255}}return r}function h(e){var t={};t.DSFlag="base",t.projectId=e.projectId,t.version=e.version,t.name=e.name||"default project",t.author=e.author||"author",t.CANId=e.CANId,t.lastSaveTimeStamp=e.lastSaveTimeStamp,t.lastSaveUUID=e.lastSaveUUID,t.size=e.currentSize;var r=e.pages;t.pages=[];for(var o=0;o<r.length;o++)t.pages.push(f(r[o]));return t}function f(e){var t={};m(e,t,["id","name","url","type","mode","selected","expand","current","currentFablayer","backgroundImage","backgroundColor","triggers","actions","tag","transition"]),o(t);var r=e.layers;t.layers=[];for(var a=0;a<r.length;a++)t.layers.push(p(r[a]));return t}function p(e){var t={};m(e,t,["id","name","url","type","zIndex","info","selected","current","expand","actions","animations","transition"]),t.w=e.info.width,t.h=e.info.height,t.x=e.info.left,t.y=e.info.top;var r=e.subLayers;t.subLayers=[];for(var o=0;o<r.length;o++){var a=r[o];e.showSubLayer.id==a&&(t.curSubCanvasIdx=o),t.subLayers.push(b(a))}return t}function b(e){var t={};m(e,t,["id","name","url","type","selected","expand","current","tag","actions","zIndex","backgroundImage","backgroundColor"]);var r=e.widgets;t.widgets=[];for(var o=0;o<r.length;o++){var a=r[o];t.widgets.push(y(a))}return t}function y(e){return _.cloneDeep(e)}function A(e,t,r,o,a,n){var s=document.createElement("canvas");s.width=e,s.height=t;for(var i=s.getContext("2d"),l=0;l<o.length;l++)o[l].color&&(i.fillStyle=o[l].color,i.fillRect(0,r*l,e,r)),o[l].img&&i.drawImage(o[l].img,0,r*l,e,r),o[l].text&&(i.font=a,i.fillStyle=n,i.textAlign="center",i.textBaseline="middle",i.fillText(o[l].text,e/2,r*l+r/2));var c=new Image;return c.src=s.toDataURL("image/png"),c}function v(e){for(var t=0;t<globalResources.length;t++)if(e===globalResources[t].id)return!0;return!1}function w(e,t){for(var r=0;r<globalResources.length;r++)if(e===globalResources[r].id)return globalResources[r].src=t,!0;return!1}this.transDataFile=n;var x=0;this.transDateFileBase=h}]);