ideServices.service("ProjectTransformService",["Type",function(e){function t(e,t){return actionCompiler.transformer.trans(actionCompiler.parser.parse(e),t)}function r(e,r){if(r=r||!0,e&&e.actions&&e.actions.length)for(var o=0;o<e.actions.length;o++){var a=e.actions[o];a.commands=t(a.commands,r)}}function o(){var e=["onInitialize","onMouseUp","onMouseDown","onTagChange"],t={},r=WidgetModel.models,o=_.cloneDeep(WidgetCommands);console.log("models",r);for(var a in r)if(r.hasOwnProperty(a)){var n=_.cloneDeep(r[a].prototype.commands);d(n,e),t[a]=n}console.log("registered commands",t);var s={};for(var a in o)if(s[a]={},o.hasOwnProperty(a)){modelObj=o[a];for(var i=0;i<e.length;i++){var l=e[i];l in modelObj&&(modelObj[l]=ASTTransformer.transAST(widgetCompiler.parse(modelObj[l])),g(modelObj,l),s[a][l]=cppWidgetCommandTranslator.transJSWidgetCommands(modelObj[l]))}}return console.log("testModels",o),console.log("cppModels",s),{commands:o,cppModels:s}}function a(e){var t={};t.version=e.version,t.name=e.name||"default project",t.author=e.author||"author",t.size=e.currentSize;var r=o();t.generalWidgetCommands=r.commands,t.cppWidgetCommands=r.cppModels,t.pageList=[];for(var a=0;a<e.pages.length;a++)t.pageList.push(n(e.pages[a],a));return t}function n(t,o){var a={};a.id=""+o,a.type=e.MyPage,c(t,a,["name","backgroundImage","backgroundColor","triggers","actions","tag","transition"]),r(a),a.canvasList=[];for(var n=0;n<t.layers.length;n++)a.canvasList.push(s(t.layers[n],n,a.id));return a}function s(t,o,a){var n={};n.id=a+"."+o,n.type=e.MyLayer,c(t,n,["name","triggers","actions","tag","zIndex","animations","transition"]),r(n),n.w=t.info.width,n.h=t.info.height,n.x=t.info.left,n.y=t.info.top,n.subCanvasList=[];for(var s=0;s<t.subLayers.length;s++){var l=t.subLayers[s];t.showSubLayer.id==l&&(n.curSubCanvasIdx=s),n.subCanvasList.push(i(l,s,n.id))}return n}function i(t,o,a){var n={};n.id=a+"."+o,n.type=e.MySubLayer,c(t,n,["name","tag","actions","zIndex","backgroundImage","backgroundColor"]),r(n),n.widgetList=[];for(var s=0;s<t.widgets.length;s++){var i=t.widgets[s];n.widgetList.push(l(i,s,n.id))}return n}function l(e,t,o){var a={},n={};if(a=_.cloneDeep(e),r(a),"general"==a.type){var s=a.info,i=s.left,l=s.top,d=s.width,g=s.height;n=new WidgetModel.models.Button(i,l,d,g,"button",null,a.texList[0].slices),n=n.toObject(),n.generalType="Button",n.id=o+"."+t,n.type="widget",n.tag=e.tag,n.subType="general"}else{var s=a.info,i=s.left,l=s.top,d=s.width,g=s.height;switch(a.type){case"MyButton":n=new WidgetModel.models.Button(i,l,d,g,"button",null,a.texList[0].slices),n=n.toObject(),n.generalType="Button",n.mode=Number(e.buttonModeId),n.tag=_.cloneDeep(e.tag),n.subType="general",n.actions=a.actions;break;case"MyButtonGroup":var c=[];a.texList.map(function(e){c.push(e.slices[0]),c.push(e.slices[1])}),n=new WidgetModel.models.ButtonGroup(i,l,d,g,a.info.count||1,"horizontal"==a.info.arrange?0:1,a.info.interval||0,c),n=n.toObject(),n.tag=_.cloneDeep(e.tag),n.generalType="ButtonGroup",n.subType="general",n.actions=a.actions;break;case"MyDashboard":n=new WidgetModel.models.Dashboard(i,l,d,g,a.dashboardModeId,a.texList,a.info),n=n.toObject(),n.generalType="Dashboard",n.mode=Number(e.dashboardModeId),n.tag=_.cloneDeep(e.tag),n.subType="general";var h="minValue,maxValue,minAngle,maxAngle,lowAlarmValue,highAlarmValue";h.split(",").forEach(function(e){n[e]=s[e]||0}),n.otherAttrs[0]=s.offsetValue||0,n.otherAttrs[1]=Number(s.clockwise),n.actions=a.actions;break;case"MyProgress":var c=[];a.texList.map(function(e){c.push(e.slices[0])}),n=new WidgetModel.models.Progress(i,l,d,g,a.info,c),n=n.toObject(),n.tag=_.cloneDeep(e.tag),n.mode=Number(e.info.progressModeId),n.minValue=Number(e.info.minValue),n.maxValue=Number(e.info.maxValue),n.actions=a.actions,n.generalType="Progress",n.subType="general";var m;if(1==n.mode?(m=u(c[1].color),n.otherAttrs[0]=m.r,n.otherAttrs[1]=m.g,n.otherAttrs[2]=m.b,n.otherAttrs[3]=m.a,m=u(c[2].color),n.otherAttrs[4]=m.r,n.otherAttrs[5]=m.g,n.otherAttrs[6]=m.b,n.otherAttrs[7]=m.a):3==n.mode&&(n.otherAttrs[0]=a.info.thresholdModeId,n.otherAttrs[1]=a.info.threshold1,n.otherAttrs[2]=a.info.threshold2,m=u(c[1].color),n.otherAttrs[3]=m.r,n.otherAttrs[4]=m.g,n.otherAttrs[5]=m.b,n.otherAttrs[6]=m.a,m=u(c[2].color),n.otherAttrs[7]=m.a,n.otherAttrs[8]=m.g,n.otherAttrs[9]=m.b,n.otherAttrs[10]=m.a,2==a.info.thresholdModeId&&(m=u(c[3].color),n.otherAttrs[11]=m.a,n.otherAttrs[12]=m.g,n.otherAttrs[13]=m.b,n.otherAttrs[14]=m.a)),n.otherAttrs[19]=Number(e.info.cursor),"1"==e.info.cursor){var p=c[c.length-1].imgSrc;if(p){var f=new Image;if(f.src=p,f.complete){n.layers[2].width=f.width,n.layers[2].height=f.height;var b=n.layers[0].height,l=parseInt((b-f.height)/2);n.layers[2].y=l}else f.onload=function(){n.layers[2].width=f.width,n.layers[2].height=f.height;var e=n.layers[0].height,t=parseInt((e-f.height)/2);n.layers[2].y=t}}}break;case"MyRotateImg":n=new WidgetModel.models.RotateImg(i,l,d,g,a.texList[0].slices[0]),n=n.toObject(),n.generalType="RotateImg",n.tag=_.cloneDeep(e.tag),n.subType="general";var h="minValue,maxValue";h.split(",").forEach(function(e){n[e]=s[e]||0}),n.actions=a.actions;break;case"MyTextArea":var y={};"fontFamily,fontSize,fontColor,fontBold,fontItalic,fontUnderline".split(",").forEach(function(e){y[e]=s[e]}),n=new WidgetModel.models.TextArea(i,l,d,g,s.text,y,a.texList[0].slices[0]),n=n.toObject(),n.generalType="TextArea",n.tag=_.cloneDeep(e.tag),n.subType="general";break;default:a.subType=e.type,n=a}n.id=o+"."+t,n.type="widget"}return n}function d(e,t){for(var r=0;r<t.length;r++){g(e,t[r])}}function g(e,t){t in e&&(e[t]=WidgetModel.WidgetCommandParser.complier.transformer.trans(WidgetModel.WidgetCommandParser.complier.parser.parse(e[t]),!0).map(function(e){return e.cmd}))}function c(e,t,r){for(var o=0;o<r.length;o++){var a=r[o];"object"==typeof e[a]?t[a]=_.cloneDeep(e[a]):t[a]=e[a]}}function u(e){var t=[],r={r:0,g:0,b:0,a:0};if(-1!==e.indexOf("rgba"))t=e.split(/[\(|\)]/)[1].split(",").map(function(e){return Number(e)}),r={r:t[0],g:t[1],b:t[2],a:255*t[3]};else{if(-1===e.indexOf("rgb"))throw new Error("parsing color error: "+e);t=e.split(/[\(|\)]/)[1].split(","),r={r:t[0],g:t[1],b:t[2],a:255}}return r}this.transDataFile=a}]);