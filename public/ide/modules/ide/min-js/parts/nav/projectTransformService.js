ideServices.service("ProjectTransformService",["Type",function(e){function t(e,t){return actionCompiler.transformer.trans(actionCompiler.parser.parse(e),t)}function o(e,o){if(o=o||!0,e&&e.actions&&e.actions.length)for(var r=0;r<e.actions.length;r++){var a=e.actions[r];a.commands=t(a.commands,o)}}function r(){var e=["onInitialize","onMouseUp","onMouseDown","onTagChange"],t={},o=WidgetModel.models,r=_.cloneDeep(WidgetCommands);console.log("models",o);for(var a in o)if(o.hasOwnProperty(a)){var n=_.cloneDeep(o[a].prototype.commands);c(n,e),t[a]=n}console.log("registered commands",t);var s={};for(var a in r)if(s[a]={},r.hasOwnProperty(a)){modelObj=r[a];for(var i=0;i<e.length;i++){var l=e[i];l in modelObj&&(modelObj[l]=ASTTransformer.transAST(widgetCompiler.parse(modelObj[l])),d(modelObj,l),s[a][l]=cppWidgetCommandTranslator.transJSWidgetCommands(modelObj[l]))}}return console.log("testModels",r),console.log("cppModels",s),{commands:r,cppModels:s}}function a(e){var t={};t.version=e.version,t.name=e.name||"default project",t.author=e.author||"author",t.size=e.currentSize;var o=r();t.generalWidgetCommands=o.commands,t.cppWidgetCommands=o.cppModels,t.pageList=[];for(var a=0;a<e.pages.length;a++)t.pageList.push(n(e.pages[a],a));return t}function n(t,r){var a={};a.id=""+r,a.type=e.MyPage,g(t,a,["name","backgroundImage","backgroundColor","triggers","actions","tag","transition"]),o(a),a.canvasList=[];for(var n=0;n<t.layers.length;n++)a.canvasList.push(s(t.layers[n],n,a.id));return a}function s(t,r,a){var n={};n.id=a+"."+r,n.type=e.MyLayer,g(t,n,["name","triggers","actions","tag","zIndex","animations","transition"]),o(n),n.w=t.info.width,n.h=t.info.height,n.x=t.info.left,n.y=t.info.top,n.subCanvasList=[];for(var s=0;s<t.subLayers.length;s++){var l=t.subLayers[s];t.showSubLayer.id==l&&(n.curSubCanvasIdx=s),n.subCanvasList.push(i(l,s,n.id))}return n}function i(t,r,a){var n={};n.id=a+"."+r,n.type=e.MySubLayer,g(t,n,["name","tag","actions","zIndex","backgroundImage","backgroundColor"]),o(n),n.widgetList=[];for(var s=0;s<t.widgets.length;s++){var i=t.widgets[s];n.widgetList.push(l(i,s,n.id))}return n}function l(e,t,r){var a={},n={};if(a=_.cloneDeep(e),o(a),"general"==a.type){var s=a.info,i=s.left,l=s.top,c=s.width,d=s.height;n=new WidgetModel.models.Button(i,l,c,d,"button",null,a.texList[0].slices),n=n.toObject(),n.generalType="Button",n.id=r+"."+t,n.type="widget",n.tag=e.tag,n.subType="general"}else{var s=a.info,i=s.left,l=s.top,c=s.width,d=s.height;switch(a.type){case"MyButton":n=new WidgetModel.models.Button(i,l,c,d,"button",null,a.texList[0].slices),n=n.toObject(),n.generalType="Button",n.mode=Number(e.buttonModeId),n.tag=_.cloneDeep(e.tag),n.subType="general",n.actions=a.actions;break;case"MyButtonGroup":var g=[];a.texList.map(function(e){g.push(e.slices[0]),g.push(e.slices[1])}),n=new WidgetModel.models.ButtonGroup(i,l,c,d,a.info.count||1,"horizontal"==a.info.arrange?0:1,a.info.interval||0,g),n=n.toObject(),n.tag=_.cloneDeep(e.tag),n.generalType="ButtonGroup",n.subType="general",n.actions=a.actions;break;case"MyDashboard":n=new WidgetModel.models.Dashboard(i,l,c,d,a.dashboardModeId,a.texList,a.info),n=n.toObject(),n.generalType="Dashboard",n.mode=Number(e.dashboardModeId),n.tag=_.cloneDeep(e.tag),n.subType="general";var h="minValue,maxValue,minAngle,maxAngle,lowAlarmValue,highAlarmValue";h.split(",").forEach(function(e){n[e]=s[e]||0}),n.otherAttrs[0]=s.offsetValue||0,n.otherAttrs[1]=Number(s.clockwise),n.actions=a.actions;break;case"MyProgress":var g=[];a.texList.map(function(e){g.push(e.slices[0])}),n=new WidgetModel.models.Progress(i,l,c,d,a.info,g),n=n.toObject(),n.tag=_.cloneDeep(e.tag),n.mode=Number(e.info.progressModeId),n.minValue=Number(e.info.minValue),n.maxValue=Number(e.info.maxValue),n.actions=a.actions,n.generalType="Progress",n.subType="general";var m;if(1==n.mode?(m=u(g[1].color),n.otherAttrs[0]=m.r,n.otherAttrs[1]=m.g,n.otherAttrs[2]=m.b,n.otherAttrs[3]=m.a,m=u(g[2].color),n.otherAttrs[4]=m.r,n.otherAttrs[5]=m.g,n.otherAttrs[6]=m.b,n.otherAttrs[7]=m.a):3==n.mode&&(n.otherAttrs[0]=a.info.thresholdModeId,n.otherAttrs[1]=a.info.threshold1,n.otherAttrs[2]=a.info.threshold2,m=u(g[1].color),n.otherAttrs[3]=m.r,n.otherAttrs[4]=m.g,n.otherAttrs[5]=m.b,n.otherAttrs[6]=m.a,m=u(g[2].color),n.otherAttrs[7]=m.a,n.otherAttrs[8]=m.g,n.otherAttrs[9]=m.b,n.otherAttrs[10]=m.a,2==a.info.thresholdModeId&&(m=u(g[3].color),n.otherAttrs[11]=m.a,n.otherAttrs[12]=m.g,n.otherAttrs[13]=m.b,n.otherAttrs[14]=m.a)),n.otherAttrs[19]=Number(e.info.cursor),"1"==e.info.cursor){var p=g[g.length-1].imgSrc;if(p){var f,b,y=new Image;y.src=p,y.complete?(n.layers[2].width=y.width,n.layers[2].height=y.height,f=n.layers[0].height,b=parseInt((f-y.height)/2),n.layers[2].y=b):y.onload=function(){n.layers[2].width=y.width,n.layers[2].height=y.height,f=n.layers[0].height,b=parseInt((f-y.height)/2),n.layers[2].y=b}}}break;case"MyRotateImg":n=new WidgetModel.models.RotateImg(i,l,c,d,a.texList[0].slices[0]),n=n.toObject(),n.generalType="RotateImg",n.tag=_.cloneDeep(e.tag),n.subType="general";var h="minValue,maxValue";h.split(",").forEach(function(e){n[e]=s[e]||0}),n.actions=a.actions;break;case"MyTextArea":var v="fontFamily,fontSize,fontColor,fontBold,fontItalic,fontUnderline",A={};v.split(",").forEach(function(e){A[e]=s[e]}),n=new WidgetModel.models.TextArea(i,l,c,d,s.text,A,a.texList[0].slices[0]),n=n.toObject(),n.generalType="TextArea",n.tag=_.cloneDeep(e.tag),n.subType="general";break;case"MySwitch":var g=[];a.texList.map(function(e){g.push(e.slices[0])}),n=new WidgetModel.models.Switch(i,l,c,d,a.info,g),n=n.toObject(),n.tag=_.cloneDeep(e.tag),n.generalType="Switch",n.subType="general",n.otherAttrs[0]=Number(a.info.bindBit);break;case"MyScriptTrigger":n=new WidgetModel.models.ScriptTrigger(i,l,c,d),n=n.toObject(),n.generalType="ScriptTrigger",n.tag=_.cloneDeep(e.tag),n.subType="general";var h="lowAlarmValue,highAlarmValue";h.split(",").forEach(function(e){n[e]=s[e]||0});break;case"MyVideo":n=new WidgetModel.models.Video(i,l,c,d,a.texList[0].slices[0]),n=n.toObject(),n.generalType="Video","HDMI"==s.scource?n.mode=0:n.mode=1,n.tag=_.cloneDeep(e.tag),n.subType="general";break;case"MySlide":n=new WidgetModel.models.Slide(i,l,c,d,a.info,_.cloneDeep(a.texList[0].slices)),n=n.toObject(),n.generalType="Slide",n.tag=_.cloneDeep(e.tag),n.subType="general",n.actions=a.actions;break;case"MyNum":var v="fontFamily,fontSize,fontColor,fontBold,fontItalic,fontUnderline",A={};v.split(",").forEach(function(e){A[e]=s[e]}),n=new WidgetModel.models.Num(i,l,c,d,s,A),n=n.toObject();var h="minValue,maxValue,lowAlarmValue,highAlarmValue";switch(h.split(",").forEach(function(e){n[e]=s[e]||0}),n.mode=Number(s.numModeId),n.otherAttrs[0]=Number("NO"!=s.noInit),n.otherAttrs[1]=Number(s.frontZeroMode),n.otherAttrs[2]=Number(s.symbolMode),n.otherAttrs[3]=s.decimalCount,n.otherAttrs[4]=s.numOfDigits,n.otherAttrs[5]=Number(s.overFlowStyle),n.otherAttrs[6]=Number(s.maxFontWidth),s.align){case"left":n.otherAttrs[7]=0;break;case"center":n.otherAttrs[7]=1;break;case"right":n.otherAttrs[7]=2;break;default:n.otherAttrs[7]=1}n.generalType="Num",n.tag=_.cloneDeep(e.tag),n.subType="general",n.actions=a.actions,console.log(n);break;default:a.subType=e.type,n=a}n.id=r+"."+t,n.type="widget"}return n}function c(e,t){for(var o=0;o<t.length;o++){d(e,t[o])}}function d(e,t){t in e&&(e[t]=WidgetModel.WidgetCommandParser.complier.transformer.trans(WidgetModel.WidgetCommandParser.complier.parser.parse(e[t]),!0).map(function(e){return e.cmd}))}function g(e,t,o){for(var r=0;r<o.length;r++){var a=o[r];"object"==typeof e[a]?t[a]=_.cloneDeep(e[a]):t[a]=e[a]}}function u(e){var t=[],o={r:0,g:0,b:0,a:0};if(-1!==e.indexOf("rgba"))t=e.split(/[\(|\)]/)[1].split(",").map(function(e){return Number(e)}),o={r:t[0],g:t[1],b:t[2],a:255*t[3]};else{if(-1===e.indexOf("rgb"))throw new Error("parsing color error: "+e);t=e.split(/[\(|\)]/)[1].split(","),o={r:t[0],g:t[1],b:t[2],a:255}}return o}this.transDataFile=a}]);