ide.controller("NavCtrl",["$scope","$timeout","GlobalService","NavService","saveProjectModal","ProjectService","TemplateProvider","ProjectFileManage","Type","CanvasService","$uibModal","OperateQueService","TagService","ResourceService","TimerService","$http","ProjectTransformService","RenderSerive","LinkPageWidgetsService","NavModalCANConfigService",function(e,t,o,a,n,r,s,i,c,l,u,d,f,g,p,y,h,m,w,b){function S(){r.getProjectTo(e),e.$on("NavStatusChanged",O),e.$on("OpenSimulator",e.component.tool.play)}function v(){window.spinner&&(window.spinner.setBackgroundColor("rgba(0,0,0,0.5)"),window.spinner.show({progress:!1}))}function L(){window.spinner&&window.spinner.hide()}function M(){e.$emit("ChangeShownArea",0)}function j(){e.$emit("ChangeShownArea",1)}function C(){e.$emit("ChangeShownArea",2)}function A(){var e=document.getElementById("c"),t=document.getElementById("backgroundCanvas"),o=document.getElementById("c1");e.style.cssText="transform:rotate(270deg);left:0;top:0",t.style.cssText="transform:rotate(270deg);left:0;top:0",o.style.cssText="transform:rotate(270deg);left:0;top:0"}function N(){var e=document.getElementById("c"),t=document.getElementById("backgroundCanvas"),o=document.getElementById("c1");e.style.cssText="transform:rotate(0deg);left:0;top:0",t.style.cssText="transform:rotate(0deg);left:0;top:0",o.style.cssText="transform:rotate(0deg);left:0;top:0"}function I(e,t,o,a,n,r){var s=new Image;s.src=e,s.onload=function(){var e=s.width,i=s.height,c=l.getOffCanvas();c.width=o,c.height=a;var u=c.getContext("2d");if(n){if(e>i){var d=1*i/e*o,f=(a-d)/2;u.drawImage(s,0,f,o,d)}else{var g=1*e/i*a,p=(o-g)/2;u.drawImage(s,p,0,g,a)}}else u.drawImage(s,0,0,o,a);"jpeg"==t[0]?r&&r(c.toDataURL("image/jpeg",t[1]||.8)):r&&r(c.toDataURL("image/png"))},s.onerror=function(){r&&r("")}}function P(t,o,a){o&&v(),r.addSaveInfo();var n=r.SaveCurrentOperate();r.changeCurrentPageIndex(0,function(){function s(){i.project.resourceList=g.getAllResource(),i.project.customTags=f.getAllCustomTags(),i.project.timerTags=f.getAllTimerTags(),i.project.timers=f.getTimerNum(),i.project.version=window.ideVersion,i.project.CANId=b.getCANId();var a=i.project;I(_.cloneDeep(a.pages[0].url),["jpeg"],200,200,!0,function(s){_.forEach(a.pages,function(e){e.url="",_.forEach(e.layers,function(e){e.url="",e.showSubLayer.url="",_.forEach(e.subLayers,function(e){e.url=""})})}),window.local?function(t,o){var n=new Buffer(t.split(",")[1],"base64"),r=e.project.projectUrl||le.join(de,"localproject",a.projectId),s=le.join(r,"thumbnail.jpg");try{ue.writeFileSync(s,n),o&&o()}catch(e){o&&o(e)}}(s,function(){var s=g.getProjectUrl(),i=le.join(s,"project.json"),c=le.join(s,"resources"),l=a.resourceList&&a.resourceList.map(function(e){return e.id});try{var u=JSON.parse(ue.readFileSync(i));u.lastModifiedTime=(new Date).toLocaleString(),u.thumbnail=le.join(s,"thumbnail.jpg"),u.content=JSON.stringify(a),u.backups&&u.backups instanceof Array||(u.backups=[]),u.backups.length>=5&&u.backups.shift(),u.backups.push({time:new Date,content:u.content}),ue.readdir(c,function(e,t){if(e)console.log("err in read files",e);else if(t&&t.length){var o=_.difference(t,l);o.map(function(e){var t=le.join(c,e);ue.stat(t,function(e,o){o&&o.isFile()&&ue.unlink(t)})})}}),ue.writeFileSync(i,JSON.stringify(u)),toastr.info("保存成功"),r.LoadCurrentOperate(n,function(){e.$emit("UpdateProject");var o="/project/"+a.projectId+"/editor";history.pushState(null,"",o),t&&t()})}catch(t){toastr.warning("保存失败"),r.LoadCurrentOperate(n,function(){e.$emit("UpdateProject")})}o&&L()}):function(e,t){y({method:"POST",url:"/project/"+a.projectId+"/thumbnail",data:{thumbnail:e}}).success(function(e){console.log(e),t&&t()}).error(function(e){console.log(e),toastr.warning("上传失败")})}(s,function(){y({method:"PUT",url:"/project/"+a.projectId+"/save",data:{project:a}}).success(function(s){var i=!1;"ok"==s?(toastr.info("保存成功"),i=!0):toastr.warning("保存失败"),o&&L(),r.LoadCurrentOperate(n,function(){if(e.$emit("UpdateProject"),i){var o="/project/"+a.projectId+"/editor";void 0!==history.pushState?history.pushState(null,"",o):window.location.assign(o)}t&&t()})}).error(function(t){console.log(t),toastr.warning("保存失败"),o&&L(),r.LoadCurrentOperate(n,function(){e.$emit("UpdateProject")})})})})}var i={};r.getProjectCopyTo(i),a?V(i.project,function(e){i.project=e,s()}):s()})}function T(){var t=r.getProjectId(),o=u.open({animation:e.animationsEnabled,templateUrl:"saveAsModal.html",controller:"NavModalSaveAsCtrl",size:"md",resolve:{}});window.local?o.result.then(function(e){v();var o,a=g.getProjectUrl(),n=le.join(a,"project.json"),r=""+Date.now()+Math.round(1e3*(Math.random()+1)),s=new RegExp(String(t),"g"),i=le.join(de,"localproject"),c=se(n,!0);c=c.replace(s,r),o=JSON.parse(c),e.saveAsName?o.name=e.saveAsName:o.name=o.name+"副本",e.saveAsAuthor&&(o.author=e.saveAsAuthor),e.saveAsResolution&&(o.content=k(e.saveAsResolution,o.resolution,o.content),o.resolution=e.saveAsResolution),o.createTime=(new Date).toLocaleString(),o.lastModifiedTime=(new Date).toLocaleString();var l=le.join(i,r);fe.emptyDir(l,function(e){e&&(console.log(e),toastr.error("另存为出错")),console.log(a,l),fe.copy(a,l,function(e){e&&(console.error(e),toastr.error("另存为出错")),fe.writeFile(le.join(l,"project.json"),JSON.stringify(o),function(e){e&&(console.log(e),toastr.error("另存为出错")),L(),toastr.info("另存为成功!"),window.opener.location.reload()})})})}):o.result.then(function(e){v(),y({method:"POST",url:"/project/"+t+"/saveAs",data:e}).success(function(e){console.log("data",e),"ok"==e&&(L(),toastr.info("另存为成功"),window.opener&&window.opener.location.reload())}).error(function(e){console.log(e),toastr.info("另存为失败"),L()})},function(e){})}function k(e,t,o){var a=e.split("*")[0]/t.split("*")[0],n=e.split("*")[1]/t.split("*")[1],o=JSON.parse(o);for(var r in o.pages)if(o.pages[r].layers)for(var s in o.pages[r].layers){if(o.pages[r].layers[s].info.width=Math.round(o.pages[r].layers[s].info.width*a),o.pages[r].layers[s].info.height=Math.round(o.pages[r].layers[s].info.height*n),o.pages[r].layers[s].info.left=Math.round(o.pages[r].layers[s].info.left*a),o.pages[r].layers[s].info.top=Math.round(o.pages[r].layers[s].info.top*n),o.pages[r].layers[s].subLayers)for(var i in o.pages[r].layers[s].subLayers)for(var c in o.pages[r].layers[s].subLayers[i].widgets){var l=o.pages[r].layers[s].subLayers[i].widgets[c].type;o.pages[r].layers[s].subLayers[i].widgets[c].info.width=Math.round(o.pages[r].layers[s].subLayers[i].widgets[c].info.width*a),o.pages[r].layers[s].subLayers[i].widgets[c].info.height=Math.round(o.pages[r].layers[s].subLayers[i].widgets[c].info.height*n),o.pages[r].layers[s].subLayers[i].widgets[c].info.left=Math.round(o.pages[r].layers[s].subLayers[i].widgets[c].info.left*a),o.pages[r].layers[s].subLayers[i].widgets[c].info.top=Math.round(o.pages[r].layers[s].subLayers[i].widgets[c].info.top*n),"MyButton"!=l&&"MyTextArea"!=l||(o.pages[r].layers[s].subLayers[i].widgets[c].info.fontSize=Math.round(o.pages[r].layers[s].subLayers[i].widgets[c].info.fontSize*a)),"MyTexNum"==l&&(o.pages[r].layers[s].subLayers[i].widgets[c].info.characterW=Math.round(o.pages[r].layers[s].subLayers[i].widgets[c].info.characterW*a),o.pages[r].layers[s].subLayers[i].widgets[c].info.characterH=Math.round(o.pages[r].layers[s].subLayers[i].widgets[c].info.characterH*n)),"MyDateTime"!=l&&"MyNum"!=l||(o.pages[r].layers[s].subLayers[i].widgets[c].info.fontSize=Math.round(o.pages[r].layers[s].subLayers[i].widgets[c].info.fontSize*a),o.pages[r].layers[s].subLayers[i].widgets[c].info.maxFontWidth=Math.round(o.pages[r].layers[s].subLayers[i].widgets[c].info.maxFontWidth*a)),"MySelector"!=l&&"MySelector"!=l||(o.pages[r].layers[s].subLayers[i].widgets[c].info.itemFont.fontSize=Math.round(o.pages[r].layers[s].subLayers[i].widgets[c].info.itemFont.fontSize*a),o.pages[r].layers[s].subLayers[i].widgets[c].info.selectorFont.fontSize=Math.round(o.pages[r].layers[s].subLayers[i].widgets[c].info.selectorFont.fontSize*a),o.pages[r].layers[s].subLayers[i].widgets[c].info.selectorWidth=Math.round(o.pages[r].layers[s].subLayers[i].widgets[c].info.selectorWidth*a),o.pages[r].layers[s].subLayers[i].widgets[c].info.selectorHeight=Math.round(o.pages[r].layers[s].subLayers[i].widgets[c].info.selectorHeight*a),o.pages[r].layers[s].subLayers[i].widgets[c].info.itemWidth=Math.round(o.pages[r].layers[s].subLayers[i].widgets[c].info.itemWidth*a),o.pages[r].layers[s].subLayers[i].widgets[c].info.itemHeight=Math.round(o.pages[r].layers[s].subLayers[i].widgets[c].info.itemHeight*a)),"MyDashboard"==l&&(o.pages[r].layers[s].subLayers[i].widgets[c].info.pointerLength=Math.round(o.pages[r].layers[s].subLayers[i].widgets[c].info.pointerLength*a))}if(o.pages[r].layers[s].showSubLayer)for(var u in o.pages[r].layers[s].showSubLayer.widgets){var d=o.pages[r].layers[s].showSubLayer.widgets[u].type;o.pages[r].layers[s].showSubLayer.widgets[u].info.width=Math.round(o.pages[r].layers[s].showSubLayer.widgets[u].info.width*a),o.pages[r].layers[s].showSubLayer.widgets[u].info.height=Math.round(o.pages[r].layers[s].showSubLayer.widgets[u].info.height*n),o.pages[r].layers[s].showSubLayer.widgets[u].info.left=Math.round(o.pages[r].layers[s].showSubLayer.widgets[u].info.left*a),o.pages[r].layers[s].showSubLayer.widgets[u].info.top=Math.round(o.pages[r].layers[s].showSubLayer.widgets[u].info.top*n),"MyButton"!=d&&"MyTextArea"!=d||(o.pages[r].layers[s].showSubLayer.widgets[u].info.fontSize=Math.round(o.pages[r].layers[s].showSubLayer.widgets[u].info.fontSize*a)),"MyTexNum"==d&&(o.pages[r].layers[s].showSubLayer.widgets[u].info.characterW=Math.round(o.pages[r].layers[s].showSubLayer.widgets[u].info.characterW*a),o.pages[r].layers[s].showSubLayer.widgets[u].info.characterH=Math.round(o.pages[r].layers[s].showSubLayer.widgets[u].info.characterH*n)),"MyDateTime"!=d&&"MyNum"!=d||(o.pages[r].layers[s].showSubLayer.widgets[u].info.fontSize=Math.round(o.pages[r].layers[s].showSubLayer.widgets[u].info.fontSize*a),o.pages[r].layers[s].showSubLayer.widgets[u].info.maxFontWidth=Math.round(o.pages[r].layers[s].showSubLayer.widgets[u].info.maxFontWidth*a)),"MySelector"!=l&&"MySelector"!=l||(o.pages[r].layers[s].showSubLayer[i].widgets[c].info.itemFont.fontSize=Math.round(o.pages[r].layers[s].showSubLayer[i].widgets[c].info.itemFont.fontSize*a),o.pages[r].layers[s].showSubLayer[i].widgets[c].info.selectorFont.fontSize=Math.round(o.pages[r].layers[s].showSubLayer[i].widgets[c].info.selectorFont.fontSize*a),o.pages[r].layers[s].showSubLayer[i].widgets[c].info.selectorWidth=Math.round(o.pages[r].layers[s].showSubLayer[i].widgets[c].info.selectorWidth*a),o.pages[r].layers[s].showSubLayer[i].widgets[c].info.selectorHeight=Math.round(o.pages[r].layers[s].showSubLayer[i].widgets[c].info.selectorHeight*a),o.pages[r].layers[s].showSubLayer[i].widgets[c].info.itemWidth=Math.round(o.pages[r].layers[s].showSubLayer[i].widgets[c].info.itemWidth*a),o.pages[r].layers[s].showSubLayer[i].widgets[c].info.itemHeight=Math.round(o.pages[r].layers[s].showSubLayer[i].widgets[c].info.itemHeight*a)),"MyDashboard"==d&&(o.pages[r].layers[s].showSubLayer.widgets[u].info.pointerLength=Math.round(o.pages[r].layers[s].showSubLayer.widgets[u].info.pointerLength*a))}if(o.pages[r].layers[s].animations)for(var f in o.pages[r].layers[s].animations)o.pages[r].layers[s].animations[f].animationAttrs.translate.srcPos.x=Math.round(o.pages[r].layers[s].animations[f].animationAttrs.translate.srcPos.x*a),o.pages[r].layers[s].animations[f].animationAttrs.translate.srcPos.y=Math.round(o.pages[r].layers[s].animations[f].animationAttrs.translate.srcPos.y*n),o.pages[r].layers[s].animations[f].animationAttrs.translate.dstPos.x=Math.round(o.pages[r].layers[s].animations[f].animationAttrs.translate.dstPos.x*a),o.pages[r].layers[s].animations[f].animationAttrs.translate.dstPos.y=Math.round(o.pages[r].layers[s].animations[f].animationAttrs.translate.dstPos.y*n)}return JSON.stringify(o)}function D(t){t!=e.component.nav.currentNav?(e.component.nav.currentNav=t,e.component.tool.toolShow=!0):e.component.tool.toolShow=!e.component.tool.toolShow,e.$emit("ChangeToolShow",e.component.tool.toolShow),e.$broadcast("ChangeToolShow",e.component.tool.toolShow)}function O(){t(function(){e.component.tool.operateQueStatus=a.getOperateQueStatus(),e.component.tool.deleteStatus=a.getDeleteStatus(),e.component.tool.layerStatus=a.getLayerStatus(),e.component.tool.widgetStatus=a.getWidgetStatus(),e.component.tool.copyStatus=a.getCopyStatus(),e.component.tool.pasteStatus=a.getPasteStatus(),e.component.tool.sublayerStatus=a.getSubLayerStatus(),e.component.tool.pageStatus=a.getPageStatus()})}function W(){if(!a.getLayerStatus())return void console.warn("不在对应模式");var o=r.SaveCurrentOperate(),n=s.getDefaultLayer();r.AddNewLayerInCurrentPage(n,function(){t(function(){e.$emit("ChangeCurrentPage",o)})})}function $(){if(a.getSubLayerStatus()){var o=r.SaveCurrentOperate(),n=s.getDefaultSubLayer();r.AddNewSubLayerInCurrentLayer(n,function(){t(function(){e.$emit("ChangeCurrentPage",o)})})}}function F(o){if(a.getWidgetStatus()){var n=r.SaveCurrentOperate(),i=null;if(0===o)i=s.getDefaultSlide();else if(2===o)i=s.getDefaultProgress();else if(3===o)i=s.getDefaultDashboard();else if(8===o)i=s.getDefaultButton();else if(10===o)i=s.getDefaultButtonGroup();else if(7===o)i=s.getDefaultTextArea();else if(6===o)i=s.getDefaultNum();else if(1===o)i=s.getDefaultSwitch();else if(4===o)i=s.getDefaultRotateImg();else if(5===o)i=s.getDefaultDateTime();else if(11===o)i=s.getDefaultScriptTrigger();else if(9===o)i=s.getDefaultSlideBlock();else if(12===o)i=s.getDefaultVideo();else if(13===o)i=s.getDefaultAnimation();else if(14===o)i=s.getDefaultTexNum();else if(15===o)i=s.getDefaultTexTime();else if(16===o)i=s.getDefaultSelector();else{if(17!==o)return;i=s.getDefaultRotaryKnob()}i.name==e.oldWidget.name?(e.oldWidget.coordinate+=20,i.info.left=e.oldWidget.coordinate,i.info.top=e.oldWidget.coordinate):(e.oldWidget.name=i.name,e.oldWidget.coordinate=0),r.AddNewWidgetInCurrentSubLayer(i,function(){toastr.info("添加Widget成功"),t(function(){e.$emit("ChangeCurrentSubLayer",n)})},function(e){})}}function R(){a.DoUndo(function(){e.$emit("Undo")})}function x(){a.DoRedo(function(){e.$emit("Redo")})}function z(t){a.DoCopy(function(){e.$emit("DoCopy"),t&&t()})}function B(){z(function(){J()})}function E(e){r.OnSelectAll(e)}function U(){E(function(){J()})}function H(){var o=r.SaveCurrentOperate();a.DoPaste(function(){t(function(){e.$emit("ChangeCurrentPage",o)})})}function J(){var o=r.SaveCurrentOperate();a.DoDelete(function(){t(function(){e.$emit("ChangeCurrentPage",o)})})}function K(){i.OpenProject(function(){})}function G(t){if("local"==t||"localCompatible"==t){var o={},a=function(){window.spinner&&(window.spinner.setBackgroundColor("rgba(0,0,0,0.5)"),v()),y({method:"POST",url:"/project/"+e.project.projectId+"/generateLocalProject"}).success(function(t,o,a){window.spinner&&window.spinner.hide(),"ok"==t?(toastr.info("生成本地版成功"),window.location.href="/project/"+e.project.projectId+"/downloadLocalProject"):toastr.error("生成失败")}).error(function(e,t,o){window.spinner&&window.spinner.hide(),toastr.error("生成失败,请尝试先保存"),console.log(e)})};r.getProjectCopyTo(o),"localCompatible"===t?P(a,!0,!0):a()}else Q(t),window?(window.spinner&&(window.spinner.setBackgroundColor("rgba(0,0,0,0.5)"),v()),m.renderProject(window.projectData,function(){toastr.info("生成成功"),window.spinner&&window.spinner.hide()},function(){toastr.info("生成失败"),window.spinner&&window.spinner.hide()})):P(function(){v(),y({method:"POST",url:"/project/"+e.project.projectId+"/generate",data:{dataStructure:window.projectData}}).success(function(t,o,a){L(),"ok"==t?(toastr.info("生成成功"),window.location.href="/project/"+e.project.projectId+"/download"):(console.log(t),toastr.info("生成失败"))}).error(function(e,t,o){L(),console.log(e),toastr.info("生成失败")})})}function Q(e){var t={};r.getProjectCopyTo(t),t.project=h.transDataFile(t.project),t.project.format=e,t.project.resourceList=_.cloneDeep(g.getAllResource()),t.project.basicUrl=g.getResourceUrl(),t.project.tagList=f.getAllTags(),t.project.timers=f.getTimerNum(),t.project.CANId=b.getCANId();for(var o=0;o<t.project.pageList.length;o++)w.linkPageAllWidgets(t.project.pageList[o]);window.projectData=t.project}function V(e,t){var o=_.cloneDeep(e),a=0,n=new fabric.Canvas("tmp1"),r=new fabric.Canvas("tmp2",{renderOnAddRemove:!1});a=0;var s,i,c=o.pages.length,l=function(){s=null,s=o.pages[a],i=a,n.setWidth(o.initSize.width),n.setHeight(o.initSize.height),n.zoomToPoint(new fabric.Point(0,0),1),void 0!==s.layers&&(s.layers.forEach(function(e,t){e.subLayers.forEach(function(t,o){r.setWidth(e.w),r.setHeight(e.h),r.zoomToPoint(new fabric.Point(0,0),1),t.widgets.forEach(function(e,t){q(e,r)}),t.proJsonStr=r.toJSON(),r.clear()}),q(e,n)}),s.backgroundImage&&""!==s.backgroundImage?n.setBackgroundImage(s.backgroundImage,function(){n.setBackgroundColor(s.backgroundColor,function(){s.proJsonStr=n.toJSON(),n.clear(),a++,a<c?l():t&&t(o)})},{width:n.getWidth(),height:n.getHeight()}):n.setBackgroundImage(null,function(){n.setBackgroundColor(s.backgroundColor,function(){s.proJsonStr=n.toJSON(),n.clear(),a++,a<c?l():t&&t(o)})}))};l()}function q(e,t,o){var a={width:e.info.width,height:e.info.height,top:e.info.top,left:e.info.left,id:e.id,lockScalingFlip:!0,hasRotatingPoint:!1,shadow:{color:"rgba(0,0,0,0.4)",blur:2}},n=function(e){t.add(e)};switch(e.type){case"MySlide":fabric.MySlide.fromLevel(e,n,a);break;case"MyProgress":fabric.MyProgress.fromLevel(e,n,a);break;case"MyDashboard":fabric.MyDashboard.fromLevel(e,n,a);break;case"MyButton":fabric.MyButton.fromLevel(e,n,a);break;case"MyButtonGroup":fabric.MyButtonGroup.fromLevel(e,n,a);break;case"MyNumber":fabric.MyNumber.fromLevel(e,n,a);break;case"MyTextArea":fabric.MyTextArea.fromLevel(e,n,a);break;case"MyKnob":fabric.MyKnob.fromLevel(e,n,a);break;case"MyOscilloscope":fabric.MyOscilloscope.fromLevel(e,n,a);break;case"MySwitch":fabric.MySwitch.fromLevel(e,n,a);break;case"MyRotateImg":fabric.MyRotateImg.fromLevel(e,n,a);break;case"MyDateTime":fabric.MyDateTime.fromLevel(e,n,a);break;case"MyScriptTrigger":fabric.MyScriptTrigger.fromLevel(e,n,a);break;case"MyVideo":fabric.MyVideo.fromLevel(e,n,a);break;case"MyAnimation":fabric.MyAnimation.fromLevel(e,n,a);break;case"MyLayer":t.add(new fabric.MyLayer(e,a));break;case"MyNum":t.add(new fabric.MyNum(e,a));break;case"MyTexNum":t.add(new fabric.MyTexNum(e,a));break;case"MyTexTime":t.add(new fabric.MyTexTime(e,a));break;case"MySelector":t.add(new fabric.MySelector(e,a));break;case"MyRotaryKnob":t.add(new fabric.MyRotaryKnob(e,a));break;default:console.error("not match widget in preprocess!")}}function Z(){Q(),window.cachedResourceList=g.getGlobalResources(),e.component.simulator.show=!0}function X(){e.component.simulator.show=!1}function Y(){}function ee(t,o){u.open({animation:e.animationsEnabled,templateUrl:"navModalCloseWindow.html",controller:"NavModalCloseWindwoCtl",size:"md",backdrop:"static",resolve:{}}).result.then(function(e){t&&t()},function(){o&&o()})}function te(){u.open({animation:e.animationsEnabled,templateUrl:"navModal.html",controller:"NavModalCtl",size:"md",resolve:{}}).result.then(function(e){G(e.format)},function(){console.log("Modal dismissed at: "+new Date)})}function oe(){var e=!1;return"true"===document.getElementById("saveFlag").value&&(e=!0),e}function ae(){console.log("share"),u.open({animation:e.animationsEnabled,templateUrl:"shareModal.html",controller:"shareModalCtl",scope:e,size:"md",resolve:{id:function(){return e.project.projectId}}}).result.then(function(e){G(e.format)},function(){})}function ne(){var t;if(window.local){var o=re("CAN").map(function(e){return JSON.parse(e)}),t=o.map(function(e){return{name:e.name,id:e._id}});u.open({animation:e.animationsEnabled,templateUrl:"navCANModal.html",controller:"NavModalCANConfig",size:"md",resolve:{data:function(){return t}}}).result.then(function(e){if(e){for(var t=null,a=0;a<o.length;a++)if(o[a]._id==e){t=JSON.parse(o[a].content);break}t?ie(e,t):toastr.error("导入失败")}else ce()},function(){})}else y({method:"GET",url:"/CANProject/names"}).success(function(o,a,n){t=o,u.open({animation:e.animationsEnabled,templateUrl:"navCANModal.html",controller:"NavModalCANConfig",size:"md",resolve:{data:function(){return t}}}).result.then(function(e){e?ie(e):ce()},function(){})}).error(function(e){console.log("err",e),toastr.warning("获取失败")})}function re(e){var t,o,a=le.join(de,"localproject","localCANProject");switch(e){case"CAN":t=a,o="CANProject.json";break;case"normal":default:t=localProjectDir,o="project.json"}var n=[];try{var r=ue.statSync(t);if(r&&r.isDirectory())for(var s=ue.readdirSync(t),i=0;i<s.length;i++){var c=le.join(t,s[i]),l=se(le.join(c,o),!0);l&&n.push(l)}}catch(e){}return n}function se(e,t){if(!t)return ue.readFileSync(e,"utf-8");try{var o=ue.statSync(e);return o&&o.isFile()?ue.readFileSync(e,"utf-8"):null}catch(e){return null}}function ie(t,o){if(window.local){var a=le.join(de,"localproject",e.project.projectId,"resources");try{if(ue.statSync(a).isDirectory()){var n=le.join(a,"CANFile.json");ue.writeFileSync(n,JSON.stringify(o,null,4)),toastr.info("导入成功")}else toastr.error("导入失败")}catch(e){toastr.error("导入失败")}}else y({method:"POST",url:"/CANProject/"+t+"/importCANFile",data:{projectId:e.project.projectId}}).success(function(e,t,o){"ok"==e&&toastr.info("导入成功")}).error(function(e,t,o){toastr.error("导入失败"),console.log("导入失败",e)})}function ce(){if(window.local){var t=le.join(de,"localproject",e.project.projectId,"resources");try{if(ue.statSync(t).isDirectory()){var o=le.join(t,"CANFile.json");ue.unlink(o,function(e){e?toastr.error("取消失败"):toastr.info("取消CAN配置")})}else toastr.error("取消失败")}catch(e){toastr.error("取消失败")}}else y({method:"POST",url:"/CANProject/"+e.project.projectId+"/deleteCANFile",data:{}}).success(function(e,t,o){"ok"==e&&toastr.info("取消CAN配置")}).error(function(e,t,o){console.log("删除失败",e)})}var le,ue,de,fe;!function(){window.local&&(le=require("path"),ue=require("fs"),fe=require("fs-extra"),de=global.__dirname)}(),function(){e.component={nav:{currentNav:-1,navs:[{name:"文件"},{name:"开始"},{name:"编辑"},{name:"格式"},{name:"视图"},{name:"帮助"}],changeNav:D},tool:{toolShow:!1,operateQueStatus:d.getOperateQueStatus(),deleteStatus:!1,sublayerStatus:!1,undo:R,redo:x,copy:z,cut:B,paste:H,selectAll:E,clearAll:U,addLayer:W,addSubLayer:$,deleteObject:J,addWidget:F,openProject:K,generateDataFile:G,play:Z,openPanel:te,openShare:ae,openCANPanel:ne,runSimulator:Y,closeSimulator:X,saveProject:P.bind(null,null,!0),saveProjectAs:T,showLeft:M,showRight:j,showBottom:C,rotateCanvasLeft:A,rotateCanvasRight:N},simulator:{show:!1}}}(),function(){if(window.local){var e=nw.Window.get(),t=!1;e.on("close",function(o){t||(t=!0,oe()?e.close(!0):(t=!0,ee(function(){P(function(){e.close(!0)}.bind(this),!0)}.bind(this),function(){e.close(!0)}.bind(this))))}.bind(this))}else window.addEventListener("beforeunload",function(e){oe()?console.log("projects have been saved"):e.returnValue="请确定已保存您的工程"})}(),e.$on("GlobalProjectReceived",function(){S(),e.$emit("LoadUp")}),e.oldWidget={name:"",coordinate:0}}]),ide.controller("NavModalCtl",["$scope","$uibModalInstance",function(e,t){e.formats=[{type:"normal",name:"默认"},{type:"dxt3",name:"压缩"}];var o={type:"local",name:"本地"},a={type:"localCompatible",name:"本地(兼容)"};window.local||(e.formats[2]=o,e.formats[3]=a),e.generateFormat="normal",e.ok=function(){t.close({format:e.generateFormat})},e.cancel=function(){t.dismiss("cancel")}}]),ide.controller("shareModalCtl",["$rootScope","$scope","$uibModalInstance","$http","id",function(e,t,o,a,n){console.log("load"),t.loading=!0,t.processing=!1,t.message="加载中...",console.log(window.location),t.sharedUrl=window.location.href,t.shareInfo={shared:!1,sharedKey:"",readOnlySharedKey:"",own:!1},function(){a({method:"GET",url:"/project/"+n+"/share"}).success(function(e,o,a){t.shareInfo.shared=e.shared,t.shareInfo.sharedKey=e.sharedKey,t.shareInfo.readOnlySharedKey=e.readOnlySharedKey,t.shareInfo.own=e.own,t.loading=!1,t.message=""}).error(function(e){console.log(e),t.loading=!1,t.message="加载出错..."})}(),t.toggleShare=function(){t.processing=!0,a({method:"POST",url:"/project/"+n+"/share",data:{share:!t.shareInfo.shared}}).success(function(e,o,a){t.shareInfo.shared=e.shared,t.shareInfo.sharedKey=e.sharedKey,t.shareInfo.readOnlySharedKey=e.readOnlySharedKey,t.processing=!1,t.message="",e.shared?t.$emit("createSocketIO"):t.$emit("closeSocketIO")}).error(function(e){console.log(e),t.processing=!1,t.message="更新出错..."})},t.cancel=function(){o.dismiss(t.shareInfo.shared)}}]),ide.controller("NavModalCloseWindwoCtl",["$scope","$uibModalInstance",function(e,t){e.ok=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}]),ide.controller("NavModalCANConfig",["$scope","$uibModalInstance","data","NavModalCANConfigService",function(e,t,o,a){e.CANInfo=o,e.selectCANId=a.getCANId(),e.ok=function(){null==e.selectCANId&&null==a.getCANId()?t.dismiss("cancel"):(a.setCANId(e.selectCANId),t.close(e.selectCANId))},e.cancel=function(){t.dismiss("cancel")}}]),ide.service("NavModalCANConfigService",[function(){var e;this.setCANId=function(t){e=t},this.getCANId=function(){return e||""}}]),ide.controller("NavModalSaveAsCtrl",["$scope","$uibModalInstance",function(e,t){function o(){try{for(var e=0;e<arguments.length;e++){if(arguments[e].match(/[^\d|A-Z|a-z|\u4E00-\u9FFF| ]/))return!1}return!0}catch(e){return!1}}function a(){var t="";if("custom"==e.selectCustomResolution){if(!e.saveAsWidth||!e.saveAsHeight)return!1;t=e.saveAsWidth+"*"+e.saveAsHeight}else t=e.selectCustomResolution;return t}e.saveAsName="",e.saveAsAuthor="",e.saveAsResolution="",e.selectCustomResolution="1280*480",e.ok=function(){var n="";if(!o(e.saveAsName,e.saveAsAuthor))return void toastr.error("名称只能是汉字、英文和数字");if(e.isScale){if(!a())return void toastr.error("分辨率范围有误");if(1!=confirm("请尽量保持与原尺寸等比例缩放，否则会导致控件变形"))return;e.selectCustomResolution=a(),n={saveAsName:e.saveAsName,saveAsAuthor:e.saveAsAuthor,saveAsResolution:e.selectCustomResolution}}else n={saveAsName:e.saveAsName,saveAsAuthor:e.saveAsAuthor};t.close(n)},e.cancel=function(){t.dismiss("cancel")}}]);