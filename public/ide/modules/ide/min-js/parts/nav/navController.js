ide.controller("NavCtrl",["$scope","$timeout","GlobalService","NavService","saveProjectModal","ProjectService","TemplateProvider","ProjectFileManage","Type","CanvasService","$uibModal","OperateQueService","TagService","ResourceService","TimerService","$http","ProjectTransformService","RenderSerive","LinkPageWidgetsService",function(e,t,o,n,a,r,i,c,l,u,s,d,f,g,p,m,w,v,S){function h(){window.local&&(Z=require("path"),ee=require("fs"),te=global.__dirname)}function j(){e.component={nav:{currentNav:-1,navs:[{name:"文件"},{name:"开始"},{name:"编辑"},{name:"格式"},{name:"视图"},{name:"帮助"}],changeNav:N},tool:{toolShow:!1,operateQueStatus:d.getOperateQueStatus(),deleteStatus:!1,sublayerStatus:!1,undo:R,redo:M,copy:k,cut:F,paste:Q,selectAll:B,clearAll:E,addLayer:I,addSubLayer:A,deleteObject:x,addWidget:U,openProject:G,generateDataFile:J,play:q,openPanel:X,runSimulator:H,closeSimulator:z,saveProject:O.bind(null,null,!0),showLeft:D,showRight:P,showBottom:L},simulator:{show:!1}}}function C(){r.getProjectTo(e),e.$on("NavStatusChanged",W)}function b(){window.spinner&&(window.spinner.setBackgroundColor("rgba(0,0,0,0.5)"),window.spinner.show())}function y(){window.spinner&&window.spinner.hide()}function D(){e.$emit("ChangeShownArea",0)}function P(){e.$emit("ChangeShownArea",1)}function L(){e.$emit("ChangeShownArea",2)}function $(){if(window.local){var e=nw.Window.get(),t=!1;e.on("close",function(o){t||(t=!0,Y()?e.close(!0):(t=!0,K(function(){O(function(){e.close(!0)}.bind(this),!0)}.bind(this),function(){e.close(!0)}.bind(this))))}.bind(this))}else window.addEventListener("beforeunload",function(e){Y()?console.log("projects have been saved"):e.returnValue="请确定已保存您的工程"})}function T(e,t,o,n,a,r){var i=new Image;i.src=e,i.onload=function(){var e=i.width,c=i.height,l=u.getOffCanvas();l.width=o,l.height=n;var s=l.getContext("2d");if(a){var d=e>c;if(d){var f=1*c/e*o,g=(n-f)/2;s.drawImage(i,0,g,o,f)}else{var p=1*e/c*n,m=(o-p)/2;s.drawImage(i,m,0,p,n)}}else s.drawImage(i,0,0,o,n);var w=t[0];"jpeg"==w?r&&r(l.toDataURL("image/jpeg",t[1]||.8)):r&&r(l.toDataURL("image/png"))},i.onerror=function(){r&&r("")}}function O(t,o){o&&b();var n=r.SaveCurrentOperate();r.changeCurrentPageIndex(0,function(){var a={};r.getProjectCopyTo(a),a.project.resourceList=g.getAllResource(),a.project.customTags=f.getAllCustomTags(),a.project.timerTags=f.getAllTimerTags(),a.project.timers=f.getTimerNum(),a.project.version=window.ideVersion;var i=a.project,c=_.cloneDeep(i.pages[0].url);T(c,["jpeg"],200,200,!0,function(a){function c(e,t){m({method:"POST",url:"/project/"+i.projectId+"/thumbnail",data:{thumbnail:e}}).success(function(e){console.log(e),t&&t()}).error(function(e){console.log(e),toastr.warning("上传失败")})}function l(t,o){console.log(t);var n=new Buffer(t.split(",")[1],"base64"),a=e.project.projectUrl||Z.join(te,"localproject",i.projectId),r=Z.join(a,"thumbnail.jpg");try{ee.writeFileSync(r,n),o&&o()}catch(e){o&&o(e)}}_.forEach(i.pages,function(e){e.url="",_.forEach(e.layers,function(e){e.url="",e.showSubLayer.url="",_.forEach(e.subLayers,function(e){e.url=""})})}),window.local?l(a,function(){var a=g.getProjectUrl(),c=Z.join(a,"project.json");try{var l=JSON.parse(ee.readFileSync(c));l.thumbnail=Z.join(a,"thumbnail.jpg"),console.log(l.thumbnail),l.content=JSON.stringify(i),ee.writeFileSync(c,JSON.stringify(l)),toastr.info("保存成功"),r.LoadCurrentOperate(n,function(){e.$emit("UpdateProject"),t&&t()})}catch(t){toastr.warning("保存失败"),r.LoadCurrentOperate(n,function(){e.$emit("UpdateProject")})}o&&y()}):c(a,function(){console.log(i),m({method:"PUT",url:"/project/"+i.projectId+"/save",data:{project:i}}).success(function(a){"ok"==a?toastr.info("保存成功"):toastr.warning("保存失败"),o&&y(),r.LoadCurrentOperate(n,function(){e.$emit("UpdateProject"),t&&t()})}).error(function(t){console.log(t),toastr.warning("保存失败"),o&&y(),r.LoadCurrentOperate(n,function(){e.$emit("UpdateProject")})})})})})}function N(t){t!=e.component.nav.currentNav?(e.component.nav.currentNav=t,e.component.tool.toolShow=!0):e.component.tool.toolShow=!e.component.tool.toolShow,e.$emit("ChangeToolShow",e.component.tool.toolShow),e.$broadcast("ChangeToolShow",e.component.tool.toolShow)}function W(){t(function(){e.component.tool.operateQueStatus=n.getOperateQueStatus(),e.component.tool.deleteStatus=n.getDeleteStatus(),e.component.tool.layerStatus=n.getLayerStatus(),e.component.tool.widgetStatus=n.getWidgetStatus(),e.component.tool.copyStatus=n.getCopyStatus(),e.component.tool.pasteStatus=n.getPasteStatus(),e.component.tool.sublayerStatus=n.getSubLayerStatus()})}function I(){if(!n.getLayerStatus())return void console.warn("不在对应模式");var o=r.SaveCurrentOperate(),a=i.getDefaultLayer();r.AddNewLayerInCurrentPage(a,function(){t(function(){e.$emit("ChangeCurrentPage",o)})})}function A(){if(n.getSubLayerStatus()){var o=r.SaveCurrentOperate(),a=i.getDefaultSubLayer();r.AddNewSubLayerInCurrentLayer(a,function(){t(function(){e.$emit("ChangeCurrentPage",o)})})}}function U(o){if(n.getWidgetStatus()){var a=r.SaveCurrentOperate(),c=null;if(0==o)c=i.getDefaultSlide();else if(2==o)c=i.getDefaultProgress();else if(3==o)c=i.getDefaultDashboard();else if(8==o)c=i.getDefaultButton();else if(10==o)c=i.getDefaultButtonGroup();else if(7==o)c=i.getDefaultTextArea();else if(6==o)c=i.getDefaultNum();else if(1==o)c=i.getDefaultSwitch();else if(4==o)c=i.getDefaultRotateImg();else if(5==o)c=i.getDefaultDateTime();else if(11==o)c=i.getDefaultScriptTrigger();else if(9==o)c=i.getDefaultSlideBlock();else{if(12!=o)return;c=i.getDefaultVideo()}c.name==e.oldWidget.name?(e.oldWidget.coordinate+=20,c.info.left=e.oldWidget.coordinate,c.info.top=e.oldWidget.coordinate):(e.oldWidget.name=c.name,e.oldWidget.coordinate=0),r.AddNewWidgetInCurrentSubLayer(c,function(){toastr.info("添加Widget成功"),t(function(){e.$emit("ChangeCurrentSubLayer",a)})},function(e){})}}function R(){n.DoUndo(function(){e.$emit("Undo")})}function M(){n.DoRedo(function(){e.$emit("Redo")})}function k(t){n.DoCopy(function(){e.$emit("DoCopy"),t&&t()})}function F(){k(function(){x()})}function B(e){r.OnSelectAll(e)}function E(){B(function(){x()})}function Q(){var o=r.SaveCurrentOperate();n.DoPaste(function(){t(function(){e.$emit("ChangeCurrentPage",o)})})}function x(){var o=r.SaveCurrentOperate();n.DoDelete(function(){t(function(){e.$emit("ChangeCurrentPage",o)})})}function G(){c.OpenProject(function(){})}function J(t){V(t),window.local?(window.spinner&&(window.spinner.setBackgroundColor("rgba(0,0,0,0.5)"),window.spinner.show()),v.renderProject(window.projectData,function(){toastr.info("生成成功"),window.spinner&&window.spinner.hide()},function(){toastr.info("生成失败"),window.spinner&&window.spinner.hide()})):O(function(){b(),m({method:"POST",url:"/project/"+e.project.projectId+"/generate",data:{dataStructure:window.projectData}}).success(function(t,o,n){y(),"ok"==t?(toastr.info("生成成功"),window.location.href="/project/"+e.project.projectId+"/download"):(console.log(t),toastr.info("生成失败"))}).error(function(e,t,o){y(),console.log(e),toastr.info("生成失败")})})}function V(e){var t={};r.getProjectCopyTo(t),t.project=w.transDataFile(t.project),t.project.format=e,t.project.resourceList=_.cloneDeep(g.getAllResource()),t.project.basicUrl=g.getResourceUrl(),t.project.tagList=f.getAllTags(),t.project.timers=f.getTimerNum();for(var o=0;o<t.project.pageList.length;o++)S.linkPageAllWidgets(t.project.pageList[o]);window.projectData=t.project}function q(){V(),window.cachedResourceList=_.cloneDeep(g.getGlobalResources()),e.component.simulator.show=!0}function z(){e.component.simulator.show=!1}function H(){}function K(t,o){var n=s.open({animation:e.animationsEnabled,templateUrl:"navModalCloseWindow.html",controller:"NavModalCloseWindwoCtl",size:"md",backdrop:"static",resolve:{}});n.result.then(function(e){t&&t()},function(){o&&o()})}function X(){var t=s.open({animation:e.animationsEnabled,templateUrl:"navModal.html",controller:"NavModalCtl",size:"md",resolve:{}});t.result.then(function(e){J(e.format)},function(){console.log("Modal dismissed at: "+new Date)})}function Y(){var e=!1;return"true"===document.getElementById("saveFlag").value&&(e=!0),e}var Z,ee,te;h(),j(),$(),e.$on("GlobalProjectReceived",function(){C(),e.$emit("LoadUp")}),e.oldWidget={name:"",coordinate:0}}]),ide.controller("NavModalCtl",["$scope","$uibModalInstance",function(e,t){e.formats=[{type:"normal",name:"默认"},{type:"dxt3",name:"压缩"}],e.generateFormat="normal",e.ok=function(){t.close({format:e.generateFormat})},e.cancel=function(){t.dismiss("cancel")}}]),ide.controller("NavModalCloseWindwoCtl",["$scope","$uibModalInstance",function(e,t){e.ok=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}]);