ideServices.service("RenderSerive",["ResourceService","Upload","$http",function(e,t,n){function r(e){var t;t=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):unescape(e.split(",")[1]);for(var n=e.split(",")[0].split(":")[1].split(";")[0],r=new Uint8Array(t.length),i=0;i<t.length;i++)r[i]=t.charCodeAt(i);return new Blob([r],{type:n})}function i(e,n,i,o,a){var s=r(e),c=function(){console.log("save tex ok"),o&&o()},l=function(e){console.log(e),a&&a()};t.upload({url:i,data:{file:s,name:n}}).then(c,l)}function o(){for(var t=e.getGlobalResources(),n={},r=0;r<t.length;r++){var i=t[r];n[i.id]=i.content}return n}function a(e,t){this.text=e,this.style=t}function s(e,t,n,r,i,o,a){this.img=e,this.color=t,this.text=n,this.outFile=r,this.w=i,this.h=o,this.slice=a}function c(e,t){this.width=e,this.height=t;var n=document.createElement("canvas");n.width=this.width,n.height=this.height,n.hidden=!0,this.canvasObj=n}function l(e){switch(e){case"jpg":case"jpeg":return"image/jpeg";case"png":return"image/png";case"bmp":return"image/bmp";default:return"image/png"}}function g(e){if(p){return"data:"+l(u.extname(e))+";base64,"+w.readFileSync(e).toString("base64")}return e}function f(e){var t=e.split("/");return t[t.length-1]}function d(e,t){this.images=e||{},window.images=this.images,this.customFonts=t||{},this.trackedRes=[]}function h(){var e,t="win32"===require("os").platform()?"win":"other",n="zip";"win"===t?(n=".\\utils\\7z\\7z.exe",e=["a"]):e=["-rj"];var r,i,o,a=function(){"win"===t&&"\\"!==i[i.length-1]&&(i+="\\*");var a=e.concat(r).concat(i),s=S(n,a);console.log("command",n,a),s.stdout.on("data",function(e){}),s.stderr.on("data",function(e){}),s.on("error",function(e){console.log(e),o(e)}),s.on("exit",function(e){0===e?o():o(new Error(e))})};this.compress=function(e,t,n){r=e,i=t,o=n,w.stat(e,function(t,n){n&&n.isFile()?w.unlink(e,function(e){e?o(e):a()}):a()})}}var u,p=!1;try{u=require("path");var w=require("fs");p=!0}catch(e){u={},u.sep="/",u.join=function(e,t){return e[e.length-1]==u.sep&&(e=e.slice(0,e.length-1)),t[0]==u.sep&&(t=t.slice(1)),e+u.sep+t}}s.prototype.equal=function(e){for(var t=["img","color","text","w","h"],n=0;n<t.length;n++){var r=t[n];if(this[r]!=e[r])return!1}return!0},c.prototype.getContext=function(e){if("2d"===e)return this.canvasObj.getContext("2d")},c.prototype.pngStream=function(){var e=this.canvasObj.toDataURL();if(p){return new Buffer(e.split(",")[1],"base64")}return e},c.prototype.toBuffer=function(){var e=this.canvasObj.toDataURL();return new Buffer(e.split(",")[1],"base64")},c.prototype.output=function(t,n){var r=this.pngStream(),o=f(t);if(p)try{w.writeFileSync(t,r),n&&n()}catch(e){n&&n(e)}else i(r,o,"/project/"+e.getResourceUrl().split("/")[2]+"/generatetex",n,n)};var m=renderingX.Size,v=renderingX.Pos;if(d.prototype.compareTrackedRes=function(e){for(var t=0;t<this.trackedRes.length;t++){if(this.trackedRes[t].eq(e))return!0}return!1},d.prototype.getTargetImage=function(e){return p?"undefined"!==this.images[e]?this.images[e]:null:this.images[f(e)]},d.prototype.addImage=function(e,t){this.images[e]=t},d.prototype.renderButton=function(e,t,n,r,i){var o=e.info;if(o){var l={},f={};f["font-style"]=e.info.fontItalic,f["font-weight"]=e.info.fontBold,f["font-size"]=e.info.fontSize,f["font-family"]=e.info.fontFamily,f["font-color"]=e.info.fontColor,l.color=f["font-color"],l.font=(f["font-style"]||"")+" "+(f["font-variant"]||"")+" "+(f["font-weight"]||"")+" "+(f["font-size"]||24)+"px "+(f["font-family"]||"arial"),l.textAlign="center",l.textBaseline="middle";var d=e.texList[0].slices,h=d.length;d.map(function(f,d){var p=new c(o.width,o.height),w=p.getContext("2d"),S=f.imgSrc;w.clearRect(0,0,o.width,o.height),w.save(),renderingX.renderColor(w,new m(o.width,o.height),new v,f.color);var y;if(""!==S){y=u.join(t,S);var x=this.getTargetImage(y);if(!x){var j=new Image;try{j.src=g(y),this.addImage(y,j),x=j}catch(e){x=null}}renderingX.renderImage(w,new m(o.width,o.height),new v,x,new v,new m(o.width,o.height))}d<2&&o.text&&renderingX.renderText(w,new m(o.width,o.height),new v,o.text,l,!0,null,this.customFonts);var b=e.id.split(".").join(""),I=b+"-"+d+".png",R=u.join(n,I);p.output(R,function(t){t?(h-=1)<=0&&i&&i(t):(this.trackedRes.push(new s(S,f.color,new a(o.text,l),I,o.width,o.height,f)),e.texList[0].slices[d].originSrc=e.texList[0].slices[d].imgSrc,e.texList[0].slices[d].imgSrc=u.join(r||"",I),(h-=1)<=0&&i&&i())}.bind(this)),w.restore()}.bind(this))}else i&&i()},d.prototype.renderButtonGroup=function(e,t,n,r,i){var o=e.info;if(o){var a=o.width,l=o.height,f=o.interval,d=o.count;"horizontal"===o.arrange?a=(a-(d-1)*f)/d:l=(l-(d-1)*f)/d;for(var h=e.texList,p=2*d,w=[],S=0;S<d;S++)for(var y=0;y<2;y++)w.push(h[S].slices[y]);h[d]&&(w.push(h[d].slices[0]),p++),w.map(function(o,f){var d=new c(a,l),h=d.getContext("2d"),w=o;h.clearRect(0,0,a,l),h.save(),renderingX.renderColor(h,new m(a,l),new v,w.color);var S=w.imgSrc;if(""!==S){var y=u.join(t,S),x=this.getTargetImage(y);if(!x){var j=new Image;try{j.src=g(y),this.addImage(y,j),x=j}catch(e){x=null}}renderingX.renderImage(h,new m(a,l),new v,x,new v,new m(a,l))}var b=e.id.split(".").join(""),I=b+"-"+f+".png",R=u.join(n,I);d.output(R,function(e){e?(p-=1)<=0&&i&&i(e):(this.trackedRes.push(new s(S,w.color,null,I,a,l,o)),w.originSrc=w.imgSrc,w.imgSrc=u.join(r||"",I),(p-=1)<=0&&i&&i())}.bind(this)),h.restore()}.bind(this))}else i&&i()},d.prototype.renderDashboard=function(e,t,n,r,i){var o=e.info;if(o){var a=e.texList,l=a.length;a.map(function(f,d){var h=o.width,p=o.height;1===d&&(h=p=o.pointerLength/Math.sqrt(2));var w=new c(h,p),S=w.getContext("2d"),y=a[d].slices[0];S.clearRect(0,0,h,p),S.save(),renderingX.renderColor(S,new m(h,p),new v,y.color);var x=y.imgSrc;if(""!==x){var j=u.join(t,x),b=this.getTargetImage(j);if(!b){var I=new Image;try{I.src=g(j),this.addImage(j,I),b=I}catch(e){b=null}}renderingX.renderImage(S,new m(h,p),new v,b,new v,new m(h,p))}var R=e.id.split(".").join(""),k=R+"-"+d+".png",T=u.join(n,k);w.output(T,function(e){e?(l-=1)<=0&&i&&i(e):(this.trackedRes.push(new s(x,y.color,null,k,h,p,y)),y.originSrc=y.imgSrc,y.imgSrc=u.join(r||"",k),(l-=1)<=0&&i&&i())}.bind(this)),S.restore()}.bind(this))}else i&&i()},d.prototype.renderSlide=function(e,t,n,r,i){var o=e.info;if(o){var a="",l={},f={};f["font-style"]=e.info.fontItalic,f["font-weight"]=e.info.fontBold,f["font-size"]=e.info.fontSize,f["font-family"]=e.info.fontFamily,f["font-color"]=e.info.fontColor,l.color=f["font-color"],l.font=(f["font-style"]||"")+" "+(f["font-variant"]||"")+" "+(f["font-weight"]||"")+" "+(f["font-size"]||24)+"px "+(f["font-family"]||"arial"),l.textAlign="center",l.textBaseline="middle";var d=o.width,h=o.height,p=e.texList[0],w=p.slices.length;p.slices.map(function(f,S){var y=new c(d,h),x=y.getContext("2d"),j=p.slices[S];x.clearRect(0,0,d,h),x.save(),renderingX.renderColor(x,new m(d,h),new v,j.color);var b=j.imgSrc;if(""!==b){var I=u.join(t,b),R=this.getTargetImage(I);if(!R){var k=new Image;try{k.src=g(I),this.addImage(I,k),R=k}catch(e){R=null}}renderingX.renderImage(x,new m(d,h),new v,R,new v,new m(d,h))}(a=j.text)&&renderingX.renderText(x,new m(o.width,o.height),new v,a,l,!0,null,this.customFonts);var T=e.id.split(".").join(""),C=T+"-"+S+".png",L=u.join(n,C);y.output(L,function(e){e?i&&i(e):(this.trackedRes.push(new s(b,j.color,null,C,d,h,j)),j.originSrc=j.imgSrc,j.imgSrc=u.join(r||"",C),(w-=1)<=0&&i&&i())}.bind(this)),x.restore()}.bind(this))}else i&&i()},d.prototype.renderTexNum=function(e,t,n,r,i){var o=e.info;if(o){var a=o.characterW,l=o.characterH,f=e.texList[0],d=f.slices.length;f.slices.map(function(o,h){var p=new c(a,l),w=p.getContext("2d"),S=f.slices[h];w.clearRect(0,0,a,l),w.save(),renderingX.renderColor(w,new m(a,l),new v,S.color);var y=S.imgSrc;if(""!==y){var x=u.join(t,y),j=this.getTargetImage(x);if(!j){var b=new Image;try{b.src=g(x),this.addImage(x,b),j=b}catch(e){j=null}}renderingX.renderImage(w,new m(a,l),new v,j,new v,new m(a,l))}var I=e.id.split(".").join(""),R=I+"-"+h+".png",k=u.join(n,R);p.output(k,function(e){e?i&&i(e):(this.trackedRes.push(new s(y,S.color,null,R,a,l,S)),S.originSrc=S.imgSrc,S.imgSrc=u.join(r||"",R),(d-=1)<=0&&i&&i())}.bind(this)),w.restore()}.bind(this))}else i&&i()},d.prototype.renderTexTime=function(e,t,n,r,i){var o=e.info;if(o){var a=o.characterW,l=o.characterH,f=e.texList[0];f.slices.push(e.texList[1].slices[0]);var d=f.slices.length;f.slices.map(function(o,h){var p=new c(a,l),w=p.getContext("2d"),S=f.slices[h];w.clearRect(0,0,a,l),w.save(),renderingX.renderColor(w,new m(a,l),new v,S.color);var y=S.imgSrc;if(""!==y){var x=u.join(t,y),j=this.getTargetImage(x);if(!j){var b=new Image;try{b.src=g(x),this.addImage(x,b),j=b}catch(e){j=null}}renderingX.renderImage(w,new m(a,l),new v,j,new v,new m(a,l))}var I=e.id.split(".").join(""),R=I+"-"+h+".png",k=u.join(n,R);p.output(k,function(e){e?i&&i(e):(this.trackedRes.push(new s(y,S.color,null,R,a,l,S)),S.originSrc=S.imgSrc,S.imgSrc=u.join(r||"",R),(d-=1)<=0&&i&&i())}.bind(this)),w.restore()}.bind(this))}else i&&i()},d.prototype.renderRotateImg=function(e,t,n,r,i){var o=e.info;if(o){var a=o.width,l=o.height,f=e.texList[0],d=f.slices.length;f.slices.map(function(o,h){var p=new c(a,l),w=p.getContext("2d"),S=f.slices[h];w.clearRect(0,0,a,l),w.save(),renderingX.renderColor(w,new m(a,l),new v,S.color);var y=S.imgSrc;if(""!==y){var x=u.join(t,y),j=this.getTargetImage(x);if(!j){var b=new Image;try{b.src=g(x),this.addImage(x,b),j=b}catch(e){j=null}}renderingX.renderImage(w,new m(a,l),new v,j,new v,new m(a,l))}var I=e.id.split(".").join(""),R=I+"-"+h+".png",k=u.join(n,R);p.output(k,function(e){e?i&&i(e):(this.trackedRes.push(new s(y,S.color,null,R,a,l,S)),S.originSrc=S.imgSrc,S.imgSrc=u.join(r||"",R),(d-=1)<=0&&i&&i())}.bind(this)),w.restore()}.bind(this))}else i&&i()},d.prototype.renderOscilloscope=function(e,t,n,r,i){var o=e.info,a=o.width,s=o.height;if(o){var l=new c(a,s),f=l.getContext("2d");f.clearRect(0,0,a,s);var d=e.texList[0].slices[0];if(renderingX.renderColor(f,new m(a,s),new v,d.color),""!==d.imgSrc){var h=u.join(t,d.imgSrc),p=this.getTargetImage(h);if(!p){var w=new Image;try{w.src=g(h),this.addImage(h,w),p=w}catch(e){p=null}}renderingX.renderImage(f,new m(a,s),new v,p,new v,new m(a,s))}renderingX.renderGrid(f,new m(a,s),new v,new m(o.spacing,o.spacing),new v);var S=e.id.split(".").join(""),y=S+"-1.png",x=u.join(n,y);l.output(x,function(e){e?i&&i(e):(d.originSrc=d.imgSrc,d.imgSrc=u.join(r||"",y),i&&i())}.bind(this))}else i&&i()},d.prototype.renderTextArea=function(e,t,n,r,i){var o=e.info,l=o.width,f=o.height;if(o){var d={},h={};h["font-style"]=e.info.fontItalic,h["font-weight"]=e.info.fontBold,h["font-size"]=e.info.fontSize,h["font-family"]=e.info.fontFamily,h["font-color"]=e.info.fontColor,d.color=h["font-color"],d.font=(h["font-style"]||"")+" "+(h["font-variant"]||"")+" "+(h["font-weight"]||"")+" "+(h["font-size"]||24)+"px "+(h["font-family"]||"arial"),d.textAlign="center",d.textBaseline="middle",d.arrange=e.info.arrange;var p=new c(l,f),w=p.getContext("2d");w.clearRect(0,0,l,f);var S=e.texList[0].slices[0];if(renderingX.renderColor(w,new m(l,f),new v,S.color),""!==S.imgSrc){var y=u.join(t,S.imgSrc),x=this.getTargetImage(y);if(!x){var j=new Image;try{j.src=g(y),this.addImage(y,j),x=j}catch(e){x=null}}renderingX.renderImage(w,new m(l,f),new v,x,new v,new m(l,f))}o.text&&""!==o.text&&renderingX.renderText(w,new m(l,f),new v,o.text,d,!0,new v(.5*l,.5*f),this.customFonts);var b=e.id.split(".").join(""),I=b+"-1.png",R=new Date,k=u.join(n,I);p.output(k,function(e){if(e)i&&i(e);else{this.trackedRes.push(new s(S.imgSrc,S.color,new a(o.text,d),I,l,f,S)),S.originSrc=S.imgSrc,S.imgSrc=u.join(r||"",I);var t=new Date;console.log("Output stream costs: ",(t-R)/1e3+"s"),i&&i()}}.bind(this))}else i&&i()},d.prototype.renderWidget=function(e,t,n,r,i){switch(e.subType){case"MyButton":case"MySwitch":this.renderButton(e,t,n,r,i);break;case"MyButtonGroup":this.renderButtonGroup(e,t,n,r,i);break;case"MySlide":case"MyAnimation":this.renderSlide(e,t,n,r,i);break;case"MyOscilloscope":this.renderOscilloscope(e,t,n,r,i);break;case"MyTextArea":this.renderTextArea(e,t,n,r,i);break;case"MyDashboard":this.renderDashboard(e,t,n,r,i);break;case"MyRotateImg":this.renderRotateImg(e,t,n,r,i);break;case"MyTexNum":this.renderTexNum(e,t,n,r,i);break;case"MyTexTime":this.renderTexTime(e,t,n,r,i);break;default:i&&i()}},d.prototype.removeSameOutputFiles=function(){for(var e=[],t=0;t<this.trackedRes.length;t++)for(var n=this.trackedRes[t],r=0;r<t;r++)if(this.trackedRes[r].equal(n)){e.push(n.slice.imgSrc),n.slice.imgSrc=this.trackedRes[r].slice.imgSrc;break}return e},this.renderProject=function(t,r,i){function a(e){console.log(e),g||(i&&i(),g=!0)}function s(){console.log("zip ok"),r&&r()}function c(e,t){y.compress(e,t,function(e){e?a(e):s()}.bind(this))}for(var l,g=!1,f=e.getProjectUrl(),h=e.getResourceUrl(),m=u.join(h,"data.json"),v=[],S=0;S<t.pageList.length;S++)for(var x=t.pageList[S],j=0;j<x.canvasList.length;j++)for(var b=x.canvasList[j],I=0;I<b.subCanvasList.length;I++)for(var R=b.subCanvasList[I],k=0;k<R.widgetList.length;k++)v.push(R.widgetList[k]);var T=v.length;if(T>0){var C=!0,L=function(o){if(o)C=!1,a("generate error");else if((T-=1)<=0&&C){console.log("trans finished");l.removeSameOutputFiles();p?w.writeFile(m,JSON.stringify(t,null,4),function(e){if(e)a(e);else{console.log("write ok");var t=u.join(f,"resources");c(u.join(f,"file.zip"),t)}}):n({method:"POST",url:"/project/"+e.getResourceUrl().split("/")[2]+"/savedatacompress",data:{dataStructure:t}}).success(function(t){"ok"==t?window.location.href="/project/"+e.getResourceUrl().split("/")[2]+"/download":(console.log(t),toastr.info("生成失败")),r&&r()}).error(function(e){a(e),i&&i()})}}.bind(this);if(p){l=new d;var X=u.join(global.__dirname,u.dirname(window.location.pathname));console.log("viewUrl",X);for(var z=0;z<v.length;z++){var B=v[z];l.renderWidget(B,X,h,h,L)}}else{l=new d(o());for(var z=0;z<v.length;z++){var B=v[z];l.renderWidget(B,"/",h,h,L)}}}else p?w.writeFile(m,JSON.stringify(t,null,4),function(e){if(e)a(res,500,e);else{var t=u.join(f,"resources");c(u.join(f,"file.zip"),t)}}):n({method:"POST",url:"/project/"+e.getResourceUrl().split("/")[2]+"/savedatacompress",data:{dataStructure:t}}).success(function(t){"ok"==t?window.location.href="/project/"+e.getResourceUrl().split("/")[2]+"/download":(console.log(t),toastr.info("生成失败")),r&&r()}).error(function(e){a(e),i&&i()})},p)var S=require("child_process").spawn,y=new h}]);