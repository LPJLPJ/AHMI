ideServices.service("RenderSerive",["ResourceService","Upload","$http","FontGeneratorService",function(e,t,n,i){function r(e){var t;t=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):unescape(e.split(",")[1]);for(var n=e.split(",")[0].split(":")[1].split(";")[0],i=new Uint8Array(t.length),r=0;r<t.length;r++)i[r]=t.charCodeAt(r);return new Blob([i],{type:n})}function o(e,n,i,o,a){var s=r(e),c=function(){console.log("save tex ok"),o&&o()},l=function(e){console.log(e),a&&a()};t.upload({url:i,data:{file:s,name:n}}).then(c,l)}function a(){for(var t=e.getGlobalResources(),n={},i=0;i<t.length;i++){var r=t[i];n[r.id]=r.content}return n}function s(e,t){this.text=e,this.style=t}function c(e,t,n,i,r,o,a){this.img=e,this.color=t,this.text=n,this.outFile=i,this.w=r,this.h=o,this.slice=a}function l(e,t){this.width=e,this.height=t;var n=document.createElement("canvas");n.width=this.width,n.height=this.height,n.hidden=!0,this.canvasObj=n}function g(e){switch(e){case"jpg":case"jpeg":return"image/jpeg";case"png":return"image/png";case"bmp":return"image/bmp";default:return"image/png"}}function f(e){if(w){return"data:"+g(p.extname(e))+";base64,"+m.readFileSync(e).toString("base64")}return e}function d(e){var t=e.split("/");return t[t.length-1]}function h(e,t){this.images=e||{},window.images=this.images,this.customFonts=t||{},this.trackedRes=[]}function u(){var e,t="win32"===require("os").platform()?"win":"other",n="zip";"win"===t?(n=".\\utils\\7z\\7z.exe",e=["a"]):e=["-rj"];var i,r,o,a=function(){"win"===t&&"\\"!==r[r.length-1]&&(r+="\\*");var a=e.concat(i).concat(r),s=y(n,a);console.log("command",n,a),s.stdout.on("data",function(e){}),s.stderr.on("data",function(e){}),s.on("error",function(e){console.log(e),o(e)}),s.on("exit",function(e){0===e?o():o(new Error(e))})};this.compress=function(e,t,n){i=e,r=t,o=n,m.stat(e,function(t,n){n&&n.isFile()?m.unlink(e,function(e){e?o(e):a()}):a()})}}var p,w=!1;try{p=require("path");var m=require("fs");w=!0}catch(e){p={},p.sep="/",p.join=function(e,t){return e[e.length-1]==p.sep&&(e=e.slice(0,e.length-1)),t[0]==p.sep&&(t=t.slice(1)),e+p.sep+t}}c.prototype.equal=function(e){for(var t=["img","color","text","w","h"],n=0;n<t.length;n++){var i=t[n];if(this[i]!=e[i])return!1}return!0},l.prototype.getContext=function(e){if("2d"===e)return this.canvasObj.getContext("2d")},l.prototype.pngStream=function(){var e=this.canvasObj.toDataURL();if(w){return new Buffer(e.split(",")[1],"base64")}return e},l.prototype.toBuffer=function(){var e=this.canvasObj.toDataURL();return new Buffer(e.split(",")[1],"base64")},l.prototype.output=function(t,n){var i=this.pngStream(),r=d(t);if(w)try{m.writeFileSync(t,i),n&&n()}catch(e){n&&n(e)}else o(i,r,"/project/"+e.getResourceUrl().split("/")[2]+"/generatetex",n,n)};var v=renderingX.Size,S=renderingX.Pos;if(h.prototype.compareTrackedRes=function(e){for(var t=0;t<this.trackedRes.length;t++){if(this.trackedRes[t].eq(e))return!0}return!1},h.prototype.getTargetImage=function(e){return w?"undefined"!==this.images[e]?this.images[e]:null:this.images[d(e)]},h.prototype.addImage=function(e,t){this.images[e]=t},h.prototype.renderButton=function(e,t,n,i,r){var o=e.info;if(o){var a={},g={};g["font-style"]=e.info.fontItalic,g["font-weight"]=e.info.fontBold,g["font-size"]=e.info.fontSize,g["font-family"]=e.info.fontFamily,g["font-color"]=e.info.fontColor,a.color=g["font-color"],a.font=(g["font-style"]||"")+" "+(g["font-variant"]||"")+" "+(g["font-weight"]||"")+" "+(g["font-size"]||24)+"px "+(g["font-family"]||"arial"),a.textAlign="center",a.textBaseline="middle";var d=e.texList[0].slices,h=d.length;d.map(function(g,d){var u=new l(o.width,o.height),w=u.getContext("2d"),m=g.imgSrc;w.clearRect(0,0,o.width,o.height),w.save(),renderingX.renderColor(w,new v(o.width,o.height),new S,g.color);var y;if(""!==m){y=p.join(t,m);var x=this.getTargetImage(y);if(!x){var j=new Image;try{j.src=f(y),this.addImage(y,j),x=j}catch(e){x=null}}renderingX.renderImage(w,new v(o.width,o.height),new S,x,new S,new v(o.width,o.height))}d<2&&void 0!==o.text&&o.text&&renderingX.renderText(w,new v(o.width,o.height),new S,o.text,a,!0,null,this.customFonts);var b=e.id.split(".").join("-"),I=b+"-"+d+".png";console.log("dstDir",n,"outputFilename",I);var R=p.join(n,I);u.output(R,function(t){t?(h-=1)<=0&&r&&r(t):(this.trackedRes.push(new c(m,g.color,new s(o.text,a),I,o.width,o.height,g)),e.texList[0].slices[d].originSrc=e.texList[0].slices[d].imgSrc,e.texList[0].slices[d].imgSrc=p.join(i||"",I),(h-=1)<=0&&r&&r())}.bind(this)),w.restore()}.bind(this))}else r&&r()},h.prototype.renderButtonGroup=function(e,t,n,i,r){var o=e.info;if(o){var a=o.width,s=o.height,g=o.interval,d=o.count;"horizontal"===o.arrange?a=(a-(d-1)*g)/d:s=(s-(d-1)*g)/d;for(var h=e.texList,u=2*d,w=[],m=0;m<d;m++)for(var y=0;y<2;y++)w.push(h[m].slices[y]);h[d]&&(w.push(h[d].slices[0]),u++),w.map(function(o,g){var d=new l(a,s),h=d.getContext("2d"),w=o;h.clearRect(0,0,a,s),h.save(),renderingX.renderColor(h,new v(a,s),new S,w.color);var m=w.imgSrc;if(""!==m){var y=p.join(t,m),x=this.getTargetImage(y);if(!x){var j=new Image;try{j.src=f(y),this.addImage(y,j),x=j}catch(e){x=null}}renderingX.renderImage(h,new v(a,s),new S,x,new S,new v(a,s))}var b=e.id.split(".").join("-"),I=b+"-"+g+".png",R=p.join(n,I);d.output(R,function(e){e?(u-=1)<=0&&r&&r(e):(this.trackedRes.push(new c(m,w.color,null,I,a,s,o)),w.originSrc=w.imgSrc,w.imgSrc=p.join(i||"",I),(u-=1)<=0&&r&&r())}.bind(this)),h.restore()}.bind(this))}else r&&r()},h.prototype.renderDashboard=function(e,t,n,i,r){var o=e.info;if(o){var a=e.texList,s=a.length;a.map(function(g,d){var h=o.width,u=o.height;1===d&&(h=u=o.pointerLength/Math.sqrt(2));var w=new l(h,u),m=w.getContext("2d"),y=a[d].slices[0];m.clearRect(0,0,h,u),m.save(),renderingX.renderColor(m,new v(h,u),new S,y.color);var x=y.imgSrc;if(""!==x){var j=p.join(t,x),b=this.getTargetImage(j);if(!b){var I=new Image;try{I.src=f(j),this.addImage(j,I),b=I}catch(e){b=null}}renderingX.renderImage(m,new v(h,u),new S,b,new S,new v(h,u))}var R=e.id.split(".").join("-"),k=R+"-"+d+".png",C=p.join(n,k);w.output(C,function(e){e?(s-=1)<=0&&r&&r(e):(this.trackedRes.push(new c(x,y.color,null,k,h,u,y)),y.originSrc=y.imgSrc,y.imgSrc=p.join(i||"",k),(s-=1)<=0&&r&&r())}.bind(this)),m.restore()}.bind(this))}else r&&r()},h.prototype.renderSlide=function(e,t,n,i,r){var o=e.info;if(o){var a="",s={},g={};g["font-style"]=e.info.fontItalic,g["font-weight"]=e.info.fontBold,g["font-size"]=e.info.fontSize,g["font-family"]=e.info.fontFamily,g["font-color"]=e.info.fontColor,s.color=g["font-color"],s.font=(g["font-style"]||"")+" "+(g["font-variant"]||"")+" "+(g["font-weight"]||"")+" "+(g["font-size"]||24)+"px "+(g["font-family"]||"arial"),s.textAlign="center",s.textBaseline="middle";var d=o.width,h=o.height,u=e.texList[0],w=u.slices.length;u.slices.map(function(g,m){var y=new l(d,h),x=y.getContext("2d"),j=u.slices[m];x.clearRect(0,0,d,h),x.save(),renderingX.renderColor(x,new v(d,h),new S,j.color);var b=j.imgSrc;if(""!==b){var I=p.join(t,b),R=this.getTargetImage(I);if(!R){var k=new Image;try{k.src=f(I),this.addImage(I,k),R=k}catch(e){R=null}}renderingX.renderImage(x,new v(d,h),new S,R,new S,new v(d,h))}(a=j.text)&&renderingX.renderText(x,new v(o.width,o.height),new S,a,s,!0,null,this.customFonts);var C=e.id.split(".").join("-"),F=C+"-"+m+".png",L=p.join(n,F);y.output(L,function(e){e?r&&r(e):(this.trackedRes.push(new c(b,j.color,null,F,d,h,j)),j.originSrc=j.imgSrc,j.imgSrc=p.join(i||"",F),(w-=1)<=0&&r&&r())}.bind(this)),x.restore()}.bind(this))}else r&&r()},h.prototype.renderTexNum=function(e,t,n,i,r){var o=e.info;if(o){var a=o.characterW,s=o.characterH,g=e.texList[0],d=g.slices.length;g.slices.map(function(o,h){var u=new l(a,s),w=u.getContext("2d"),m=g.slices[h];w.clearRect(0,0,a,s),w.save(),renderingX.renderColor(w,new v(a,s),new S,m.color);var y=m.imgSrc;if(""!==y){var x=p.join(t,y),j=this.getTargetImage(x);if(!j){var b=new Image;try{b.src=f(x),this.addImage(x,b),j=b}catch(e){j=null}}renderingX.renderImage(w,new v(a,s),new S,j,new S,new v(a,s))}var I=e.id.split(".").join("-"),R=I+"-"+h+".png",k=p.join(n,R);u.output(k,function(e){e?r&&r(e):(this.trackedRes.push(new c(y,m.color,null,R,a,s,m)),m.originSrc=m.imgSrc,m.imgSrc=p.join(i||"",R),(d-=1)<=0&&r&&r())}.bind(this)),w.restore()}.bind(this))}else r&&r()},h.prototype.renderRotateImg=function(e,t,n,i,r){var o=e.info;if(o){var a=o.width,s=o.height,g=e.texList[0],d=g.slices.length;g.slices.map(function(o,h){var u=new l(a,s),w=u.getContext("2d"),m=g.slices[h];w.clearRect(0,0,a,s),w.save(),renderingX.renderColor(w,new v(a,s),new S,m.color);var y=m.imgSrc;if(""!==y){var x=p.join(t,y),j=this.getTargetImage(x);if(!j){var b=new Image;try{b.src=f(x),this.addImage(x,b),j=b}catch(e){j=null}}renderingX.renderImage(w,new v(a,s),new S,j,new S,new v(a,s))}var I=e.id.split(".").join("-"),R=I+"-"+h+".png",k=p.join(n,R);u.output(k,function(e){e?r&&r(e):(this.trackedRes.push(new c(y,m.color,null,R,a,s,m)),m.originSrc=m.imgSrc,m.imgSrc=p.join(i||"",R),(d-=1)<=0&&r&&r())}.bind(this)),w.restore()}.bind(this))}else r&&r()},h.prototype.renderOscilloscope=function(e,t,n,i,r){var o=e.info,a=o.width,s=o.height;if(o){var c=new l(a,s),g=c.getContext("2d");g.clearRect(0,0,a,s);var d=e.texList[0].slices[0];if(renderingX.renderColor(g,new v(a,s),new S,d.color),""!==d.imgSrc){var h=p.join(t,d.imgSrc),u=this.getTargetImage(h);if(!u){var w=new Image;try{w.src=f(h),this.addImage(h,w),u=w}catch(e){u=null}}renderingX.renderImage(g,new v(a,s),new S,u,new S,new v(a,s))}renderingX.renderGrid(g,new v(a,s),new S,new v(o.spacing,o.spacing),new S);var m=e.id.split(".").join("-"),y=m+"-1.png",x=p.join(n,y);c.output(x,function(e){e?r&&r(e):(d.originSrc=d.imgSrc,d.imgSrc=p.join(i||"",y),r&&r())}.bind(this))}else r&&r()},h.prototype.renderTextArea=function(e,t,n,i,r){var o=e.info,a=o.width,g=o.height;if(o){var d={},h={};h["font-style"]=e.info.fontItalic,h["font-weight"]=e.info.fontBold,h["font-size"]=e.info.fontSize,h["font-family"]=e.info.fontFamily,h["font-color"]=e.info.fontColor,d.color=h["font-color"],d.font=(h["font-style"]||"")+" "+(h["font-variant"]||"")+" "+(h["font-weight"]||"")+" "+(h["font-size"]||24)+"px "+(h["font-family"]||"arial"),d.textAlign="center",d.textBaseline="middle",d.arrange=e.info.arrange;var u=new l(a,g),w=u.getContext("2d");w.clearRect(0,0,a,g);var m=e.texList[0].slices[0];if(renderingX.renderColor(w,new v(a,g),new S,m.color),""!==m.imgSrc){var y=p.join(t,m.imgSrc),x=this.getTargetImage(y);if(!x){var j=new Image;try{j.src=f(y),this.addImage(y,j),x=j}catch(e){x=null}}renderingX.renderImage(w,new v(a,g),new S,x,new S,new v(a,g))}o.text&&""!==o.text&&renderingX.renderText(w,new v(a,g),new S,o.text,d,!0,new S(.5*a,.5*g),this.customFonts);var b=e.id.split(".").join("-"),I=b+"-1.png",R=new Date,k=p.join(n,I);u.output(k,function(e){if(e)r&&r(e);else{this.trackedRes.push(new c(m.imgSrc,m.color,new s(o.text,d),I,a,g,m)),m.originSrc=m.imgSrc,m.imgSrc=p.join(i||"",I);var t=new Date;console.log("Output stream costs: ",(t-R)/1e3+"s"),r&&r()}}.bind(this))}else r&&r()},h.prototype.renderWidget=function(e,t,n,i,r){switch(e.subType){case"MyButton":case"MySwitch":this.renderButton(e,t,n,i,r);break;case"MyButtonGroup":this.renderButtonGroup(e,t,n,i,r);break;case"MySlide":case"MyAnimation":this.renderSlide(e,t,n,i,r);break;case"MyOscilloscope":this.renderOscilloscope(e,t,n,i,r);break;case"MyTextArea":this.renderTextArea(e,t,n,i,r);break;case"MyDashboard":this.renderDashboard(e,t,n,i,r);break;case"MyRotateImg":this.renderRotateImg(e,t,n,i,r);break;case"MyTexNum":this.renderTexNum(e,t,n,i,r);break;default:r&&r()}},h.prototype.removeSameOutputFiles=function(){for(var e=[],t=0;t<this.trackedRes.length;t++)for(var n=this.trackedRes[t],i=0;i<t;i++)if(this.trackedRes[i].equal(n)){e.push(n.slice.imgSrc),n.slice.imgSrc=this.trackedRes[i].slice.imgSrc;break}return e},h.prototype.renderFontPng=function(t,n,r,a,s){var c=t["font-family"];if(new RegExp("[\\u4E00-\\u9FFF]+","g").test(c)){for(var l="",g=0;g<c.length;g++)l+=c.charCodeAt(g).toString(32);c=l}var f=c+"-"+t["font-size"]+"-"+t["font-bold"]+"-"+(t["font-italic"]||"null")+".png",d={showGrid:!0},h="",u=p.join(r,f);if(d.paddingRatio=1.2,h=i.generateSingleFont(t,d),h=i.pngStream(h,w),w)try{m.writeFileSync(u,h),s&&s()}catch(e){s&&s(e)}else o(h,f,"/project/"+e.getResourceUrl().split("/")[2]+"/generatetex",s,s)},this.renderProject=function(t,r,o){function s(e){console.log(e),f||(o&&o(),f=!0)}function c(){console.log("zip ok"),r&&r()}function l(e,t){x.compress(e,t,function(e){e?s(e):c()}.bind(this))}for(var g,f=!1,d=e.getProjectUrl(),u=e.getResourceUrl(),v=p.join(u,"data.json"),S=[],y=0;y<t.pageList.length;y++)for(var j=t.pageList[y],b=0;b<j.canvasList.length;b++)for(var I=j.canvasList[b],R=0;R<I.subCanvasList.length;R++)for(var k=I.subCanvasList[R],C=0;C<k.widgetList.length;C++)S.push(k.widgetList[C]);var F=i.getFontCollections(S),L=S.length+F.length,T=0,X=null;if(L>0){var z=!0,B=function(i){if(i)z=!1,s("generate error");else if((L-=1)<=0&&z){console.log("trans finished");g.removeSameOutputFiles();w?m.writeFile(v,JSON.stringify(t,null,4),function(e){if(e)s(e);else{console.log("write ok");var t=p.join(d,"resources");l(p.join(d,"file.zip"),t)}}):n({method:"POST",url:"/project/"+e.getResourceUrl().split("/")[2]+"/savedatacompress",data:{dataStructure:t}}).success(function(t){"ok"==t?window.location.href="/project/"+e.getResourceUrl().split("/")[2]+"/download":(console.log(t),toastr.info("生成失败")),r&&r()}).error(function(e){s(e),o&&o()})}}.bind(this);if(w){g=new h;var O=p.join(global.__dirname,p.dirname(window.location.pathname));if(0!==F.length)for(T=0;T<F.length;T++)F[T],g.renderFontPng(F[T],O,u,u,B);for(T=0;T<S.length;T++)X=S[T],g.renderWidget(X,O,u,u,B)}else{if(g=new h(a()),0!==F.length)for(T=0;T<F.length;T++)F[T],g.renderFontPng(F[T],"/",u,u,B);for(T=0;T<S.length;T++)X=S[T],g.renderWidget(X,"/",u,u,B)}}else w?m.writeFile(v,JSON.stringify(t,null,4),function(e){if(e)s(res,500,e);else{var t=p.join(d,"resources");l(p.join(d,"file.zip"),t)}}):n({method:"POST",url:"/project/"+e.getResourceUrl().split("/")[2]+"/savedatacompress",data:{dataStructure:t}}).success(function(t){"ok"==t?window.location.href="/project/"+e.getResourceUrl().split("/")[2]+"/download":(console.log(t),toastr.info("生成失败")),r&&r()}).error(function(e){s(e),o&&o()})},w)var y=require("child_process").spawn,x=new u}]);