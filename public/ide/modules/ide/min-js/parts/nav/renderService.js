ideServices.service("RenderSerive",["ResourceService","Upload","$http",function(e,n,t){function i(e){var n;n=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):unescape(e.split(",")[1]);for(var t=e.split(",")[0].split(":")[1].split(";")[0],i=new Uint8Array(n.length),r=0;r<n.length;r++)i[r]=n.charCodeAt(r);return new Blob([i],{type:t})}function r(e,t,r,o,a){var s=i(e),c=function(){console.log("save tex ok"),o&&o()},l=function(e){console.log(e),a&&a()};n.upload({url:r,data:{file:s,name:t}}).then(c,l)}function o(){for(var n=e.getGlobalResources(),t={},i=0;i<n.length;i++){var r=n[i];t[r.id]=r.content}return t}function a(e,n){this.width=e,this.height=n;var t=document.createElement("canvas");t.width=this.width,t.height=this.height,t.hidden=!0,this.canvasObj=t}function s(e){switch(e){case"jpg":case"jpeg":return"image/jpeg";case"png":return"image/png";case"bmp":return"image/bmp";default:return"image/png"}}function c(e){if(h){var n=d.extname(e),t=s(n),i="data:"+t+";base64,";return i+u.readFileSync(e).toString("base64")}return e}function l(e){var n=e.split("/");return n[n.length-1]}function g(e,n){this.images=e||{},window.images=this.images,this.customFonts=n||{}}function f(){var e,n="win32"===require("os").platform()?"win":"other",t="zip";"win"===n?(t=".\\utils\\7z\\7z.exe",e=["a"]):e=["-rj"];var i,r,o,a=function(){"win"===n&&"\\"!==r[r.length-1]&&(r+="\\*");var a=e.concat(i).concat(r),s=v(t,a);console.log("command",t,a),s.stdout.on("data",function(e){}),s.stderr.on("data",function(e){}),s.on("error",function(e){console.log(e),o(e)}),s.on("exit",function(e){0===e?o():o(new Error(e))})};this.compress=function(e,n,t){i=e,r=n,o=t,u.stat(e,function(n,t){t&&t.isFile()?u.unlink(e,function(e){e?o(e):a()}):a()})}}var d,h=!1;try{d=require("path");var u=require("fs");h=!0}catch(e){d={},d.sep="/",d.join=function(e,n){return e[e.length-1]==d.sep&&(e=e.slice(0,e.length-1)),n[0]==d.sep&&(n=n.slice(1)),e+d.sep+n}}a.prototype.getContext=function(e){if("2d"===e)return this.canvasObj.getContext("2d")},a.prototype.pngStream=function(){var e=this.canvasObj.toDataURL();if(h){var n=new Buffer(e.split(",")[1],"base64");return n}return e},a.prototype.toBuffer=function(){var e=this.canvasObj.toDataURL(),n=new Buffer(e.split(",")[1],"base64");return n},a.prototype.output=function(n,t){var i=this.pngStream(),o=l(n);if(h)try{u.writeFileSync(n,i),t&&t()}catch(e){t&&t(e)}else r(i,o,"/project/"+e.getResourceUrl().split("/")[2]+"/generatetex",t,t)};var p=renderingX.Size,w=renderingX.Pos;if(g.prototype.getTargetImage=function(e){return h?"undefined"!==this.images[e]?this.images[e]:null:this.images[l(e)]},g.prototype.addImage=function(e,n){this.images[e]=n},g.prototype.renderButton=function(e,n,t,i,r){var o=e.info;if(o){var s={},l={};l["font-style"]=e.info.fontItalic,l["font-weight"]=e.info.fontBold,l["font-size"]=e.info.fontSize,l["font-family"]=e.info.fontFamily,l["font-color"]=e.info.fontColor,s.color=l["font-color"],s.font=(l["font-style"]||"")+" "+(l["font-variant"]||"")+" "+(l["font-weight"]||"")+" "+(l["font-size"]||24)+"px "+(l["font-family"]||"arial"),s.textAlign="center",s.textBaseline="middle";var g=e.texList[0].slices,f=g.length;g.map(function(l,g){var h=new a(o.width,o.height),u=h.getContext("2d"),v=l.imgSrc;u.clearRect(0,0,o.width,o.height),u.save(),renderingX.renderColor(u,new p(o.width,o.height),new w,l.color);var m;if(""!==v){m=d.join(n,v);var j=this.getTargetImage(m);if(!j){var y=new Image;try{y.src=c(m),this.addImage(m,y),j=y}catch(e){j=null}}renderingX.renderImage(u,new p(o.width,o.height),new w,j,new w,new p(o.width,o.height))}g<2&&renderingX.renderText(u,new p(o.width,o.height),new w,o.text,s,!0,null,this.customFonts);var b=e.id.split(".").join(""),x=b+"-"+g+".png",S=d.join(t,x);h.output(S,function(n){n?(f-=1,f<=0&&r&&r(n)):(e.texList[0].slices[g].imgSrc=d.join(i||"",x),f-=1,f<=0&&r&&r())}.bind(this)),u.restore()}.bind(this))}else r&&r()},g.prototype.renderButtonGroup=function(e,n,t,i,r){var o=e.info;if(o){var s=o.width,l=o.height,g=o.interval,f=o.count,h="horizontal"===o.arrange;h?s=(s-(f-1)*g)/f:l=(l-(f-1)*g)/f;for(var u=e.texList,v=2*f,m=[],j=0;j<f;j++)for(var y=0;y<2;y++)m.push(u[j].slices[y]);u[f]&&(m.push(u[f].slices[0]),v++),m.map(function(o,g){var f=new a(s,l),h=f.getContext("2d"),u=o;h.clearRect(0,0,s,l),h.save(),renderingX.renderColor(h,new p(s,l),new w,u.color);var m=u.imgSrc;if(""!==m){var j=d.join(n,m),y=this.getTargetImage(j);if(!y){var b=new Image;try{b.src=c(j),this.addImage(j,b),y=b}catch(e){y=null}}renderingX.renderImage(h,new p(s,l),new w,y,new w,new p(s,l))}var x=e.id.split(".").join(""),S=x+"-"+g+".png",I=d.join(t,S);f.output(I,function(e){e?(v-=1,v<=0&&r&&r(e)):(u.imgSrc=d.join(i||"",S),v-=1,v<=0&&r&&r())}.bind(this)),h.restore()}.bind(this))}else r&&r()},g.prototype.renderDashboard=function(e,n,t,i,r){var o=e.info;if(o){var s=o.width,l=o.height,g=e.texList,f=g.length;g.map(function(h,u){1===u&&(s=l=o.pointerLength/Math.sqrt(2));var v=new a(s,l),m=v.getContext("2d"),j=g[u].slices[0];m.clearRect(0,0,s,l),m.save(),renderingX.renderColor(m,new p(s,l),new w,j.color);var y=j.imgSrc;if(""!==y){var b=d.join(n,y),x=this.getTargetImage(b);if(!x){var S=new Image;try{S.src=c(b),this.addImage(b,S),x=S}catch(e){x=null}}renderingX.renderImage(m,new p(s,l),new w,x,new w,new p(s,l))}var I=e.id.split(".").join(""),C=I+"-"+u+".png",L=d.join(t,C);v.output(L,function(e){e?(f-=1,f<=0&&r&&r(e)):(j.imgSrc=d.join(i||"",C),f-=1,f<=0&&r&&r())}.bind(this)),m.restore()}.bind(this))}else r&&r()},g.prototype.renderSlide=function(e,n,t,i,r){var o=e.info;if(o){var s=o.width,l=o.height,g=e.texList[0],f=g.slices.length;g.slices.map(function(o,h){var u=new a(s,l),v=u.getContext("2d"),m=g.slices[h];v.clearRect(0,0,s,l),v.save(),renderingX.renderColor(v,new p(s,l),new w,m.color);var j=m.imgSrc;if(""!==j){var y=d.join(n,j),b=this.getTargetImage(y);if(!b){var x=new Image;try{x.src=c(y),this.addImage(y,x),b=x}catch(e){b=null}}renderingX.renderImage(v,new p(s,l),new w,b,new w,new p(s,l))}var S=e.id.split(".").join(""),I=S+"-"+h+".png",C=d.join(t,I);u.output(C,function(e){e?r&&r(e):(m.imgSrc=d.join(i||"",I),f-=1,f<=0&&r&&r())}.bind(this)),v.restore()}.bind(this))}else r&&r()},g.prototype.renderOscilloscope=function(e,n,t,i,r){var o=e.info,s=o.width,l=o.height;if(o){var g=new a(s,l),f=g.getContext("2d");f.clearRect(0,0,s,l);var h=e.texList[0].slices[0];if(renderingX.renderColor(f,new p(s,l),new w,h.color),""!==h.imgSrc){var u=d.join(n,h.imgSrc),v=this.getTargetImage(u);if(!v){var m=new Image;try{m.src=c(u),this.addImage(u,m),v=m}catch(e){v=null}}renderingX.renderImage(f,new p(s,l),new w,v,new w,new p(s,l))}renderingX.renderGrid(f,new p(s,l),new w,new p(o.spacing,o.spacing),new w);var j=e.id.split(".").join(""),y=j+"-1.png",b=d.join(t,y);g.output(b,function(e){e?r&&r(e):(h.imgSrc=d.join(i||"",y),r&&r())}.bind(this))}else r&&r()},g.prototype.renderTextArea=function(e,n,t,i,r){var o=e.info,s=o.width,l=o.height;if(o){var g={},f={};f["font-style"]=e.info.fontItalic,f["font-weight"]=e.info.fontBold,f["font-size"]=e.info.fontSize,f["font-family"]=e.info.fontFamily,f["font-color"]=e.info.fontColor,g.color=f["font-color"],g.font=(f["font-style"]||"")+" "+(f["font-variant"]||"")+" "+(f["font-weight"]||"")+" "+(f["font-size"]||24)+"px "+(f["font-family"]||"arial"),g.textAlign="center",g.textBaseline="middle",g.arrange=e.info.arrange;var h=new a(s,l),u=h.getContext("2d");u.clearRect(0,0,s,l);var v=e.texList[0].slices[0];if(renderingX.renderColor(u,new p(s,l),new w,v.color),""!==v.imgSrc){var m=d.join(n,v.imgSrc),j=this.getTargetImage(m);if(!j){var y=new Image;try{y.src=c(m),this.addImage(m,y),j=y}catch(e){j=null}}renderingX.renderImage(u,new p(s,l),new w,j,new w,new p(s,l))}o.text&&""!==o.text&&renderingX.renderText(u,new p(s,l),new w,o.text,g,!0,new w(.5*s,.5*l),this.customFonts);var b=e.id.split(".").join(""),x=b+"-1.png",S=new Date,I=d.join(t,x);h.output(I,function(e){if(e)r&&r(e);else{v.imgSrc=d.join(i||"",x);var n=new Date;console.log("Output stream costs: ",(n-S)/1e3+"s"),r&&r()}})}else r&&r()},g.prototype.renderWidget=function(e,n,t,i,r){switch(e.subType){case"MyButton":this.renderButton(e,n,t,i,r);break;case"MyButtonGroup":this.renderButtonGroup(e,n,t,i,r);break;case"MySlide":this.renderSlide(e,n,t,i,r);break;case"MyOscilloscope":this.renderOscilloscope(e,n,t,i,r);break;case"MyTextArea":this.renderTextArea(e,n,t,i,r);break;case"MyDashboard":this.renderDashboard(e,n,t,i,r);break;default:r&&r()}},this.renderProject=function(n,i,r){function a(e){console.log(e),l||(r&&r(),l=!0)}function s(){console.log("zip ok"),i&&i()}function c(e,n){m.compress(e,n,function(e){e?a(e):s()}.bind(this))}for(var l=!1,f=e.getProjectUrl(),p=e.getResourceUrl(),w=d.join(p,"data.json"),v=[],j=0;j<n.pageList.length;j++)for(var y=n.pageList[j],b=0;b<y.canvasList.length;b++)for(var x=y.canvasList[b],S=0;S<x.subCanvasList.length;S++)for(var I=x.subCanvasList[S],C=0;C<I.widgetList.length;C++)v.push(I.widgetList[C]);var L=v.length;if(L>0){var X,R=!0,z=function(i){i?(R=!1,a("generate error")):(L-=1,L<=0&&R&&(console.log("trans finished"),h?u.writeFile(w,JSON.stringify(n,null,4),function(e){if(e)a(e);else{console.log("write ok");var n=d.join(f,"resources"),t=d.join(f,"file.zip");c(t,n)}}):t({method:"POST",url:"/project/"+e.getResourceUrl().split("/")[2]+"/savedatacompress",data:{data:JSON.stringify(n,null,4)}}).success(function(n){"ok"==n?(toastr.info("生成成功"),window.location.href="/project/"+e.getResourceUrl().split("/")[2]+"/download"):(console.log(n),toastr.info("生成失败"))}).error(function(e){a(e)})))}.bind(this);if(h){X=new g;var B=d.join(global.__dirname,d.dirname(window.location.pathname));console.log("viewUrl",B);for(var T=0;T<v.length;T++){var O=v[T];X.renderWidget(O,B,p,p,z)}}else{X=new g(o());for(var T=0;T<v.length;T++){var O=v[T];X.renderWidget(O,"/",p,p,z)}}}else u.writeFile(w,JSON.stringify(n,null,4),function(e){if(e)a(res,500,e);else{var n=d.join(f,"resources"),t=d.join(f,"file.zip");c(t,n)}})},h)var v=require("child_process").spawn,m=new f}]);