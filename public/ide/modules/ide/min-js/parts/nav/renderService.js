ideServices.service("RenderSerive",["ResourceService","Upload","$http","FontGeneratorService",function(e,t,n,r){function i(e){var t;t=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):unescape(e.split(",")[1]);for(var n=e.split(",")[0].split(":")[1].split(";")[0],r=new Uint8Array(t.length),i=0;i<t.length;i++)r[i]=t.charCodeAt(i);return new Blob([r],{type:n})}function o(e,n,r,o,s){var a=i(e),c=function(){console.log("save tex ok"),o&&o()},l=function(e){console.log(e),s&&s()};t.upload({url:r,data:{file:a,name:n}}).then(c,l)}function s(){for(var t=e.getGlobalResources(),n={},r=0;r<t.length;r++){var i=t[r];n[i.id]=i.content}return n}function a(e,t){this.text=e,this.style=t}function c(e,t,n,r,i,o,s,a,c){this.img=e,this.color=t,this.text=n,this.outFile=r,this.w=i,this.h=o,this.slice=s,this.generalImageTextureList=a,this.generalImageTextureIdx=c}function l(e,t){this.width=e,this.height=t;var n=document.createElement("canvas");n.width=this.width,n.height=this.height,n.hidden=!0,this.canvasObj=n}function g(e){switch(e){case"jpg":case"jpeg":return"image/jpeg";case"png":return"image/png";case"bmp":return"image/bmp";default:return"image/png"}}function h(e){if(m){return"data:"+g(p.extname(e))+";base64,"+w.readFileSync(e).toString("base64")}return e}function f(e){var t=e.split("/");return t[t.length-1]}function d(e,t){this.images=e||{},window.images=this.images,this.customFonts=t||{},this.trackedRes=[]}function u(){var e,t="win32"===require("os").platform()?"win":"other",n="zip";"win"===t?(n=".\\utils\\7z\\7z.exe",e=["a"]):e=["-rj"];var r,i,o,s=function(){"win"===t&&"\\"!==i[i.length-1]&&(i+="\\*");var s=e.concat(r).concat(i),a=y(n,s);console.log("command",n,s),a.stdout.on("data",function(e){}),a.stderr.on("data",function(e){}),a.on("error",function(e){console.log(e),o(e)}),a.on("exit",function(e){0===e?o():o(new Error(e))})};this.compress=function(e,t,n){r=e,i=t,o=n,w.stat(e,function(t,n){n&&n.isFile()?w.unlink(e,function(e){e?o(e):s()}):s()})}}var p,m=!1;try{p=require("path");var w=require("fs");m=!0}catch(e){p={},p.sep="/",p.join=function(e,t){return e[e.length-1]==p.sep&&(e=e.slice(0,e.length-1)),t[0]==p.sep&&(t=t.slice(1)),e+p.sep+t}}c.prototype.equal=function(e){for(var t=["img","color","text","w","h"],n=0;n<t.length;n++){var r=t[n];if(this[r]!=e[r])return!1}return!0},c.prototype.getImgSrc=function(){return this.slice?this.slice.imgSrc:this.generalImageTextureList?this.generalImageTextureList[this.generalImageTextureIdx]:void 0},c.prototype.setImgSrc=function(e){this.slice?this.slice.imgSrc=e:this.generalImageTextureList&&(this.generalImageTextureList[this.generalImageTextureIdx]=e)},l.prototype.getContext=function(e){if("2d"===e)return this.canvasObj.getContext("2d")},l.prototype.pngStream=function(){var e=this.canvasObj.toDataURL();if(m){return new Buffer(e.split(",")[1],"base64")}return e},l.prototype.toBuffer=function(){var e=this.canvasObj.toDataURL();return new Buffer(e.split(",")[1],"base64")},l.prototype.output=function(t,n){var r=this.pngStream(),i=f(t);if(m)try{w.writeFileSync(t,r),n&&n()}catch(e){n&&n(e)}else o(r,i,"/project/"+e.getResourceUrl().split("/")[2]+"/generatetex",n,n)};var v=renderingX.Size,x=renderingX.Pos;if(d.prototype.compareTrackedRes=function(e){for(var t=0;t<this.trackedRes.length;t++){if(this.trackedRes[t].eq(e))return!0}return!1},d.prototype.getTargetImage=function(e){return m?"undefined"!==this.images[e]?this.images[e]:null:this.images[f(e)]},d.prototype.addImage=function(e,t){this.images[e]=t},d.prototype.renderButton=function(e,t,n,r,i){var o=e.info;if(o){var s={},g={};g["font-style"]=e.info.fontItalic,g["font-weight"]=e.info.fontBold,g["font-size"]=e.info.fontSize,g["font-family"]=e.info.fontFamily,g["font-color"]=e.info.fontColor,s.color=g["font-color"],s.font=(g["font-style"]||"")+" "+(g["font-variant"]||"")+" "+(g["font-weight"]||"")+" "+(g["font-size"]||24)+"px "+(g["font-family"]||"arial"),s.textAlign="center",s.textBaseline="middle";var f=e.texList[0].slices,d=f.length;f.map(function(g,f){var u=new l(o.width,o.height),m=u.getContext("2d"),w=g.imgSrc;m.clearRect(0,0,o.width,o.height),m.save(),renderingX.renderColor(m,new v(o.width,o.height),new x,g.color);var y;if(""!==w){y=p.join(t,w);var S=this.getTargetImage(y);if(!S){var j=new Image;try{j.src=h(y),this.addImage(y,j),S=j}catch(e){S=null}}renderingX.renderImage(m,new v(o.width,o.height),new x,S,new x,new v(o.width,o.height))}f<2&&void 0!==o.text&&o.text&&renderingX.renderText(m,new v(o.width,o.height),new x,o.text,s,!0,null,this.customFonts);var I=e.id.split(".").join("-"),b=I+"-"+f+".png",R=p.join(n,b);u.output(R,function(t){t?(d-=1)<=0&&i&&i(t):(this.trackedRes.push(new c(w,g.color,new a(o.text,s),b,o.width,o.height,g)),e.texList[0].slices[f].originSrc=e.texList[0].slices[f].imgSrc,e.texList[0].slices[f].imgSrc=p.join(r||"",b),(d-=1)<=0&&i&&i())}.bind(this)),m.restore()}.bind(this))}else i&&i()},d.prototype.renderButtonGroup=function(e,t,n,r,i){var o=e.info;if(o){var s=o.width,a=o.height,g=o.interval,f=o.count;"horizontal"===o.arrange?s=(s-(f-1)*g)/f:a=(a-(f-1)*g)/f;for(var d=e.texList,u=2*f,m=[],w=0;w<f;w++)for(var y=0;y<2;y++)m.push(d[w].slices[y]);d[f]&&(m.push(d[f].slices[0]),u++),m.map(function(o,g){var f=new l(s,a),d=f.getContext("2d"),m=o;d.clearRect(0,0,s,a),d.save(),renderingX.renderColor(d,new v(s,a),new x,m.color);var w=m.imgSrc;if(""!==w){var y=p.join(t,w),S=this.getTargetImage(y);if(!S){var j=new Image;try{j.src=h(y),this.addImage(y,j),S=j}catch(e){S=null}}renderingX.renderImage(d,new v(s,a),new x,S,new x,new v(s,a))}var I=e.id.split(".").join("-"),b=I+"-"+g+".png",R=p.join(n,b);f.output(R,function(e){e?(u-=1)<=0&&i&&i(e):(this.trackedRes.push(new c(w,m.color,null,b,s,a,o)),m.originSrc=m.imgSrc,m.imgSrc=p.join(r||"",b),(u-=1)<=0&&i&&i())}.bind(this)),d.restore()}.bind(this))}else i&&i()},d.prototype.renderDashboard=function(e,t,n,r,i){var o=e.info;if(o){var s=e.texList,a=s.length;s.map(function(g,f){var d=o.width,u=o.height;1===f&&(d=u=o.pointerLength/Math.sqrt(2));var m=new l(d,u),w=m.getContext("2d"),y=s[f].slices[0];w.clearRect(0,0,d,u),w.save(),renderingX.renderColor(w,new v(d,u),new x,y.color);var S=y.imgSrc;if(""!==S){var j=p.join(t,S),I=this.getTargetImage(j);if(!I){var b=new Image;try{b.src=h(j),this.addImage(j,b),I=b}catch(e){I=null}}renderingX.renderImage(w,new v(d,u),new x,I,new x,new v(d,u))}var R=e.id.split(".").join("-"),L=R+"-"+f+".png",T=p.join(n,L);m.output(T,function(e){e?(a-=1)<=0&&i&&i(e):(this.trackedRes.push(new c(S,y.color,null,L,d,u,y)),y.originSrc=y.imgSrc,y.imgSrc=p.join(r||"",L),(a-=1)<=0&&i&&i())}.bind(this)),w.restore()}.bind(this))}else i&&i()},d.prototype.renderSlide=function(e,t,n,r,i){var o=e.info;if(o){var s="",a={},g={};g["font-style"]=e.info.fontItalic,g["font-weight"]=e.info.fontBold,g["font-size"]=e.info.fontSize,g["font-family"]=e.info.fontFamily,g["font-color"]=e.info.fontColor,a.color=g["font-color"],a.font=(g["font-style"]||"")+" "+(g["font-variant"]||"")+" "+(g["font-weight"]||"")+" "+(g["font-size"]||24)+"px "+(g["font-family"]||"arial"),a.textAlign="center",a.textBaseline="middle";var f=o.width,d=o.height,u=e.texList[0],m=u.slices.length;u.slices.map(function(g,w){var y=new l(f,d),S=y.getContext("2d"),j=u.slices[w];S.clearRect(0,0,f,d),S.save(),renderingX.renderColor(S,new v(f,d),new x,j.color);var I=j.imgSrc;if(""!==I){var b=p.join(t,I),R=this.getTargetImage(b);if(!R){var L=new Image;try{L.src=h(b),this.addImage(b,L),R=L}catch(e){R=null}}renderingX.renderImage(S,new v(f,d),new x,R,new x,new v(f,d))}(s=j.text)&&renderingX.renderText(S,new v(o.width,o.height),new x,s,a,!0,null,this.customFonts);var T=e.id.split(".").join("-"),k=T+"-"+w+".png",C=p.join(n,k);y.output(C,function(e){e?i&&i(e):(this.trackedRes.push(new c(I,j.color,null,k,f,d,j)),j.originSrc=j.imgSrc,j.imgSrc=p.join(r||"",k),(m-=1)<=0&&i&&i())}.bind(this)),S.restore()}.bind(this))}else i&&i()},d.prototype.renderTexNum=function(e,t,n,r,i){var o=e.info;if(o){var s=o.characterW,a=o.characterH,g=e.texList[0],f=g.slices.length;g.slices.map(function(o,d){var u=new l(s,a),m=u.getContext("2d"),w=g.slices[d];m.clearRect(0,0,s,a),m.save(),renderingX.renderColor(m,new v(s,a),new x,w.color);var y=w.imgSrc;if(""!==y){var S=p.join(t,y),j=this.getTargetImage(S);if(!j){var I=new Image;try{I.src=h(S),this.addImage(S,I),j=I}catch(e){j=null}}renderingX.renderImage(m,new v(s,a),new x,j,new x,new v(s,a))}var b=e.id.split(".").join("-"),R=b+"-"+d+".png",L=p.join(n,R);u.output(L,function(e){e?i&&i(e):(this.trackedRes.push(new c(y,w.color,null,R,s,a,w)),w.originSrc=w.imgSrc,w.imgSrc=p.join(r||"",R),(f-=1)<=0&&i&&i())}.bind(this)),m.restore()}.bind(this))}else i&&i()},d.prototype.renderTexTime=function(e,t,n,r,i){var o=e.info;if(o){var s=o.characterW,a=o.characterH,g=_.cloneDeep(e.texList[0]);g.slices.push(e.texList[1].slices[0]);var f=g.slices.length;g.slices.map(function(o,d){var u=new l(s,a),m=u.getContext("2d"),w=g.slices[d];m.clearRect(0,0,s,a),m.save(),renderingX.renderColor(m,new v(s,a),new x,w.color);var y=w.imgSrc;if(""!==y){var S=p.join(t,y),j=this.getTargetImage(S);if(!j){var I=new Image;try{I.src=h(S),this.addImage(S,I),j=I}catch(e){j=null}}renderingX.renderImage(m,new v(s,a),new x,j,new x,new v(s,a))}var b=e.id.split(".").join(""),R=b+"-"+d+".png",L=p.join(n,R);u.output(L,function(e){e?i&&i(e):(this.trackedRes.push(new c(y,w.color,null,R,s,a,w)),w.originSrc=w.imgSrc,w.imgSrc=p.join(r||"",R),(f-=1)<=0&&i&&i())}.bind(this));for(var T=[],k=0;k<13;k++)T.push(g.slices[k]);e.texList[0].slices=T,m.restore()}.bind(this))}else i&&i()},d.prototype.renderRotateImg=function(e,t,n,r,i){var o=e.info;if(o){var s=o.width,a=o.height,g=e.texList[0],f=g.slices.length;g.slices.map(function(o,d){var u=new l(s,a),m=u.getContext("2d"),w=g.slices[d];m.clearRect(0,0,s,a),m.save(),renderingX.renderColor(m,new v(s,a),new x,w.color);var y=w.imgSrc;if(""!==y){var S=p.join(t,y),j=this.getTargetImage(S);if(!j){var I=new Image;try{I.src=h(S),this.addImage(S,I),j=I}catch(e){j=null}}renderingX.renderImage(m,new v(s,a),new x,j,new x,new v(s,a))}var b=e.id.split(".").join("-"),R=b+"-"+d+".png",L=p.join(n,R);u.output(L,function(e){e?i&&i(e):(this.trackedRes.push(new c(y,w.color,null,R,s,a,w)),w.originSrc=w.imgSrc,w.imgSrc=p.join(r||"",R),(f-=1)<=0&&i&&i())}.bind(this)),m.restore()}.bind(this))}else i&&i()},d.prototype.renderOscilloscope=function(e,t,n,r,i){var o=e.info,s=o.width,a=o.height;if(o){var c=new l(s,a),g=c.getContext("2d");g.clearRect(0,0,s,a);var f=e.texList[0].slices[0];if(renderingX.renderColor(g,new v(s,a),new x,f.color),""!==f.imgSrc){var d=p.join(t,f.imgSrc),u=this.getTargetImage(d);if(!u){var m=new Image;try{m.src=h(d),this.addImage(d,m),u=m}catch(e){u=null}}renderingX.renderImage(g,new v(s,a),new x,u,new x,new v(s,a))}renderingX.renderGrid(g,new v(s,a),new x,new v(o.spacing,o.spacing),new x);var w=e.id.split(".").join("-"),y=w+"-1.png",S=p.join(n,y);c.output(S,function(e){e?i&&i(e):(f.originSrc=f.imgSrc,f.imgSrc=p.join(r||"",y),i&&i())}.bind(this))}else i&&i()},d.prototype.renderTextArea=function(e,t,n,r,i){var o=e.info,s=o.width,g=o.height;if(o){var f={},d={};d["font-style"]=e.info.fontItalic,d["font-weight"]=e.info.fontBold,d["font-size"]=e.info.fontSize,d["font-family"]=e.info.fontFamily,d["font-color"]=e.info.fontColor,f.color=d["font-color"],f.font=(d["font-style"]||"")+" "+(d["font-variant"]||"")+" "+(d["font-weight"]||"")+" "+(d["font-size"]||24)+"px "+(d["font-family"]||"arial"),f.textAlign="center",f.textBaseline="middle",f.arrange=e.info.arrange;var u=new l(s,g),m=u.getContext("2d");m.clearRect(0,0,s,g);var w=e.texList[0].slices[0];if(renderingX.renderColor(m,new v(s,g),new x,w.color),""!==w.imgSrc){var y=p.join(t,w.imgSrc),S=this.getTargetImage(y);if(!S){var j=new Image;try{j.src=h(y),this.addImage(y,j),S=j}catch(e){S=null}}renderingX.renderImage(m,new v(s,g),new x,S,new x,new v(s,g))}o.text&&""!==o.text&&renderingX.renderText(m,new v(s,g),new x,o.text,f,!0,new x(.5*s,.5*g),this.customFonts);var I=e.id.split(".").join("-"),b=I+"-1.png",R=new Date,L=p.join(n,b);u.output(L,function(e){if(e)i&&i(e);else{this.trackedRes.push(new c(w.imgSrc,w.color,new a(o.text,f),b,s,g,w)),w.originSrc=w.imgSrc,w.imgSrc=p.join(r||"",b);var t=new Date;console.log("Output stream costs: ",(t-R)/1e3+"s"),i&&i()}}.bind(this))}else i&&i()},d.prototype.renderGeneral=function(e,t,n,r,i){if(e.info){var o,s=e.layers.length,a=function(e){s--,e&&(o=e,console.log("layerHandler",e)),0==s&&i&&i(o)}.bind(this);s?e.layers.forEach(function(i,o){var s=i.width,g=i.height;if(i.subLayers&&i.subLayers.image&&i.subLayers.image.textureList.length){var f,d=i.subLayers.image.textureList.length,u=function(e){d--,e&&(f=e,console.log("texErr",e)),0==d&&a&&a(f)};i.subLayers.image.textureList.forEach(function(a,f){var d=new l(s,g),m=d.getContext("2d");m.clearRect(0,0,s,g),m.save();var w=p.join(t,a),y=this.getTargetImage(w);if(!y){var S=new Image;try{S.src=h(w),this.addImage(w,S),y=S}catch(e){y=null}}renderingX.renderImage(m,new v(s,g),new x,y,new x,new v(s,g));var j;j=void 0!==e.id?e.id.split(".").join("-"):e.generalType;var I=j+"-"+o+".png",b=p.join(n,I);d.output(b,function(e){e?u&&u(e):(this.trackedRes.push(new c(a,null,null,I,s,g,null,i.subLayers.image.textureList,f)),i.subLayers.image.textureList[f]=p.join(r||"",I),u&&u())}.bind(this)),m.restore()}.bind(this))}else a&&a()}.bind(this)):i&&i()}else i&&i()},d.prototype.renderWidget=function(e,t,n,r,i){switch(e.subType){case"MyButton":case"MySwitch":this.renderButton(e,t,n,r,i);break;case"MyButtonGroup":this.renderButtonGroup(e,t,n,r,i);break;case"MySlide":case"MyAnimation":this.renderSlide(e,t,n,r,i);break;case"MyOscilloscope":this.renderOscilloscope(e,t,n,r,i);break;case"MyTextArea":this.renderTextArea(e,t,n,r,i);break;case"MyDashboard":this.renderDashboard(e,t,n,r,i);break;case"MyRotateImg":this.renderRotateImg(e,t,n,r,i);break;case"MyTexNum":this.renderTexNum(e,t,n,r,i);break;case"MyTexTime":this.renderTexTime(e,t,n,r,i);break;case"general":this.renderGeneral(e,t,n,r,i);break;default:i&&i()}},d.prototype.removeSameOutputFiles=function(){for(var e=[],t=0;t<this.trackedRes.length;t++)for(var n=this.trackedRes[t],r=0;r<t;r++)if(this.trackedRes[r].equal(n)){var i=this.trackedRes[r].getImgSrc();e.push(i),n.setImgSrc(i);break}return e},d.prototype.renderFontPng=function(t,n,i,s,a){var c=t["font-family"];if(new RegExp("[\\u4E00-\\u9FFF]+","g").test(c)){for(var l="",g=0;g<c.length;g++)l+=c.charCodeAt(g).toString(32);c=l}var h=c+"-"+t["font-size"]+"-"+t["font-bold"]+"-"+(t["font-italic"]||"null")+".png",f={},d="",u=p.join(i,h);if(f.paddingRatio=1.2,d=r.generateSingleFont(t,f),d=r.pngStream(d,m),m)try{w.writeFileSync(u,d),a&&a()}catch(e){a&&a(e)}else o(d,h,"/project/"+e.getResourceUrl().split("/")[2]+"/generatetex",a,a)},this.renderProject=function(t,i,o){function a(e){console.log(e),h||(o&&o(),h=!0)}function c(){console.log("zip ok"),i&&i()}function l(e,t){S.compress(e,t,function(e){e?a(e):c()}.bind(this))}for(var g,h=!1,f=e.getProjectUrl(),u=e.getResourceUrl(),v=p.join(u,"data.json"),x=[],y=0;y<t.pageList.length;y++)for(var j=t.pageList[y],I=0;I<j.canvasList.length;I++)for(var b=j.canvasList[I],R=0;R<b.subCanvasList.length;R++)for(var L=b.subCanvasList[R],T=0;T<L.widgetList.length;T++)x.push(L.widgetList[T]);x=x.concat(t.systemWidgets||[]);var k=r.getFontCollections(x),C=x.length+k.length,F=0,X=null;if(C>0){var z=!0,B=function(r){if(r)z=!1,a("generate error");else if((C-=1)<=0&&z){console.log("trans finished");g.removeSameOutputFiles();m?w.writeFile(v,JSON.stringify(t,null,4),function(e){if(e)a(e);else{console.log("write ok");var t=p.join(f,"resources");l(p.join(f,"file.zip"),t)}}):n({method:"POST",url:"/project/"+e.getResourceUrl().split("/")[2]+"/savedatacompress",data:{dataStructure:t}}).success(function(t){"ok"==t?window.location.href="/project/"+e.getResourceUrl().split("/")[2]+"/download":(console.log(t),toastr.info("生成失败")),i&&i()}).error(function(e){a(e),o&&o()})}}.bind(this);if(m){g=new d;var O=p.join(global.__dirname,p.dirname(window.location.pathname));if(0!==k.length)for(F=0;F<k.length;F++)k[F],g.renderFontPng(k[F],O,u,u,B);for(F=0;F<x.length;F++)X=x[F],g.renderWidget(X,O,u,u,B)}else{if(g=new d(s()),0!==k.length)for(F=0;F<k.length;F++)k[F],g.renderFontPng(k[F],"/",u,u,B);for(F=0;F<x.length;F++)X=x[F],g.renderWidget(X,"/",u,u,B)}}else m?w.writeFile(v,JSON.stringify(t,null,4),function(e){if(e)a(res,500,e);else{var t=p.join(f,"resources");l(p.join(f,"file.zip"),t)}}):n({method:"POST",url:"/project/"+e.getResourceUrl().split("/")[2]+"/savedatacompress",data:{dataStructure:t}}).success(function(t){"ok"==t?window.location.href="/project/"+e.getResourceUrl().split("/")[2]+"/download":(console.log(t),toastr.info("生成失败")),i&&i()}).error(function(e){a(e),o&&o()})},m)var y=require("child_process").spawn,S=new u}]);