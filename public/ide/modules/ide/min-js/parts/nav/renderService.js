ideServices.service("RenderSerive",["ResourceService","Upload","$http","FontGeneratorService",function(e,t,n,i){function r(e){var t;t=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):unescape(e.split(",")[1]);for(var n=e.split(",")[0].split(":")[1].split(";")[0],i=new Uint8Array(t.length),r=0;r<t.length;r++)i[r]=t.charCodeAt(r);return new Blob([i],{type:n})}function o(e,n,i,o,a){var s=r(e),c=function(){o&&o()},l=function(e){console.log(e),a&&a()};t.upload({url:i,data:{file:s,name:n}}).then(c,l)}function a(){for(var t=e.getGlobalResources(),n={},i=0;i<t.length;i++){var r=t[i];n[r.id]=r.content}return n}function s(e,t){this.text=e,this.style=t}function c(e,t,n,i,r,o,a){this.img=e,this.color=t,this.text=n,this.outFile=i,this.w=r,this.h=o,this.slice=a}function l(e,t){this.width=e,this.height=t;var n=document.createElement("canvas");n.width=this.width,n.height=this.height,n.hidden=!0,this.canvasObj=n}function h(e){switch(e){case"jpg":case"jpeg":return"image/jpeg";case"png":return"image/png";case"bmp":return"image/bmp";default:return"image/png"}}function g(e){if(y){return"data:"+h(m.extname(e))+";base64,"+S.readFileSync(e).toString("base64")}return e}function f(e){var t=e.split("/");return t[t.length-1]}function d(e,t){return"r-"+e.split(".").join("-")+"-"+t+".png"}function u(e,t){this.images=e||{},window.images=this.images,this.customFonts=t||{},this.trackedRes=[]}function p(){this.totalSize=0}function w(){var e,t="win32"===require("os").platform()?"win":"other",n="zip";"win"===t?(n=".\\utils\\7z\\7z.exe",e=["a"]):e=["-rj"];var i,r,o,a=function(){"win"===t&&"\\"!==r[r.length-1]&&(r+="\\*");var a=e.concat(i).concat(r),s=j(n,a);console.log("command",n,a),s.stdout.on("data",function(e){}),s.stderr.on("data",function(e){}),s.on("error",function(e){console.log(e),o(e)}),s.on("exit",function(e){0===e?o():o(new Error(e))})};this.compress=function(e,t,n){i=e,r=t,o=n,S.stat(e,function(t,n){n&&n.isFile()?S.unlink(e,function(e){e?o(e):a()}):a()})}}var m,y=!1;try{m=require("path");var S=require("fs");y=!0}catch(e){m={},m.sep="/",m.join=function(e,t){return e[e.length-1]==m.sep&&(e=e.slice(0,e.length-1)),t[0]==m.sep&&(t=t.slice(1)),e+m.sep+t}}c.prototype.equal=function(e){for(var t=["img","color","text","w","h"],n=0;n<t.length;n++){var i=t[n];if(this[i]!=e[i])return!1}return!0},l.prototype.getContext=function(e){if("2d"===e)return this.canvasObj.getContext("2d")},l.prototype.pngStream=function(){var e=this.canvasObj.toDataURL();if(y){return new Buffer(e.split(",")[1],"base64")}return e},l.prototype.toBuffer=function(){var e=this.canvasObj.toDataURL();return new Buffer(e.split(",")[1],"base64")},l.prototype.output=function(t,n){var i=this.pngStream(),r=f(t);if(y)try{S.writeFileSync(t,i),n&&n()}catch(e){n&&n(e)}else o(i,r,"/project/"+e.getResourceUrl().split("/")[2]+"/generatetex",n,n)};var x=renderingX.Size,b=renderingX.Pos;if(u.prototype.compareTrackedRes=function(e){for(var t=0;t<this.trackedRes.length;t++){if(this.trackedRes[t].eq(e))return!0}return!1},u.prototype.getTargetImage=function(e){return y?"undefined"!==this.images[e]?this.images[e]:null:this.images[f(e)]},u.prototype.addImage=function(e,t){this.images[e]=t},u.prototype.renderButton=function(e,t,n,i,r){var o=e.info;if(o){var a={},h={};h["font-style"]=e.info.fontItalic,h["font-weight"]=e.info.fontBold,h["font-size"]=e.info.fontSize,h["font-family"]=e.info.fontFamily,h["font-color"]=e.info.fontColor,a.color=h["font-color"],a.font=(h["font-style"]||"")+" "+(h["font-variant"]||"")+" "+(h["font-weight"]||"")+" "+(h["font-size"]||24)+"px "+(h["font-family"]||"arial"),a.textAlign="center",a.textBaseline="middle";var f=e.texList[0].slices,u=f.length;f.map(function(h,f){var p=new l(o.width,o.height),v=p.getContext("2d"),w=h.imgSrc;v.clearRect(0,0,o.width,o.height),v.save(),renderingX.renderColor(v,new x(o.width,o.height),new b,h.color);var y;if(""!==w){y=m.join(t,w);var S=this.getTargetImage(y);if(!S){var j=new Image;try{j.src=g(y),this.addImage(y,j),S=j}catch(e){S=null}}renderingX.renderImage(v,new x(o.width,o.height),new b,S,new b,new x(o.width,o.height))}f<2&&void 0!==o.text&&o.text&&renderingX.renderText(v,new x(o.width,o.height),new b,o.text,a,!0,null,this.customFonts);var I=d(e.id,f),R=m.join(n,I);p.output(R,function(t){t?(u-=1)<=0&&r&&r(t):(this.trackedRes.push(new c(w,h.color,new s(o.text,a),I,o.width,o.height,h)),e.texList[0].slices[f].originSrc=e.texList[0].slices[f].imgSrc,e.texList[0].slices[f].imgSrc=m.join(i||"",I),(u-=1)<=0&&r&&r())}.bind(this)),v.restore()}.bind(this))}else r&&r()},u.prototype.renderButtonGroup=function(e,t,n,i,r){var o=e.info;if(o){var a=o.width,s=o.height,h=o.interval,f=o.count;"horizontal"===o.arrange?a=(a-(f-1)*h)/f:s=(s-(f-1)*h)/f;for(var u=e.texList,p=2*f,v=[],w=0;w<f;w++)for(var y=0;y<2;y++)v.push(u[w].slices[y]);u[f]&&(v.push(u[f].slices[0]),p++),v.map(function(o,h){var f=new l(a,s),u=f.getContext("2d"),v=o;u.clearRect(0,0,a,s),u.save(),renderingX.renderColor(u,new x(a,s),new b,v.color);var w=v.imgSrc;if(""!==w){var y=m.join(t,w),S=this.getTargetImage(y);if(!S){var j=new Image;try{j.src=g(y),this.addImage(y,j),S=j}catch(e){S=null}}renderingX.renderImage(u,new x(a,s),new b,S,new b,new x(a,s))}var I=d(e.id,h),R=m.join(n,I);f.output(R,function(e){e?(p-=1)<=0&&r&&r(e):(this.trackedRes.push(new c(w,v.color,null,I,a,s,o)),v.originSrc=v.imgSrc,v.imgSrc=m.join(i||"",I),(p-=1)<=0&&r&&r())}.bind(this)),u.restore()}.bind(this))}else r&&r()},u.prototype.renderDashboard=function(e,t,n,i,r){var o=e.info;if(o){var a=e.texList,s=a.length;a.map(function(h,f){var u=o.width,p=o.height;1===f&&(u=p=o.pointerLength/Math.sqrt(2));var v=new l(u,p),w=v.getContext("2d"),y=a[f].slices[0];w.clearRect(0,0,u,p),w.save(),renderingX.renderColor(w,new x(u,p),new b,y.color);var S=y.imgSrc;if(""!==S){var j=m.join(t,S),I=this.getTargetImage(j);if(!I){var R=new Image;try{R.src=g(j),this.addImage(j,R),I=R}catch(e){I=null}}renderingX.renderImage(w,new x(u,p),new b,I,new b,new x(u,p))}var T=d(e.id,f),L=m.join(n,T);v.output(L,function(e){e?(s-=1)<=0&&r&&r(e):(this.trackedRes.push(new c(S,y.color,null,T,u,p,y)),y.originSrc=y.imgSrc,y.imgSrc=m.join(i||"",T),(s-=1)<=0&&r&&r())}.bind(this)),w.restore()}.bind(this))}else r&&r()},u.prototype.renderSlide=function(e,t,n,i,r){var o=e.info;if(o){var a="",s={},h={};h["font-style"]=e.info.fontItalic,h["font-weight"]=e.info.fontBold,h["font-size"]=e.info.fontSize,h["font-family"]=e.info.fontFamily,h["font-color"]=e.info.fontColor,s.color=h["font-color"],s.font=(h["font-style"]||"")+" "+(h["font-variant"]||"")+" "+(h["font-weight"]||"")+" "+(h["font-size"]||24)+"px "+(h["font-family"]||"arial"),s.textAlign="center",s.textBaseline="middle";var f=o.width,u=o.height,p=e.texList[0],v=p.slices.length;p.slices.map(function(h,w){var y=new l(f,u),S=y.getContext("2d"),j=p.slices[w];S.clearRect(0,0,f,u),S.save(),renderingX.renderColor(S,new x(f,u),new b,j.color);var I=j.imgSrc;if(""!==I){var R=m.join(t,I),T=this.getTargetImage(R);if(!T){var L=new Image;try{L.src=g(R),this.addImage(R,L),T=L}catch(e){T=null}}renderingX.renderImage(S,new x(f,u),new b,T,new b,new x(f,u))}(a=j.text)&&renderingX.renderText(S,new x(o.width,o.height),new b,a,s,!0,null,this.customFonts);var k=d(e.id,w),z=m.join(n,k);y.output(z,function(e){e?r&&r(e):(this.trackedRes.push(new c(I,j.color,null,k,f,u,j)),j.originSrc=j.imgSrc,j.imgSrc=m.join(i||"",k),(v-=1)<=0&&r&&r())}.bind(this)),S.restore()}.bind(this))}else r&&r()},u.prototype.renderTexNum=function(e,t,n,i,r){var o=e.info;if(o){var a=o.characterW,s=o.characterH,h=e.texList[0],f=h.slices.length;h.slices.map(function(o,u){var p=new l(a,s),v=p.getContext("2d"),w=h.slices[u];v.clearRect(0,0,a,s),v.save(),renderingX.renderColor(v,new x(a,s),new b,w.color);var y=w.imgSrc;if(""!==y){var S=m.join(t,y),j=this.getTargetImage(S);if(!j){var I=new Image;try{I.src=g(S),this.addImage(S,I),j=I}catch(e){j=null}}renderingX.renderImage(v,new x(a,s),new b,j,new b,new x(a,s))}var R=d(e.id,u),T=m.join(n,R);p.output(T,function(e){e?r&&r(e):(this.trackedRes.push(new c(y,w.color,null,R,a,s,w)),w.originSrc=w.imgSrc,w.imgSrc=m.join(i||"",R),(f-=1)<=0&&r&&r())}.bind(this)),v.restore()}.bind(this))}else r&&r()},u.prototype.renderTexTime=function(e,t,n,i,r){var o=e.info;if(o){var a=o.characterW,s=o.characterH,h=_.cloneDeep(e.texList[0]);h.slices.push(e.texList[1].slices[0]);var f=h.slices.length;h.slices.map(function(o,u){var p=new l(a,s),v=p.getContext("2d"),w=h.slices[u];v.clearRect(0,0,a,s),v.save(),renderingX.renderColor(v,new x(a,s),new b,w.color);var y=w.imgSrc;if(""!==y){var S=m.join(t,y),j=this.getTargetImage(S);if(!j){var I=new Image;try{I.src=g(S),this.addImage(S,I),j=I}catch(e){j=null}}renderingX.renderImage(v,new x(a,s),new b,j,new b,new x(a,s))}var R=d(e.id,u),T=m.join(n,R);p.output(T,function(e){e?r&&r(e):(this.trackedRes.push(new c(y,w.color,null,R,a,s,w)),w.originSrc=w.imgSrc,w.imgSrc=m.join(i||"",R),(f-=1)<=0&&r&&r())}.bind(this));for(var L=[],k=0;k<13;k++)L.push(h.slices[k]);e.texList[0].slices=L,v.restore()}.bind(this))}else r&&r()},u.prototype.renderRotateImg=function(e,t,n,i,r){var o=e.info;if(o){var a=o.width,s=o.height,h=e.texList[0],f=h.slices.length;h.slices.map(function(o,u){var p=new l(a,s),v=p.getContext("2d"),w=h.slices[u];v.clearRect(0,0,a,s),v.save(),renderingX.renderColor(v,new x(a,s),new b,w.color);var y=w.imgSrc;if(""!==y){var S=m.join(t,y),j=this.getTargetImage(S);if(!j){var I=new Image;try{I.src=g(S),this.addImage(S,I),j=I}catch(e){j=null}}renderingX.renderImage(v,new x(a,s),new b,j,new b,new x(a,s))}var R=d(e.id,u),T=m.join(n,R);p.output(T,function(e){e?r&&r(e):(this.trackedRes.push(new c(y,w.color,null,R,a,s,w)),w.originSrc=w.imgSrc,w.imgSrc=m.join(i||"",R),(f-=1)<=0&&r&&r())}.bind(this)),v.restore()}.bind(this))}else r&&r()},u.prototype.renderOscilloscope=function(e,t,n,i,r){var o=e.info,a=o.width,s=o.height;if(o){var c=new l(a,s),h=c.getContext("2d");h.clearRect(0,0,a,s);var f=e.texList[0].slices[0];if(renderingX.renderColor(h,new x(a,s),new b,f.color),""!==f.imgSrc){var u=m.join(t,f.imgSrc),p=this.getTargetImage(u);if(!p){var v=new Image;try{v.src=g(u),this.addImage(u,v),p=v}catch(e){p=null}}renderingX.renderImage(h,new x(a,s),new b,p,new b,new x(a,s))}renderingX.renderGrid(h,new x(a,s),new b,new x(o.spacing,o.spacing),new b);var w=d(e.id,1),y=m.join(n,w);c.output(y,function(e){e?r&&r(e):(f.originSrc=f.imgSrc,f.imgSrc=m.join(i||"",w),r&&r())}.bind(this))}else r&&r()},u.prototype.renderTextArea=function(e,t,n,i,r){var o=e.info,a=o.width,h=o.height;if(o){var f={},u={};u["font-style"]=e.info.fontItalic,u["font-weight"]=e.info.fontBold,u["font-size"]=e.info.fontSize,u["font-family"]=e.info.fontFamily,u["font-color"]=e.info.fontColor,f.color=u["font-color"],f.font=(u["font-style"]||"")+" "+(u["font-variant"]||"")+" "+(u["font-weight"]||"")+" "+(u["font-size"]||24)+"px "+(u["font-family"]||"arial"),f.textAlign="center",f.textBaseline="middle",f.arrange=e.info.arrange;var p=new l(a,h),v=p.getContext("2d");v.clearRect(0,0,a,h);var w=e.texList[0].slices[0];if(renderingX.renderColor(v,new x(a,h),new b,w.color),""!==w.imgSrc){var y=m.join(t,w.imgSrc),S=this.getTargetImage(y);if(!S){var j=new Image;try{j.src=g(y),this.addImage(y,j),S=j}catch(e){S=null}}renderingX.renderImage(v,new x(a,h),new b,S,new b,new x(a,h))}o.text&&""!==o.text&&renderingX.renderText(v,new x(a,h),new b,o.text,f,!0,new b(.5*a,.5*h),this.customFonts);var I=d(e.id,1),R=(new Date,m.join(n,I));p.output(R,function(e){if(e)r&&r(e);else{this.trackedRes.push(new c(w.imgSrc,w.color,new s(o.text,f),I,a,h,w)),w.originSrc=w.imgSrc,w.imgSrc=m.join(i||"",I);new Date;r&&r()}}.bind(this))}else r&&r()},u.prototype.renderWidget=function(e,t,n,i,r){switch(e.subType){case"MyButton":case"MySwitch":this.renderButton(e,t,n,i,r);break;case"MyButtonGroup":this.renderButtonGroup(e,t,n,i,r);break;case"MySlide":case"MyAnimation":this.renderSlide(e,t,n,i,r);break;case"MyOscilloscope":this.renderOscilloscope(e,t,n,i,r);break;case"MyTextArea":this.renderTextArea(e,t,n,i,r);break;case"MyDashboard":this.renderDashboard(e,t,n,i,r);break;case"MyRotateImg":this.renderRotateImg(e,t,n,i,r);break;case"MyTexNum":this.renderTexNum(e,t,n,i,r);break;case"MyTexTime":this.renderTexTime(e,t,n,i,r);break;default:r&&r()}},u.prototype.removeSameOutputFiles=function(){for(var e=[],t=0;t<this.trackedRes.length;t++)for(var n=this.trackedRes[t],i=0;i<t;i++)if(this.trackedRes[i].equal(n)){e.push(n.slice.imgSrc),n.slice.imgSrc=this.trackedRes[i].slice.imgSrc;break}return e},u.prototype.renderFontPng=function(t,n,r,a,s){var c=t["font-family"];if(new RegExp("[\\u4E00-\\u9FFF]+","g").test(c)){for(var l="",h=0;h<c.length;h++)l+=c.charCodeAt(h).toString(32);c=l}var g=c+"-"+t["font-size"]+"-"+t["font-bold"]+"-"+(t["font-italic"]||"null")+".png",f={},d="",u=m.join(r,g);if(f.paddingRatio=1.2,d=i.generateSingleFont(t,f),d=i.pngStream(d,y),y)try{S.writeFileSync(u,d),s&&s()}catch(e){s&&s(e)}else o(d,g,"/project/"+e.getResourceUrl().split("/")[2]+"/generatetex",s,s)},this.renderProject=function(t,r,o){function s(e){console.log(e),g||(o&&o(),g=!0)}function c(){console.log("zip ok"),r&&r()}function l(e,t){I.compress(e,t,function(e){e?s(e):c()}.bind(this))}for(var h,g=!1,f=e.getProjectUrl(),d=e.getResourceUrl(),p=m.join(d,"data.json"),v=[],w=0;w<t.pageList.length;w++)for(var x=t.pageList[w],b=0;b<x.canvasList.length;b++)for(var j=x.canvasList[b],R=0;R<j.subCanvasList.length;R++)for(var T=j.subCanvasList[R],L=0;L<T.widgetList.length;L++)v.push(T.widgetList[L]);var k=i.getFontCollections(v),z=v.length+k.length,C=0,F=null;if(z>0){var M=!0,X=function(i){if(i)M=!1,s("generate error");else if((z-=1)<=0&&M){console.log("trans finished");h.removeSameOutputFiles();y?S.writeFile(p,JSON.stringify(t,null,4),function(e){if(e)s(e);else{console.log("write ok");var t=m.join(f,"resources");l(m.join(f,"file.zip"),t)}}):n({method:"POST",url:"/project/"+e.getResourceUrl().split("/")[2]+"/savedatacompress",data:{dataStructure:t}}).success(function(t){"ok"==t?window.location.href="/project/"+e.getResourceUrl().split("/")[2]+"/download":(console.log(t),toastr.info("生成失败")),r&&r()}).error(function(e){s(e),o&&o()})}}.bind(this);if(y){h=new u;var B=m.join(global.__dirname,m.dirname(window.location.pathname));if(0!==k.length)for(C=0;C<k.length;C++)k[C],h.renderFontPng(k[C],B,d,d,X);for(C=0;C<v.length;C++)F=v[C],h.renderWidget(F,B,d,d,X)}else{if(h=new u(a()),0!==k.length)for(C=0;C<k.length;C++)k[C],h.renderFontPng(k[C],"/",d,d,X);for(C=0;C<v.length;C++)F=v[C],h.renderWidget(F,"/",d,d,X)}}else y?S.writeFile(p,JSON.stringify(t,null,4),function(e){if(e)s(res,500,e);else{var t=m.join(f,"resources");l(m.join(f,"file.zip"),t)}}):n({method:"POST",url:"/project/"+e.getResourceUrl().split("/")[2]+"/savedatacompress",data:{dataStructure:t}}).success(function(t){"ok"==t?window.location.href="/project/"+e.getResourceUrl().split("/")[2]+"/download":(console.log(t),toastr.info("生成失败")),r&&r()}).error(function(e){s(e),o&&o()})},p.prototype.convertTotalSize=function(){return this.totalSize/1024+"KB"},p.prototype.addSize=function(e,t,n){var i=Number(Number(e)*Number(t))||0;this.totalSize+=i*(n||4)},p.prototype.calcButton=function(e){if(e.info){var t=e.texList[0].slices;t.length,t.map(function(t,n){this.addSize(e.info.width,e.info.height)}.bind(this))}},p.prototype.calcButtonGroup=function(e){var t=e.info;if(t){var n=t.width,i=t.height,r=t.interval,o=t.count;"horizontal"===t.arrange?n=(n-(o-1)*r)/o:i=(i-(o-1)*r)/o;for(var a=e.texList,s=2*o,c=[],l=0;l<o;l++)for(var h=0;h<2;h++)c.push(a[l].slices[h]);a[o]&&(c.push(a[o].slices[0]),s++),c.map(function(e,t){this.addSize(n,i)}.bind(this))}},p.prototype.calcDashboard=function(e){var t=e.info;if(t){var n=e.texList;n.length;n.map(function(e,n){var i=t.width,r=t.height;1===n&&(i=r=t.pointerLength/Math.sqrt(2)),this.addSize(i,r)}.bind(this))}},p.prototype.calcSlide=function(e){var t=e.info;if(t){v;var n=t.width,i=t.height,r=e.texList[0];r.slices.length;r.slices.map(function(e,t){this.addSize(n,i)}.bind(this))}},p.prototype.calcTexNum=function(e){var t=e.info;if(t){var n=t.characterW,i=t.characterH,r=e.texList[0];r.slices.length;r.slices.map(function(e,t){this.addSize(n,i)}.bind(this))}},p.prototype.calcTexTime=function(e){var t=e.info;if(t){var n=t.characterW,i=t.characterH,r=_.cloneDeep(e.texList[0]);r.slices.push(e.texList[1].slices[0]);r.slices.length;r.slices.map(function(e,t){this.addSize(n,i)}.bind(this))}},p.prototype.calcRotateImg=function(e){var t=e.info;if(t){var n=t.width,i=t.height,r=e.texList[0];r.slices.length;r.slices.map(function(e,t){this.addSize(n,i)}.bind(this))}},p.prototype.calcOscilloscope=function(e){var t=e.info,n=t.width,i=t.height;t&&this.addSize(n,i)},p.prototype.calcTextArea=function(e){var t=e.info,n=t.width,i=t.height;t&&this.addSize(n,i)},p.prototype.calcPage=function(e,t,n){e.backgroundImage&&this.addSize(t,n)},p.prototype.calcWidget=function(e){switch(e.subType){case"MyButton":case"MySwitch":this.calcButton(e);break;case"MyButtonGroup":this.calcButtonGroup(e);break;case"MySlide":case"MyAnimation":this.calcSlide(e);break;case"MyOscilloscope":this.calcOscilloscope(e);break;case"MyTextArea":this.calcTextArea(e);break;case"MyDashboard":this.calcDashboard(e);break;case"MyRotateImg":this.calcRotateImg(e);break;case"MyTexNum":this.calcTexNum(e);break;case"MyTexTime":this.calcTexTime(e)}},this.calcProjectSize=function(e){for(var t=[],n=new p,r=0;r<e.pageList.length;r++){var o=e.pageList[r];n.calcPage(o,e.size.width,e.size.height);for(var a=0;a<o.canvasList.length;a++)for(var s=o.canvasList[a],c=0;c<s.subCanvasList.length;c++)for(var l=s.subCanvasList[c],h=0;h<l.widgetList.length;h++)t.push(l.widgetList[h]),n.calcWidget(l.widgetList[h])}var g=i.getFontCollections(t);console.log(g);for(var r=0;r<g.length;r++){var f=g[r],d=f["font-size"]||24,u=1.2*Math.sqrt(128)*d;n.addSize(u,u,.5)}return n.convertTotalSize()},y)var j=require("child_process").spawn,I=new w}]);