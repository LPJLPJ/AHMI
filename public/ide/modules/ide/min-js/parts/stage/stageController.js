ide.controller("StageCtrl",["$scope","$timeout","$interval","ProjectService","CanvasService","Preference","Type","KeydownService","OperateQueService","TagService","$uibModal",function(e,t,n,o,a,r,i,u,c,s,d){function l(){o.getProjectTo(e),e.component.menuOptions.allMenuItems=[["上移一层",function(){k(0)}],null,["下移一层",function(){k(1)}],null,["移至顶层",function(){k("front")}],null,["移至底层",function(){k("back")}]],e.component.menuOptions.contextMenu=m,e.component.canvas.node.on({"object:selected":L,"object:moving":h,"object:scaling":C,"object:rotating":h,"mouse:down":y,"mouse:up":$,"selection:cleared":b}),e.component.subCanvas.node.on({"object:selected":w,"object:moving":M,"object:scaling":M,"object:rotating":M,"mouse:down":O,"mouse:up":j,"selection:cleared":p}),e.$on("CurrentPageChanged",function(e,t,n){v(t,n)}),e.$on("CanvasScaleChanged",function(e,t){T({scaleMode:t})}),e.$on("CurrentSubLayerChanged",function(e,t,n){v(t,n)}),e.$on("ToolShowChanged",function(t,n){e.component.out.toolShow=n}),e.$on("PageChangedSwitched",function(e,t,n){v(t,n)}),e.$on("NewPageAdded",function(e,t,n){v(t,n)}),e.$on("OperateQueChanged",function(e,t,n){v(t,n)}),e.$on("SubLayerEntered",function(e){toastr.info("显示子图层"),v()})}function g(){var t=o.getCurrentSelectObject()||{};t=t.level,e.component.preview.showPreviewBtn=!1,t&&t.type===i.MySubLayer&&t.info&&(e.component.preview.showPreviewBtn=t.info.scrollVEnabled||t.info.scrollHEnabled)}function f(){var e=o.getCurrentLayer(),t=o.getCurrentSubLayer(),n=a.getSubLayerNode();d.open({animation:!1,templateUrl:"previewPanelModal.html",controller:"previewInstanceCtrl",size:"lg",backdrop:"static",resolve:{currentLayer:function(){return e},currentSubLayer:function(){return t},subLayerNode:function(){return n}}}).result.then(function(){},function(){})}function v(t,n){if(o.isEditingPage()?(e.component.canvas.node,e.status.editPage=!0):(e.component.subCanvas.node,e.status.editPage=!1),t){var a=o.SaveCurrentOperate(),r={undoOperate:t,redoOperate:a};c.pushNewOperate(r)}o.setRendering(!1),n&&n()}function m(){var t=o.getCurrentSelectObject();return t.type==i.MyLayer||i.isWidget(t.type)?e.component.menuOptions.allMenuItems:[]}function b(t){if(!u.isCtrlPressed()){o.layerClickPop=0;var n=-1;if(_.forEach(e.project.pages,function(e,t){e.id==o.getCurrentPage().id&&(n=t)}),n<0)return void console.warn("找不到Page");o.OnPageClicked(n,function(){e.$emit("ChangeCurrentPage")})}}function p(){if(!u.isCtrlPressed()){var t=o.getCurrentPage();_.forEach(t.layers,function(t,n){t.current&&_.forEach(t.subLayers,function(t,a){t.current&&o.OnSubLayerClicked(n,a,function(){e.$emit("ChangeCurrentSubLayer")})})})}}function h(t){"release"==e.status.gesture&&(e.status.gesture="moving",r.THUMB_REAL_TIME>0&&(W=n(function(){o.UpdateCurrentThumb()},r.THUMB_REAL_TIME)),o.HoldObject(e.status))}function C(){"release"==e.status.gesture&&(e.status.gesture="moving",r.THUMB_REAL_TIME>0&&(W=n(function(){o.UpdateCurrentThumb()},r.THUMB_REAL_TIME)),o.ScaleLayer(e.status))}function y(e){A.x=e.e.x,A.y=e.e.y,void 0==e.e.y&&void 0==e.e.x&&(A.x=e.e.layerX,A.y=e.e.layerY)}function L(t){if(R)return void console.log("双击中");var n=t.target;o.OnLayerClicked(n,function(){if(!u.isCtrlPressed()){var t=o.getCurrentSelectObject();if(t.type==i.MyLayer){var n=o.getFabricObject(t.level.id);o.currentFabLayerIdList=[],o.currentFabLayerIdList.push(n.id)}else if(t.type==i.MyGroup){var a=t.target;o.currentFabLayerIdList=[],_.forEach(a.getObjects(),function(e){o.currentFabLayerIdList.push(e.id)})}}e.$emit("ChangeCurrentPage")})}function w(t){var n=t.target;o.getLayerInfo?o.setAbsolutePosition(n):o.getLayerInfo=!0,o.OnWidgetClicked(n,function(){if(!u.isCtrlPressed()){var t=o.getCurrentSelectObject();if(i.isWidget(t.type)){var n=o.getFabricObject(t.level.id,!0);o.currentFabWidgetIdList=[],o.currentFabWidgetIdList.push(n.id)}else if(t.type==i.MyGroup){var a=t.target;o.currentFabWidgetIdList=[],_.forEach(a.getObjects(),function(e){o.currentFabWidgetIdList.push(e.id)})}}e.$emit("ChangeCurrentSubLayer")})}function P(t){if(!t)return void o.OnLayerMultiSelected(function(){e.$emit("ChangeCurrentPage"),o.UpdateCurrentThumb()});for(var n=!1,r=0;r<o.currentFabLayerIdList.length;r++)if(o.currentFabLayerIdList[r]==t.id){var i=a.getPageNode();i.renderAll(),o.currentFabLayerIdList.splice(r,1),i.renderAll(),toastr.info("多选去除"),n=!0}n&&0!=o.currentFabLayerIdList.length||(o.currentFabLayerIdList.push(t.id),toastr.info("多选添加")),o.OnLayerMultiSelected(function(){e.$emit("ChangeCurrentPage"),o.UpdateCurrentThumb()})}function S(n){R=!0,o.OnLayerDoubleClicked(n.id,function(){t(function(){R=!1},0),e.$emit("ChangeCurrentPage"),o.UpdateCurrentThumb()})}function I(t){if(!t)return void o.OnWidgetMultiSelected(function(){e.$emit("ChangeCurrentPage")});for(var n=!1,a=0;a<o.currentFabWidgetIdList.length;a++)o.currentFabWidgetIdList[a]==t.id&&(o.currentFabWidgetIdList.splice(a,1),toastr.info("多选去除"),n=!0);n&&o.currentFabWidgetIdList!=[]||(o.currentFabWidgetIdList.push(t.id),toastr.info("多选添加")),o.OnWidgetMultiSelected(function(){e.$emit("ChangeCurrentPage")})}function O(e){A.x=e.e.x,A.y=e.e.y,void 0==e.e.y&&void 0==e.e.x&&(A.x=e.e.layerX,A.y=e.e.layerY)}function M(){"release"==e.status.gesture&&(e.status.gesture="moving",r.THUMB_REAL_TIME>0&&(W=n(function(){o.updateCurrentThumbInPage()},r.THUMB_REAL_TIME)),o.HoldObject(e.status))}function $(t){var a=function(){var n=null,o=null,a=null;if(t.e.x&&t.e.y?(o=t.e.x,a=t.e.y):t.e.layerX&&t.e.layerY&&(o=t.e.layerX,a=t.e.layerY),Math.abs(o-A.x)<=2&&Math.abs(a-A.y)<=2){var i=new fabric.Point(t.e.offsetX/e.component.canvas.node.getZoom(),t.e.offsetY/e.component.canvas.node.getZoom()),c=e.component.canvas.node.getActiveGroup(),s=null,d=null;c&&c.containsPoint(i)?(s=t.e.offsetX/e.component.canvas.node.getZoom()-(c.left+c.width/2),d=t.e.offsetY/e.component.canvas.node.getZoom()-(c.top+c.height/2)):(s=t.e.offsetX/e.component.canvas.node.getZoom(),d=t.e.offsetY/e.component.canvas.node.getZoom()),_.forEach(e.component.canvas.node.getObjects(),function(e){s<=e.getWidth()+e.left&&d<=e.getHeight()+e.top&&s>=e.left&&d>=e.top&&(n=e)}),u.isCtrlPressed()?P(n):r&&n&&S(n)}};if(R)return void console.log("双击layer中");var r=!1;if(x){(new Date).getTime()-x.getTime()<300&&(console.log("双击"),r=!0),x=new Date}else x=new Date;var i=o.getCurrentLayer();if(o.setAbsolutePosition(t.target),i){var c=o.getFabricObject(i.id);c&&o.SyncLevelFromFab(i,c)}"release"!=e.status.gesture?(angular.isDefined(W)&&(n.cancel(W),W=void 0),o.ReleaseObject(e.status,function(){e.$emit("ChangeCurrentPage",e.status.holdOperate),e.status.gesture="release",a(),o.UpdateCurrentThumb()})):a()}function j(t){var a=o.getCurrentWidget(),r=function(){var n=null;if(Math.abs(t.e.x-U.x)<=2&&Math.abs(t.e.y-U.y)<=2){var o=new fabric.Point(t.e.offsetX/e.component.subCanvas.node.getZoom(),t.e.offsetY/e.component.subCanvas.node.getZoom()),a=e.component.subCanvas.node.getActiveGroup(),r=null,i=null;a&&a.containsPoint(o)?(r=t.e.offsetX/e.component.subCanvas.node.getZoom()-(a.left+a.width/2),i=t.e.offsetY/e.component.subCanvas.node.getZoom()-(a.top+a.height/2)):(r=t.e.offsetX/e.component.subCanvas.node.getZoom(),i=t.e.offsetY/e.component.subCanvas.node.getZoom()),_.forEach(e.component.subCanvas.node.getObjects(),function(e){r<=e.getWidth()+e.getLeft()&&i<=e.getHeight()+e.getTop()&&r>=e.getLeft()&&i>=e.getTop()&&(n=e)}),u.isCtrlPressed()&&I(n)}};if(a){var i=o.getFabricObject(a.id,!0);i&&o.SyncLevelFromFab(a,i)}"release"!=e.status.gesture?(angular.isDefined(W)&&(n.cancel(W),W=void 0),o.ReleaseObject(e.status,function(){e.$emit("ChangeCurrentPage",e.status.holdOperate),e.status.gesture="release",o.updateCurrentThumbInPage(),r()})):r()}function k(t){var n={index:t},a=o.SaveCurrentOperate();o.ChangeAttributeZIndex(n,function(){e.$emit("ChangeCurrentPage",a),o.updateCurrentThumbInPage()})}function T(e){o.ScaleCanvas(e)}function F(){var t=o.initMaskAttr();e.maskStyle=t,e.maskSrc=t.src}function E(){var n=angular.element("div #mask");t(function(){var t={width:parseInt(n.css("width")),height:parseInt(n.css("height")),top:parseInt(n.css("top")),left:parseInt(n.css("left")),name:e.maskStyle.name,src:e.maskSrc};e.$emit("ChangeMaskStyle",t)})}!function(){e.component={out:{toolShow:!1},canvas:{node:null,currentWidth:0,currentHeight:0,holdOperate:null},subCanvas:{node:null,currentWidth:0,currentHeight:0,holdOperate:null},menuOptions:{contextMenu:null,allMenuItems:[]},preview:{showPreviewBtn:!1,showPreviewModal:f}},e.status={gesture:"release",holdOperate:null,editPage:!0},e.component.canvas.node=new fabric.Canvas("c"),e.component.subCanvas.node=new fabric.Canvas("c1",{renderOnAddRemove:!1});var t=e.component.canvas.node;a.setPageNode(t);var n=e.component.subCanvas.node;a.setSubLayerNode(n)}(),function(){a.setOffCanvas(document.getElementById("offCanvas"))}(),e.$on("GlobalProjectReceived",function(){l(),e.$emit("LoadUp"),F()}),e.$on("AttributeChanged",function(e){g()});var W,A={},x=new Date,R=!1,U={};e.$on("MaskAttr",function(t,n){e.maskStyle=_.cloneDeep(n),o.saveMaskInfo(e.maskStyle)}),e.$on("MaskCtrl",function(t,n){e.maskSwitch=n}),e.$on("ChangeMask",function(t,n){e.maskSrc=n,E()}),e.getMaskAttr=E,e.selectMask=function(t){e.$emit("ChangeMaskStyle",t)}}]),ide.controller("previewInstanceCtrl",["$scope","$uibModalInstance","currentSubLayer","currentLayer","subLayerNode",function(e,t,n,o,a){e.cancel=function(){t.dismiss()},e.init=function(){var e=document.getElementById("backgroundCanvas"),t=e.toDataURL(),n=a.toDataURL(),r=new Image,i=new Image,u=new SXRender({id:"previewCanvas",w:o.info.width,h:o.info.height,contentW:a.width,contentH:a.height,backgroundColor:"rgb(159,192,234)",drawScrollBar:!0});r.onload=function(){var e={imgObj:r,sw:u.width,sh:u.height};u.drawBackground(e),u.reRender()},i.onload=function(){u.add({type:"image",imgObj:i,w:u.contentW,h:u.contentH,x:0,y:0}),u.reRender()},r.src=t,i.src=n}}]);