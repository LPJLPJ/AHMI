ide.controller("StageCtrl",["$scope","$timeout","$interval","ProjectService","CanvasService","Preference","Type","KeydownService","OperateQueService","TagService",function(e,t,n,a,o,r,i,s,u,c){function d(){a.getProjectTo(e),e.component.menuOptions.allMenuItems=[["上移一层",function(){$(0)}],null,["下移一层",function(){$(1)}],null,["移至顶层",function(){$("front")}],null,["移至底层",function(){$("back")}]],e.component.menuOptions.contextMenu=g,e.component.canvas.node.on({"object:selected":C,"object:moving":v,"object:scaling":p,"object:rotating":v,"mouse:down":b,"mouse:up":I,"selection:cleared":f}),e.component.subCanvas.node.on({"object:selected":h,"object:moving":S,"object:scaling":S,"object:rotating":S,"mouse:down":O,"mouse:up":M,"selection:cleared":m}),e.$on("CurrentPageChanged",function(e,t,n){l(t,n)}),e.$on("CanvasScaleChanged",function(e,t){T(t)}),e.$on("CurrentSubLayerChanged",function(e,t,n){l(t,n)}),e.$on("ToolShowChanged",function(t,n){e.component.out.toolShow=n}),e.$on("PageChangedSwitched",function(e,t,n){l(t,n)}),e.$on("NewPageAdded",function(e,t,n){l(t,n)}),e.$on("OperateQueChanged",function(e,t,n){l(t,n)}),e.$on("SubLayerEntered",function(e){toastr.info("显示子图层"),l()})}function l(t,n){if(a.isEditingPage()?(e.component.canvas.node,e.status.editPage=!0):(e.component.subCanvas.node,e.status.editPage=!1),t){var o=a.SaveCurrentOperate(),r={undoOperate:t,redoOperate:o};u.pushNewOperate(r)}a.setRendering(!1),n&&n()}function g(){var t=a.getCurrentSelectObject();return t.type==i.MyLayer||i.isWidget(t.type)?e.component.menuOptions.allMenuItems:[]}function f(t){if(!s.isCtrlPressed()){a.layerClickPop=0;var n=-1;if(_.forEach(e.project.pages,function(e,t){e.id==a.getCurrentPage().id&&(n=t)}),n<0)return void console.warn("找不到Page");a.OnPageClicked(n,function(){e.$emit("ChangeCurrentPage")})}}function m(){if(!s.isCtrlPressed()){var t=a.getCurrentPage();_.forEach(t.layers,function(t,n){t.current&&_.forEach(t.subLayers,function(t,o){t.current&&a.OnSubLayerClicked(n,o,function(){e.$emit("ChangeCurrentSubLayer")})})})}}function v(t){"release"==e.status.gesture&&(e.status.gesture="moving",r.THUMB_REAL_TIME>0&&(k=n(function(){a.UpdateCurrentThumb()},r.THUMB_REAL_TIME)),a.HoldObject(e.status))}function p(){"release"==e.status.gesture&&(e.status.gesture="moving",r.THUMB_REAL_TIME>0&&(k=n(function(){a.UpdateCurrentThumb()},r.THUMB_REAL_TIME)),a.ScaleLayer(e.status))}function b(e){w.x=e.e.x,w.y=e.e.y,void 0==e.e.y&&void 0==e.e.x&&(w.x=e.e.layerX,w.y=e.e.layerY)}function C(t){if(W)return void console.log("双击中");var n=t.target;a.OnLayerClicked(n,function(){if(!s.isCtrlPressed()){var t=a.getCurrentSelectObject();if(t.type==i.MyLayer){var n=a.getFabricObject(t.level.id);a.currentFabLayerIdList=[],a.currentFabLayerIdList.push(n.id)}else if(t.type==i.MyGroup){var o=t.target;a.currentFabLayerIdList=[],_.forEach(o.getObjects(),function(e){a.currentFabLayerIdList.push(e.id)})}}e.$emit("ChangeCurrentPage")})}function h(t){var n=t.target;a.getLayerInfo?a.setAbsolutePosition(n):a.getLayerInfo=!0,a.OnWidgetClicked(n,function(){if(!s.isCtrlPressed()){var t=a.getCurrentSelectObject();if(i.isWidget(t.type)){var n=a.getFabricObject(t.level.id,!0);a.currentFabWidgetIdList=[],a.currentFabWidgetIdList.push(n.id)}else if(t.type==i.MyGroup){var o=t.target;a.currentFabWidgetIdList=[],_.forEach(o.getObjects(),function(e){a.currentFabWidgetIdList.push(e.id)})}}e.$emit("ChangeCurrentSubLayer")})}function y(t){if(!t)return void a.OnLayerMultiSelected(function(){e.$emit("ChangeCurrentPage"),a.UpdateCurrentThumb()});for(var n=!1,r=0;r<a.currentFabLayerIdList.length;r++)if(a.currentFabLayerIdList[r]==t.id){var i=o.getPageNode();i.renderAll(),a.currentFabLayerIdList.splice(r,1),i.renderAll(),toastr.info("多选去除"),n=!0}n&&0!=a.currentFabLayerIdList.length||(a.currentFabLayerIdList.push(t.id),toastr.info("多选添加")),a.OnLayerMultiSelected(function(){e.$emit("ChangeCurrentPage"),a.UpdateCurrentThumb()})}function L(n){W=!0,a.OnLayerDoubleClicked(n.id,function(){t(function(){W=!1},0),e.$emit("ChangeCurrentPage"),a.UpdateCurrentThumb()})}function P(t){if(!t)return void a.OnWidgetMultiSelected(function(){e.$emit("ChangeCurrentPage")});for(var n=!1,o=0;o<a.currentFabWidgetIdList.length;o++)a.currentFabWidgetIdList[o]==t.id&&(a.currentFabWidgetIdList.splice(o,1),toastr.info("多选去除"),n=!0);n&&a.currentFabWidgetIdList!=[]||(a.currentFabWidgetIdList.push(t.id),toastr.info("多选添加")),a.OnWidgetMultiSelected(function(){e.$emit("ChangeCurrentPage")})}function O(e){w.x=e.e.x,w.y=e.e.y,void 0==e.e.y&&void 0==e.e.x&&(w.x=e.e.layerX,w.y=e.e.layerY)}function S(){"release"==e.status.gesture&&(e.status.gesture="moving",r.THUMB_REAL_TIME>0&&(k=n(function(){a.updateCurrentThumbInPage()},r.THUMB_REAL_TIME)),a.HoldObject(e.status))}function I(t){function o(){var n=null,a=null,o=null;if(t.e.x&&t.e.y?(a=t.e.x,o=t.e.y):t.e.layerX&&t.e.layerY&&(a=t.e.layerX,o=t.e.layerY),Math.abs(a-w.x)<=2&&Math.abs(o-w.y)<=2){var i=new fabric.Point(t.e.offsetX/e.component.canvas.node.getZoom(),t.e.offsetY/e.component.canvas.node.getZoom()),u=e.component.canvas.node.getActiveGroup(),c=null,d=null;u&&u.containsPoint(i)?(c=t.e.offsetX/e.component.canvas.node.getZoom()-(u.left+u.width/2),d=t.e.offsetY/e.component.canvas.node.getZoom()-(u.top+u.height/2)):(c=t.e.offsetX/e.component.canvas.node.getZoom(),d=t.e.offsetY/e.component.canvas.node.getZoom()),_.forEach(e.component.canvas.node.getObjects(),function(e){c<=e.getWidth()+e.left&&d<=e.getHeight()+e.top&&c>=e.left&&d>=e.top&&(n=e)}),s.isCtrlPressed()?y(n):r&&n&&L(n)}else console.log("偏移")}if(W)return void console.log("双击layer中");var r=!1;if(E){(new Date).getTime()-E.getTime()<300&&(console.log("双击"),r=!0),E=new Date}else E=new Date;var i=a.getCurrentLayer();if(i){var u=a.getFabricObject(i.id);u&&a.SyncLevelFromFab(i,u)}"release"!=e.status.gesture?(angular.isDefined(k)&&(n.cancel(k),k=void 0),a.ReleaseObject(e.status,function(){e.$emit("ChangeCurrentPage",e.status.holdOperate),e.status.gesture="release",o(),a.UpdateCurrentThumb()})):o()}function M(t){function o(){var n=null;if(Math.abs(t.e.x-A.x)<=2&&Math.abs(t.e.y-A.y)<=2){var a=new fabric.Point(t.e.offsetX/e.component.subCanvas.node.getZoom(),t.e.offsetY/e.component.subCanvas.node.getZoom()),o=e.component.subCanvas.node.getActiveGroup(),r=null,i=null;o&&o.containsPoint(a)?(r=t.e.offsetX/e.component.subCanvas.node.getZoom()-(o.left+o.width/2),i=t.e.offsetY/e.component.subCanvas.node.getZoom()-(o.top+o.height/2)):(r=t.e.offsetX/e.component.subCanvas.node.getZoom(),i=t.e.offsetY/e.component.subCanvas.node.getZoom()),_.forEach(e.component.subCanvas.node.getObjects(),function(e){r<=e.getWidth()+e.getLeft()&&i<=e.getHeight()+e.getTop()&&r>=e.getLeft()&&i>=e.getTop()&&(n=e)}),s.isCtrlPressed()&&P(n)}}var r=a.getCurrentWidget();if(a.setAbsolutePosition(t.target),r){var i=a.getFabricObject(r.id,!0);i&&a.SyncLevelFromFab(r,i)}"release"!=e.status.gesture?(angular.isDefined(k)&&(n.cancel(k),k=void 0),a.ReleaseObject(e.status,function(){e.$emit("ChangeCurrentPage",e.status.holdOperate),e.status.gesture="release",a.updateCurrentThumbInPage(),o()})):o()}function $(t){var n={index:t},o=a.SaveCurrentOperate();a.ChangeAttributeZIndex(n,function(){e.$emit("ChangeCurrentPage",o),a.updateCurrentThumbInPage()})}function T(e){a.ScaleCanvas(e)}function j(){var t=a.initMaskAttr();e.maskStyle=t,e.maskSrc=t.src}function F(){var n=angular.element("div #mask");t(function(){var t={width:parseInt(n.css("width")),height:parseInt(n.css("height")),top:parseInt(n.css("top")),left:parseInt(n.css("left")),name:e.maskStyle.name,src:e.maskSrc};e.$emit("ChangeMaskStyle",t)})}!function(){e.component={out:{toolShow:!1},canvas:{node:null,currentWidth:0,currentHeight:0,holdOperate:null},subCanvas:{node:null,currentWidth:0,currentHeight:0,holdOperate:null},menuOptions:{contextMenu:null,allMenuItems:[]}},e.status={gesture:"release",holdOperate:null,editPage:!0},e.component.canvas.node=new fabric.Canvas("c"),e.component.subCanvas.node=new fabric.Canvas("c1",{renderOnAddRemove:!1});var t=e.component.canvas.node;o.setPageNode(t);var n=e.component.subCanvas.node;o.setSubLayerNode(n)}(),function(){o.setOffCanvas(document.getElementById("offCanvas"))}(),e.$on("GlobalProjectReceived",function(){d(),e.$emit("LoadUp"),j()});var k,w={},E=new Date,W=!1,A={};e.$on("MaskAttr",function(t,n){e.maskStyle=_.cloneDeep(n),a.saveMaskInfo(e.maskStyle)}),e.$on("MaskCtrl",function(t,n){e.maskSwitch=n}),e.$on("ChangeMask",function(t,n){e.maskSrc=n,F()}),e.getMaskAttr=F,e.selectMask=function(t){e.$emit("ChangeMaskStyle",t)}}]);