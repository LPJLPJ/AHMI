ideServices.service("CanvasService",[function(){function t(t){var i=c.getRelativeRect(t);this.selectObjId=c.checkClickElm(this.objs,i,this.contentOffset),this.mouseDownPos=i,this.selectObjId?this.dragging=!0:(this.scratching=!0,clearInterval(this._animation),clearInterval(this._ticker),this._contentVelcoity.y=0,this._contentVelcoity.x=0,this._amplitude.y=0,this._amplitude.x=0,this._timeStamp=Date.now(),this._frame.y=i.y,this._ticker=setInterval(function(){var t,i,s,e;t=Date.now(),i=t-this._timeStamp,this._timeStamp=t,s=this.mouseDownPos.y-this._frame.y,this._frame.y=this.mouseDownPos.y,e=1e3*s/(1+i),this._contentVelcoity.y=.8*e+.2*this._contentVelcoity.y}.bind(this),50))}function i(t){if(this.dragging)this.dragging=!1,this.selectObjId=0;else if(this.scratching){this.scratching=!1,clearInterval(this._ticker);var i=0,s=0;0!==this.springOffset.y?(clearInterval(this._animation),this._animation=setInterval(function(){Math.abs(this.springOffset.y)>1e-4?(s=this._springTimeFun(i/1e3),i+=16,this.springOffset.y=(1-s)*this.springOffset.y,this.reRender()):(this.springOffset.y=0,this.reRender(),clearInterval(this._animation),this._animation=null,i=null,s=null)}.bind(this),16)):(this._contentVelcoity.y>30||this._contentVelcoity.y<-30)&&(this._amplitude.y=.8*this._contentVelcoity.y,this._timeStamp=Date.now(),this._targetPos.y=Math.round(this.contentOffset.y+this._amplitude.y),requestAnimationFrame(e.bind(this)))}}function s(t){var i,s,e={x:0,y:0};s=c.getRelativeRect(t),this.dragging?(e.x=s.x-this.mouseDownPos.x,e.y=s.y-this.mouseDownPos.y,this.mouseDownPos.x=s.x,this.mouseDownPos.y=s.y,i=this.findObjById(this.selectObjId),i.x+=e.x,i.y+=e.y,this.reRender()):this.scratching&&(e.x=s.x-this.mouseDownPos.x,e.y=s.y-this.mouseDownPos.y,e.y<0?this.contentOffset.y<=this.height-this.contentH?(this.contentOffset.y=Math.floor(this.height-this.contentH),this.springOffset.y=c.rubberBanding(e.y,this.height)):(this.mouseDownPos.x=s.x,this.mouseDownPos.y=s.y,this.contentOffset.y+=e.y):this.contentOffset.y>=0?(this.contentOffset.y=0,this.springOffset.y=c.rubberBanding(e.y,this.height)):(this.mouseDownPos.x=s.x,this.mouseDownPos.y=s.y,this.contentOffset.y+=e.y),this.reRender())}function e(){var t,i;t=Date.now()-this._timeStamp,i=-this._amplitude.y*Math.exp(-t/o),this.contentOffset.y>0?(this.contentOffset.y=0,this._contentVelcoity.y=this._amplitude.y/o*Math.exp(-t/o)):this.contentOffset.y<this.height-this.contentH?this.contentOffset.y=this.height-this.contentH:(this._amplitude.y||this._amplitude.x)&&(i>.5||i<-.5?(this.contentOffset.y=this._targetPos.y+i,requestAnimationFrame(e.bind(this))):this.contentOffset.y=this._targetPos.y),this.reRender()}var n=null;this.setPageNode=function(t){n=t},this.getPageNode=function(){return n};var h=null;this.setSubLayerNode=function(t){h=t},this.getSubLayerNode=function(){return h};var r=null;this.setOffCanvas=function(t){r=t},this.getOffCanvas=function(){return r};var a=1;const o=500;var c={getRelativeRect:function(t){var i,s,e;return i=t.clientX,s=t.clientY,e=t.target.getBoundingClientRect(),{x:Math.round(i-e.x),y:Math.round(s-e.y)}},checkClickElm:function(t,i,s){for(var e=null,n=i,h=0,r=t.length;h<r;h++)if(e=t[h],!0===e.draggable)switch(e.type){case"ball":if(n.x>e.x+s.x-e.radius&&n.x<e.x+s.x+e.radius&&n.y>e.y+s.y-e.radius&&n.y<e.y+s.y+e.radius)return e.id;break;case"rect":if(n.x>e.x+s.x&&n.x<e.x+s.x+e.w&&n.y>e.y+s.y&&n.y<e.y+s.y+e.h)return e.id;break;case"image":return e.id;default:return 0}},rubberBanding:function(t,i){return t>0?Math.round((1-1/(.55*t/i+1))*i):-Math.round((1-1/(.55*-t/i+1))*i)},calTimingFunctionBySpring:function(t,i,s,e){var n,h,r,a,o,c,d=t,g=i,u=s,f=d*d-4*g;o=(e||0)-1,c=u;var y,l;return f>0?(f=Math.sqrt(f),n=.5*(-d+f),h=.5*(-d-f),y=(c-h*o)/(n-h),l=(c-n*o)/(h-n),function(t){return y*Math.exp(n*t)+l*Math.exp(h*t)+1}):0==f?(n=.5*-d,y=o,l=c-y*n,function(t){return(y+l*t)*Math.exp(n*t)+1}):(f=Math.sqrt(-f),r=.5*-d,a=.5*f,y=o,l=(c-r*o)/a,function(t){return(y*Math.cos(a*t)+l*Math.sin(a*t))*Math.exp(r*t)+1})}},d=function(t){var i,s,t,e,n,h,r,a,o,c;t=t||{},e=t.id||"",n=t.w,h=t.h,r=t.backgroundColor||"",a=t.contentW||n,o=t.contentH||h,c=t.drawScrollBar||!1,i=e?document.getElementById(e):document.createElement("canvas"),i.style.backgroundColor=r||"rgba(0,0,0,0)",i.width=n||500,i.height=h||500,s=i.getContext("2d"),this.init(i,s,a,o,c)};Object.assign(d.prototype,{init:function(e,n,h,r,a){this.canvas=e,this.ctx=n,this.width=e.width,this.height=e.height,this.dragging=!1,this.scratching=!1,this.selectObjId=0,this.contentW=h,this.contentH=r,this.drawScrollBar=a,this.backgroundImg={},this.mouseDownPos={x:0,y:0},this.springOffset={x:0,y:0},this.contentOffset={x:0,y:0},this.objs=[],this._springTimeFun=c.calTimingFunctionBySpring(12,180,0),this._animation=null,this._contentVelcoity={y:0,x:0},this._amplitude={y:0,x:0},this._frame={x:0,y:0},this._targetPos={x:0,y:0},this._ticker=null,this._timeStamp=0,this.canvas.addEventListener("mousedown",t.bind(this),!1),this.canvas.addEventListener("mouseup",i.bind(this),!1),this.canvas.addEventListener("mousemove",s.bind(this),!1),this.canvas.addEventListener("mouseout",i.bind(this),!1)},drawBackground:function(t){t&&(this.backgroundImg.content=t.imgObj,this.backgroundImg.sx=t.sx||0,this.backgroundImg.sy=t.sy||0,this.backgroundImg.sw=t.sw||0,this.backgroundImg.sh=t.sh||0,this.backgroundImg.dx=t.dx||0,this.backgroundImg.dy=t.dy||0,this.backgroundImg.dw=t.dw||this.width,this.backgroundImg.dh=t.dh||this.height),this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.backgroundImg.content&&(this.backgroundImg.sw&&this.backgroundImg.sh?this.ctx.drawImage(this.backgroundImg.content,this.backgroundImg.sx,this.backgroundImg.sy,this.backgroundImg.sw,this.backgroundImg.sh,this.backgroundImg.dx,this.backgroundImg.dy,this.backgroundImg.dw,this.backgroundImg.dh):this.ctx.drawImage(this.backgroundImg.content,this.backgroundImg.dx,this.backgroundImg.dy,this.backgroundImg.dw,this.backgroundImg.dh),this.ctx.restore())},drawBall:function(t){var i,s,e,n,t=t||{},h=0*Math.PI,r=2*Math.PI;i=t.x+this.springOffset.x,s=t.y+this.springOffset.y,e=t.radius,n=t.color,this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle=n,this.ctx.arc(i,s,e,h,r,!1),this.ctx.fill(),this.ctx.closePath(),this.ctx.restore()},clearCtx:function(t){var i,s,e,n,t=t||{};i=t.x||0,s=t.y||0,e=t.w||this.width,n=t.h||this.height,this.ctx.clearRect(i,s,e,n)},drawRect:function(t){var i,s,e,n,h,t=t||{};i=t.x+this.springOffset.x,s=t.y+this.springOffset.y,e=t.w,n=t.h,h=t.color,this.ctx.save(),this.ctx.fillStyle=h,this.ctx.fillRect(i,s,e,n),this.ctx.restore()},drawImage:function(t){var i,s,e,n,h,t=t||{};i=t.imgObj,s=t.x||0,e=t.y||0,n=t.w,h=t.h,dx=t.dx||0,dy=t.dy||0,dw=t.dw||0,dh=t.dh||0,this.ctx.save(),dw&&dh?this.ctx.drawImage(i,s,e,n,h,dx,dy,dw,dh):n&&h?(s+=this.springOffset.x,e+=this.springOffset.y,this.ctx.drawImage(i,s,e,n,h)):this.ctx.drawImage(i,s,e),this.ctx.restore()},reRender:function(){this.clearCtx(),this.backgroundImg.content&&this.drawBackground(),this.ctx.setTransform(1,0,0,1,this.contentOffset.x,this.contentOffset.y);for(var t=this.objs||[],i=0,s=t.length;i<s;i++)switch(t[i].type){case"ball":this.drawBall(t[i]);break;case"rect":this.drawRect(t[i]);break;case"image":this.drawImage(t[i]);break;default:console.log("miss in reRender")}this.drawScrollBar&&this._drawProgress()},findObjById:function(t){for(var i=0,s=this.objs.length;i<s;i++)if(this.objs[i].id===t)return this.objs[i];return null},add:function(t){var i={};i=Object.assign(i,t,{id:a++}),this.objs.push(i)},_drawProgress:function(){this.ctx.setTransform(1,0,0,1,0,0);var t,i,s,e,n;n=this.springOffset.y>0?-this.springOffset.y:-2*this.springOffset.y,s=4,e=Math.round(this.height*this.height/this.contentH)-Math.abs(this.springOffset.y),e=e<10?10:e,t=Math.round(-this.contentOffset.y*this.height/this.contentH)+n,i=this.width-s,this.drawRect({x:i,y:t,w:s,h:e,color:"#888888"})}}),this.createPaintBoard=function(t){var t=t||{};return new d(t)}}]);