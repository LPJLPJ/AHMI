var ide=angular.module("ide",["ui.bootstrap.contextMenu","colorpicker.module","ui.sortable","btford.modal","ui.bootstrap","ngAnimate","GlobalModule","ui.tree","IDEServices"]);ide.config(["$compileProvider",function(e){e.imgSrcSanitizationWhitelist(/^\s*((https?|ftp|file|blob|chrome-extension):|data:image\/)/),e.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|tel|file:chrome-extension|chrome-extension):/)}]);var baseUrl="",PID="",TOKEN="",MAX_DATA_LENGTH=1e5,ideScope,isOffline,mode="DEBUG";console.log=function(e){return"DEBUG"===mode?e.log:(e.oldLog=e.log,function(){})}(console);var logs=[];ide.controller("IDECtrl",["$scope","$timeout","$http","$interval","ProjectService","GlobalService","Preference","ResourceService","TagService","TemplateProvider","TimerService","UserTypeService","WidgetService","NavModalCANConfigService",function(e,o,t,n,a,r,i,c,s,l,d,u,f,g){function h(){var t=window.location.href,n=t.split("?")[1].split("=")[1];"#"===n[n.length-1]&&(n=n.slice(0,-1)),console.log(n);var a=G.join(I,"localproject",n);c.setProjectUrl(a);var r=G.join(a,"resources");c.setResourceUrl(r);var i=G.join(I,G.dirname(window.location.pathname));c.setResourceNWUrl(G.relative(i,r)),console.log(G.relative(i,r));var s=p(G.join(a,"project.json"));o(function(){s?(s=JSON.parse(s),m(s,n)):v({},n)},0),e.$on("LoadUp",function(){6==++A&&S()})}function p(e,o){if(!o)return M.readFileSync(e,"utf-8");try{var t=M.statSync(e);return t&&t.isFile()?M.readFileSync(e,"utf-8"):null}catch(e){return null}}function b(e,o){console.log("project data.content receive",JSON.parse(e.content));var n=e.template;l.setTemplateId(n),n&&""!==n?t({method:"GET",url:"/public/templates/defaultTemplate/defaultTemplate.json"}).success(function(t){j(t,function(){void 0===e.thumbnail&&void 0===e.supportTouch?L(e,function(e){m(e,o)}):m(e,o)}.bind(this))}).error(function(e){console.log("get json failed")}):void 0===e.thumbnail&&void 0===e.supportTouch?L(e,function(e){m(e,o)}):m(e,o)}function m(o,t){if(o.content){var n=JSON.parse(o.content),i=o.resolution.split("*").map(function(e){return Number(e)});n.initSize={width:i[0],height:i[1]},n.currentSize={width:i[0],height:i[1]},n.maxSize=o.maxSize,n.projectId=t;var s=n.resourceList;console.log("resourceList",s);var d=s.length,u=c.getGlobalResources();window.globalResources=u;var f=function(o,t){"error"===o.type?(toastr.warning("图片加载失败: "+t.name),t.complete=!1):t.complete=!0,(d-=1)<=0&&(l.saveProjectFromGlobal(n),C(n),a.saveProjectFromGlobal(n,function(){e.$broadcast("GlobalProjectReceived")}))}.bind(this);if(d>0)for(var g=0;g<s.length;g++){var h=s[g];console.log("caching ",g),c.cacheFileToGlobalResources(h,f,f)}else console.log(n),l.saveProjectFromGlobal(n),C(n),a.saveProjectFromGlobal(n,function(){e.$broadcast("GlobalProjectReceived")})}else{n=r.getBlankProject(),n.projectId=t;var i=o.resolution.split("*").map(function(e){return Number(e)});n.initSize={width:i[0],height:i[1]},n.currentSize={width:i[0],height:i[1]},n.maxSize=o.maxSize,console.log("globalProject new",_.cloneDeep(n)),l.saveProjectFromGlobal(n),C(n),a.saveProjectFromGlobal(n,function(){e.$broadcast("GlobalProjectReceived")})}}function v(o,t){var n=r.getBlankProject();n.projectId=t;var i=(o.resolution||"800*480").split("*").map(function(e){return Number(e)});n.initSize={width:i[0],height:i[1]},n.currentSize={width:i[0],height:i[1]},n.maxSize=o.maxSize||104857600,console.log("globalProject",n),l.saveProjectFromGlobal(n),a.saveProjectFromGlobal(n,function(){C(n),e.$broadcast("GlobalProjectReceived")})}function y(){for(var o=window.location.href,n=o.split("/"),a="",r=0;r<n.length;r++)if("project"==n[r]){a=n[r+1];break}c.setResourceUrl("/project/"+a+"/resources/"),t({method:"GET",url:baseUrl+"/project/"+a+"/content"}).success(function(e){b(e,a)}).error(function(e){toastr.warning("读取错误"),v({},a)}),e.$on("LoadUp",function(){6==++A&&S()})}function S(){o(function(){e.ide.loaded=!0,window.spinner&&window.spinner.hide()},200)}function w(n){var i={};if(!n)return o(function(){toastr.info("加载离线项目"),i=r.getBlankProject(),l.saveProjectFromGlobal(i),a.saveProjectFromGlobal(i,function(){PID=n,C(i),e.$broadcast("GlobalProjectReceived")})}),void logs.push("打开本地项目");console.log(TOKEN);!function(o){t({method:"GET",url:baseUrl+"/project",params:{token:window.localStorage.getItem("token"),pid:n}}).success(function(o){console.log(o),"success"==o.status?(i=o.project.data,i?(l.saveProjectFromGlobal(i),a.saveProjectFromGlobal(i,function(){PID=n,C(i),e.$broadcast("GlobalProjectReceived"),logs.push("从服务器获取项目")})):(console.log("获取信息失败"),P())):(console.log("获取信息失败"),P())}).error(function(e){console.log(e),P()})}()}function $(o,t){e.ide.loaded=!1,A=0,w(t)}function P(){try{console.log("读取缓存");var o=PID,t=JSON.parse(window.localStorage.getItem("projectCache"+o)),n=t;console.log(n),l.saveProjectFromGlobal(n),a.saveProjectFromGlobal(n,function(){C(n),e.$broadcast("GlobalProjectReceived")})}catch(e){toastr.info("获取项目失败")}}function C(e){c.setMaxTotalSize(e.maxSize||104857600),c.syncFiles(e.resourceList),s.syncCustomTags(e.customTags),s.syncTimerTags(e.timerTags),s.setTimerNum(e.timers),g.setCANId(e.CANId)}function j(e,o){var t=_.cloneDeep(e),n=c.getResourceUrl()+"template/",a="";for(var r in t)t[r]instanceof Array?t[r].forEach(function(e){a=e.src&&e.src.split("/"),a=a[a.length-1],a=n+a,e.src=a}):t[r].texList&&t[r].texList.forEach(function(e){e.slices&&e.slices.forEach(function(e){a=e.imgSrc&&e.imgSrc.split("/"),a=a[a.length-1],a=n+a,e.imgSrc=a})});c.setTemplateFiles(t.templateResourcesList),l.setDefaultWidget(t);var i=t.templateResourcesList||[],s=i.length,d=function(e,t){"error"===e.type?(toastr.warning("图片加载失败: "+t.name),t.complete=!1):t.complete=!0,--s<=0&&o&&o()};s>0?i.map(function(e,o){c.cacheFileToGlobalResources(e,d,d)}):o&&o()}function L(e,o){var t,n=_.cloneDeep(e),a=0,r=JSON.parse(e.content),i=[],c=new fabric.Canvas("c"),s=new fabric.Canvas("c1",{renderOnAddRemove:!1});for(n.thumbnail="",n.template="",n.supportTouch="false",r.currentSize=_.cloneDeep(r.size),r.customTags=_.cloneDeep(r.tagList),r.projectId=window.location.pathname&&window.location.pathname.split("/")[2],r.initSize=_.cloneDeep(r.size),r.pages=_.cloneDeep(r.pageList),a=0;a<r.tagList.length;a++)if(void 0===r.tagList[a].type){t=a;break}r.timerTags=t>0?r.customTags.splice(t,r.customTags.length-t):[],i=["size","tagList","basicUrl","format","name","author","pageList"],T(r,i),a=0;var l,t,d=r.pages.length,u=function(){l=null,l=r.pages[a],t=a,c.setWidth(r.initSize.width),c.setHeight(r.initSize.height),c.zoomToPoint(new fabric.Point(0,0),1),void 0!==l.canvasList&&(l.selected=0===t,l.layers=l.canvasList,i=["canvasList","linkedAllWidgets"],T(l,i),l.layers.forEach(function(e,o){e.subLayers=e.subCanvasList,e.subLayers.forEach(function(o,t){o.widgets=o.widgetList,i=["widgetList"],T(o,i),s.setWidth(e.w),s.setHeight(e.h),s.zoomToPoint(new fabric.Point(0,0),1),o.current=!1,o.expand=!0,o.selected=!1,o.url="",o.widgets.forEach(function(e,o){e.type=e.subType,T(e,["subType"]),e.current=!1,e.currentFabwidget=null,e.expand=!0,e.selected=!1,e.texList&&e.texList instanceof Array&&e.texList.forEach(function(e,o){e.slices&&e.slices instanceof Array&&e.slices.forEach(function(e,o){e.hasOwnProperty("originSrc")&&(e.imgSrc=e.originSrc,delete e.originSrc)})}),N(e,s)}),o.proJsonStr=s.toJSON(),s.clear()}),e.info={},e.info.width=e.w,e.info.height=e.h,e.info.top=e.y,e.info.left=e.x,e.zIndex=o,e.current=!1,e.expand=!0,e.selected=!1,e.showSubLayer=e.subLayers[0],e.url="",i=["w","h","y","x","subCanvasList"],T(e,i),N(e,c)}),l.backgroundImage&&""!==l.backgroundImage?c.setBackgroundImage(l.backgroundImage,function(){c.setBackgroundColor(l.backgroundColor,function(){l.proJsonStr=c.toJSON(),c.clear(),a++,a<d?u():(console.log("after preprocess",r),n.content=JSON.stringify(r),o&&o(n))})},{width:c.getWidth(),height:c.getHeight()}):c.setBackgroundImage(null,function(){c.setBackgroundColor(l.backgroundColor,function(){l.proJsonStr=c.toJSON(),c.clear(),a++,a<d?u():(console.log("after preprocess",r),n.content=JSON.stringify(r),o&&o(n))})}))};u()}function T(e,o){return o instanceof Array&&o.forEach(function(o,t){delete e[o]}),e}function N(e,o,t){var n={width:e.info.width,height:e.info.height,top:e.info.top,left:e.info.left,id:e.id,lockScalingFlip:!0,hasRotatingPoint:!1,shadow:{color:"rgba(0,0,0,0.4)",blur:2}};if(e.type,"MySlide"==e.type)fabric.MySlide.fromLevel(e,function(e){o.add(e)},n);else if("MyProgress"==e.type)fabric.MyProgress.fromLevel(e,function(e){o.add(e)},n);else if("MyDashboard"==e.type)fabric.MyDashboard.fromLevel(e,function(e){o.add(e)},n);else if("MyButton"==e.type)fabric.MyButton.fromLevel(e,function(e){o.add(e)},n);else if("MyButtonGroup"==e.type)fabric.MyButtonGroup.fromLevel(e,function(e){o.add(e)},n);else if("MyNumber"==e.type)fabric.MyNumber.fromLevel(e,function(e){o.add(e)},n);else if("MyTextArea"==e.type)fabric.MyTextArea.fromLevel(e,function(e){o.add(e)},n);else if("MyNum"==e.type)fabric.MyNum.fromLevel(e,function(e){o.add(e)},n);else if("MyKnob"==e.type)fabric.MyKnob.fromLevel(e,function(e){o.add(e)},n);else if("MyOscilloscope"==e.type)fabric.MyOscilloscope.fromLevel(e,function(e){o.add(e)},n);else if("MySwitch"==e.type)fabric.MySwitch.fromLevel(e,function(e){o.add(e)},n);else if("MyRotateImg"==e.type)fabric.MyRotateImg.fromLevel(e,function(e){o.add(e)},n);else if("MyDateTime"==e.type)fabric.MyDateTime.fromLevel(e,function(e){o.add(e)},n);else if("MyScriptTrigger"==e.type)fabric.MyScriptTrigger.fromLevel(e,function(e){o.add(e)},n);else if("MySlideBlock"==e.type)fabric.MySlideBlock.fromLevel(e,function(e){o.add(e)},n);else if("MyVideo"==e.type)fabric.MyVideo.fromLevel(e,function(e){o.add(e)},n);else if("MyAnimation"==e.type)fabric.MyAnimation.fromLevel(e,function(e){o.add(e)},n);else if("MyLayer"==e.type){var a=new fabric.MyLayer(e,n);o.add(a)}}ideScope=e,e.ide={loaded:!1};var M,G,I,A=0;!function(){e.leftShown=!0,e.rightShown=!0,e.bottomShown=!0;try{require("os")&&(window.local=!0,e.local=!0,window.ondragover=function(e){return e.preventDefault(),!1},window.ondrop=function(e){return e.preventDefault(),!1},I=global.__dirname,G=require("path"),M=require("fs"))}catch(e){window.local=!1}}(),function(){window.local?h():y()}(),function(){var e="basic";if(window.local){var o=G.join(I,"public","nw","userInfo.json"),t={name:"",type:"basic"};M.existsSync(o)||M.writeFileSync(o,JSON.stringify(t)),e=JSON.parse(M.readFileSync(o,"utf-8")).type}else e=localStorage.getItem("userType");u.setUserType(e)}(),function(){e.$on("ChangePageNode",function(){e.$broadcast("PageNodeChanged"),e.$broadcast("NavStatusChanged")}),e.$on("ChangeCurrentPage",function(o,t,n){e.$broadcast("CurrentPageChanged",t,n),e.$broadcast("NavStatusChanged"),e.$broadcast("AttributeChanged"),document.getElementById("saveFlag").value="false"}),e.$on("ChangeCurrentSubLayer",function(o,t,n){e.$broadcast("CurrentSubLayerChanged",t,n),e.$broadcast("NavStatusChanged"),e.$broadcast("AttributeChanged")}),e.$on("SwitchCurrentPage",function(o,t,n){e.$broadcast("PageChangedSwitched",t,n),e.$broadcast("NavStatusChanged"),e.$broadcast("AttributeChanged")}),e.$on("ChangeToolShow",function(o,t){e.$broadcast("ToolShowChanged",t),e.$broadcast("NavStatusChanged")}),e.$on("AddNewPage",function(o,t,n){e.$broadcast("NewPageAdded",t,n),e.$broadcast("PageNodeChanged"),e.$broadcast("NavStatusChanged"),e.$broadcast("AttributeChanged")}),e.$on("changeCanvasScale",function(o,t){e.$broadcast("CanvasScaleChanged",t)}),e.$on("UpdateProject",function(o){e.$broadcast("ProjectUpdated"),document.getElementById("saveFlag").value="true"}),e.$on("Undo",function(o,t,n){e.$broadcast("OperateQueChanged",t,n),e.$broadcast("NavStatusChanged"),e.$broadcast("PageNodeChanged"),e.$broadcast("AttributeChanged")}),e.$on("Redo",function(o,t,n){e.$broadcast("OperateQueChanged",t,n),e.$broadcast("NavStatusChanged"),e.$broadcast("PageNodeChanged"),e.$broadcast("AttributeChanged")}),e.$on("DoCopy",function(o){e.$broadcast("NavStatusChanged")}),e.$on("ResourceUpdate",function(){e.$broadcast("AttributeChanged"),e.$broadcast("ResourceChanged")}),e.$on("ReOpenProject",$),e.$on("ChangeShownArea",function(o,t){switch(console.log(t),t){case 0:e.leftShown=!e.leftShown;break;case 1:e.rightShown=!e.rightShown;break;case 2:e.bottomShown=!e.bottomShown}})}(),function(){fabric.FX_DURATION=i.FX_DURATION}(),function(){window.local||setInterval(function(){t({method:"GET",url:baseUrl+"/api/refreshlogin"}).success(function(e){console.log(e)}).error(function(e){console.log(e)})},6e5)}()}]);