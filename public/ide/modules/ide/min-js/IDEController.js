var ide=angular.module("ide",["ui.bootstrap.contextMenu","colorpicker.module","btford.modal","ui.bootstrap","ngAnimate","GlobalModule","ui.tree","IDEServices"]);ide.config(["$compileProvider",function(e){e.imgSrcSanitizationWhitelist(/^\s*((https?|ftp|file|blob|chrome-extension):|data:image\/)/),e.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|tel|file:chrome-extension|chrome-extension):/)}]);var baseUrl="",PID="",TOKEN="",MAX_DATA_LENGTH=1e5,ideScope,isOffline,mode="DEBUG";console.log=function(e){return"DEBUG"===mode?e.log:(e.oldLog=e.log,function(){})}(console);var logs=[];ide.controller("IDECtrl",["$scope","$timeout","$http","$interval","ProjectService","GlobalService","Preference","ResourceService","TagService","TemplateProvider","TimerService","UserTypeService",function(e,t,o,a,n,r,c,i,s,l,u,d){function h(){e.leftShown=!0,e.rightShown=!0,e.bottomShown=!0;try{var t=require("os");t&&(window.local=!0,e.local=!0,I=global.__dirname,y=require("path"),U=require("fs"))}catch(e){window.local=!1}}function f(){window.local?g():$()}function b(){if(window.local)d.setUserType("basic");else{var e=localStorage.getItem("userType");d.setUserType(e)}}function g(){var o=window.location.href,a=o.split("?")[1].split("=")[1];"#"===a[a.length-1]&&(a=a.slice(0,-1));var n=y.join(I,"localproject",a);i.setProjectUrl(n);var r=y.join(n,"resources");i.setResourceUrl(r);var c=y.join(I,y.dirname(window.location.pathname));i.setResourceNWUrl(y.relative(c,r));var s=m(y.join(n,"project.json"));t(function(){s?(s=JSON.parse(s),p(s,a)):S({},a)},0),e.$on("LoadUp",function(){z++,6==z&&w()})}function m(e,t){if(!t)return U.readFileSync(e,"utf-8");try{var o=U.statSync(e);return o&&o.isFile()?U.readFileSync(e,"utf-8"):null}catch(e){return null}}function v(e,t){var a=e.template;l.setTemplateId(a),a&&""!==a?o({method:"GET",url:"/public/templates/defaultTemplate/defaultTemplate.json"}).success(function(o){R(o,function(){p(e,t)}.bind(this))}).error(function(e){}):p(e,t)}function p(t,o){if(t.content){var a=JSON.parse(t.content),c=t.resolution.split("*").map(function(e){return Number(e)});a.initSize={width:c[0],height:c[1]},a.currentSize={width:c[0],height:c[1]},a.maxSize=t.maxSize,a.projectId=o;var s=a.resourceList,u=s.length,d=i.getGlobalResources();window.globalResources=d;var h=function(t,o){"error"===t.type?(toastr.warning("图片加载失败: "+o.name),o.complete=!1):o.complete=!0,u-=1,u<=0&&(l.saveProjectFromGlobal(a),F(a),n.saveProjectFromGlobal(a,function(){e.$broadcast("GlobalProjectReceived")}))}.bind(this);if(u>0)for(var f=0;f<s.length;f++){var b=s[f];i.cacheFileToGlobalResources(b,h,h)}else l.saveProjectFromGlobal(a),F(a),n.saveProjectFromGlobal(a,function(){e.$broadcast("GlobalProjectReceived")})}else{a=r.getBlankProject(),a.projectId=o;var c=t.resolution.split("*").map(function(e){return Number(e)});a.initSize={width:c[0],height:c[1]},a.currentSize={width:c[0],height:c[1]},a.maxSize=t.maxSize,l.saveProjectFromGlobal(a),F(a),n.saveProjectFromGlobal(a,function(){e.$broadcast("GlobalProjectReceived")})}}function S(t,o){var a=r.getBlankProject();a.projectId=o;var c=(t.resolution||"800*480").split("*").map(function(e){return Number(e)});a.initSize={width:c[0],height:c[1]},a.currentSize={width:c[0],height:c[1]},a.maxSize=t.maxSize||104857600,l.saveProjectFromGlobal(a),n.saveProjectFromGlobal(a,function(){F(a),e.$broadcast("GlobalProjectReceived")})}function $(){for(var t=window.location.href,a=t.split("/"),n="",r=0;r<a.length;r++)if("project"==a[r]){n=a[r+1];break}i.setResourceUrl("/project/"+n+"/resources/"),o({method:"GET",url:baseUrl+"/project/"+n+"/content"}).success(function(e){v(e,n)}).error(function(e){toastr.warning("读取错误"),S({},n)}),e.$on("LoadUp",function(){z++,6==z&&w()})}function w(){t(function(){e.ide.loaded=!0,window.spinner&&window.spinner.hide()},200)}function P(){window.local||setInterval(function(){o({method:"GET",url:baseUrl+"/api/refreshlogin"}).success(function(e){}).error(function(e){})},6e5)}function j(a){function c(t){o({method:"GET",url:baseUrl+"/project",params:{token:window.localStorage.getItem("token"),pid:a}}).success(function(t){var o=t.status;"success"==o?(i=t.project.data,i?(l.saveProjectFromGlobal(i),n.saveProjectFromGlobal(i,function(){PID=a,F(i),e.$broadcast("GlobalProjectReceived"),logs.push("从服务器获取项目")})):N()):N()}).error(function(e){N()})}var i={};if(!a)return t(function(){toastr.info("加载离线项目"),i=r.getBlankProject(),l.saveProjectFromGlobal(i),n.saveProjectFromGlobal(i,function(){PID=a,F(i),e.$broadcast("GlobalProjectReceived")})}),void logs.push("打开本地项目");c()}function C(){e.$on("ChangePageNode",function(){e.$broadcast("PageNodeChanged"),e.$broadcast("NavStatusChanged")}),e.$on("ChangeCurrentPage",function(t,o,a){e.$broadcast("CurrentPageChanged",o,a),e.$broadcast("NavStatusChanged"),e.$broadcast("AttributeChanged"),document.getElementById("saveFlag").value="false"}),e.$on("ChangeCurrentSubLayer",function(t,o,a){e.$broadcast("CurrentSubLayerChanged",o,a),e.$broadcast("NavStatusChanged"),e.$broadcast("AttributeChanged")}),e.$on("SwitchCurrentPage",function(t,o,a){e.$broadcast("PageChangedSwitched",o,a),e.$broadcast("NavStatusChanged"),e.$broadcast("AttributeChanged")}),e.$on("ChangeToolShow",function(t,o){e.$broadcast("ToolShowChanged",o),e.$broadcast("NavStatusChanged")}),e.$on("AddNewPage",function(t,o,a){e.$broadcast("NewPageAdded",o,a),e.$broadcast("PageNodeChanged"),e.$broadcast("NavStatusChanged"),e.$broadcast("AttributeChanged")}),e.$on("changeCanvasScale",function(t,o){e.$broadcast("CanvasScaleChanged",o)}),e.$on("UpdateProject",function(t){e.$broadcast("ProjectUpdated"),document.getElementById("saveFlag").value="true"}),e.$on("Undo",function(t,o,a){e.$broadcast("OperateQueChanged",o,a),e.$broadcast("NavStatusChanged"),e.$broadcast("PageNodeChanged"),e.$broadcast("AttributeChanged")}),e.$on("Redo",function(t,o,a){e.$broadcast("OperateQueChanged",o,a),e.$broadcast("NavStatusChanged"),e.$broadcast("PageNodeChanged"),e.$broadcast("AttributeChanged")}),e.$on("DoCopy",function(t){e.$broadcast("NavStatusChanged")}),e.$on("ResourceUpdate",function(){e.$broadcast("AttributeChanged"),e.$broadcast("ResourceChanged")}),e.$on("ReOpenProject",G),e.$on("ChangeShownArea",function(t,o){switch(o){case 0:e.leftShown=!e.leftShown;break;case 1:e.rightShown=!e.rightShown;break;case 2:e.bottomShown=!e.bottomShown}})}function G(t,o){e.ide.loaded=!1,z=0,j(o)}function T(){fabric.FX_DURATION=c.FX_DURATION}function N(){try{var t=PID,o=JSON.parse(window.localStorage.getItem("projectCache"+t)),a=o;l.saveProjectFromGlobal(a),n.saveProjectFromGlobal(a,function(){F(a),e.$broadcast("GlobalProjectReceived")})}catch(e){toastr.info("获取项目失败")}}function F(e){i.setMaxTotalSize(e.maxSize||104857600),i.syncFiles(e.resourceList),s.syncCustomTags(e.customTags),s.syncTimerTags(e.timerTags),s.setTimerNum(e.timers)}function R(e,t){var o=_.cloneDeep(e);i.setTemplateFiles(o.templateResourcesList),l.setDefaultWidget(o);var a=o.templateResourcesList||[],n=a.length,r=function(e,o){"error"===e.type?(toastr.warning("图片加载失败: "+o.name),o.complete=!1):o.complete=!0,n--,n<=0&&t&&t()};n>0?a.map(function(e,t){i.cacheFileToGlobalResources(e,r,r)}):t&&t()}ideScope=e,e.ide={loaded:!1};var U,y,I,z=0;h(),f(),b(),C(),T(),P()}]);